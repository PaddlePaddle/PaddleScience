
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="An out-of-the-box open source library for scientific computing based on deep learning.">
      
      
        <meta name="author" content="PaddlePaddle">
      
      
        <link rel="canonical" href="https://github.com/PaddlePaddle/PaddleScience/ai4s_universal_platform/zh/examples/tempoGAN/">
      
      
        <link rel="prev" href="../shock_wave/">
      
      
        <link rel="next" href="../nsfnet4/">
      
      
      <link rel="icon" href="../../../images/icons/favcion.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.12">
    
    
      
        <title>tempoGAN - PaddleScience Docs</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.7e359304.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      

  
  
  
  
  <style>:root{--md-annotation-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M256 512a256 256 0 1 0 0-512 256 256 0 1 0 0 512zm-86.2-346.7c7.9-22.3 29.1-37.3 52.8-37.3h58.3c34.9 0 63.1 28.3 63.1 63.1 0 22.6-12.1 43.5-31.7 54.8L280 264.4c-.2 13-10.9 23.6-24 23.6-13.3 0-24-10.7-24-24v-13.5c0-8.6 4.6-16.5 12.1-20.8l44.3-25.4c4.7-2.7 7.6-7.7 7.6-13.1 0-8.4-6.8-15.1-15.1-15.1h-58.3c-3.4 0-6.4 2.1-7.5 5.3l-.4 1.2c-4.4 12.5-18.2 19-30.6 14.6s-19-18.2-14.6-30.6l.4-1.2zM224 352a32 32 0 1 1 64 0 32 32 0 1 1-64 0z"/></svg>');}</style>


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Noto Serif SC";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tempogantemporally-generative-adversarial-networks" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="PaddleScience Docs" class="md-header__button md-logo" aria-label="PaddleScience Docs" data-md-component="logo">
      
  <img src="../../../images/icons/paddle.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PaddleScience Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              tempoGAN
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="选择当前语言">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.52 17.52 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04M18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12m-2.62 7 1.62-4.33L19.12 17h-3.24Z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="/zh/" hreflang="zh" class="md-select__link">
              简体中文
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="/en/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/PaddlePaddle/PaddleScience" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    PaddleScience
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../.." class="md-tabs__link">
          
  
  PaddleScience

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      
  
  
    
  
  
    
    
      
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../allen_cahn/" class="md-tabs__link">
          
  
  经典案例

        </a>
      </li>
    
  

    
  

    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../api/arch/" class="md-tabs__link">
          
  
  API 文档

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../user_guide/" class="md-tabs__link">
        
  
    
  
  使用指南

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../development/" class="md-tabs__link">
          
  
  开发与复现指南

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../technical_doc/" class="md-tabs__link">
        
  
    
  
  技术稿件

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../cooperation/" class="md-tabs__link">
        
  
    
  
  共创计划

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="https://aistudio.baidu.com/aistudio/projectoverview/public?topic=15" class="md-tabs__link">
        
  
    
  
  实训社区

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="PaddleScience Docs" class="md-nav__button md-logo" aria-label="PaddleScience Docs" data-md-component="logo">
      
  <img src="../../../images/icons/paddle.png" alt="logo">

    </a>
    PaddleScience Docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/PaddlePaddle/PaddleScience" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    PaddleScience
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    PaddleScience
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            PaddleScience
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    主页
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    功能介绍
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../install_setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    安装使用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstart/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    快速开始
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    学习资料
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    经典案例
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            经典案例
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" checked>
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="">
            
  
  <span class="md-ellipsis">
     
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
             
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1_1" id="__nav_2_1_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    数学(AI for Math)
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_1">
            <span class="md-nav__icon md-icon"></span>
            数学(AI for Math)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../allen_cahn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AllenCahn
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../deephpms/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DeepHPMs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../deeponet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DeepONet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../euler_beam/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Euler_Beam
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../laplace2d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Laplace2D
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lorenz/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lorenz_transform_physx
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pirbn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PIRBN
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../rossler/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rossler_transform_physx
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../volterra_ide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Volterra_IDE
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../nlsmb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NLSMB
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xpinns/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    XPINN
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2_1_2" id="__nav_2_1_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    技术科学(AI for Technology)
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_1_2">
            <span class="md-nav__icon md-icon"></span>
            技术科学(AI for Technology)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_2_1" checked>
        
          
          <label class="md-nav__link" for="__nav_2_1_2_1" id="__nav_2_1_2_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    流体
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_2_1_2_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_1_2_1">
            <span class="md-nav__icon md-icon"></span>
            流体
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../amgnet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AMGNet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../aneurysm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Aneurysm
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bubble/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BubbleNet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cfdgcn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CFDGCN
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cylinder2d_unsteady/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cylinder2D_unsteady
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cylinder2d_unsteady_transformer_physx/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cylinder2D_unsteady_transform_physx
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../darcy2d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Darcy2D
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../deepcfd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DeepCFD
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ldc2d_steady/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LDC2D_steady
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ldc2d_unsteady/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LDC2D_unsteady
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../labelfree_DNN_surrogate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Labelfree_DNN_surrogate
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../nsfnet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NSFNets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../phycrnet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PhyCRNet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../shock_wave/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ShockWave
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    tempoGAN
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    tempoGAN
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 背景简介
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2. 问题定义
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      3. 问题求解
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. 问题求解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 数据集介绍
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 模型构建
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-transform" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 transform构建
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34" class="md-nav__link">
    <span class="md-ellipsis">
      3.4 参数和超参数设定
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35" class="md-nav__link">
    <span class="md-ellipsis">
      3.5 优化器构建
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#36" class="md-nav__link">
    <span class="md-ellipsis">
      3.6 约束构建
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.6 约束构建">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#361-generator" class="md-nav__link">
    <span class="md-ellipsis">
      3.6.1 Generator 的约束
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#362-discriminator" class="md-nav__link">
    <span class="md-ellipsis">
      3.6.2 Discriminator 的约束
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#363-discriminator_tempo" class="md-nav__link">
    <span class="md-ellipsis">
      3.6.3 Discriminator_tempo 的约束
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#37" class="md-nav__link">
    <span class="md-ellipsis">
      3.7 可视化器构建
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#38-loss-data-transform" class="md-nav__link">
    <span class="md-ellipsis">
      3.8 自定义 loss 和 data transform
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.8 自定义 loss 和 data transform">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#381-generator-loss" class="md-nav__link">
    <span class="md-ellipsis">
      3.8.1 Generator 的 loss
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#382-discriminator-loss" class="md-nav__link">
    <span class="md-ellipsis">
      3.8.2 Discriminator 的 loss
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#383-discriminator_tempo-loss" class="md-nav__link">
    <span class="md-ellipsis">
      3.8.3 Discriminator_tempo 的 loss
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#384-data-transform" class="md-nav__link">
    <span class="md-ellipsis">
      3.8.4 自定义 data transform
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#39" class="md-nav__link">
    <span class="md-ellipsis">
      3.9 模型训练
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#310" class="md-nav__link">
    <span class="md-ellipsis">
      3.10 模型评估
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.10 模型评估">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#3101" class="md-nav__link">
    <span class="md-ellipsis">
      3.10.1 训练中评估
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3102-eval" class="md-nav__link">
    <span class="md-ellipsis">
      3.10.2 eval 中评估
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      4. 完整代码
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      5. 结果展示
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    <span class="md-ellipsis">
      6. 参考文献
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../nsfnet4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NSFNet4
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../viv/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ViV
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_1_2_2" id="__nav_2_1_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    结构
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_2_1_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_2_2">
            <span class="md-nav__icon md-icon"></span>
            结构
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../biharmonic2d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Biharmonic2D
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bracket/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bracket
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../control_arm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Control_arm
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../epnn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EPNN
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../phylstm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Phy-LSTM
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../topopt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TopOpt
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_1_2_3" id="__nav_2_1_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    传热
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_2_1_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_2_3">
            <span class="md-nav__icon md-icon"></span>
            传热
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../heat_exchanger/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Heat_Exchanger
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../heat_pinn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Heat_PINN
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../phygeonet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PhyGeoNet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chip_heat/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chip_heat
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_3" >
        
          
          <label class="md-nav__link" for="__nav_2_1_3" id="__nav_2_1_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    材料科学(AI for Material)
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_3">
            <span class="md-nav__icon md-icon"></span>
            材料科学(AI for Material)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hpinns/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hPINNs
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_4" >
        
          
          <label class="md-nav__link" for="__nav_2_1_4" id="__nav_2_1_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    地球科学(AI for Earth Science)
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_4">
            <span class="md-nav__icon md-icon"></span>
            地球科学(AI for Earth Science)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fourcastnet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FourCastNet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../nowcastnet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NowcastNet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dgmr/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DGMR
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../earthformer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EarthFormer
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API 文档
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            API 文档
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ppsci
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            ppsci
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/arch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.arch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/autodiff/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.autodiff
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/constraint/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.constraint
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_4" >
        
          
          <label class="md-nav__link" for="__nav_3_1_4" id="__nav_3_1_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ppsci.data
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_4">
            <span class="md-nav__icon md-icon"></span>
            ppsci.data
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data/dataset/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.data.dataset
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data/process/transform/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.data.transform
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data/process/batch_transform/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.data.batch_transform
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/equation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.equation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/geometry/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.geometry
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_7" >
        
          
          <label class="md-nav__link" for="__nav_3_1_7" id="__nav_3_1_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ppsci.loss
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_7">
            <span class="md-nav__icon md-icon"></span>
            ppsci.loss
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/loss/loss/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.loss.loss
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/loss/mtl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.loss.mtl
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/metric/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.metric
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_9" >
        
          
          <label class="md-nav__link" for="__nav_3_1_9" id="__nav_3_1_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ppsci.optimizer
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_9">
            <span class="md-nav__icon md-icon"></span>
            ppsci.optimizer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/optimizer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.optimizer.optimizer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/lr_scheduler/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.optimizer.lr_scheduler
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/solver/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.solver
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_11" >
        
          
          <label class="md-nav__link" for="__nav_3_1_11" id="__nav_3_1_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ppsci.utils
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_11">
            <span class="md-nav__icon md-icon"></span>
            ppsci.utils
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/utils/checker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.utils.checker
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/utils/expression/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.utils.expression
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/utils/initializer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.utils.initializer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/utils/logger/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.utils.logger
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/utils/misc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.utils.misc
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/utils/ema/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.utils.ema
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/utils/reader/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.utils.reader
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/utils/writer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.utils.writer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/utils/save_load/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.utils.save_load
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/utils/symbolic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.utils.symbolic
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/validate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.validate
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/visualize/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.visualize
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/experimental/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.experimental
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/probability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.probability
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    deploy
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            deploy
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/depoly/python_infer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    deploy.python_infer
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user_guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    使用指南
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    开发与复现指南
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            开发与复现指南
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    开发指南
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reproduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    复现指南
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../technical_doc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    技术稿件
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cooperation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    共创计划
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://aistudio.baidu.com/aistudio/projectoverview/public?topic=15" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    实训社区
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 背景简介
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2. 问题定义
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      3. 问题求解
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. 问题求解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 数据集介绍
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 模型构建
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-transform" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 transform构建
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34" class="md-nav__link">
    <span class="md-ellipsis">
      3.4 参数和超参数设定
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35" class="md-nav__link">
    <span class="md-ellipsis">
      3.5 优化器构建
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#36" class="md-nav__link">
    <span class="md-ellipsis">
      3.6 约束构建
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.6 约束构建">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#361-generator" class="md-nav__link">
    <span class="md-ellipsis">
      3.6.1 Generator 的约束
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#362-discriminator" class="md-nav__link">
    <span class="md-ellipsis">
      3.6.2 Discriminator 的约束
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#363-discriminator_tempo" class="md-nav__link">
    <span class="md-ellipsis">
      3.6.3 Discriminator_tempo 的约束
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#37" class="md-nav__link">
    <span class="md-ellipsis">
      3.7 可视化器构建
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#38-loss-data-transform" class="md-nav__link">
    <span class="md-ellipsis">
      3.8 自定义 loss 和 data transform
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.8 自定义 loss 和 data transform">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#381-generator-loss" class="md-nav__link">
    <span class="md-ellipsis">
      3.8.1 Generator 的 loss
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#382-discriminator-loss" class="md-nav__link">
    <span class="md-ellipsis">
      3.8.2 Discriminator 的 loss
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#383-discriminator_tempo-loss" class="md-nav__link">
    <span class="md-ellipsis">
      3.8.3 Discriminator_tempo 的 loss
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#384-data-transform" class="md-nav__link">
    <span class="md-ellipsis">
      3.8.4 自定义 data transform
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#39" class="md-nav__link">
    <span class="md-ellipsis">
      3.9 模型训练
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#310" class="md-nav__link">
    <span class="md-ellipsis">
      3.10 模型评估
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.10 模型评估">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#3101" class="md-nav__link">
    <span class="md-ellipsis">
      3.10.1 训练中评估
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3102-eval" class="md-nav__link">
    <span class="md-ellipsis">
      3.10.2 eval 中评估
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      4. 完整代码
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      5. 结果展示
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    <span class="md-ellipsis">
      6. 参考文献
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/PaddlePaddle/PaddleScience/edit/develop/docs/zh/examples/tempoGAN.md" title="编辑此页" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/PaddlePaddle/PaddleScience/raw/develop/docs/zh/examples/tempoGAN.md" title="查看本页的源代码" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5Z"/></svg>
    </a>
  


<div><h1 id="tempogantemporally-generative-adversarial-networks">tempoGAN(temporally Generative Adversarial Networks)<a class="headerlink" href="#tempogantemporally-generative-adversarial-networks" title="Permanent link">¶</a></h1>
<p><a href="https://aistudio.baidu.com/aistudio/projectdetail/6521709" class="md-button md-button--primary" style>AI Studio快速体验</a></p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:4"><input checked id="__tabbed_1_1" name="__tabbed_1" type="radio"><input id="__tabbed_1_2" name="__tabbed_1" type="radio"><input id="__tabbed_1_3" name="__tabbed_1" type="radio"><input id="__tabbed_1_4" name="__tabbed_1" type="radio"><div class="tabbed-labels"><label for="__tabbed_1_1">模型训练命令</label><label for="__tabbed_1_2">模型评估命令</label><label for="__tabbed_1_3">模型导出命令</label><label for="__tabbed_1_4">模型推理命令</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># linux</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>wget<span class="w"> </span>-nc<span class="w"> </span>https://paddle-org.bj.bcebos.com/paddlescience/datasets/tempoGAN/2d_train.mat<span class="w"> </span>-P<span class="w"> </span>datasets/tempoGAN/
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>wget<span class="w"> </span>-nc<span class="w"> </span>https://paddle-org.bj.bcebos.com/paddlescience/datasets/tempoGAN/2d_valid.mat<span class="w"> </span>-P<span class="w"> </span>datasets/tempoGAN/
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="c1"># windows</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="c1"># curl https://paddle-org.bj.bcebos.com/paddlescience/datasets/tempoGAN/2d_train.mat --create-dirs -o ./datasets/tempoGAN/2d_train.mat</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="c1"># curl https://paddle-org.bj.bcebos.com/paddlescience/datasets/tempoGAN/2d_valid.mat --create-dirs -o ./datasets/tempoGAN/2d_valid.mat</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>python<span class="w"> </span>tempoGAN.py
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># linux</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>wget<span class="w"> </span>-nc<span class="w"> </span>https://paddle-org.bj.bcebos.com/paddlescience/datasets/tempoGAN/2d_train.mat<span class="w"> </span>-P<span class="w"> </span>datasets/tempoGAN/
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>wget<span class="w"> </span>-nc<span class="w"> </span>https://paddle-org.bj.bcebos.com/paddlescience/datasets/tempoGAN/2d_valid.mat<span class="w"> </span>-P<span class="w"> </span>datasets/tempoGAN/
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="c1"># windows</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="c1"># curl https://paddle-org.bj.bcebos.com/paddlescience/datasets/tempoGAN/2d_train.mat --create-dirs -o ./datasets/tempoGAN/2d_train.mat</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="c1"># curl https://paddle-org.bj.bcebos.com/paddlescience/datasets/tempoGAN/2d_valid.mat --create-dirs -o ./datasets/tempoGAN/2d_valid.mat</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>python<span class="w"> </span>tempoGAN.py<span class="w"> </span><span class="nv">mode</span><span class="o">=</span><span class="nb">eval</span><span class="w"> </span>EVAL.pretrained_model_path<span class="o">=</span>https://paddle-org.bj.bcebos.com/paddlescience/models/tempoGAN/tempogan_pretrained.pdparams
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>python<span class="w"> </span>tempoGAN.py<span class="w"> </span><span class="nv">mode</span><span class="o">=</span><span class="nb">export</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># linux</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>wget<span class="w"> </span>-nc<span class="w"> </span>https://paddle-org.bj.bcebos.com/paddlescience/datasets/tempoGAN/2d_valid.mat<span class="w"> </span>-P<span class="w"> </span>datasets/tempoGAN/
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="c1"># windows</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="c1"># curl https://paddle-org.bj.bcebos.com/paddlescience/datasets/tempoGAN/2d_valid.mat --create-dirs -o ./datasets/tempoGAN/2d_valid.mat</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>python<span class="w"> </span>tempoGAN.py<span class="w"> </span><span class="nv">mode</span><span class="o">=</span>infer
</span></code></pre></div>
</div>
</div>
</div>
<table>
<thead>
<tr>
<th style="text-align: left;">预训练模型</th>
<th style="text-align: left;">指标</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><a href="https://paddle-org.bj.bcebos.com/paddlescience/models/tempoGAN/tempogan_pretrained.pdparams">tempogan_pretrained.pdparams</a></td>
<td style="text-align: left;">MSE: 4.21e-5<br>PSNR: 47.19<br>SSIM: 0.9974</td>
</tr>
</tbody>
</table>
<h2 id="1">1. 背景简介<a class="headerlink" href="#1" title="Permanent link">¶</a></h2>
<p>流体模拟方面的问题，捕捉湍流的复杂细节一直是数值模拟的长期挑战，用离散模型解决这些细节会产生巨大的计算成本，对于人类空间和时间尺度上的流动来说，很快就会变得不可行。因此流体超分辨率的需求应运而生，它旨在通过流体动力学模拟和深度学习技术将低分辨率流体模拟结果恢复为高分辨率结果，以减少生成高分辨率流体过程中的巨大计算成本。该技术可以应用于各种流体模拟，例如水流、空气流动、火焰模拟等。</p>
<p>生成式对抗网络 GAN(Generative Adversarial Networks) 是一种使用无监督学习方法的深度学习网络，GAN 网络中（至少）包含两个模型：生成器(Generator) 和判别器(Discriminator)，生成器用于生成问题的输出，判别器用于判断输出的真假，两者在相互博弈中共同优化，最终使得生成器的输出接近真实值。</p>
<p>tempoGAN 在 GAN 网络的基础上新增了一个与时间相关的判别器 Discriminator_tempo，该判别器的网络结构与基础判别器相同，但输入为时间连续的几帧数据，而不是单帧数据，从而将时序纳入考虑范围。</p>
<p>本问题主要使用该网络，通过输入的低密度流体数据，得到对应的高密度流体数据，大大节省时间和计算成本。</p>
<h2 id="2">2. 问题定义<a class="headerlink" href="#2" title="Permanent link">¶</a></h2>
<p>本问题包含三个模型：生成器(Generator)、判别器(Discriminator)和与时间相关的判别器(Discriminator_tempo)，根据 GAN 网络的训练流程，这三个模型交替训练，训练顺序依次为：Discriminator、Discriminator_tempo、Generator。
GAN 网络为无监督学习，本问题网络设计中将目标值作为一个输入值，输入网络进行训练。</p>
<h2 id="3">3. 问题求解<a class="headerlink" href="#3" title="Permanent link">¶</a></h2>
<p>接下来开始讲解如何将问题一步一步地转化为 PaddleScience 代码，用深度学习的方法求解该问题。为了快速理解 PaddleScience，接下来仅对模型构建、约束构建等关键步骤进行阐述，而其余细节请参考 <a href="../../api/arch/">API文档</a>。</p>
<h3 id="31">3.1 数据集介绍<a class="headerlink" href="#31" title="Permanent link">¶</a></h3>
<p>数据集为使用开源代码包 <a href="http://mantaflow.com/install.html">mantaflow</a> 生成的 2d 流体数据集，数据集中包括一定数量连续帧的低、高密度流体图像转化成的数值，以字典的形式存储在 <code>.mat</code> 文件中。</p>
<p>运行本问题代码前请下载 <a href="https://paddle-org.bj.bcebos.com/paddlescience/datasets/tempoGAN/2d_train.mat">训练数据集</a> 和 <a href="https://paddle-org.bj.bcebos.com/paddlescience/datasets/tempoGAN/2d_valid.mat">验证数据集</a>， 下载后分别存放在路径：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-27">27</a></span>
<span class="normal"><a href="#__codelineno-4-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27"></a><span class="nt">output_dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${hydra:run.dir}</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28"></a><span class="nt">log_freq</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="32">3.2 模型构建<a class="headerlink" href="#32" title="Permanent link">¶</a></h3>
<figure>
<p><a class="glightbox" href="https://paddle-org.bj.bcebos.com/paddlescience/docs/tempoGAN/tempoGAN_arch.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="tempoGAN-arch" loading="lazy" src="https://paddle-org.bj.bcebos.com/paddlescience/docs/tempoGAN/tempoGAN_arch.png" style="margin:0 auto"></a>
  </p>
<figcaption> tempoGAN 网络模型</figcaption>
</figure>
<p>上图为tempoGAN 完整的模型结构图，但本问题只针对较为简单的情况进行处理，不涉及包含速度和涡度的输入、3d、数据增强、advection operator 等部分，如果您对这些文档中未包含的内容感兴趣，可以自行修改代码并进行进一步实验。</p>
<p>如上图所示，Generator 的输入为低密度流体数据的插值，输出为生成的高密度流体模拟数据，Discriminator 的输入为低密度流体数据的插值分别与 Generator 生成的高密度流体模拟数据、目标高密度流体数据的拼接， Discriminator_tempo 的输入为多帧连续的 Generator 生成的高密度流体模拟数据以及目标高密度流体数据。</p>
<p>虽然输入输出的组成看起来较为复杂，但本质都是流体的密度数据，因此 3 个网络的映射函数都是 <span class="arithmatex">\(f: \mathbb{R}^1 \to \mathbb{R}^1\)</span>。</p>
<p>与简单的 MLP 网络不同，根据要解决的问题不同，GAN 的生成器和判别器有多种网络结构可以选择，在此不再赘述。由于这种独特性，本问题中的 tempoGAN 网络没有被内置在 PaddleScience 中，需要额外实现。</p>
<p>本问题中的 Generator 是一个拥有 4 层改良 Res Block 的模型，Discriminator 和 Discriminator_tempo 为同一个拥有 4 层卷积结果的模型，两者网络结构相同但输入不同。Generator、Discriminator 和 Discriminator_tempo 的网络参数也需要额外定义。</p>
<p>具体代码请参考 <a href="#4">完整代码</a> 中 gan.py 文件。</p>
<p>由于 GAN 网络中生成器和判别器的中间结果要相互调用，参与对方的 loss 计算，因此使用 Model List 实现，用 PaddleScience 代码表示如下：</p>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-57">57</a></span>
<span class="normal"><a href="#__codelineno-5-58">58</a></span>
<span class="normal"><a href="#__codelineno-5-59">59</a></span>
<span class="normal"><a href="#__codelineno-5-60">60</a></span>
<span class="normal"><a href="#__codelineno-5-61">61</a></span>
<span class="normal"><a href="#__codelineno-5-62">62</a></span>
<span class="normal"><a href="#__codelineno-5-63">63</a></span>
<span class="normal"><a href="#__codelineno-5-64">64</a></span>
<span class="normal"><a href="#__codelineno-5-65">65</a></span>
<span class="normal"><a href="#__codelineno-5-66">66</a></span>
<span class="normal"><a href="#__codelineno-5-67">67</a></span>
<span class="normal"><a href="#__codelineno-5-68">68</a></span>
<span class="normal"><a href="#__codelineno-5-69">69</a></span>
<span class="normal"><a href="#__codelineno-5-70">70</a></span>
<span class="normal"><a href="#__codelineno-5-71">71</a></span>
<span class="normal"><a href="#__codelineno-5-72">72</a></span>
<span class="normal"><a href="#__codelineno-5-73">73</a></span>
<span class="normal"><a href="#__codelineno-5-74">74</a></span>
<span class="normal"><a href="#__codelineno-5-75">75</a></span>
<span class="normal"><a href="#__codelineno-5-76">76</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-57"><a id="__codelineno-5-57" name="__codelineno-5-57"></a><span class="c1"># define Generator model</span>
</span><span id="__span-5-58"><a id="__codelineno-5-58" name="__codelineno-5-58"></a><span class="n">model_gen</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">Generator</span><span class="p">(</span><span class="o">**</span><span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">gen_net</span><span class="p">)</span>
</span><span id="__span-5-59"><a id="__codelineno-5-59" name="__codelineno-5-59"></a><span class="n">model_gen</span><span class="o">.</span><span class="n">register_input_transform</span><span class="p">(</span><span class="n">gen_funcs</span><span class="o">.</span><span class="n">transform_in</span><span class="p">)</span>
</span><span id="__span-5-60"><a id="__codelineno-5-60" name="__codelineno-5-60"></a><span class="n">disc_funcs</span><span class="o">.</span><span class="n">model_gen</span> <span class="o">=</span> <span class="n">model_gen</span>
</span><span id="__span-5-61"><a id="__codelineno-5-61" name="__codelineno-5-61"></a>
</span><span id="__span-5-62"><a id="__codelineno-5-62" name="__codelineno-5-62"></a><span class="n">model_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">model_gen</span><span class="p">,)</span>
</span><span id="__span-5-63"><a id="__codelineno-5-63" name="__codelineno-5-63"></a><span class="c1"># define Discriminators</span>
</span><span id="__span-5-64"><a id="__codelineno-5-64" name="__codelineno-5-64"></a><span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">USE_SPATIALDISC</span><span class="p">:</span>
</span><span id="__span-5-65"><a id="__codelineno-5-65" name="__codelineno-5-65"></a>    <span class="n">model_disc</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">Discriminator</span><span class="p">(</span><span class="o">**</span><span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">disc_net</span><span class="p">)</span>
</span><span id="__span-5-66"><a id="__codelineno-5-66" name="__codelineno-5-66"></a>    <span class="n">model_disc</span><span class="o">.</span><span class="n">register_input_transform</span><span class="p">(</span><span class="n">disc_funcs</span><span class="o">.</span><span class="n">transform_in</span><span class="p">)</span>
</span><span id="__span-5-67"><a id="__codelineno-5-67" name="__codelineno-5-67"></a>    <span class="n">model_tuple</span> <span class="o">+=</span> <span class="p">(</span><span class="n">model_disc</span><span class="p">,)</span>
</span><span id="__span-5-68"><a id="__codelineno-5-68" name="__codelineno-5-68"></a>
</span><span id="__span-5-69"><a id="__codelineno-5-69" name="__codelineno-5-69"></a><span class="c1"># define temporal Discriminators</span>
</span><span id="__span-5-70"><a id="__codelineno-5-70" name="__codelineno-5-70"></a><span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">USE_TEMPODISC</span><span class="p">:</span>
</span><span id="__span-5-71"><a id="__codelineno-5-71" name="__codelineno-5-71"></a>    <span class="n">model_disc_tempo</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">Discriminator</span><span class="p">(</span><span class="o">**</span><span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">tempo_net</span><span class="p">)</span>
</span><span id="__span-5-72"><a id="__codelineno-5-72" name="__codelineno-5-72"></a>    <span class="n">model_disc_tempo</span><span class="o">.</span><span class="n">register_input_transform</span><span class="p">(</span><span class="n">disc_funcs</span><span class="o">.</span><span class="n">transform_in_tempo</span><span class="p">)</span>
</span><span id="__span-5-73"><a id="__codelineno-5-73" name="__codelineno-5-73"></a>    <span class="n">model_tuple</span> <span class="o">+=</span> <span class="p">(</span><span class="n">model_disc_tempo</span><span class="p">,)</span>
</span><span id="__span-5-74"><a id="__codelineno-5-74" name="__codelineno-5-74"></a>
</span><span id="__span-5-75"><a id="__codelineno-5-75" name="__codelineno-5-75"></a><span class="c1"># define model_list</span>
</span><span id="__span-5-76"><a id="__codelineno-5-76" name="__codelineno-5-76"></a><span class="n">model_list</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">ModelList</span><span class="p">(</span><span class="n">model_tuple</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>注意到上述代码中定义的网络输入与实际网络输入不完全一样，因此需要对输入进行transform。</p>
<h3 id="33-transform">3.3 transform构建<a class="headerlink" href="#33-transform" title="Permanent link">¶</a></h3>
<p>Generator 的输入为低密度流体数据的插值，而数据集中保存的为原始的低密度流体数据，因此需要进行一个插值的 transform。</p>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-269">269</a></span>
<span class="normal"><a href="#__codelineno-6-270">270</a></span>
<span class="normal"><a href="#__codelineno-6-271">271</a></span>
<span class="normal"><a href="#__codelineno-6-272">272</a></span>
<span class="normal"><a href="#__codelineno-6-273">273</a></span>
<span class="normal"><a href="#__codelineno-6-274">274</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-269"><a id="__codelineno-6-269" name="__codelineno-6-269"></a><span class="k">def</span> <span class="nf">transform_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_in</span><span class="p">):</span>
</span><span id="__span-6-270"><a id="__codelineno-6-270" name="__codelineno-6-270"></a>    <span class="n">ratio</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="__span-6-271"><a id="__codelineno-6-271" name="__codelineno-6-271"></a>    <span class="n">input_dict</span> <span class="o">=</span> <span class="n">reshape_input</span><span class="p">(</span><span class="n">_in</span><span class="p">)</span>
</span><span id="__span-6-272"><a id="__codelineno-6-272" name="__codelineno-6-272"></a>    <span class="n">density_low</span> <span class="o">=</span> <span class="n">input_dict</span><span class="p">[</span><span class="s2">"density_low"</span><span class="p">]</span>
</span><span id="__span-6-273"><a id="__codelineno-6-273" name="__codelineno-6-273"></a>    <span class="n">density_low_inp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="p">(</span><span class="n">density_low</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="s2">"nearest"</span><span class="p">)</span>
</span><span id="__span-6-274"><a id="__codelineno-6-274" name="__codelineno-6-274"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">"input_gen"</span><span class="p">:</span> <span class="n">density_low_inp</span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Discriminator 和 Discriminator_tempo 对输入的 transform 更为复杂，分别为：</p>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-359">359</a></span>
<span class="normal"><a href="#__codelineno-7-360">360</a></span>
<span class="normal"><a href="#__codelineno-7-361">361</a></span>
<span class="normal"><a href="#__codelineno-7-362">362</a></span>
<span class="normal"><a href="#__codelineno-7-363">363</a></span>
<span class="normal"><a href="#__codelineno-7-364">364</a></span>
<span class="normal"><a href="#__codelineno-7-365">365</a></span>
<span class="normal"><a href="#__codelineno-7-366">366</a></span>
<span class="normal"><a href="#__codelineno-7-367">367</a></span>
<span class="normal"><a href="#__codelineno-7-368">368</a></span>
<span class="normal"><a href="#__codelineno-7-369">369</a></span>
<span class="normal"><a href="#__codelineno-7-370">370</a></span>
<span class="normal"><a href="#__codelineno-7-371">371</a></span>
<span class="normal"><a href="#__codelineno-7-372">372</a></span>
<span class="normal"><a href="#__codelineno-7-373">373</a></span>
<span class="normal"><a href="#__codelineno-7-374">374</a></span>
<span class="normal"><a href="#__codelineno-7-375">375</a></span>
<span class="normal"><a href="#__codelineno-7-376">376</a></span>
<span class="normal"><a href="#__codelineno-7-377">377</a></span>
<span class="normal"><a href="#__codelineno-7-378">378</a></span>
<span class="normal"><a href="#__codelineno-7-379">379</a></span>
<span class="normal"><a href="#__codelineno-7-380">380</a></span>
<span class="normal"><a href="#__codelineno-7-381">381</a></span>
<span class="normal"><a href="#__codelineno-7-382">382</a></span>
<span class="normal"><a href="#__codelineno-7-383">383</a></span>
<span class="normal"><a href="#__codelineno-7-384">384</a></span>
<span class="normal"><a href="#__codelineno-7-385">385</a></span>
<span class="normal"><a href="#__codelineno-7-386">386</a></span>
<span class="normal"><a href="#__codelineno-7-387">387</a></span>
<span class="normal"><a href="#__codelineno-7-388">388</a></span>
<span class="normal"><a href="#__codelineno-7-389">389</a></span>
<span class="normal"><a href="#__codelineno-7-390">390</a></span>
<span class="normal"><a href="#__codelineno-7-391">391</a></span>
<span class="normal"><a href="#__codelineno-7-392">392</a></span>
<span class="normal"><a href="#__codelineno-7-393">393</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-359"><a id="__codelineno-7-359" name="__codelineno-7-359"></a><span class="k">def</span> <span class="nf">transform_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_in</span><span class="p">):</span>
</span><span id="__span-7-360"><a id="__codelineno-7-360" name="__codelineno-7-360"></a>    <span class="n">ratio</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="__span-7-361"><a id="__codelineno-7-361" name="__codelineno-7-361"></a>    <span class="n">input_dict</span> <span class="o">=</span> <span class="n">reshape_input</span><span class="p">(</span><span class="n">_in</span><span class="p">)</span>
</span><span id="__span-7-362"><a id="__codelineno-7-362" name="__codelineno-7-362"></a>    <span class="n">density_low</span> <span class="o">=</span> <span class="n">input_dict</span><span class="p">[</span><span class="s2">"density_low"</span><span class="p">]</span>
</span><span id="__span-7-363"><a id="__codelineno-7-363" name="__codelineno-7-363"></a>    <span class="n">density_high_from_target</span> <span class="o">=</span> <span class="n">input_dict</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">]</span>
</span><span id="__span-7-364"><a id="__codelineno-7-364" name="__codelineno-7-364"></a>
</span><span id="__span-7-365"><a id="__codelineno-7-365" name="__codelineno-7-365"></a>    <span class="n">density_low_inp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="p">(</span><span class="n">density_low</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="s2">"nearest"</span><span class="p">)</span>
</span><span id="__span-7-366"><a id="__codelineno-7-366" name="__codelineno-7-366"></a>
</span><span id="__span-7-367"><a id="__codelineno-7-367" name="__codelineno-7-367"></a>    <span class="n">density_high_from_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_gen</span><span class="p">(</span><span class="n">input_dict</span><span class="p">)[</span><span class="s2">"output_gen"</span><span class="p">]</span>
</span><span id="__span-7-368"><a id="__codelineno-7-368" name="__codelineno-7-368"></a>    <span class="n">density_high_from_gen</span><span class="o">.</span><span class="n">stop_gradient</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-7-369"><a id="__codelineno-7-369" name="__codelineno-7-369"></a>
</span><span id="__span-7-370"><a id="__codelineno-7-370" name="__codelineno-7-370"></a>    <span class="n">density_input_from_target</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
</span><span id="__span-7-371"><a id="__codelineno-7-371" name="__codelineno-7-371"></a>        <span class="p">[</span><span class="n">density_low_inp</span><span class="p">,</span> <span class="n">density_high_from_target</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
</span><span id="__span-7-372"><a id="__codelineno-7-372" name="__codelineno-7-372"></a>    <span class="p">)</span>
</span><span id="__span-7-373"><a id="__codelineno-7-373" name="__codelineno-7-373"></a>    <span class="n">density_input_from_gen</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
</span><span id="__span-7-374"><a id="__codelineno-7-374" name="__codelineno-7-374"></a>        <span class="p">[</span><span class="n">density_low_inp</span><span class="p">,</span> <span class="n">density_high_from_gen</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
</span><span id="__span-7-375"><a id="__codelineno-7-375" name="__codelineno-7-375"></a>    <span class="p">)</span>
</span><span id="__span-7-376"><a id="__codelineno-7-376" name="__codelineno-7-376"></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-7-377"><a id="__codelineno-7-377" name="__codelineno-7-377"></a>        <span class="s2">"input_disc_from_target"</span><span class="p">:</span> <span class="n">density_input_from_target</span><span class="p">,</span>
</span><span id="__span-7-378"><a id="__codelineno-7-378" name="__codelineno-7-378"></a>        <span class="s2">"input_disc_from_gen"</span><span class="p">:</span> <span class="n">density_input_from_gen</span><span class="p">,</span>
</span><span id="__span-7-379"><a id="__codelineno-7-379" name="__codelineno-7-379"></a>    <span class="p">}</span>
</span><span id="__span-7-380"><a id="__codelineno-7-380" name="__codelineno-7-380"></a>
</span><span id="__span-7-381"><a id="__codelineno-7-381" name="__codelineno-7-381"></a><span class="k">def</span> <span class="nf">transform_in_tempo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_in</span><span class="p">):</span>
</span><span id="__span-7-382"><a id="__codelineno-7-382" name="__codelineno-7-382"></a>    <span class="n">density_high_from_target</span> <span class="o">=</span> <span class="n">_in</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">]</span>
</span><span id="__span-7-383"><a id="__codelineno-7-383" name="__codelineno-7-383"></a>
</span><span id="__span-7-384"><a id="__codelineno-7-384" name="__codelineno-7-384"></a>    <span class="n">input_dict</span> <span class="o">=</span> <span class="n">reshape_input</span><span class="p">(</span><span class="n">_in</span><span class="p">)</span>
</span><span id="__span-7-385"><a id="__codelineno-7-385" name="__codelineno-7-385"></a>    <span class="n">density_high_from_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_gen</span><span class="p">(</span><span class="n">input_dict</span><span class="p">)[</span><span class="s2">"output_gen"</span><span class="p">]</span>
</span><span id="__span-7-386"><a id="__codelineno-7-386" name="__codelineno-7-386"></a>    <span class="n">density_high_from_gen</span><span class="o">.</span><span class="n">stop_gradient</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-7-387"><a id="__codelineno-7-387" name="__codelineno-7-387"></a>
</span><span id="__span-7-388"><a id="__codelineno-7-388" name="__codelineno-7-388"></a>    <span class="n">input_trans</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-7-389"><a id="__codelineno-7-389" name="__codelineno-7-389"></a>        <span class="s2">"input_tempo_disc_from_target"</span><span class="p">:</span> <span class="n">density_high_from_target</span><span class="p">,</span>
</span><span id="__span-7-390"><a id="__codelineno-7-390" name="__codelineno-7-390"></a>        <span class="s2">"input_tempo_disc_from_gen"</span><span class="p">:</span> <span class="n">density_high_from_gen</span><span class="p">,</span>
</span><span id="__span-7-391"><a id="__codelineno-7-391" name="__codelineno-7-391"></a>    <span class="p">}</span>
</span><span id="__span-7-392"><a id="__codelineno-7-392" name="__codelineno-7-392"></a>
</span><span id="__span-7-393"><a id="__codelineno-7-393" name="__codelineno-7-393"></a>    <span class="k">return</span> <span class="n">dereshape_input</span><span class="p">(</span><span class="n">input_trans</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>其中：</p>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-368">368</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-368"><a id="__codelineno-8-368" name="__codelineno-8-368"></a><span class="n">density_high_from_gen</span><span class="o">.</span><span class="n">stop_gradient</span> <span class="o">=</span> <span class="kc">True</span>
</span></code></pre></div></td></tr></table></div>
<p>表示停止参数的计算梯度，这样设置是因为这个变量在这里仅作为 Discriminator 和 Discriminator_tempo 的输入，在反向计算时不应该参与梯度回传，如果不进行这样的设置，由于这个变量来源于 Generator 的输出，在反向传播时梯度会沿着这个变量传给 Generator，从而改变 Generator 中的参数，这显然不是我们想要的。</p>
<p>这样，我们就实例化出了一个拥有 Generator、Discriminator 和 Discriminator_tempo 并包含输入 transform 的神经网络模型 <code>model list</code>。</p>
<h3 id="34">3.4 参数和超参数设定<a class="headerlink" href="#34" title="Permanent link">¶</a></h3>
<p>我们需要指定问题相关的参数，如数据集路径、各项 loss 的权重参数等。</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-27">27</a></span>
<span class="normal"><a href="#__codelineno-9-28">28</a></span>
<span class="normal"><a href="#__codelineno-9-29">29</a></span>
<span class="normal"><a href="#__codelineno-9-30">30</a></span>
<span class="normal"><a href="#__codelineno-9-31">31</a></span>
<span class="normal"><a href="#__codelineno-9-32">32</a></span>
<span class="normal"><a href="#__codelineno-9-33">33</a></span>
<span class="normal"><a href="#__codelineno-9-34">34</a></span>
<span class="normal"><a href="#__codelineno-9-35">35</a></span>
<span class="normal"><a href="#__codelineno-9-36">36</a></span>
<span class="normal"><a href="#__codelineno-9-37">37</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27"></a><span class="nt">output_dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${hydra:run.dir}</span>
</span><span id="__span-9-28"><a id="__codelineno-9-28" name="__codelineno-9-28"></a><span class="nt">log_freq</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20</span>
</span><span id="__span-9-29"><a id="__codelineno-9-29" name="__codelineno-9-29"></a><span class="nt">DATASET_PATH</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./datasets/tempoGAN/2d_train.mat</span>
</span><span id="__span-9-30"><a id="__codelineno-9-30" name="__codelineno-9-30"></a><span class="nt">DATASET_PATH_VALID</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./datasets/tempoGAN/2d_valid.mat</span>
</span><span id="__span-9-31"><a id="__codelineno-9-31" name="__codelineno-9-31"></a>
</span><span id="__span-9-32"><a id="__codelineno-9-32" name="__codelineno-9-32"></a><span class="c1"># set working condition</span>
</span><span id="__span-9-33"><a id="__codelineno-9-33" name="__codelineno-9-33"></a><span class="nt">USE_AMP</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-9-34"><a id="__codelineno-9-34" name="__codelineno-9-34"></a><span class="nt">USE_SPATIALDISC</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-9-35"><a id="__codelineno-9-35" name="__codelineno-9-35"></a><span class="nt">USE_TEMPODISC</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-9-36"><a id="__codelineno-9-36" name="__codelineno-9-36"></a><span class="nt">WEIGHT_GEN</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">5.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.0</span><span class="p p-Indicator">]</span><span class="w">  </span><span class="c1"># lambda_l1, lambda_l2, lambda_t</span>
</span><span id="__span-9-37"><a id="__codelineno-9-37" name="__codelineno-9-37"></a><span class="nt">WEIGHT_GEN_LAYER</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-1.0e-5</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">-1.0e-5</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">-1.0e-5</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">-1.0e-5</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">-1.0e-5</span><span class="p p-Indicator">]</span>
</span></code></pre></div></td></tr></table></div>
<p>注意到其中包含 3 个 bool 类型的变量 <code>use_amp</code>、<code>use_spatialdisc</code> 和 <code>use_tempodisc</code>，它们分别表示是否使用混合精度训练(AMP)、是否使用 Discriminator 和是否使用 Discriminator_tempo，当 <code>use_spatialdisc</code> 和 <code>use_tempodisc</code> 都被设置为 <code>False</code> 时，本问题的网络结构将会变为一个单纯的 Genrator 模型，不再是 GAN 网络了。</p>
<p>同时需要指定训练轮数和学习率等超参数，注意由于 GAN 网络训练流程与一般单个模型的网络不同，<code>EPOCHS</code> 的设置也有所不同。</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-73">73</a></span>
<span class="normal"><a href="#__codelineno-10-74">74</a></span>
<span class="normal"><a href="#__codelineno-10-75">75</a></span>
<span class="normal"><a href="#__codelineno-10-76">76</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-73"><a id="__codelineno-10-73" name="__codelineno-10-73"></a><span class="c1"># training settings</span>
</span><span id="__span-10-74"><a id="__codelineno-10-74" name="__codelineno-10-74"></a><span class="nt">TRAIN</span><span class="p">:</span>
</span><span id="__span-10-75"><a id="__codelineno-10-75" name="__codelineno-10-75"></a><span class="w">  </span><span class="nt">epochs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">40000</span>
</span><span id="__span-10-76"><a id="__codelineno-10-76" name="__codelineno-10-76"></a><span class="w">  </span><span class="nt">epochs_gen</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="35">3.5 优化器构建<a class="headerlink" href="#35" title="Permanent link">¶</a></h3>
<p>训练使用 Adam 优化器，学习率在 <code>Epoch</code> 达到一半时减小到原来的 <span class="arithmatex">\(1/20\)</span>，因此使用 <code>Step</code> 方法作为学习率策略。如果将 <code>by_epoch</code> 设为 True，学习率将根据训练的 <code>Epoch</code> 改变，否则将根据 <code>Iteration</code> 改变。</p>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-78">78</a></span>
<span class="normal"><a href="#__codelineno-11-79">79</a></span>
<span class="normal"><a href="#__codelineno-11-80">80</a></span>
<span class="normal"><a href="#__codelineno-11-81">81</a></span>
<span class="normal"><a href="#__codelineno-11-82">82</a></span>
<span class="normal"><a href="#__codelineno-11-83">83</a></span>
<span class="normal"><a href="#__codelineno-11-84">84</a></span>
<span class="normal"><a href="#__codelineno-11-85">85</a></span>
<span class="normal"><a href="#__codelineno-11-86">86</a></span>
<span class="normal"><a href="#__codelineno-11-87">87</a></span>
<span class="normal"><a href="#__codelineno-11-88">88</a></span>
<span class="normal"><a href="#__codelineno-11-89">89</a></span>
<span class="normal"><a href="#__codelineno-11-90">90</a></span>
<span class="normal"><a href="#__codelineno-11-91">91</a></span>
<span class="normal"><a href="#__codelineno-11-92">92</a></span>
<span class="normal"><a href="#__codelineno-11-93">93</a></span>
<span class="normal"><a href="#__codelineno-11-94">94</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-78"><a id="__codelineno-11-78" name="__codelineno-11-78"></a><span class="c1"># initialize Adam optimizer</span>
</span><span id="__span-11-79"><a id="__codelineno-11-79" name="__codelineno-11-79"></a><span class="n">lr_scheduler_gen</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">Step</span><span class="p">(</span>
</span><span id="__span-11-80"><a id="__codelineno-11-80" name="__codelineno-11-80"></a>    <span class="n">step_size</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">epochs</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">lr_scheduler</span>
</span><span id="__span-11-81"><a id="__codelineno-11-81" name="__codelineno-11-81"></a><span class="p">)()</span>
</span><span id="__span-11-82"><a id="__codelineno-11-82" name="__codelineno-11-82"></a><span class="n">optimizer_gen</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">lr_scheduler_gen</span><span class="p">)(</span><span class="n">model_gen</span><span class="p">)</span>
</span><span id="__span-11-83"><a id="__codelineno-11-83" name="__codelineno-11-83"></a><span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">USE_SPATIALDISC</span><span class="p">:</span>
</span><span id="__span-11-84"><a id="__codelineno-11-84" name="__codelineno-11-84"></a>    <span class="n">lr_scheduler_disc</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">Step</span><span class="p">(</span>
</span><span id="__span-11-85"><a id="__codelineno-11-85" name="__codelineno-11-85"></a>        <span class="n">step_size</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">epochs</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">lr_scheduler</span>
</span><span id="__span-11-86"><a id="__codelineno-11-86" name="__codelineno-11-86"></a>    <span class="p">)()</span>
</span><span id="__span-11-87"><a id="__codelineno-11-87" name="__codelineno-11-87"></a>    <span class="n">optimizer_disc</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">lr_scheduler_disc</span><span class="p">)(</span><span class="n">model_disc</span><span class="p">)</span>
</span><span id="__span-11-88"><a id="__codelineno-11-88" name="__codelineno-11-88"></a><span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">USE_TEMPODISC</span><span class="p">:</span>
</span><span id="__span-11-89"><a id="__codelineno-11-89" name="__codelineno-11-89"></a>    <span class="n">lr_scheduler_disc_tempo</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">Step</span><span class="p">(</span>
</span><span id="__span-11-90"><a id="__codelineno-11-90" name="__codelineno-11-90"></a>        <span class="n">step_size</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">epochs</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">lr_scheduler</span>
</span><span id="__span-11-91"><a id="__codelineno-11-91" name="__codelineno-11-91"></a>    <span class="p">)()</span>
</span><span id="__span-11-92"><a id="__codelineno-11-92" name="__codelineno-11-92"></a>    <span class="n">optimizer_disc_tempo</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">lr_scheduler_disc_tempo</span><span class="p">)(</span>
</span><span id="__span-11-93"><a id="__codelineno-11-93" name="__codelineno-11-93"></a>        <span class="p">(</span><span class="n">model_disc_tempo</span><span class="p">,)</span>
</span><span id="__span-11-94"><a id="__codelineno-11-94" name="__codelineno-11-94"></a>    <span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="36">3.6 约束构建<a class="headerlink" href="#36" title="Permanent link">¶</a></h3>
<p>本问题采用无监督学习的方式，虽然不是以监督学习方式进行训练，但此处仍然可以采用监督约束 <code>SupervisedConstraint</code>，在定义约束之前，需要给监督约束指定文件路径等数据读取配置，因为 tempoGAN 属于自监督学习，数据集中没有标签数据，而是使用一部分输入数据作为 <code>label</code>，因此需要设置约束的 <code>output_expr</code>。</p>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-122">122</a></span>
<span class="normal"><a href="#__codelineno-12-123">123</a></span>
<span class="normal"><a href="#__codelineno-12-124">124</a></span>
<span class="normal"><a href="#__codelineno-12-125">125</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-122"><a id="__codelineno-12-122" name="__codelineno-12-122"></a><span class="p">{</span>
</span><span id="__span-12-123"><a id="__codelineno-12-123" name="__codelineno-12-123"></a>    <span class="s2">"output_gen"</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">out</span><span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="s2">"output_gen"</span><span class="p">],</span>
</span><span id="__span-12-124"><a id="__codelineno-12-124" name="__codelineno-12-124"></a>    <span class="s2">"density_high"</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">out</span><span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">],</span>
</span><span id="__span-12-125"><a id="__codelineno-12-125" name="__codelineno-12-125"></a><span class="p">},</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="361-generator">3.6.1 Generator 的约束<a class="headerlink" href="#361-generator" title="Permanent link">¶</a></h4>
<p>下面是约束的具体内容，要注意上述提到的 <code>output_expr</code>：</p>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-13-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-13-100">100</a></span>
<span class="normal"><a href="#__codelineno-13-101">101</a></span>
<span class="normal"><a href="#__codelineno-13-102">102</a></span>
<span class="normal"><a href="#__codelineno-13-103">103</a></span>
<span class="normal"><a href="#__codelineno-13-104">104</a></span>
<span class="normal"><a href="#__codelineno-13-105">105</a></span>
<span class="normal"><a href="#__codelineno-13-106">106</a></span>
<span class="normal"><a href="#__codelineno-13-107">107</a></span>
<span class="normal"><a href="#__codelineno-13-108">108</a></span>
<span class="normal"><a href="#__codelineno-13-109">109</a></span>
<span class="normal"><a href="#__codelineno-13-110">110</a></span>
<span class="normal"><a href="#__codelineno-13-111">111</a></span>
<span class="normal"><a href="#__codelineno-13-112">112</a></span>
<span class="normal"><a href="#__codelineno-13-113">113</a></span>
<span class="normal"><a href="#__codelineno-13-114">114</a></span>
<span class="normal"><a href="#__codelineno-13-115">115</a></span>
<span class="normal"><a href="#__codelineno-13-116">116</a></span>
<span class="normal"><a href="#__codelineno-13-117">117</a></span>
<span class="normal"><a href="#__codelineno-13-118">118</a></span>
<span class="normal"><a href="#__codelineno-13-119">119</a></span>
<span class="normal"><a href="#__codelineno-13-120">120</a></span>
<span class="normal"><a href="#__codelineno-13-121">121</a></span>
<span class="normal"><a href="#__codelineno-13-122">122</a></span>
<span class="normal"><a href="#__codelineno-13-123">123</a></span>
<span class="normal"><a href="#__codelineno-13-124">124</a></span>
<span class="normal"><a href="#__codelineno-13-125">125</a></span>
<span class="normal"><a href="#__codelineno-13-126">126</a></span>
<span class="normal"><a href="#__codelineno-13-127">127</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-98"><a id="__codelineno-13-98" name="__codelineno-13-98"></a><span class="n">sup_constraint_gen</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">SupervisedConstraint</span><span class="p">(</span>
</span><span id="__span-13-99"><a id="__codelineno-13-99" name="__codelineno-13-99"></a>    <span class="p">{</span>
</span><span id="__span-13-100"><a id="__codelineno-13-100" name="__codelineno-13-100"></a>        <span class="s2">"dataset"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-13-101"><a id="__codelineno-13-101" name="__codelineno-13-101"></a>            <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"NamedArrayDataset"</span><span class="p">,</span>
</span><span id="__span-13-102"><a id="__codelineno-13-102" name="__codelineno-13-102"></a>            <span class="s2">"input"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-13-103"><a id="__codelineno-13-103" name="__codelineno-13-103"></a>                <span class="s2">"density_low"</span><span class="p">:</span> <span class="n">dataset_train</span><span class="p">[</span><span class="s2">"density_low"</span><span class="p">],</span>
</span><span id="__span-13-104"><a id="__codelineno-13-104" name="__codelineno-13-104"></a>                <span class="s2">"density_high"</span><span class="p">:</span> <span class="n">dataset_train</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">],</span>
</span><span id="__span-13-105"><a id="__codelineno-13-105" name="__codelineno-13-105"></a>            <span class="p">},</span>
</span><span id="__span-13-106"><a id="__codelineno-13-106" name="__codelineno-13-106"></a>            <span class="s2">"transforms"</span><span class="p">:</span> <span class="p">(</span>
</span><span id="__span-13-107"><a id="__codelineno-13-107" name="__codelineno-13-107"></a>                <span class="p">{</span>
</span><span id="__span-13-108"><a id="__codelineno-13-108" name="__codelineno-13-108"></a>                    <span class="s2">"FunctionalTransform"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-13-109"><a id="__codelineno-13-109" name="__codelineno-13-109"></a>                        <span class="s2">"transform_func"</span><span class="p">:</span> <span class="n">data_funcs</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
</span><span id="__span-13-110"><a id="__codelineno-13-110" name="__codelineno-13-110"></a>                    <span class="p">},</span>
</span><span id="__span-13-111"><a id="__codelineno-13-111" name="__codelineno-13-111"></a>                <span class="p">},</span>
</span><span id="__span-13-112"><a id="__codelineno-13-112" name="__codelineno-13-112"></a>            <span class="p">),</span>
</span><span id="__span-13-113"><a id="__codelineno-13-113" name="__codelineno-13-113"></a>        <span class="p">},</span>
</span><span id="__span-13-114"><a id="__codelineno-13-114" name="__codelineno-13-114"></a>        <span class="s2">"batch_size"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">batch_size</span><span class="o">.</span><span class="n">sup_constraint</span><span class="p">,</span>
</span><span id="__span-13-115"><a id="__codelineno-13-115" name="__codelineno-13-115"></a>        <span class="s2">"sampler"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-13-116"><a id="__codelineno-13-116" name="__codelineno-13-116"></a>            <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"BatchSampler"</span><span class="p">,</span>
</span><span id="__span-13-117"><a id="__codelineno-13-117" name="__codelineno-13-117"></a>            <span class="s2">"drop_last"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-13-118"><a id="__codelineno-13-118" name="__codelineno-13-118"></a>            <span class="s2">"shuffle"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-13-119"><a id="__codelineno-13-119" name="__codelineno-13-119"></a>        <span class="p">},</span>
</span><span id="__span-13-120"><a id="__codelineno-13-120" name="__codelineno-13-120"></a>    <span class="p">},</span>
</span><span id="__span-13-121"><a id="__codelineno-13-121" name="__codelineno-13-121"></a>    <span class="n">ppsci</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">FunctionalLoss</span><span class="p">(</span><span class="n">gen_funcs</span><span class="o">.</span><span class="n">loss_func_gen</span><span class="p">),</span>
</span><span id="__span-13-122"><a id="__codelineno-13-122" name="__codelineno-13-122"></a>    <span class="p">{</span>
</span><span id="__span-13-123"><a id="__codelineno-13-123" name="__codelineno-13-123"></a>        <span class="s2">"output_gen"</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">out</span><span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="s2">"output_gen"</span><span class="p">],</span>
</span><span id="__span-13-124"><a id="__codelineno-13-124" name="__codelineno-13-124"></a>        <span class="s2">"density_high"</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">out</span><span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">],</span>
</span><span id="__span-13-125"><a id="__codelineno-13-125" name="__codelineno-13-125"></a>    <span class="p">},</span>
</span><span id="__span-13-126"><a id="__codelineno-13-126" name="__codelineno-13-126"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">"sup_constraint_gen"</span><span class="p">,</span>
</span><span id="__span-13-127"><a id="__codelineno-13-127" name="__codelineno-13-127"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p><code>SupervisedConstraint</code> 的第一个参数是监督约束的读取配置，其中 <code>dataset</code> 字段表示使用的训练数据集信息，各个字段分别表示：</p>
<ol>
<li><code>name</code>： 数据集类型，此处 <code>NamedArrayDataset</code> 表示从 Array 中读取的 <code>.mat</code> 类型的数据集；</li>
<li><code>input</code>： Array 类型的输入数据；</li>
<li><code>label</code>： Array 类型的标签数据；</li>
<li><code>transforms</code>： 所有数据 transform 方法，此处 <code>FunctionalTransform</code> 为PaddleScience 预留的自定义数据 transform 类，该类支持编写代码时自定义输入数据的 transform，具体代码请参考 <a href="#38">自定义 loss 和 data transform</a>；</li>
</ol>
<p><code>batch_size</code> 字段表示 batch的大小；</p>
<p><code>sampler</code> 字段表示采样方法，其中各个字段表示：</p>
<ol>
<li><code>name</code>： 采样器类型，此处 <code>BatchSampler</code> 表示批采样器；</li>
<li><code>drop_last</code>： 是否需要丢弃最后无法凑整一个 mini-batch 的样本，默认值为 False；</li>
<li><code>shuffle</code>： 是否需要在生成样本下标时打乱顺序，默认值为 False；</li>
</ol>
<p>第二个参数是损失函数，此处的 <code>FunctionalLoss</code> 为 PaddleScience 预留的自定义 loss 函数类，该类支持编写代码时自定义 loss 的计算方法，而不是使用诸如 <code>MSE</code> 等现有方法，具体代码请参考 <a href="#38">自定义 loss 和 data transform</a>。</p>
<p>第三个参数是约束条件的 <code>output_expr</code>，如上所述，是为了让程序可以将输入数据作为 <code>label</code>。</p>
<p>第四个参数是约束条件的名字，我们需要给每一个约束条件命名，方便后续对其索引。</p>
<p>在约束构建完毕之后，以我们刚才的命名为关键字，封装到一个字典中，方便后续访问，由于本问题设置了<code>use_spatialdisc</code> 和 <code>use_tempodisc</code>，导致 Generator 的部分约束不一定存在，因此先封装一定存在的约束到字典中，当其余约束存在时，在向字典中添加约束元素。</p>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-129">129</a></span>
<span class="normal"><a href="#__codelineno-14-130">130</a></span>
<span class="normal"><a href="#__codelineno-14-131">131</a></span>
<span class="normal"><a href="#__codelineno-14-132">132</a></span>
<span class="normal"><a href="#__codelineno-14-133">133</a></span>
<span class="normal"><a href="#__codelineno-14-134">134</a></span>
<span class="normal"><a href="#__codelineno-14-135">135</a></span>
<span class="normal"><a href="#__codelineno-14-136">136</a></span>
<span class="normal"><a href="#__codelineno-14-137">137</a></span>
<span class="normal"><a href="#__codelineno-14-138">138</a></span>
<span class="normal"><a href="#__codelineno-14-139">139</a></span>
<span class="normal"><a href="#__codelineno-14-140">140</a></span>
<span class="normal"><a href="#__codelineno-14-141">141</a></span>
<span class="normal"><a href="#__codelineno-14-142">142</a></span>
<span class="normal"><a href="#__codelineno-14-143">143</a></span>
<span class="normal"><a href="#__codelineno-14-144">144</a></span>
<span class="normal"><a href="#__codelineno-14-145">145</a></span>
<span class="normal"><a href="#__codelineno-14-146">146</a></span>
<span class="normal"><a href="#__codelineno-14-147">147</a></span>
<span class="normal"><a href="#__codelineno-14-148">148</a></span>
<span class="normal"><a href="#__codelineno-14-149">149</a></span>
<span class="normal"><a href="#__codelineno-14-150">150</a></span>
<span class="normal"><a href="#__codelineno-14-151">151</a></span>
<span class="normal"><a href="#__codelineno-14-152">152</a></span>
<span class="normal"><a href="#__codelineno-14-153">153</a></span>
<span class="normal"><a href="#__codelineno-14-154">154</a></span>
<span class="normal"><a href="#__codelineno-14-155">155</a></span>
<span class="normal"><a href="#__codelineno-14-156">156</a></span>
<span class="normal"><a href="#__codelineno-14-157">157</a></span>
<span class="normal"><a href="#__codelineno-14-158">158</a></span>
<span class="normal"><a href="#__codelineno-14-159">159</a></span>
<span class="normal"><a href="#__codelineno-14-160">160</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-129"><a id="__codelineno-14-129" name="__codelineno-14-129"></a><span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">USE_TEMPODISC</span><span class="p">:</span>
</span><span id="__span-14-130"><a id="__codelineno-14-130" name="__codelineno-14-130"></a>    <span class="n">sup_constraint_gen_tempo</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">SupervisedConstraint</span><span class="p">(</span>
</span><span id="__span-14-131"><a id="__codelineno-14-131" name="__codelineno-14-131"></a>        <span class="p">{</span>
</span><span id="__span-14-132"><a id="__codelineno-14-132" name="__codelineno-14-132"></a>            <span class="s2">"dataset"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-14-133"><a id="__codelineno-14-133" name="__codelineno-14-133"></a>                <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"NamedArrayDataset"</span><span class="p">,</span>
</span><span id="__span-14-134"><a id="__codelineno-14-134" name="__codelineno-14-134"></a>                <span class="s2">"input"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-14-135"><a id="__codelineno-14-135" name="__codelineno-14-135"></a>                    <span class="s2">"density_low"</span><span class="p">:</span> <span class="n">dataset_train</span><span class="p">[</span><span class="s2">"density_low_tempo"</span><span class="p">],</span>
</span><span id="__span-14-136"><a id="__codelineno-14-136" name="__codelineno-14-136"></a>                    <span class="s2">"density_high"</span><span class="p">:</span> <span class="n">dataset_train</span><span class="p">[</span><span class="s2">"density_high_tempo"</span><span class="p">],</span>
</span><span id="__span-14-137"><a id="__codelineno-14-137" name="__codelineno-14-137"></a>                <span class="p">},</span>
</span><span id="__span-14-138"><a id="__codelineno-14-138" name="__codelineno-14-138"></a>                <span class="s2">"transforms"</span><span class="p">:</span> <span class="p">(</span>
</span><span id="__span-14-139"><a id="__codelineno-14-139" name="__codelineno-14-139"></a>                    <span class="p">{</span>
</span><span id="__span-14-140"><a id="__codelineno-14-140" name="__codelineno-14-140"></a>                        <span class="s2">"FunctionalTransform"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-14-141"><a id="__codelineno-14-141" name="__codelineno-14-141"></a>                            <span class="s2">"transform_func"</span><span class="p">:</span> <span class="n">data_funcs</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
</span><span id="__span-14-142"><a id="__codelineno-14-142" name="__codelineno-14-142"></a>                        <span class="p">},</span>
</span><span id="__span-14-143"><a id="__codelineno-14-143" name="__codelineno-14-143"></a>                    <span class="p">},</span>
</span><span id="__span-14-144"><a id="__codelineno-14-144" name="__codelineno-14-144"></a>                <span class="p">),</span>
</span><span id="__span-14-145"><a id="__codelineno-14-145" name="__codelineno-14-145"></a>            <span class="p">},</span>
</span><span id="__span-14-146"><a id="__codelineno-14-146" name="__codelineno-14-146"></a>            <span class="s2">"batch_size"</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">batch_size</span><span class="o">.</span><span class="n">sup_constraint</span> <span class="o">//</span> <span class="mi">3</span><span class="p">),</span>
</span><span id="__span-14-147"><a id="__codelineno-14-147" name="__codelineno-14-147"></a>            <span class="s2">"sampler"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-14-148"><a id="__codelineno-14-148" name="__codelineno-14-148"></a>                <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"BatchSampler"</span><span class="p">,</span>
</span><span id="__span-14-149"><a id="__codelineno-14-149" name="__codelineno-14-149"></a>                <span class="s2">"drop_last"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-14-150"><a id="__codelineno-14-150" name="__codelineno-14-150"></a>                <span class="s2">"shuffle"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-14-151"><a id="__codelineno-14-151" name="__codelineno-14-151"></a>            <span class="p">},</span>
</span><span id="__span-14-152"><a id="__codelineno-14-152" name="__codelineno-14-152"></a>        <span class="p">},</span>
</span><span id="__span-14-153"><a id="__codelineno-14-153" name="__codelineno-14-153"></a>        <span class="n">ppsci</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">FunctionalLoss</span><span class="p">(</span><span class="n">gen_funcs</span><span class="o">.</span><span class="n">loss_func_gen_tempo</span><span class="p">),</span>
</span><span id="__span-14-154"><a id="__codelineno-14-154" name="__codelineno-14-154"></a>        <span class="p">{</span>
</span><span id="__span-14-155"><a id="__codelineno-14-155" name="__codelineno-14-155"></a>            <span class="s2">"output_gen"</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">out</span><span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="s2">"output_gen"</span><span class="p">],</span>
</span><span id="__span-14-156"><a id="__codelineno-14-156" name="__codelineno-14-156"></a>            <span class="s2">"density_high"</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">out</span><span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">],</span>
</span><span id="__span-14-157"><a id="__codelineno-14-157" name="__codelineno-14-157"></a>        <span class="p">},</span>
</span><span id="__span-14-158"><a id="__codelineno-14-158" name="__codelineno-14-158"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">"sup_constraint_gen_tempo"</span><span class="p">,</span>
</span><span id="__span-14-159"><a id="__codelineno-14-159" name="__codelineno-14-159"></a>    <span class="p">)</span>
</span><span id="__span-14-160"><a id="__codelineno-14-160" name="__codelineno-14-160"></a>    <span class="n">constraint_gen</span><span class="p">[</span><span class="n">sup_constraint_gen_tempo</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sup_constraint_gen_tempo</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="362-discriminator">3.6.2 Discriminator 的约束<a class="headerlink" href="#362-discriminator" title="Permanent link">¶</a></h4>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-164">164</a></span>
<span class="normal"><a href="#__codelineno-15-165">165</a></span>
<span class="normal"><a href="#__codelineno-15-166">166</a></span>
<span class="normal"><a href="#__codelineno-15-167">167</a></span>
<span class="normal"><a href="#__codelineno-15-168">168</a></span>
<span class="normal"><a href="#__codelineno-15-169">169</a></span>
<span class="normal"><a href="#__codelineno-15-170">170</a></span>
<span class="normal"><a href="#__codelineno-15-171">171</a></span>
<span class="normal"><a href="#__codelineno-15-172">172</a></span>
<span class="normal"><a href="#__codelineno-15-173">173</a></span>
<span class="normal"><a href="#__codelineno-15-174">174</a></span>
<span class="normal"><a href="#__codelineno-15-175">175</a></span>
<span class="normal"><a href="#__codelineno-15-176">176</a></span>
<span class="normal"><a href="#__codelineno-15-177">177</a></span>
<span class="normal"><a href="#__codelineno-15-178">178</a></span>
<span class="normal"><a href="#__codelineno-15-179">179</a></span>
<span class="normal"><a href="#__codelineno-15-180">180</a></span>
<span class="normal"><a href="#__codelineno-15-181">181</a></span>
<span class="normal"><a href="#__codelineno-15-182">182</a></span>
<span class="normal"><a href="#__codelineno-15-183">183</a></span>
<span class="normal"><a href="#__codelineno-15-184">184</a></span>
<span class="normal"><a href="#__codelineno-15-185">185</a></span>
<span class="normal"><a href="#__codelineno-15-186">186</a></span>
<span class="normal"><a href="#__codelineno-15-187">187</a></span>
<span class="normal"><a href="#__codelineno-15-188">188</a></span>
<span class="normal"><a href="#__codelineno-15-189">189</a></span>
<span class="normal"><a href="#__codelineno-15-190">190</a></span>
<span class="normal"><a href="#__codelineno-15-191">191</a></span>
<span class="normal"><a href="#__codelineno-15-192">192</a></span>
<span class="normal"><a href="#__codelineno-15-193">193</a></span>
<span class="normal"><a href="#__codelineno-15-194">194</a></span>
<span class="normal"><a href="#__codelineno-15-195">195</a></span>
<span class="normal"><a href="#__codelineno-15-196">196</a></span>
<span class="normal"><a href="#__codelineno-15-197">197</a></span>
<span class="normal"><a href="#__codelineno-15-198">198</a></span>
<span class="normal"><a href="#__codelineno-15-199">199</a></span>
<span class="normal"><a href="#__codelineno-15-200">200</a></span>
<span class="normal"><a href="#__codelineno-15-201">201</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-164"><a id="__codelineno-15-164" name="__codelineno-15-164"></a><span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">USE_SPATIALDISC</span><span class="p">:</span>
</span><span id="__span-15-165"><a id="__codelineno-15-165" name="__codelineno-15-165"></a>    <span class="n">sup_constraint_disc</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">SupervisedConstraint</span><span class="p">(</span>
</span><span id="__span-15-166"><a id="__codelineno-15-166" name="__codelineno-15-166"></a>        <span class="p">{</span>
</span><span id="__span-15-167"><a id="__codelineno-15-167" name="__codelineno-15-167"></a>            <span class="s2">"dataset"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-15-168"><a id="__codelineno-15-168" name="__codelineno-15-168"></a>                <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"NamedArrayDataset"</span><span class="p">,</span>
</span><span id="__span-15-169"><a id="__codelineno-15-169" name="__codelineno-15-169"></a>                <span class="s2">"input"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-15-170"><a id="__codelineno-15-170" name="__codelineno-15-170"></a>                    <span class="s2">"density_low"</span><span class="p">:</span> <span class="n">dataset_train</span><span class="p">[</span><span class="s2">"density_low"</span><span class="p">],</span>
</span><span id="__span-15-171"><a id="__codelineno-15-171" name="__codelineno-15-171"></a>                    <span class="s2">"density_high"</span><span class="p">:</span> <span class="n">dataset_train</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">],</span>
</span><span id="__span-15-172"><a id="__codelineno-15-172" name="__codelineno-15-172"></a>                <span class="p">},</span>
</span><span id="__span-15-173"><a id="__codelineno-15-173" name="__codelineno-15-173"></a>                <span class="s2">"label"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-15-174"><a id="__codelineno-15-174" name="__codelineno-15-174"></a>                    <span class="s2">"out_disc_from_target"</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="__span-15-175"><a id="__codelineno-15-175" name="__codelineno-15-175"></a>                        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dataset_train</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="__span-15-176"><a id="__codelineno-15-176" name="__codelineno-15-176"></a>                        <span class="n">dtype</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">get_default_dtype</span><span class="p">(),</span>
</span><span id="__span-15-177"><a id="__codelineno-15-177" name="__codelineno-15-177"></a>                    <span class="p">),</span>
</span><span id="__span-15-178"><a id="__codelineno-15-178" name="__codelineno-15-178"></a>                    <span class="s2">"out_disc_from_gen"</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="__span-15-179"><a id="__codelineno-15-179" name="__codelineno-15-179"></a>                        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dataset_train</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="__span-15-180"><a id="__codelineno-15-180" name="__codelineno-15-180"></a>                        <span class="n">dtype</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">get_default_dtype</span><span class="p">(),</span>
</span><span id="__span-15-181"><a id="__codelineno-15-181" name="__codelineno-15-181"></a>                    <span class="p">),</span>
</span><span id="__span-15-182"><a id="__codelineno-15-182" name="__codelineno-15-182"></a>                <span class="p">},</span>
</span><span id="__span-15-183"><a id="__codelineno-15-183" name="__codelineno-15-183"></a>                <span class="s2">"transforms"</span><span class="p">:</span> <span class="p">(</span>
</span><span id="__span-15-184"><a id="__codelineno-15-184" name="__codelineno-15-184"></a>                    <span class="p">{</span>
</span><span id="__span-15-185"><a id="__codelineno-15-185" name="__codelineno-15-185"></a>                        <span class="s2">"FunctionalTransform"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-15-186"><a id="__codelineno-15-186" name="__codelineno-15-186"></a>                            <span class="s2">"transform_func"</span><span class="p">:</span> <span class="n">data_funcs</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
</span><span id="__span-15-187"><a id="__codelineno-15-187" name="__codelineno-15-187"></a>                        <span class="p">},</span>
</span><span id="__span-15-188"><a id="__codelineno-15-188" name="__codelineno-15-188"></a>                    <span class="p">},</span>
</span><span id="__span-15-189"><a id="__codelineno-15-189" name="__codelineno-15-189"></a>                <span class="p">),</span>
</span><span id="__span-15-190"><a id="__codelineno-15-190" name="__codelineno-15-190"></a>            <span class="p">},</span>
</span><span id="__span-15-191"><a id="__codelineno-15-191" name="__codelineno-15-191"></a>            <span class="s2">"batch_size"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">batch_size</span><span class="o">.</span><span class="n">sup_constraint</span><span class="p">,</span>
</span><span id="__span-15-192"><a id="__codelineno-15-192" name="__codelineno-15-192"></a>            <span class="s2">"sampler"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-15-193"><a id="__codelineno-15-193" name="__codelineno-15-193"></a>                <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"BatchSampler"</span><span class="p">,</span>
</span><span id="__span-15-194"><a id="__codelineno-15-194" name="__codelineno-15-194"></a>                <span class="s2">"drop_last"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-15-195"><a id="__codelineno-15-195" name="__codelineno-15-195"></a>                <span class="s2">"shuffle"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-15-196"><a id="__codelineno-15-196" name="__codelineno-15-196"></a>            <span class="p">},</span>
</span><span id="__span-15-197"><a id="__codelineno-15-197" name="__codelineno-15-197"></a>        <span class="p">},</span>
</span><span id="__span-15-198"><a id="__codelineno-15-198" name="__codelineno-15-198"></a>        <span class="n">ppsci</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">FunctionalLoss</span><span class="p">(</span><span class="n">disc_funcs</span><span class="o">.</span><span class="n">loss_func</span><span class="p">),</span>
</span><span id="__span-15-199"><a id="__codelineno-15-199" name="__codelineno-15-199"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">"sup_constraint_disc"</span><span class="p">,</span>
</span><span id="__span-15-200"><a id="__codelineno-15-200" name="__codelineno-15-200"></a>    <span class="p">)</span>
</span><span id="__span-15-201"><a id="__codelineno-15-201" name="__codelineno-15-201"></a>    <span class="n">constraint_disc</span> <span class="o">=</span> <span class="p">{</span><span class="n">sup_constraint_disc</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">sup_constraint_disc</span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>各个参数含义与<a href="#361">Generator 的约束</a>相同。</p>
<h4 id="363-discriminator_tempo">3.6.3 Discriminator_tempo 的约束<a class="headerlink" href="#363-discriminator_tempo" title="Permanent link">¶</a></h4>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-205">205</a></span>
<span class="normal"><a href="#__codelineno-16-206">206</a></span>
<span class="normal"><a href="#__codelineno-16-207">207</a></span>
<span class="normal"><a href="#__codelineno-16-208">208</a></span>
<span class="normal"><a href="#__codelineno-16-209">209</a></span>
<span class="normal"><a href="#__codelineno-16-210">210</a></span>
<span class="normal"><a href="#__codelineno-16-211">211</a></span>
<span class="normal"><a href="#__codelineno-16-212">212</a></span>
<span class="normal"><a href="#__codelineno-16-213">213</a></span>
<span class="normal"><a href="#__codelineno-16-214">214</a></span>
<span class="normal"><a href="#__codelineno-16-215">215</a></span>
<span class="normal"><a href="#__codelineno-16-216">216</a></span>
<span class="normal"><a href="#__codelineno-16-217">217</a></span>
<span class="normal"><a href="#__codelineno-16-218">218</a></span>
<span class="normal"><a href="#__codelineno-16-219">219</a></span>
<span class="normal"><a href="#__codelineno-16-220">220</a></span>
<span class="normal"><a href="#__codelineno-16-221">221</a></span>
<span class="normal"><a href="#__codelineno-16-222">222</a></span>
<span class="normal"><a href="#__codelineno-16-223">223</a></span>
<span class="normal"><a href="#__codelineno-16-224">224</a></span>
<span class="normal"><a href="#__codelineno-16-225">225</a></span>
<span class="normal"><a href="#__codelineno-16-226">226</a></span>
<span class="normal"><a href="#__codelineno-16-227">227</a></span>
<span class="normal"><a href="#__codelineno-16-228">228</a></span>
<span class="normal"><a href="#__codelineno-16-229">229</a></span>
<span class="normal"><a href="#__codelineno-16-230">230</a></span>
<span class="normal"><a href="#__codelineno-16-231">231</a></span>
<span class="normal"><a href="#__codelineno-16-232">232</a></span>
<span class="normal"><a href="#__codelineno-16-233">233</a></span>
<span class="normal"><a href="#__codelineno-16-234">234</a></span>
<span class="normal"><a href="#__codelineno-16-235">235</a></span>
<span class="normal"><a href="#__codelineno-16-236">236</a></span>
<span class="normal"><a href="#__codelineno-16-237">237</a></span>
<span class="normal"><a href="#__codelineno-16-238">238</a></span>
<span class="normal"><a href="#__codelineno-16-239">239</a></span>
<span class="normal"><a href="#__codelineno-16-240">240</a></span>
<span class="normal"><a href="#__codelineno-16-241">241</a></span>
<span class="normal"><a href="#__codelineno-16-242">242</a></span>
<span class="normal"><a href="#__codelineno-16-243">243</a></span>
<span class="normal"><a href="#__codelineno-16-244">244</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-205"><a id="__codelineno-16-205" name="__codelineno-16-205"></a><span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">USE_TEMPODISC</span><span class="p">:</span>
</span><span id="__span-16-206"><a id="__codelineno-16-206" name="__codelineno-16-206"></a>    <span class="n">sup_constraint_disc_tempo</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">SupervisedConstraint</span><span class="p">(</span>
</span><span id="__span-16-207"><a id="__codelineno-16-207" name="__codelineno-16-207"></a>        <span class="p">{</span>
</span><span id="__span-16-208"><a id="__codelineno-16-208" name="__codelineno-16-208"></a>            <span class="s2">"dataset"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-16-209"><a id="__codelineno-16-209" name="__codelineno-16-209"></a>                <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"NamedArrayDataset"</span><span class="p">,</span>
</span><span id="__span-16-210"><a id="__codelineno-16-210" name="__codelineno-16-210"></a>                <span class="s2">"input"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-16-211"><a id="__codelineno-16-211" name="__codelineno-16-211"></a>                    <span class="s2">"density_low"</span><span class="p">:</span> <span class="n">dataset_train</span><span class="p">[</span><span class="s2">"density_low_tempo"</span><span class="p">],</span>
</span><span id="__span-16-212"><a id="__codelineno-16-212" name="__codelineno-16-212"></a>                    <span class="s2">"density_high"</span><span class="p">:</span> <span class="n">dataset_train</span><span class="p">[</span><span class="s2">"density_high_tempo"</span><span class="p">],</span>
</span><span id="__span-16-213"><a id="__codelineno-16-213" name="__codelineno-16-213"></a>                <span class="p">},</span>
</span><span id="__span-16-214"><a id="__codelineno-16-214" name="__codelineno-16-214"></a>                <span class="s2">"label"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-16-215"><a id="__codelineno-16-215" name="__codelineno-16-215"></a>                    <span class="s2">"out_disc_tempo_from_target"</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="__span-16-216"><a id="__codelineno-16-216" name="__codelineno-16-216"></a>                        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dataset_train</span><span class="p">[</span><span class="s2">"density_high_tempo"</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="__span-16-217"><a id="__codelineno-16-217" name="__codelineno-16-217"></a>                        <span class="n">dtype</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">get_default_dtype</span><span class="p">(),</span>
</span><span id="__span-16-218"><a id="__codelineno-16-218" name="__codelineno-16-218"></a>                    <span class="p">),</span>
</span><span id="__span-16-219"><a id="__codelineno-16-219" name="__codelineno-16-219"></a>                    <span class="s2">"out_disc_tempo_from_gen"</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="__span-16-220"><a id="__codelineno-16-220" name="__codelineno-16-220"></a>                        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dataset_train</span><span class="p">[</span><span class="s2">"density_high_tempo"</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="__span-16-221"><a id="__codelineno-16-221" name="__codelineno-16-221"></a>                        <span class="n">dtype</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">get_default_dtype</span><span class="p">(),</span>
</span><span id="__span-16-222"><a id="__codelineno-16-222" name="__codelineno-16-222"></a>                    <span class="p">),</span>
</span><span id="__span-16-223"><a id="__codelineno-16-223" name="__codelineno-16-223"></a>                <span class="p">},</span>
</span><span id="__span-16-224"><a id="__codelineno-16-224" name="__codelineno-16-224"></a>                <span class="s2">"transforms"</span><span class="p">:</span> <span class="p">(</span>
</span><span id="__span-16-225"><a id="__codelineno-16-225" name="__codelineno-16-225"></a>                    <span class="p">{</span>
</span><span id="__span-16-226"><a id="__codelineno-16-226" name="__codelineno-16-226"></a>                        <span class="s2">"FunctionalTransform"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-16-227"><a id="__codelineno-16-227" name="__codelineno-16-227"></a>                            <span class="s2">"transform_func"</span><span class="p">:</span> <span class="n">data_funcs</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
</span><span id="__span-16-228"><a id="__codelineno-16-228" name="__codelineno-16-228"></a>                        <span class="p">},</span>
</span><span id="__span-16-229"><a id="__codelineno-16-229" name="__codelineno-16-229"></a>                    <span class="p">},</span>
</span><span id="__span-16-230"><a id="__codelineno-16-230" name="__codelineno-16-230"></a>                <span class="p">),</span>
</span><span id="__span-16-231"><a id="__codelineno-16-231" name="__codelineno-16-231"></a>            <span class="p">},</span>
</span><span id="__span-16-232"><a id="__codelineno-16-232" name="__codelineno-16-232"></a>            <span class="s2">"batch_size"</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">batch_size</span><span class="o">.</span><span class="n">sup_constraint</span> <span class="o">//</span> <span class="mi">3</span><span class="p">),</span>
</span><span id="__span-16-233"><a id="__codelineno-16-233" name="__codelineno-16-233"></a>            <span class="s2">"sampler"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-16-234"><a id="__codelineno-16-234" name="__codelineno-16-234"></a>                <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"BatchSampler"</span><span class="p">,</span>
</span><span id="__span-16-235"><a id="__codelineno-16-235" name="__codelineno-16-235"></a>                <span class="s2">"drop_last"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-16-236"><a id="__codelineno-16-236" name="__codelineno-16-236"></a>                <span class="s2">"shuffle"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-16-237"><a id="__codelineno-16-237" name="__codelineno-16-237"></a>            <span class="p">},</span>
</span><span id="__span-16-238"><a id="__codelineno-16-238" name="__codelineno-16-238"></a>        <span class="p">},</span>
</span><span id="__span-16-239"><a id="__codelineno-16-239" name="__codelineno-16-239"></a>        <span class="n">ppsci</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">FunctionalLoss</span><span class="p">(</span><span class="n">disc_funcs</span><span class="o">.</span><span class="n">loss_func_tempo</span><span class="p">),</span>
</span><span id="__span-16-240"><a id="__codelineno-16-240" name="__codelineno-16-240"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">"sup_constraint_disc_tempo"</span><span class="p">,</span>
</span><span id="__span-16-241"><a id="__codelineno-16-241" name="__codelineno-16-241"></a>    <span class="p">)</span>
</span><span id="__span-16-242"><a id="__codelineno-16-242" name="__codelineno-16-242"></a>    <span class="n">constraint_disc_tempo</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-16-243"><a id="__codelineno-16-243" name="__codelineno-16-243"></a>        <span class="n">sup_constraint_disc_tempo</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">sup_constraint_disc_tempo</span>
</span><span id="__span-16-244"><a id="__codelineno-16-244" name="__codelineno-16-244"></a>    <span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>各个参数含义与<a href="#361">Generator 的约束</a>相同。</p>
<h3 id="37">3.7 可视化器构建<a class="headerlink" href="#37" title="Permanent link">¶</a></h3>
<p>因为 GAN 网络训练的特性，本问题不使用 PaddleScience 中内置的可视化器，而是自定义了一个用于实现推理的函数，该函数读取验证集数据，得到推理结果并将结果以图片形式保存下来，在训练过程中按照一定间隔调用该函数即可在训练过程中监控训练效果。</p>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-153">153</a></span>
<span class="normal"><a href="#__codelineno-17-154">154</a></span>
<span class="normal"><a href="#__codelineno-17-155">155</a></span>
<span class="normal"><a href="#__codelineno-17-156">156</a></span>
<span class="normal"><a href="#__codelineno-17-157">157</a></span>
<span class="normal"><a href="#__codelineno-17-158">158</a></span>
<span class="normal"><a href="#__codelineno-17-159">159</a></span>
<span class="normal"><a href="#__codelineno-17-160">160</a></span>
<span class="normal"><a href="#__codelineno-17-161">161</a></span>
<span class="normal"><a href="#__codelineno-17-162">162</a></span>
<span class="normal"><a href="#__codelineno-17-163">163</a></span>
<span class="normal"><a href="#__codelineno-17-164">164</a></span>
<span class="normal"><a href="#__codelineno-17-165">165</a></span>
<span class="normal"><a href="#__codelineno-17-166">166</a></span>
<span class="normal"><a href="#__codelineno-17-167">167</a></span>
<span class="normal"><a href="#__codelineno-17-168">168</a></span>
<span class="normal"><a href="#__codelineno-17-169">169</a></span>
<span class="normal"><a href="#__codelineno-17-170">170</a></span>
<span class="normal"><a href="#__codelineno-17-171">171</a></span>
<span class="normal"><a href="#__codelineno-17-172">172</a></span>
<span class="normal"><a href="#__codelineno-17-173">173</a></span>
<span class="normal"><a href="#__codelineno-17-174">174</a></span>
<span class="normal"><a href="#__codelineno-17-175">175</a></span>
<span class="normal"><a href="#__codelineno-17-176">176</a></span>
<span class="normal"><a href="#__codelineno-17-177">177</a></span>
<span class="normal"><a href="#__codelineno-17-178">178</a></span>
<span class="normal"><a href="#__codelineno-17-179">179</a></span>
<span class="normal"><a href="#__codelineno-17-180">180</a></span>
<span class="normal"><a href="#__codelineno-17-181">181</a></span>
<span class="normal"><a href="#__codelineno-17-182">182</a></span>
<span class="normal"><a href="#__codelineno-17-183">183</a></span>
<span class="normal"><a href="#__codelineno-17-184">184</a></span>
<span class="normal"><a href="#__codelineno-17-185">185</a></span>
<span class="normal"><a href="#__codelineno-17-186">186</a></span>
<span class="normal"><a href="#__codelineno-17-187">187</a></span>
<span class="normal"><a href="#__codelineno-17-188">188</a></span>
<span class="normal"><a href="#__codelineno-17-189">189</a></span>
<span class="normal"><a href="#__codelineno-17-190">190</a></span>
<span class="normal"><a href="#__codelineno-17-191">191</a></span>
<span class="normal"><a href="#__codelineno-17-192">192</a></span>
<span class="normal"><a href="#__codelineno-17-193">193</a></span>
<span class="normal"><a href="#__codelineno-17-194">194</a></span>
<span class="normal"><a href="#__codelineno-17-195">195</a></span>
<span class="normal"><a href="#__codelineno-17-196">196</a></span>
<span class="normal"><a href="#__codelineno-17-197">197</a></span>
<span class="normal"><a href="#__codelineno-17-198">198</a></span>
<span class="normal"><a href="#__codelineno-17-199">199</a></span>
<span class="normal"><a href="#__codelineno-17-200">200</a></span>
<span class="normal"><a href="#__codelineno-17-201">201</a></span>
<span class="normal"><a href="#__codelineno-17-202">202</a></span>
<span class="normal"><a href="#__codelineno-17-203">203</a></span>
<span class="normal"><a href="#__codelineno-17-204">204</a></span>
<span class="normal"><a href="#__codelineno-17-205">205</a></span>
<span class="normal"><a href="#__codelineno-17-206">206</a></span>
<span class="normal"><a href="#__codelineno-17-207">207</a></span>
<span class="normal"><a href="#__codelineno-17-208">208</a></span>
<span class="normal"><a href="#__codelineno-17-209">209</a></span>
<span class="normal"><a href="#__codelineno-17-210">210</a></span>
<span class="normal"><a href="#__codelineno-17-211">211</a></span>
<span class="normal"><a href="#__codelineno-17-212">212</a></span>
<span class="normal"><a href="#__codelineno-17-213">213</a></span>
<span class="normal"><a href="#__codelineno-17-214">214</a></span>
<span class="normal"><a href="#__codelineno-17-215">215</a></span>
<span class="normal"><a href="#__codelineno-17-216">216</a></span>
<span class="normal"><a href="#__codelineno-17-217">217</a></span>
<span class="normal"><a href="#__codelineno-17-218">218</a></span>
<span class="normal"><a href="#__codelineno-17-219">219</a></span>
<span class="normal"><a href="#__codelineno-17-220">220</a></span>
<span class="normal"><a href="#__codelineno-17-221">221</a></span>
<span class="normal"><a href="#__codelineno-17-222">222</a></span>
<span class="normal"><a href="#__codelineno-17-223">223</a></span>
<span class="normal"><a href="#__codelineno-17-224">224</a></span>
<span class="normal"><a href="#__codelineno-17-225">225</a></span>
<span class="normal"><a href="#__codelineno-17-226">226</a></span>
<span class="normal"><a href="#__codelineno-17-227">227</a></span>
<span class="normal"><a href="#__codelineno-17-228">228</a></span>
<span class="normal"><a href="#__codelineno-17-229">229</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-153"><a id="__codelineno-17-153" name="__codelineno-17-153"></a><span class="k">def</span> <span class="nf">predict_and_save_plot</span><span class="p">(</span>
</span><span id="__span-17-154"><a id="__codelineno-17-154" name="__codelineno-17-154"></a>    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-17-155"><a id="__codelineno-17-155" name="__codelineno-17-155"></a>    <span class="n">epoch_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="__span-17-156"><a id="__codelineno-17-156" name="__codelineno-17-156"></a>    <span class="n">solver_gen</span><span class="p">:</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">Solver</span><span class="p">,</span>
</span><span id="__span-17-157"><a id="__codelineno-17-157" name="__codelineno-17-157"></a>    <span class="n">dataset_valid</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="__span-17-158"><a id="__codelineno-17-158" name="__codelineno-17-158"></a>    <span class="n">tile_ratio</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-17-159"><a id="__codelineno-17-159" name="__codelineno-17-159"></a><span class="p">):</span>
</span><span id="__span-17-160"><a id="__codelineno-17-160" name="__codelineno-17-160"></a><span class="w">    </span><span class="sd">"""Predicting and plotting.</span>
</span><span id="__span-17-161"><a id="__codelineno-17-161" name="__codelineno-17-161"></a>
</span><span id="__span-17-162"><a id="__codelineno-17-162" name="__codelineno-17-162"></a><span class="sd">    Args:</span>
</span><span id="__span-17-163"><a id="__codelineno-17-163" name="__codelineno-17-163"></a><span class="sd">        output_dir (str): Output dir path.</span>
</span><span id="__span-17-164"><a id="__codelineno-17-164" name="__codelineno-17-164"></a><span class="sd">        epoch_id (int): Which epoch it is.</span>
</span><span id="__span-17-165"><a id="__codelineno-17-165" name="__codelineno-17-165"></a><span class="sd">        solver_gen (ppsci.solver.Solver): Solver for predicting.</span>
</span><span id="__span-17-166"><a id="__codelineno-17-166" name="__codelineno-17-166"></a><span class="sd">        dataset_valid (np.ndarray): Valid dataset.</span>
</span><span id="__span-17-167"><a id="__codelineno-17-167" name="__codelineno-17-167"></a><span class="sd">        tile_ratio (int, optional): How many tiles of one dim. Defaults to 1.</span>
</span><span id="__span-17-168"><a id="__codelineno-17-168" name="__codelineno-17-168"></a><span class="sd">    """</span>
</span><span id="__span-17-169"><a id="__codelineno-17-169" name="__codelineno-17-169"></a>    <span class="n">dir_pred</span> <span class="o">=</span> <span class="s2">"predict/"</span>
</span><span id="__span-17-170"><a id="__codelineno-17-170" name="__codelineno-17-170"></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">dir_pred</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-17-171"><a id="__codelineno-17-171" name="__codelineno-17-171"></a>
</span><span id="__span-17-172"><a id="__codelineno-17-172" name="__codelineno-17-172"></a>    <span class="n">start_idx</span> <span class="o">=</span> <span class="mi">190</span>
</span><span id="__span-17-173"><a id="__codelineno-17-173" name="__codelineno-17-173"></a>    <span class="n">density_low</span> <span class="o">=</span> <span class="n">dataset_valid</span><span class="p">[</span><span class="s2">"density_low"</span><span class="p">][</span><span class="n">start_idx</span> <span class="p">:</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="__span-17-174"><a id="__codelineno-17-174" name="__codelineno-17-174"></a>    <span class="n">density_high</span> <span class="o">=</span> <span class="n">dataset_valid</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">][</span><span class="n">start_idx</span> <span class="p">:</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="__span-17-175"><a id="__codelineno-17-175" name="__codelineno-17-175"></a>
</span><span id="__span-17-176"><a id="__codelineno-17-176" name="__codelineno-17-176"></a>    <span class="c1"># tile</span>
</span><span id="__span-17-177"><a id="__codelineno-17-177" name="__codelineno-17-177"></a>    <span class="n">density_low</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-17-178"><a id="__codelineno-17-178" name="__codelineno-17-178"></a>        <span class="n">split_data</span><span class="p">(</span><span class="n">density_low</span><span class="p">,</span> <span class="n">tile_ratio</span><span class="p">)</span> <span class="k">if</span> <span class="n">tile_ratio</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">density_low</span>
</span><span id="__span-17-179"><a id="__codelineno-17-179" name="__codelineno-17-179"></a>    <span class="p">)</span>
</span><span id="__span-17-180"><a id="__codelineno-17-180" name="__codelineno-17-180"></a>    <span class="n">density_high</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-17-181"><a id="__codelineno-17-181" name="__codelineno-17-181"></a>        <span class="n">split_data</span><span class="p">(</span><span class="n">density_high</span><span class="p">,</span> <span class="n">tile_ratio</span><span class="p">)</span> <span class="k">if</span> <span class="n">tile_ratio</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">density_high</span>
</span><span id="__span-17-182"><a id="__codelineno-17-182" name="__codelineno-17-182"></a>    <span class="p">)</span>
</span><span id="__span-17-183"><a id="__codelineno-17-183" name="__codelineno-17-183"></a>
</span><span id="__span-17-184"><a id="__codelineno-17-184" name="__codelineno-17-184"></a>    <span class="n">pred_dict</span> <span class="o">=</span> <span class="n">solver_gen</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
</span><span id="__span-17-185"><a id="__codelineno-17-185" name="__codelineno-17-185"></a>        <span class="p">{</span>
</span><span id="__span-17-186"><a id="__codelineno-17-186" name="__codelineno-17-186"></a>            <span class="s2">"density_low"</span><span class="p">:</span> <span class="n">density_low</span><span class="p">,</span>
</span><span id="__span-17-187"><a id="__codelineno-17-187" name="__codelineno-17-187"></a>            <span class="s2">"density_high"</span><span class="p">:</span> <span class="n">density_high</span><span class="p">,</span>
</span><span id="__span-17-188"><a id="__codelineno-17-188" name="__codelineno-17-188"></a>        <span class="p">},</span>
</span><span id="__span-17-189"><a id="__codelineno-17-189" name="__codelineno-17-189"></a>        <span class="p">{</span><span class="s2">"density_high"</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">out</span><span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="s2">"output_gen"</span><span class="p">]},</span>
</span><span id="__span-17-190"><a id="__codelineno-17-190" name="__codelineno-17-190"></a>        <span class="n">batch_size</span><span class="o">=</span><span class="n">tile_ratio</span> <span class="o">*</span> <span class="n">tile_ratio</span> <span class="k">if</span> <span class="n">tile_ratio</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="__span-17-191"><a id="__codelineno-17-191" name="__codelineno-17-191"></a>        <span class="n">no_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-17-192"><a id="__codelineno-17-192" name="__codelineno-17-192"></a>    <span class="p">)</span>
</span><span id="__span-17-193"><a id="__codelineno-17-193" name="__codelineno-17-193"></a>    <span class="k">if</span> <span class="n">epoch_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="__span-17-194"><a id="__codelineno-17-194" name="__codelineno-17-194"></a>        <span class="c1"># plot interpolated input image</span>
</span><span id="__span-17-195"><a id="__codelineno-17-195" name="__codelineno-17-195"></a>        <span class="n">input_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">dataset_valid</span><span class="p">[</span><span class="s2">"density_low"</span><span class="p">][</span><span class="n">start_idx</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-17-196"><a id="__codelineno-17-196" name="__codelineno-17-196"></a>        <span class="n">input_img</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">input_img</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">get_default_dtype</span><span class="p">())</span>
</span><span id="__span-17-197"><a id="__codelineno-17-197" name="__codelineno-17-197"></a>        <span class="n">input_img</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
</span><span id="__span-17-198"><a id="__codelineno-17-198" name="__codelineno-17-198"></a>            <span class="n">input_img</span><span class="p">,</span>
</span><span id="__span-17-199"><a id="__codelineno-17-199" name="__codelineno-17-199"></a>            <span class="p">[</span><span class="n">input_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">input_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">],</span>
</span><span id="__span-17-200"><a id="__codelineno-17-200" name="__codelineno-17-200"></a>            <span class="n">mode</span><span class="o">=</span><span class="s2">"nearest"</span><span class="p">,</span>
</span><span id="__span-17-201"><a id="__codelineno-17-201" name="__codelineno-17-201"></a>        <span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="__span-17-202"><a id="__codelineno-17-202" name="__codelineno-17-202"></a>        <span class="n">Img</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span>
</span><span id="__span-17-203"><a id="__codelineno-17-203" name="__codelineno-17-203"></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">dir_pred</span><span class="p">,</span> <span class="s2">"input.png"</span><span class="p">),</span>
</span><span id="__span-17-204"><a id="__codelineno-17-204" name="__codelineno-17-204"></a>            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">input_img</span><span class="p">),</span>
</span><span id="__span-17-205"><a id="__codelineno-17-205" name="__codelineno-17-205"></a>            <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="__span-17-206"><a id="__codelineno-17-206" name="__codelineno-17-206"></a>            <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="__span-17-207"><a id="__codelineno-17-207" name="__codelineno-17-207"></a>            <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span>
</span><span id="__span-17-208"><a id="__codelineno-17-208" name="__codelineno-17-208"></a>        <span class="p">)</span>
</span><span id="__span-17-209"><a id="__codelineno-17-209" name="__codelineno-17-209"></a>        <span class="c1"># plot target image</span>
</span><span id="__span-17-210"><a id="__codelineno-17-210" name="__codelineno-17-210"></a>        <span class="n">Img</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span>
</span><span id="__span-17-211"><a id="__codelineno-17-211" name="__codelineno-17-211"></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">dir_pred</span><span class="p">,</span> <span class="s2">"target.png"</span><span class="p">),</span>
</span><span id="__span-17-212"><a id="__codelineno-17-212" name="__codelineno-17-212"></a>            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dataset_valid</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">][</span><span class="n">start_idx</span><span class="p">]),</span>
</span><span id="__span-17-213"><a id="__codelineno-17-213" name="__codelineno-17-213"></a>            <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="__span-17-214"><a id="__codelineno-17-214" name="__codelineno-17-214"></a>            <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="__span-17-215"><a id="__codelineno-17-215" name="__codelineno-17-215"></a>            <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span>
</span><span id="__span-17-216"><a id="__codelineno-17-216" name="__codelineno-17-216"></a>        <span class="p">)</span>
</span><span id="__span-17-217"><a id="__codelineno-17-217" name="__codelineno-17-217"></a>    <span class="c1"># plot pred image</span>
</span><span id="__span-17-218"><a id="__codelineno-17-218" name="__codelineno-17-218"></a>    <span class="n">pred_img</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-17-219"><a id="__codelineno-17-219" name="__codelineno-17-219"></a>        <span class="n">concat_data</span><span class="p">(</span><span class="n">pred_dict</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">tile_ratio</span><span class="p">)</span>
</span><span id="__span-17-220"><a id="__codelineno-17-220" name="__codelineno-17-220"></a>        <span class="k">if</span> <span class="n">tile_ratio</span> <span class="o">!=</span> <span class="mi">1</span>
</span><span id="__span-17-221"><a id="__codelineno-17-221" name="__codelineno-17-221"></a>        <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">pred_dict</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</span><span id="__span-17-222"><a id="__codelineno-17-222" name="__codelineno-17-222"></a>    <span class="p">)</span>
</span><span id="__span-17-223"><a id="__codelineno-17-223" name="__codelineno-17-223"></a>    <span class="n">Img</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span>
</span><span id="__span-17-224"><a id="__codelineno-17-224" name="__codelineno-17-224"></a>        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">dir_pred</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"pred_epoch_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">epoch_id</span><span class="p">)</span><span class="si">}</span><span class="s2">.png"</span><span class="p">),</span>
</span><span id="__span-17-225"><a id="__codelineno-17-225" name="__codelineno-17-225"></a>        <span class="n">pred_img</span><span class="p">,</span>
</span><span id="__span-17-226"><a id="__codelineno-17-226" name="__codelineno-17-226"></a>        <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="__span-17-227"><a id="__codelineno-17-227" name="__codelineno-17-227"></a>        <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="__span-17-228"><a id="__codelineno-17-228" name="__codelineno-17-228"></a>        <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span>
</span><span id="__span-17-229"><a id="__codelineno-17-229" name="__codelineno-17-229"></a>    <span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="38-loss-data-transform">3.8 自定义 loss 和 data transform<a class="headerlink" href="#38-loss-data-transform" title="Permanent link">¶</a></h3>
<p>由于本问题采用无监督学习，数据中不存在标签数据，loss 为计算得到，因此需要自定义 loss 。方法为先定义相关函数，再将函数名作为参数传给 <code>FunctionalLoss</code>。需要注意自定义 loss 函数的输入输出参数需要与 PaddleScience 中如 <code>MSE</code> 等其他函数保持一致，即输入为模型输出 <code>output_dict</code> 等字典变量，输出为 loss 值 <code>paddle.Tensor</code>。</p>
<h4 id="381-generator-loss">3.8.1 Generator 的 loss<a class="headerlink" href="#381-generator-loss" title="Permanent link">¶</a></h4>
<p>Generator 的 loss 提供了 l1 loss、l2 loss、输出经过 Discriminator 判断的 loss 和 输出经过 Discriminator_tempo 判断的 loss。这些 loss 是否存在根据权重参数控制，若某一项 loss 的权重参数为 0，则表示训练中不添加该 loss 项。</p>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-276">276</a></span>
<span class="normal"><a href="#__codelineno-18-277">277</a></span>
<span class="normal"><a href="#__codelineno-18-278">278</a></span>
<span class="normal"><a href="#__codelineno-18-279">279</a></span>
<span class="normal"><a href="#__codelineno-18-280">280</a></span>
<span class="normal"><a href="#__codelineno-18-281">281</a></span>
<span class="normal"><a href="#__codelineno-18-282">282</a></span>
<span class="normal"><a href="#__codelineno-18-283">283</a></span>
<span class="normal"><a href="#__codelineno-18-284">284</a></span>
<span class="normal"><a href="#__codelineno-18-285">285</a></span>
<span class="normal"><a href="#__codelineno-18-286">286</a></span>
<span class="normal"><a href="#__codelineno-18-287">287</a></span>
<span class="normal"><a href="#__codelineno-18-288">288</a></span>
<span class="normal"><a href="#__codelineno-18-289">289</a></span>
<span class="normal"><a href="#__codelineno-18-290">290</a></span>
<span class="normal"><a href="#__codelineno-18-291">291</a></span>
<span class="normal"><a href="#__codelineno-18-292">292</a></span>
<span class="normal"><a href="#__codelineno-18-293">293</a></span>
<span class="normal"><a href="#__codelineno-18-294">294</a></span>
<span class="normal"><a href="#__codelineno-18-295">295</a></span>
<span class="normal"><a href="#__codelineno-18-296">296</a></span>
<span class="normal"><a href="#__codelineno-18-297">297</a></span>
<span class="normal"><a href="#__codelineno-18-298">298</a></span>
<span class="normal"><a href="#__codelineno-18-299">299</a></span>
<span class="normal"><a href="#__codelineno-18-300">300</a></span>
<span class="normal"><a href="#__codelineno-18-301">301</a></span>
<span class="normal"><a href="#__codelineno-18-302">302</a></span>
<span class="normal"><a href="#__codelineno-18-303">303</a></span>
<span class="normal"><a href="#__codelineno-18-304">304</a></span>
<span class="normal"><a href="#__codelineno-18-305">305</a></span>
<span class="normal"><a href="#__codelineno-18-306">306</a></span>
<span class="normal"><a href="#__codelineno-18-307">307</a></span>
<span class="normal"><a href="#__codelineno-18-308">308</a></span>
<span class="normal"><a href="#__codelineno-18-309">309</a></span>
<span class="normal"><a href="#__codelineno-18-310">310</a></span>
<span class="normal"><a href="#__codelineno-18-311">311</a></span>
<span class="normal"><a href="#__codelineno-18-312">312</a></span>
<span class="normal"><a href="#__codelineno-18-313">313</a></span>
<span class="normal"><a href="#__codelineno-18-314">314</a></span>
<span class="normal"><a href="#__codelineno-18-315">315</a></span>
<span class="normal"><a href="#__codelineno-18-316">316</a></span>
<span class="normal"><a href="#__codelineno-18-317">317</a></span>
<span class="normal"><a href="#__codelineno-18-318">318</a></span>
<span class="normal"><a href="#__codelineno-18-319">319</a></span>
<span class="normal"><a href="#__codelineno-18-320">320</a></span>
<span class="normal"><a href="#__codelineno-18-321">321</a></span>
<span class="normal"><a href="#__codelineno-18-322">322</a></span>
<span class="normal"><a href="#__codelineno-18-323">323</a></span>
<span class="normal"><a href="#__codelineno-18-324">324</a></span>
<span class="normal"><a href="#__codelineno-18-325">325</a></span>
<span class="normal"><a href="#__codelineno-18-326">326</a></span>
<span class="normal"><a href="#__codelineno-18-327">327</a></span>
<span class="normal"><a href="#__codelineno-18-328">328</a></span>
<span class="normal"><a href="#__codelineno-18-329">329</a></span>
<span class="normal"><a href="#__codelineno-18-330">330</a></span>
<span class="normal"><a href="#__codelineno-18-331">331</a></span>
<span class="normal"><a href="#__codelineno-18-332">332</a></span>
<span class="normal"><a href="#__codelineno-18-333">333</a></span>
<span class="normal"><a href="#__codelineno-18-334">334</a></span>
<span class="normal"><a href="#__codelineno-18-335">335</a></span>
<span class="normal"><a href="#__codelineno-18-336">336</a></span>
<span class="normal"><a href="#__codelineno-18-337">337</a></span>
<span class="normal"><a href="#__codelineno-18-338">338</a></span>
<span class="normal"><a href="#__codelineno-18-339">339</a></span>
<span class="normal"><a href="#__codelineno-18-340">340</a></span>
<span class="normal"><a href="#__codelineno-18-341">341</a></span>
<span class="normal"><a href="#__codelineno-18-342">342</a></span>
<span class="normal"><a href="#__codelineno-18-343">343</a></span>
<span class="normal"><a href="#__codelineno-18-344">344</a></span>
<span class="normal"><a href="#__codelineno-18-345">345</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-276"><a id="__codelineno-18-276" name="__codelineno-18-276"></a><span class="k">def</span> <span class="nf">loss_func_gen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">paddle</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="__span-18-277"><a id="__codelineno-18-277" name="__codelineno-18-277"></a><span class="w">    </span><span class="sd">"""Calculate loss of generator when use spatial discriminator.</span>
</span><span id="__span-18-278"><a id="__codelineno-18-278" name="__codelineno-18-278"></a><span class="sd">        The loss consists of l1 loss, l2 loss and layer loss when use spatial discriminator.</span>
</span><span id="__span-18-279"><a id="__codelineno-18-279" name="__codelineno-18-279"></a><span class="sd">        Notice that all item of loss is optional because weight of them might be 0.</span>
</span><span id="__span-18-280"><a id="__codelineno-18-280" name="__codelineno-18-280"></a>
</span><span id="__span-18-281"><a id="__codelineno-18-281" name="__codelineno-18-281"></a><span class="sd">    Args:</span>
</span><span id="__span-18-282"><a id="__codelineno-18-282" name="__codelineno-18-282"></a><span class="sd">        output_dict (Dict): output dict of model.</span>
</span><span id="__span-18-283"><a id="__codelineno-18-283" name="__codelineno-18-283"></a>
</span><span id="__span-18-284"><a id="__codelineno-18-284" name="__codelineno-18-284"></a><span class="sd">    Returns:</span>
</span><span id="__span-18-285"><a id="__codelineno-18-285" name="__codelineno-18-285"></a><span class="sd">        paddle.Tensor: Loss of generator.</span>
</span><span id="__span-18-286"><a id="__codelineno-18-286" name="__codelineno-18-286"></a><span class="sd">    """</span>
</span><span id="__span-18-287"><a id="__codelineno-18-287" name="__codelineno-18-287"></a>    <span class="c1"># l1 loss</span>
</span><span id="__span-18-288"><a id="__codelineno-18-288" name="__codelineno-18-288"></a>    <span class="n">loss_l1</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">l1_loss</span><span class="p">(</span>
</span><span id="__span-18-289"><a id="__codelineno-18-289" name="__codelineno-18-289"></a>        <span class="n">output_dict</span><span class="p">[</span><span class="s2">"output_gen"</span><span class="p">],</span> <span class="n">output_dict</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">],</span> <span class="s2">"mean"</span>
</span><span id="__span-18-290"><a id="__codelineno-18-290" name="__codelineno-18-290"></a>    <span class="p">)</span>
</span><span id="__span-18-291"><a id="__codelineno-18-291" name="__codelineno-18-291"></a>    <span class="n">losses</span> <span class="o">=</span> <span class="n">loss_l1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_gen</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-18-292"><a id="__codelineno-18-292" name="__codelineno-18-292"></a>
</span><span id="__span-18-293"><a id="__codelineno-18-293" name="__codelineno-18-293"></a>    <span class="c1"># l2 loss</span>
</span><span id="__span-18-294"><a id="__codelineno-18-294" name="__codelineno-18-294"></a>    <span class="n">loss_l2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span>
</span><span id="__span-18-295"><a id="__codelineno-18-295" name="__codelineno-18-295"></a>        <span class="n">output_dict</span><span class="p">[</span><span class="s2">"output_gen"</span><span class="p">],</span> <span class="n">output_dict</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">],</span> <span class="s2">"mean"</span>
</span><span id="__span-18-296"><a id="__codelineno-18-296" name="__codelineno-18-296"></a>    <span class="p">)</span>
</span><span id="__span-18-297"><a id="__codelineno-18-297" name="__codelineno-18-297"></a>    <span class="n">losses</span> <span class="o">+=</span> <span class="n">loss_l2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_gen</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-18-298"><a id="__codelineno-18-298" name="__codelineno-18-298"></a>
</span><span id="__span-18-299"><a id="__codelineno-18-299" name="__codelineno-18-299"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_gen_layer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-18-300"><a id="__codelineno-18-300" name="__codelineno-18-300"></a>        <span class="c1"># disc(generator_out) loss</span>
</span><span id="__span-18-301"><a id="__codelineno-18-301" name="__codelineno-18-301"></a>        <span class="n">out_disc_from_gen</span> <span class="o">=</span> <span class="n">output_dict</span><span class="p">[</span><span class="s2">"out_disc_from_gen"</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-18-302"><a id="__codelineno-18-302" name="__codelineno-18-302"></a>        <span class="n">label_ones</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">out_disc_from_gen</span><span class="p">)</span>
</span><span id="__span-18-303"><a id="__codelineno-18-303" name="__codelineno-18-303"></a>        <span class="n">loss_gen</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">binary_cross_entropy_with_logits</span><span class="p">(</span>
</span><span id="__span-18-304"><a id="__codelineno-18-304" name="__codelineno-18-304"></a>            <span class="n">out_disc_from_gen</span><span class="p">,</span> <span class="n">label_ones</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">"mean"</span>
</span><span id="__span-18-305"><a id="__codelineno-18-305" name="__codelineno-18-305"></a>        <span class="p">)</span>
</span><span id="__span-18-306"><a id="__codelineno-18-306" name="__codelineno-18-306"></a>        <span class="n">losses</span> <span class="o">+=</span> <span class="n">loss_gen</span>
</span><span id="__span-18-307"><a id="__codelineno-18-307" name="__codelineno-18-307"></a>
</span><span id="__span-18-308"><a id="__codelineno-18-308" name="__codelineno-18-308"></a>        <span class="c1"># layer loss</span>
</span><span id="__span-18-309"><a id="__codelineno-18-309" name="__codelineno-18-309"></a>        <span class="n">key_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">output_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="__span-18-310"><a id="__codelineno-18-310" name="__codelineno-18-310"></a>        <span class="c1"># ["out0_layer0","out0_layer1","out0_layer2","out0_layer3","out_disc_from_target",</span>
</span><span id="__span-18-311"><a id="__codelineno-18-311" name="__codelineno-18-311"></a>        <span class="c1"># "out1_layer0","out1_layer1","out1_layer2","out1_layer3","out_disc_from_gen"]</span>
</span><span id="__span-18-312"><a id="__codelineno-18-312" name="__codelineno-18-312"></a>        <span class="n">loss_layer</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-18-313"><a id="__codelineno-18-313" name="__codelineno-18-313"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_gen_layer</span><span class="p">)):</span>
</span><span id="__span-18-314"><a id="__codelineno-18-314" name="__codelineno-18-314"></a>            <span class="c1"># i = 0,1,2,3</span>
</span><span id="__span-18-315"><a id="__codelineno-18-315" name="__codelineno-18-315"></a>            <span class="n">loss_layer</span> <span class="o">+=</span> <span class="p">(</span>
</span><span id="__span-18-316"><a id="__codelineno-18-316" name="__codelineno-18-316"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">weight_gen_layer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="__span-18-317"><a id="__codelineno-18-317" name="__codelineno-18-317"></a>                <span class="o">*</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span>
</span><span id="__span-18-318"><a id="__codelineno-18-318" name="__codelineno-18-318"></a>                    <span class="n">output_dict</span><span class="p">[</span><span class="n">key_list</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
</span><span id="__span-18-319"><a id="__codelineno-18-319" name="__codelineno-18-319"></a>                    <span class="n">output_dict</span><span class="p">[</span><span class="n">key_list</span><span class="p">[</span><span class="mi">5</span> <span class="o">+</span> <span class="n">i</span><span class="p">]],</span>
</span><span id="__span-18-320"><a id="__codelineno-18-320" name="__codelineno-18-320"></a>                    <span class="n">reduction</span><span class="o">=</span><span class="s2">"sum"</span><span class="p">,</span>
</span><span id="__span-18-321"><a id="__codelineno-18-321" name="__codelineno-18-321"></a>                <span class="p">)</span>
</span><span id="__span-18-322"><a id="__codelineno-18-322" name="__codelineno-18-322"></a>                <span class="o">/</span> <span class="mi">2</span>
</span><span id="__span-18-323"><a id="__codelineno-18-323" name="__codelineno-18-323"></a>            <span class="p">)</span>
</span><span id="__span-18-324"><a id="__codelineno-18-324" name="__codelineno-18-324"></a>        <span class="n">losses</span> <span class="o">+=</span> <span class="n">loss_layer</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_gen_layer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-18-325"><a id="__codelineno-18-325" name="__codelineno-18-325"></a>
</span><span id="__span-18-326"><a id="__codelineno-18-326" name="__codelineno-18-326"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">"output_gen"</span><span class="p">:</span> <span class="n">losses</span><span class="p">}</span>
</span><span id="__span-18-327"><a id="__codelineno-18-327" name="__codelineno-18-327"></a>
</span><span id="__span-18-328"><a id="__codelineno-18-328" name="__codelineno-18-328"></a><span class="k">def</span> <span class="nf">loss_func_gen_tempo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">paddle</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="__span-18-329"><a id="__codelineno-18-329" name="__codelineno-18-329"></a><span class="w">    </span><span class="sd">"""Calculate loss of generator when use temporal discriminator.</span>
</span><span id="__span-18-330"><a id="__codelineno-18-330" name="__codelineno-18-330"></a><span class="sd">        The loss is cross entropy loss when use temporal discriminator.</span>
</span><span id="__span-18-331"><a id="__codelineno-18-331" name="__codelineno-18-331"></a>
</span><span id="__span-18-332"><a id="__codelineno-18-332" name="__codelineno-18-332"></a><span class="sd">    Args:</span>
</span><span id="__span-18-333"><a id="__codelineno-18-333" name="__codelineno-18-333"></a><span class="sd">        output_dict (Dict): output dict of model.</span>
</span><span id="__span-18-334"><a id="__codelineno-18-334" name="__codelineno-18-334"></a>
</span><span id="__span-18-335"><a id="__codelineno-18-335" name="__codelineno-18-335"></a><span class="sd">    Returns:</span>
</span><span id="__span-18-336"><a id="__codelineno-18-336" name="__codelineno-18-336"></a><span class="sd">        paddle.Tensor: Loss of generator.</span>
</span><span id="__span-18-337"><a id="__codelineno-18-337" name="__codelineno-18-337"></a><span class="sd">    """</span>
</span><span id="__span-18-338"><a id="__codelineno-18-338" name="__codelineno-18-338"></a>    <span class="n">out_disc_tempo_from_gen</span> <span class="o">=</span> <span class="n">output_dict</span><span class="p">[</span><span class="s2">"out_disc_tempo_from_gen"</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-18-339"><a id="__codelineno-18-339" name="__codelineno-18-339"></a>    <span class="n">label_t_ones</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">out_disc_tempo_from_gen</span><span class="p">)</span>
</span><span id="__span-18-340"><a id="__codelineno-18-340" name="__codelineno-18-340"></a>
</span><span id="__span-18-341"><a id="__codelineno-18-341" name="__codelineno-18-341"></a>    <span class="n">loss_gen_t</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">binary_cross_entropy_with_logits</span><span class="p">(</span>
</span><span id="__span-18-342"><a id="__codelineno-18-342" name="__codelineno-18-342"></a>        <span class="n">out_disc_tempo_from_gen</span><span class="p">,</span> <span class="n">label_t_ones</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">"mean"</span>
</span><span id="__span-18-343"><a id="__codelineno-18-343" name="__codelineno-18-343"></a>    <span class="p">)</span>
</span><span id="__span-18-344"><a id="__codelineno-18-344" name="__codelineno-18-344"></a>    <span class="n">losses</span> <span class="o">=</span> <span class="n">loss_gen_t</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_gen</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="__span-18-345"><a id="__codelineno-18-345" name="__codelineno-18-345"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">"out_disc_tempo_from_gen"</span><span class="p">:</span> <span class="n">losses</span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="382-discriminator-loss">3.8.2 Discriminator 的 loss<a class="headerlink" href="#382-discriminator-loss" title="Permanent link">¶</a></h4>
<p>Discriminator 为判别器，它的作用是判断数据为真数据还是假数据，因此它的 loss 为 Generator 产生的数据应当判断为假而产生的 loss 和 目标值数据应当判断为真而产生的 loss。</p>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-395">395</a></span>
<span class="normal"><a href="#__codelineno-19-396">396</a></span>
<span class="normal"><a href="#__codelineno-19-397">397</a></span>
<span class="normal"><a href="#__codelineno-19-398">398</a></span>
<span class="normal"><a href="#__codelineno-19-399">399</a></span>
<span class="normal"><a href="#__codelineno-19-400">400</a></span>
<span class="normal"><a href="#__codelineno-19-401">401</a></span>
<span class="normal"><a href="#__codelineno-19-402">402</a></span>
<span class="normal"><a href="#__codelineno-19-403">403</a></span>
<span class="normal"><a href="#__codelineno-19-404">404</a></span>
<span class="normal"><a href="#__codelineno-19-405">405</a></span>
<span class="normal"><a href="#__codelineno-19-406">406</a></span>
<span class="normal"><a href="#__codelineno-19-407">407</a></span>
<span class="normal"><a href="#__codelineno-19-408">408</a></span>
<span class="normal"><a href="#__codelineno-19-409">409</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-19-395"><a id="__codelineno-19-395" name="__codelineno-19-395"></a><span class="k">def</span> <span class="nf">loss_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span><span id="__span-19-396"><a id="__codelineno-19-396" name="__codelineno-19-396"></a>    <span class="n">out_disc_from_target</span> <span class="o">=</span> <span class="n">output_dict</span><span class="p">[</span><span class="s2">"out_disc_from_target"</span><span class="p">]</span>
</span><span id="__span-19-397"><a id="__codelineno-19-397" name="__codelineno-19-397"></a>    <span class="n">out_disc_from_gen</span> <span class="o">=</span> <span class="n">output_dict</span><span class="p">[</span><span class="s2">"out_disc_from_gen"</span><span class="p">]</span>
</span><span id="__span-19-398"><a id="__codelineno-19-398" name="__codelineno-19-398"></a>
</span><span id="__span-19-399"><a id="__codelineno-19-399" name="__codelineno-19-399"></a>    <span class="n">label_ones</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">out_disc_from_target</span><span class="p">)</span>
</span><span id="__span-19-400"><a id="__codelineno-19-400" name="__codelineno-19-400"></a>    <span class="n">label_zeros</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">out_disc_from_gen</span><span class="p">)</span>
</span><span id="__span-19-401"><a id="__codelineno-19-401" name="__codelineno-19-401"></a>
</span><span id="__span-19-402"><a id="__codelineno-19-402" name="__codelineno-19-402"></a>    <span class="n">loss_disc_from_target</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">binary_cross_entropy_with_logits</span><span class="p">(</span>
</span><span id="__span-19-403"><a id="__codelineno-19-403" name="__codelineno-19-403"></a>        <span class="n">out_disc_from_target</span><span class="p">,</span> <span class="n">label_ones</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">"mean"</span>
</span><span id="__span-19-404"><a id="__codelineno-19-404" name="__codelineno-19-404"></a>    <span class="p">)</span>
</span><span id="__span-19-405"><a id="__codelineno-19-405" name="__codelineno-19-405"></a>    <span class="n">loss_disc_from_gen</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">binary_cross_entropy_with_logits</span><span class="p">(</span>
</span><span id="__span-19-406"><a id="__codelineno-19-406" name="__codelineno-19-406"></a>        <span class="n">out_disc_from_gen</span><span class="p">,</span> <span class="n">label_zeros</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">"mean"</span>
</span><span id="__span-19-407"><a id="__codelineno-19-407" name="__codelineno-19-407"></a>    <span class="p">)</span>
</span><span id="__span-19-408"><a id="__codelineno-19-408" name="__codelineno-19-408"></a>    <span class="n">losses</span> <span class="o">=</span> <span class="n">loss_disc_from_target</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_disc</span> <span class="o">+</span> <span class="n">loss_disc_from_gen</span>
</span><span id="__span-19-409"><a id="__codelineno-19-409" name="__codelineno-19-409"></a>    <span class="k">return</span> <span class="n">losses</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="383-discriminator_tempo-loss">3.8.3 Discriminator_tempo 的 loss<a class="headerlink" href="#383-discriminator_tempo-loss" title="Permanent link">¶</a></h4>
<p>Discriminator_tempo 的 loss 构成 与 Discriminator 相同，只是所需数据不同。</p>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-411">411</a></span>
<span class="normal"><a href="#__codelineno-20-412">412</a></span>
<span class="normal"><a href="#__codelineno-20-413">413</a></span>
<span class="normal"><a href="#__codelineno-20-414">414</a></span>
<span class="normal"><a href="#__codelineno-20-415">415</a></span>
<span class="normal"><a href="#__codelineno-20-416">416</a></span>
<span class="normal"><a href="#__codelineno-20-417">417</a></span>
<span class="normal"><a href="#__codelineno-20-418">418</a></span>
<span class="normal"><a href="#__codelineno-20-419">419</a></span>
<span class="normal"><a href="#__codelineno-20-420">420</a></span>
<span class="normal"><a href="#__codelineno-20-421">421</a></span>
<span class="normal"><a href="#__codelineno-20-422">422</a></span>
<span class="normal"><a href="#__codelineno-20-423">423</a></span>
<span class="normal"><a href="#__codelineno-20-424">424</a></span>
<span class="normal"><a href="#__codelineno-20-425">425</a></span>
<span class="normal"><a href="#__codelineno-20-426">426</a></span>
<span class="normal"><a href="#__codelineno-20-427">427</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-20-411"><a id="__codelineno-20-411" name="__codelineno-20-411"></a><span class="k">def</span> <span class="nf">loss_func_tempo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span><span id="__span-20-412"><a id="__codelineno-20-412" name="__codelineno-20-412"></a>    <span class="n">out_disc_tempo_from_target</span> <span class="o">=</span> <span class="n">output_dict</span><span class="p">[</span><span class="s2">"out_disc_tempo_from_target"</span><span class="p">]</span>
</span><span id="__span-20-413"><a id="__codelineno-20-413" name="__codelineno-20-413"></a>    <span class="n">out_disc_tempo_from_gen</span> <span class="o">=</span> <span class="n">output_dict</span><span class="p">[</span><span class="s2">"out_disc_tempo_from_gen"</span><span class="p">]</span>
</span><span id="__span-20-414"><a id="__codelineno-20-414" name="__codelineno-20-414"></a>
</span><span id="__span-20-415"><a id="__codelineno-20-415" name="__codelineno-20-415"></a>    <span class="n">label_ones</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">out_disc_tempo_from_target</span><span class="p">)</span>
</span><span id="__span-20-416"><a id="__codelineno-20-416" name="__codelineno-20-416"></a>    <span class="n">label_zeros</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">out_disc_tempo_from_gen</span><span class="p">)</span>
</span><span id="__span-20-417"><a id="__codelineno-20-417" name="__codelineno-20-417"></a>
</span><span id="__span-20-418"><a id="__codelineno-20-418" name="__codelineno-20-418"></a>    <span class="n">loss_disc_tempo_from_target</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">binary_cross_entropy_with_logits</span><span class="p">(</span>
</span><span id="__span-20-419"><a id="__codelineno-20-419" name="__codelineno-20-419"></a>        <span class="n">out_disc_tempo_from_target</span><span class="p">,</span> <span class="n">label_ones</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">"mean"</span>
</span><span id="__span-20-420"><a id="__codelineno-20-420" name="__codelineno-20-420"></a>    <span class="p">)</span>
</span><span id="__span-20-421"><a id="__codelineno-20-421" name="__codelineno-20-421"></a>    <span class="n">loss_disc_tempo_from_gen</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">binary_cross_entropy_with_logits</span><span class="p">(</span>
</span><span id="__span-20-422"><a id="__codelineno-20-422" name="__codelineno-20-422"></a>        <span class="n">out_disc_tempo_from_gen</span><span class="p">,</span> <span class="n">label_zeros</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">"mean"</span>
</span><span id="__span-20-423"><a id="__codelineno-20-423" name="__codelineno-20-423"></a>    <span class="p">)</span>
</span><span id="__span-20-424"><a id="__codelineno-20-424" name="__codelineno-20-424"></a>    <span class="n">losses</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-20-425"><a id="__codelineno-20-425" name="__codelineno-20-425"></a>        <span class="n">loss_disc_tempo_from_target</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_disc</span> <span class="o">+</span> <span class="n">loss_disc_tempo_from_gen</span>
</span><span id="__span-20-426"><a id="__codelineno-20-426" name="__codelineno-20-426"></a>    <span class="p">)</span>
</span><span id="__span-20-427"><a id="__codelineno-20-427" name="__codelineno-20-427"></a>    <span class="k">return</span> <span class="n">losses</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="384-data-transform">3.8.4 自定义 data transform<a class="headerlink" href="#384-data-transform" title="Permanent link">¶</a></h4>
<p>本问题提供了一种输入数据处理方法，将输入的流体密度数据随机裁剪一块，然后进行密度值判断，若裁剪下来的块密度值低于阈值则重新裁剪，直到密度满足条件或裁剪次数达到阈值。这样做主要是为了减少训练所需的显存，同时对裁剪下来的块密度值的判断保证了块中信息的丰富程度。<a href="#34">参数和超参数设定</a>中 <code>tile_ratio</code> 表示原始尺寸是块的尺寸的几倍，即若<code>tile_ratio</code> 为 2，裁剪下来的块的大小为整张原始图片的四分之一。</p>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-430">430</a></span>
<span class="normal"><a href="#__codelineno-21-431">431</a></span>
<span class="normal"><a href="#__codelineno-21-432">432</a></span>
<span class="normal"><a href="#__codelineno-21-433">433</a></span>
<span class="normal"><a href="#__codelineno-21-434">434</a></span>
<span class="normal"><a href="#__codelineno-21-435">435</a></span>
<span class="normal"><a href="#__codelineno-21-436">436</a></span>
<span class="normal"><a href="#__codelineno-21-437">437</a></span>
<span class="normal"><a href="#__codelineno-21-438">438</a></span>
<span class="normal"><a href="#__codelineno-21-439">439</a></span>
<span class="normal"><a href="#__codelineno-21-440">440</a></span>
<span class="normal"><a href="#__codelineno-21-441">441</a></span>
<span class="normal"><a href="#__codelineno-21-442">442</a></span>
<span class="normal"><a href="#__codelineno-21-443">443</a></span>
<span class="normal"><a href="#__codelineno-21-444">444</a></span>
<span class="normal"><a href="#__codelineno-21-445">445</a></span>
<span class="normal"><a href="#__codelineno-21-446">446</a></span>
<span class="normal"><a href="#__codelineno-21-447">447</a></span>
<span class="normal"><a href="#__codelineno-21-448">448</a></span>
<span class="normal"><a href="#__codelineno-21-449">449</a></span>
<span class="normal"><a href="#__codelineno-21-450">450</a></span>
<span class="normal"><a href="#__codelineno-21-451">451</a></span>
<span class="normal"><a href="#__codelineno-21-452">452</a></span>
<span class="normal"><a href="#__codelineno-21-453">453</a></span>
<span class="normal"><a href="#__codelineno-21-454">454</a></span>
<span class="normal"><a href="#__codelineno-21-455">455</a></span>
<span class="normal"><a href="#__codelineno-21-456">456</a></span>
<span class="normal"><a href="#__codelineno-21-457">457</a></span>
<span class="normal"><a href="#__codelineno-21-458">458</a></span>
<span class="normal"><a href="#__codelineno-21-459">459</a></span>
<span class="normal"><a href="#__codelineno-21-460">460</a></span>
<span class="normal"><a href="#__codelineno-21-461">461</a></span>
<span class="normal"><a href="#__codelineno-21-462">462</a></span>
<span class="normal"><a href="#__codelineno-21-463">463</a></span>
<span class="normal"><a href="#__codelineno-21-464">464</a></span>
<span class="normal"><a href="#__codelineno-21-465">465</a></span>
<span class="normal"><a href="#__codelineno-21-466">466</a></span>
<span class="normal"><a href="#__codelineno-21-467">467</a></span>
<span class="normal"><a href="#__codelineno-21-468">468</a></span>
<span class="normal"><a href="#__codelineno-21-469">469</a></span>
<span class="normal"><a href="#__codelineno-21-470">470</a></span>
<span class="normal"><a href="#__codelineno-21-471">471</a></span>
<span class="normal"><a href="#__codelineno-21-472">472</a></span>
<span class="normal"><a href="#__codelineno-21-473">473</a></span>
<span class="normal"><a href="#__codelineno-21-474">474</a></span>
<span class="normal"><a href="#__codelineno-21-475">475</a></span>
<span class="normal"><a href="#__codelineno-21-476">476</a></span>
<span class="normal"><a href="#__codelineno-21-477">477</a></span>
<span class="normal"><a href="#__codelineno-21-478">478</a></span>
<span class="normal"><a href="#__codelineno-21-479">479</a></span>
<span class="normal"><a href="#__codelineno-21-480">480</a></span>
<span class="normal"><a href="#__codelineno-21-481">481</a></span>
<span class="normal"><a href="#__codelineno-21-482">482</a></span>
<span class="normal"><a href="#__codelineno-21-483">483</a></span>
<span class="normal"><a href="#__codelineno-21-484">484</a></span>
<span class="normal"><a href="#__codelineno-21-485">485</a></span>
<span class="normal"><a href="#__codelineno-21-486">486</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-21-430"><a id="__codelineno-21-430" name="__codelineno-21-430"></a><span class="k">class</span> <span class="nc">DataFuncs</span><span class="p">:</span>
</span><span id="__span-21-431"><a id="__codelineno-21-431" name="__codelineno-21-431"></a><span class="w">    </span><span class="sd">"""All functions used for data transform.</span>
</span><span id="__span-21-432"><a id="__codelineno-21-432" name="__codelineno-21-432"></a>
</span><span id="__span-21-433"><a id="__codelineno-21-433" name="__codelineno-21-433"></a><span class="sd">    Args:</span>
</span><span id="__span-21-434"><a id="__codelineno-21-434" name="__codelineno-21-434"></a><span class="sd">        tile_ratio (int, optional): How many tiles of one dim. Defaults to 1.</span>
</span><span id="__span-21-435"><a id="__codelineno-21-435" name="__codelineno-21-435"></a><span class="sd">        density_min (float, optional): Minimize density of one tile. Defaults to 0.02.</span>
</span><span id="__span-21-436"><a id="__codelineno-21-436" name="__codelineno-21-436"></a><span class="sd">        max_turn (int, optional): Maximize turn of taking a tile from one image. Defaults to 20.</span>
</span><span id="__span-21-437"><a id="__codelineno-21-437" name="__codelineno-21-437"></a><span class="sd">    """</span>
</span><span id="__span-21-438"><a id="__codelineno-21-438" name="__codelineno-21-438"></a>
</span><span id="__span-21-439"><a id="__codelineno-21-439" name="__codelineno-21-439"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="__span-21-440"><a id="__codelineno-21-440" name="__codelineno-21-440"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">tile_ratio</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">density_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">max_turn</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span>
</span><span id="__span-21-441"><a id="__codelineno-21-441" name="__codelineno-21-441"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-21-442"><a id="__codelineno-21-442" name="__codelineno-21-442"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile_ratio</span> <span class="o">=</span> <span class="n">tile_ratio</span>
</span><span id="__span-21-443"><a id="__codelineno-21-443" name="__codelineno-21-443"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">density_min</span> <span class="o">=</span> <span class="n">density_min</span>
</span><span id="__span-21-444"><a id="__codelineno-21-444" name="__codelineno-21-444"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_turn</span> <span class="o">=</span> <span class="n">max_turn</span>
</span><span id="__span-21-445"><a id="__codelineno-21-445" name="__codelineno-21-445"></a>
</span><span id="__span-21-446"><a id="__codelineno-21-446" name="__codelineno-21-446"></a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span>
</span><span id="__span-21-447"><a id="__codelineno-21-447" name="__codelineno-21-447"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-21-448"><a id="__codelineno-21-448" name="__codelineno-21-448"></a>        <span class="n">input_item</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
</span><span id="__span-21-449"><a id="__codelineno-21-449" name="__codelineno-21-449"></a>        <span class="n">label_item</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
</span><span id="__span-21-450"><a id="__codelineno-21-450" name="__codelineno-21-450"></a>        <span class="n">weight_item</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
</span><span id="__span-21-451"><a id="__codelineno-21-451" name="__codelineno-21-451"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
</span><span id="__span-21-452"><a id="__codelineno-21-452" name="__codelineno-21-452"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_ratio</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="__span-21-453"><a id="__codelineno-21-453" name="__codelineno-21-453"></a>            <span class="k">return</span> <span class="n">input_item</span><span class="p">,</span> <span class="n">label_item</span><span class="p">,</span> <span class="n">weight_item</span>
</span><span id="__span-21-454"><a id="__codelineno-21-454" name="__codelineno-21-454"></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_turn</span><span class="p">):</span>
</span><span id="__span-21-455"><a id="__codelineno-21-455" name="__codelineno-21-455"></a>            <span class="n">rand_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
</span><span id="__span-21-456"><a id="__codelineno-21-456" name="__codelineno-21-456"></a>            <span class="n">density_low</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cut_data</span><span class="p">(</span><span class="n">input_item</span><span class="p">[</span><span class="s2">"density_low"</span><span class="p">],</span> <span class="n">rand_ratio</span><span class="p">)</span>
</span><span id="__span-21-457"><a id="__codelineno-21-457" name="__codelineno-21-457"></a>            <span class="n">density_high</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cut_data</span><span class="p">(</span><span class="n">input_item</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">],</span> <span class="n">rand_ratio</span><span class="p">)</span>
</span><span id="__span-21-458"><a id="__codelineno-21-458" name="__codelineno-21-458"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid_tile</span><span class="p">(</span><span class="n">density_low</span><span class="p">):</span>
</span><span id="__span-21-459"><a id="__codelineno-21-459" name="__codelineno-21-459"></a>                <span class="k">break</span>
</span><span id="__span-21-460"><a id="__codelineno-21-460" name="__codelineno-21-460"></a>
</span><span id="__span-21-461"><a id="__codelineno-21-461" name="__codelineno-21-461"></a>        <span class="n">input_item</span><span class="p">[</span><span class="s2">"density_low"</span><span class="p">]</span> <span class="o">=</span> <span class="n">density_low</span>
</span><span id="__span-21-462"><a id="__codelineno-21-462" name="__codelineno-21-462"></a>        <span class="n">input_item</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">]</span> <span class="o">=</span> <span class="n">density_high</span>
</span><span id="__span-21-463"><a id="__codelineno-21-463" name="__codelineno-21-463"></a>        <span class="k">return</span> <span class="n">input_item</span><span class="p">,</span> <span class="n">label_item</span><span class="p">,</span> <span class="n">weight_item</span>
</span><span id="__span-21-464"><a id="__codelineno-21-464" name="__codelineno-21-464"></a>
</span><span id="__span-21-465"><a id="__codelineno-21-465" name="__codelineno-21-465"></a>    <span class="k">def</span> <span class="nf">cut_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">rand_ratio</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">paddle</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="__span-21-466"><a id="__codelineno-21-466" name="__codelineno-21-466"></a>        <span class="c1"># data: C,H,W</span>
</span><span id="__span-21-467"><a id="__codelineno-21-467" name="__codelineno-21-467"></a>        <span class="n">_</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</span><span id="__span-21-468"><a id="__codelineno-21-468" name="__codelineno-21-468"></a>        <span class="k">if</span> <span class="n">H</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_ratio</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">W</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_ratio</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-21-469"><a id="__codelineno-21-469" name="__codelineno-21-469"></a>            <span class="n">exit</span><span class="p">(</span>
</span><span id="__span-21-470"><a id="__codelineno-21-470" name="__codelineno-21-470"></a>                <span class="sa">f</span><span class="s2">"ERROR: input images cannot be divided into </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_ratio</span><span class="si">}</span><span class="s2"> parts evenly!"</span>
</span><span id="__span-21-471"><a id="__codelineno-21-471" name="__codelineno-21-471"></a>            <span class="p">)</span>
</span><span id="__span-21-472"><a id="__codelineno-21-472" name="__codelineno-21-472"></a>        <span class="n">tile_shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">H</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_ratio</span><span class="p">,</span> <span class="n">W</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_ratio</span><span class="p">]</span>
</span><span id="__span-21-473"><a id="__codelineno-21-473" name="__codelineno-21-473"></a>        <span class="n">rand_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">rand_ratio</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tile_shape</span><span class="p">)))</span>
</span><span id="__span-21-474"><a id="__codelineno-21-474" name="__codelineno-21-474"></a>        <span class="n">start</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">rand_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">rand_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
</span><span id="__span-21-475"><a id="__codelineno-21-475" name="__codelineno-21-475"></a>        <span class="n">end</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">rand_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">rand_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
</span><span id="__span-21-476"><a id="__codelineno-21-476" name="__codelineno-21-476"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span>
</span><span id="__span-21-477"><a id="__codelineno-21-477" name="__codelineno-21-477"></a>            <span class="n">paddle</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">starts</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">ends</span><span class="o">=</span><span class="n">end</span>
</span><span id="__span-21-478"><a id="__codelineno-21-478" name="__codelineno-21-478"></a>        <span class="p">)</span>
</span><span id="__span-21-479"><a id="__codelineno-21-479" name="__codelineno-21-479"></a>
</span><span id="__span-21-480"><a id="__codelineno-21-480" name="__codelineno-21-480"></a>        <span class="k">return</span> <span class="n">data</span>
</span><span id="__span-21-481"><a id="__codelineno-21-481" name="__codelineno-21-481"></a>
</span><span id="__span-21-482"><a id="__codelineno-21-482" name="__codelineno-21-482"></a>    <span class="k">def</span> <span class="nf">is_valid_tile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile</span><span class="p">:</span> <span class="n">paddle</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="__span-21-483"><a id="__codelineno-21-483" name="__codelineno-21-483"></a>        <span class="n">img_density</span> <span class="o">=</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="__span-21-484"><a id="__codelineno-21-484" name="__codelineno-21-484"></a>        <span class="k">return</span> <span class="n">img_density</span> <span class="o">&gt;=</span> <span class="p">(</span>
</span><span id="__span-21-485"><a id="__codelineno-21-485" name="__codelineno-21-485"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">density_min</span> <span class="o">*</span> <span class="n">tile</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">tile</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">tile</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="__span-21-486"><a id="__codelineno-21-486" name="__codelineno-21-486"></a>        <span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>注意，此处代码仅提供 data transform 的思路。当前代码中简单的分块方法由于输入包含的信息变少，显然会影响训练效果，因此本问题中当显存充足时，应当将 <code>tile_ratio</code> 设置为 1，当显存不足时，也建议优先考虑使用混合精度训练来减少现存占用。</p>
<h3 id="39">3.9 模型训练<a class="headerlink" href="#39" title="Permanent link">¶</a></h3>
<p>完成上述设置之后，首先需要将上述实例化的对象按顺序传递给 <code>ppsci.solver.Solver</code>，然后启动训练。</p>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-247">247</a></span>
<span class="normal"><a href="#__codelineno-22-248">248</a></span>
<span class="normal"><a href="#__codelineno-22-249">249</a></span>
<span class="normal"><a href="#__codelineno-22-250">250</a></span>
<span class="normal"><a href="#__codelineno-22-251">251</a></span>
<span class="normal"><a href="#__codelineno-22-252">252</a></span>
<span class="normal"><a href="#__codelineno-22-253">253</a></span>
<span class="normal"><a href="#__codelineno-22-254">254</a></span>
<span class="normal"><a href="#__codelineno-22-255">255</a></span>
<span class="normal"><a href="#__codelineno-22-256">256</a></span>
<span class="normal"><a href="#__codelineno-22-257">257</a></span>
<span class="normal"><a href="#__codelineno-22-258">258</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-22-247"><a id="__codelineno-22-247" name="__codelineno-22-247"></a><span class="n">solver_gen</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">Solver</span><span class="p">(</span>
</span><span id="__span-22-248"><a id="__codelineno-22-248" name="__codelineno-22-248"></a>    <span class="n">model_list</span><span class="p">,</span>
</span><span id="__span-22-249"><a id="__codelineno-22-249" name="__codelineno-22-249"></a>    <span class="n">constraint_gen</span><span class="p">,</span>
</span><span id="__span-22-250"><a id="__codelineno-22-250" name="__codelineno-22-250"></a>    <span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span>
</span><span id="__span-22-251"><a id="__codelineno-22-251" name="__codelineno-22-251"></a>    <span class="n">optimizer_gen</span><span class="p">,</span>
</span><span id="__span-22-252"><a id="__codelineno-22-252" name="__codelineno-22-252"></a>    <span class="n">lr_scheduler_gen</span><span class="p">,</span>
</span><span id="__span-22-253"><a id="__codelineno-22-253" name="__codelineno-22-253"></a>    <span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">epochs_gen</span><span class="p">,</span>
</span><span id="__span-22-254"><a id="__codelineno-22-254" name="__codelineno-22-254"></a>    <span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">iters_per_epoch</span><span class="p">,</span>
</span><span id="__span-22-255"><a id="__codelineno-22-255" name="__codelineno-22-255"></a>    <span class="n">eval_during_train</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">eval_during_train</span><span class="p">,</span>
</span><span id="__span-22-256"><a id="__codelineno-22-256" name="__codelineno-22-256"></a>    <span class="n">use_amp</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">USE_AMP</span><span class="p">,</span>
</span><span id="__span-22-257"><a id="__codelineno-22-257" name="__codelineno-22-257"></a>    <span class="n">amp_level</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">amp_level</span><span class="p">,</span>
</span><span id="__span-22-258"><a id="__codelineno-22-258" name="__codelineno-22-258"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>注意 GAN 类型的网络训练方法为多个模型交替训练，与单一模型或多模型分阶段训练不同，不能简单的使用 <code>solver.train</code> API，具体代码请参考 <a href="#4">完整代码</a> 中 tempoGAN.py 文件。</p>
<h3 id="310">3.10 模型评估<a class="headerlink" href="#310" title="Permanent link">¶</a></h3>
<h4 id="3101">3.10.1 训练中评估<a class="headerlink" href="#3101" title="Permanent link">¶</a></h4>
<p>训练中仅在特定 <code>Epoch</code> 保存特定图片的目标结果和模型输出结果，训练结束后针对最后一个 <code>Epoch</code> 的输出结果进行一次评估，以便直观评价模型优化效果。不使用 PaddleScience 中内置的评估器，也不在训练过程中进行评估:</p>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-287">287</a></span>
<span class="normal"><a href="#__codelineno-23-288">288</a></span>
<span class="normal"><a href="#__codelineno-23-289">289</a></span>
<span class="normal"><a href="#__codelineno-23-290">290</a></span>
<span class="normal"><a href="#__codelineno-23-291">291</a></span>
<span class="normal"><a href="#__codelineno-23-292">292</a></span>
<span class="normal"><a href="#__codelineno-23-293">293</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-23-287"><a id="__codelineno-23-287" name="__codelineno-23-287"></a><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="__span-23-288"><a id="__codelineno-23-288" name="__codelineno-23-288"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Epoch: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-23-289"><a id="__codelineno-23-289" name="__codelineno-23-289"></a>    <span class="c1"># plotting during training</span>
</span><span id="__span-23-290"><a id="__codelineno-23-290" name="__codelineno-23-290"></a>    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">%</span> <span class="n">PRED_INTERVAL</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">epochs</span><span class="p">:</span>
</span><span id="__span-23-291"><a id="__codelineno-23-291" name="__codelineno-23-291"></a>        <span class="n">func_module</span><span class="o">.</span><span class="n">predict_and_save_plot</span><span class="p">(</span>
</span><span id="__span-23-292"><a id="__codelineno-23-292" name="__codelineno-23-292"></a>            <span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">solver_gen</span><span class="p">,</span> <span class="n">dataset_valid</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">TILE_RATIO</span>
</span><span id="__span-23-293"><a id="__codelineno-23-293" name="__codelineno-23-293"></a>        <span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-307">307</a></span>
<span class="normal"><a href="#__codelineno-24-308">308</a></span>
<span class="normal"><a href="#__codelineno-24-309">309</a></span>
<span class="normal"><a href="#__codelineno-24-310">310</a></span>
<span class="normal"><a href="#__codelineno-24-311">311</a></span>
<span class="normal"><a href="#__codelineno-24-312">312</a></span>
<span class="normal"><a href="#__codelineno-24-313">313</a></span>
<span class="normal"><a href="#__codelineno-24-314">314</a></span>
<span class="normal"><a href="#__codelineno-24-315">315</a></span>
<span class="normal"><a href="#__codelineno-24-316">316</a></span>
<span class="normal"><a href="#__codelineno-24-317">317</a></span>
<span class="normal"><a href="#__codelineno-24-318">318</a></span>
<span class="normal"><a href="#__codelineno-24-319">319</a></span>
<span class="normal"><a href="#__codelineno-24-320">320</a></span>
<span class="normal"><a href="#__codelineno-24-321">321</a></span>
<span class="normal"><a href="#__codelineno-24-322">322</a></span>
<span class="normal"><a href="#__codelineno-24-323">323</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-24-307"><a id="__codelineno-24-307" name="__codelineno-24-307"></a><span class="c1">############### evaluation for training ###############</span>
</span><span id="__span-24-308"><a id="__codelineno-24-308" name="__codelineno-24-308"></a><span class="n">img_target</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-24-309"><a id="__codelineno-24-309" name="__codelineno-24-309"></a>    <span class="n">func_module</span><span class="o">.</span><span class="n">get_image_array</span><span class="p">(</span>
</span><span id="__span-24-310"><a id="__codelineno-24-310" name="__codelineno-24-310"></a>        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"predict"</span><span class="p">,</span> <span class="s2">"target.png"</span><span class="p">)</span>
</span><span id="__span-24-311"><a id="__codelineno-24-311" name="__codelineno-24-311"></a>    <span class="p">)</span>
</span><span id="__span-24-312"><a id="__codelineno-24-312" name="__codelineno-24-312"></a>    <span class="o">/</span> <span class="mf">255.0</span>
</span><span id="__span-24-313"><a id="__codelineno-24-313" name="__codelineno-24-313"></a><span class="p">)</span>
</span><span id="__span-24-314"><a id="__codelineno-24-314" name="__codelineno-24-314"></a><span class="n">img_pred</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-24-315"><a id="__codelineno-24-315" name="__codelineno-24-315"></a>    <span class="n">func_module</span><span class="o">.</span><span class="n">get_image_array</span><span class="p">(</span>
</span><span id="__span-24-316"><a id="__codelineno-24-316" name="__codelineno-24-316"></a>        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="__span-24-317"><a id="__codelineno-24-317" name="__codelineno-24-317"></a>            <span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"predict"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"pred_epoch_</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">epochs</span><span class="si">}</span><span class="s2">.png"</span>
</span><span id="__span-24-318"><a id="__codelineno-24-318" name="__codelineno-24-318"></a>        <span class="p">)</span>
</span><span id="__span-24-319"><a id="__codelineno-24-319" name="__codelineno-24-319"></a>    <span class="p">)</span>
</span><span id="__span-24-320"><a id="__codelineno-24-320" name="__codelineno-24-320"></a>    <span class="o">/</span> <span class="mf">255.0</span>
</span><span id="__span-24-321"><a id="__codelineno-24-321" name="__codelineno-24-321"></a><span class="p">)</span>
</span><span id="__span-24-322"><a id="__codelineno-24-322" name="__codelineno-24-322"></a><span class="n">eval_mse</span><span class="p">,</span> <span class="n">eval_psnr</span><span class="p">,</span> <span class="n">eval_ssim</span> <span class="o">=</span> <span class="n">func_module</span><span class="o">.</span><span class="n">evaluate_img</span><span class="p">(</span><span class="n">img_target</span><span class="p">,</span> <span class="n">img_pred</span><span class="p">)</span>
</span><span id="__span-24-323"><a id="__codelineno-24-323" name="__codelineno-24-323"></a><span class="n">logger</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="sa">f</span><span class="s2">"MSE: </span><span class="si">{</span><span class="n">eval_mse</span><span class="si">}</span><span class="s2">, PSNR: </span><span class="si">{</span><span class="n">eval_psnr</span><span class="si">}</span><span class="s2">, SSIM: </span><span class="si">{</span><span class="n">eval_ssim</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>具体代码请参考 <a href="#4">完整代码</a> 中 tempoGAN.py 文件。</p>
<h4 id="3102-eval">3.10.2 eval 中评估<a class="headerlink" href="#3102-eval" title="Permanent link">¶</a></h4>
<p>本问题的评估指标为，将模型输出的超分结果与实际高分辨率图片做对比，使用三个指标 MSE(Mean-Square Error) 、PSNR(Peak Signal-to-Noise Ratio) 、SSIM(Structural SIMilarity) 来评价图片相似度。因此没有使用 PaddleScience 中的内置评估器，也没有 <code>Solver.eval()</code> 过程。</p>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-326">326</a></span>
<span class="normal"><a href="#__codelineno-25-327">327</a></span>
<span class="normal"><a href="#__codelineno-25-328">328</a></span>
<span class="normal"><a href="#__codelineno-25-329">329</a></span>
<span class="normal"><a href="#__codelineno-25-330">330</a></span>
<span class="normal"><a href="#__codelineno-25-331">331</a></span>
<span class="normal"><a href="#__codelineno-25-332">332</a></span>
<span class="normal"><a href="#__codelineno-25-333">333</a></span>
<span class="normal"><a href="#__codelineno-25-334">334</a></span>
<span class="normal"><a href="#__codelineno-25-335">335</a></span>
<span class="normal"><a href="#__codelineno-25-336">336</a></span>
<span class="normal"><a href="#__codelineno-25-337">337</a></span>
<span class="normal"><a href="#__codelineno-25-338">338</a></span>
<span class="normal"><a href="#__codelineno-25-339">339</a></span>
<span class="normal"><a href="#__codelineno-25-340">340</a></span>
<span class="normal"><a href="#__codelineno-25-341">341</a></span>
<span class="normal"><a href="#__codelineno-25-342">342</a></span>
<span class="normal"><a href="#__codelineno-25-343">343</a></span>
<span class="normal"><a href="#__codelineno-25-344">344</a></span>
<span class="normal"><a href="#__codelineno-25-345">345</a></span>
<span class="normal"><a href="#__codelineno-25-346">346</a></span>
<span class="normal"><a href="#__codelineno-25-347">347</a></span>
<span class="normal"><a href="#__codelineno-25-348">348</a></span>
<span class="normal"><a href="#__codelineno-25-349">349</a></span>
<span class="normal"><a href="#__codelineno-25-350">350</a></span>
<span class="normal"><a href="#__codelineno-25-351">351</a></span>
<span class="normal"><a href="#__codelineno-25-352">352</a></span>
<span class="normal"><a href="#__codelineno-25-353">353</a></span>
<span class="normal"><a href="#__codelineno-25-354">354</a></span>
<span class="normal"><a href="#__codelineno-25-355">355</a></span>
<span class="normal"><a href="#__codelineno-25-356">356</a></span>
<span class="normal"><a href="#__codelineno-25-357">357</a></span>
<span class="normal"><a href="#__codelineno-25-358">358</a></span>
<span class="normal"><a href="#__codelineno-25-359">359</a></span>
<span class="normal"><a href="#__codelineno-25-360">360</a></span>
<span class="normal"><a href="#__codelineno-25-361">361</a></span>
<span class="normal"><a href="#__codelineno-25-362">362</a></span>
<span class="normal"><a href="#__codelineno-25-363">363</a></span>
<span class="normal"><a href="#__codelineno-25-364">364</a></span>
<span class="normal"><a href="#__codelineno-25-365">365</a></span>
<span class="normal"><a href="#__codelineno-25-366">366</a></span>
<span class="normal"><a href="#__codelineno-25-367">367</a></span>
<span class="normal"><a href="#__codelineno-25-368">368</a></span>
<span class="normal"><a href="#__codelineno-25-369">369</a></span>
<span class="normal"><a href="#__codelineno-25-370">370</a></span>
<span class="normal"><a href="#__codelineno-25-371">371</a></span>
<span class="normal"><a href="#__codelineno-25-372">372</a></span>
<span class="normal"><a href="#__codelineno-25-373">373</a></span>
<span class="normal"><a href="#__codelineno-25-374">374</a></span>
<span class="normal"><a href="#__codelineno-25-375">375</a></span>
<span class="normal"><a href="#__codelineno-25-376">376</a></span>
<span class="normal"><a href="#__codelineno-25-377">377</a></span>
<span class="normal"><a href="#__codelineno-25-378">378</a></span>
<span class="normal"><a href="#__codelineno-25-379">379</a></span>
<span class="normal"><a href="#__codelineno-25-380">380</a></span>
<span class="normal"><a href="#__codelineno-25-381">381</a></span>
<span class="normal"><a href="#__codelineno-25-382">382</a></span>
<span class="normal"><a href="#__codelineno-25-383">383</a></span>
<span class="normal"><a href="#__codelineno-25-384">384</a></span>
<span class="normal"><a href="#__codelineno-25-385">385</a></span>
<span class="normal"><a href="#__codelineno-25-386">386</a></span>
<span class="normal"><a href="#__codelineno-25-387">387</a></span>
<span class="normal"><a href="#__codelineno-25-388">388</a></span>
<span class="normal"><a href="#__codelineno-25-389">389</a></span>
<span class="normal"><a href="#__codelineno-25-390">390</a></span>
<span class="normal"><a href="#__codelineno-25-391">391</a></span>
<span class="normal"><a href="#__codelineno-25-392">392</a></span>
<span class="normal"><a href="#__codelineno-25-393">393</a></span>
<span class="normal"><a href="#__codelineno-25-394">394</a></span>
<span class="normal"><a href="#__codelineno-25-395">395</a></span>
<span class="normal"><a href="#__codelineno-25-396">396</a></span>
<span class="normal"><a href="#__codelineno-25-397">397</a></span>
<span class="normal"><a href="#__codelineno-25-398">398</a></span>
<span class="normal"><a href="#__codelineno-25-399">399</a></span>
<span class="normal"><a href="#__codelineno-25-400">400</a></span>
<span class="normal"><a href="#__codelineno-25-401">401</a></span>
<span class="normal"><a href="#__codelineno-25-402">402</a></span>
<span class="normal"><a href="#__codelineno-25-403">403</a></span>
<span class="normal"><a href="#__codelineno-25-404">404</a></span>
<span class="normal"><a href="#__codelineno-25-405">405</a></span>
<span class="normal"><a href="#__codelineno-25-406">406</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-25-326"><a id="__codelineno-25-326" name="__codelineno-25-326"></a><span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">DictConfig</span><span class="p">):</span>
</span><span id="__span-25-327"><a id="__codelineno-25-327" name="__codelineno-25-327"></a>    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">EVAL</span><span class="o">.</span><span class="n">save_outs</span><span class="p">:</span>
</span><span id="__span-25-328"><a id="__codelineno-25-328" name="__codelineno-25-328"></a>        <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">image</span> <span class="k">as</span> <span class="n">Img</span>
</span><span id="__span-25-329"><a id="__codelineno-25-329" name="__codelineno-25-329"></a>
</span><span id="__span-25-330"><a id="__codelineno-25-330" name="__codelineno-25-330"></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"eval_outs"</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-25-331"><a id="__codelineno-25-331" name="__codelineno-25-331"></a>
</span><span id="__span-25-332"><a id="__codelineno-25-332" name="__codelineno-25-332"></a>    <span class="n">ppsci</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">set_random_seed</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
</span><span id="__span-25-333"><a id="__codelineno-25-333" name="__codelineno-25-333"></a>    <span class="c1"># initialize logger</span>
</span><span id="__span-25-334"><a id="__codelineno-25-334" name="__codelineno-25-334"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">init_logger</span><span class="p">(</span><span class="s2">"ppsci"</span><span class="p">,</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"eval.log"</span><span class="p">),</span> <span class="s2">"info"</span><span class="p">)</span>
</span><span id="__span-25-335"><a id="__codelineno-25-335" name="__codelineno-25-335"></a>
</span><span id="__span-25-336"><a id="__codelineno-25-336" name="__codelineno-25-336"></a>    <span class="n">gen_funcs</span> <span class="o">=</span> <span class="n">func_module</span><span class="o">.</span><span class="n">GenFuncs</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">WEIGHT_GEN</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="__span-25-337"><a id="__codelineno-25-337" name="__codelineno-25-337"></a>
</span><span id="__span-25-338"><a id="__codelineno-25-338" name="__codelineno-25-338"></a>    <span class="c1"># load dataset</span>
</span><span id="__span-25-339"><a id="__codelineno-25-339" name="__codelineno-25-339"></a>    <span class="n">dataset_valid</span> <span class="o">=</span> <span class="n">hdf5storage</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">DATASET_PATH_VALID</span><span class="p">)</span>
</span><span id="__span-25-340"><a id="__codelineno-25-340" name="__codelineno-25-340"></a>
</span><span id="__span-25-341"><a id="__codelineno-25-341" name="__codelineno-25-341"></a>    <span class="c1"># define Generator model</span>
</span><span id="__span-25-342"><a id="__codelineno-25-342" name="__codelineno-25-342"></a>    <span class="n">model_gen</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">Generator</span><span class="p">(</span><span class="o">**</span><span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">gen_net</span><span class="p">)</span>
</span><span id="__span-25-343"><a id="__codelineno-25-343" name="__codelineno-25-343"></a>    <span class="n">model_gen</span><span class="o">.</span><span class="n">register_input_transform</span><span class="p">(</span><span class="n">gen_funcs</span><span class="o">.</span><span class="n">transform_in</span><span class="p">)</span>
</span><span id="__span-25-344"><a id="__codelineno-25-344" name="__codelineno-25-344"></a>
</span><span id="__span-25-345"><a id="__codelineno-25-345" name="__codelineno-25-345"></a>    <span class="c1"># define model_list</span>
</span><span id="__span-25-346"><a id="__codelineno-25-346" name="__codelineno-25-346"></a>    <span class="n">model_list</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">ModelList</span><span class="p">((</span><span class="n">model_gen</span><span class="p">,))</span>
</span><span id="__span-25-347"><a id="__codelineno-25-347" name="__codelineno-25-347"></a>
</span><span id="__span-25-348"><a id="__codelineno-25-348" name="__codelineno-25-348"></a>    <span class="c1"># load pretrained model</span>
</span><span id="__span-25-349"><a id="__codelineno-25-349" name="__codelineno-25-349"></a>    <span class="n">save_load</span><span class="o">.</span><span class="n">load_pretrain</span><span class="p">(</span><span class="n">model_list</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">EVAL</span><span class="o">.</span><span class="n">pretrained_model_path</span><span class="p">)</span>
</span><span id="__span-25-350"><a id="__codelineno-25-350" name="__codelineno-25-350"></a>
</span><span id="__span-25-351"><a id="__codelineno-25-351" name="__codelineno-25-351"></a>    <span class="c1"># set validator</span>
</span><span id="__span-25-352"><a id="__codelineno-25-352" name="__codelineno-25-352"></a>    <span class="n">eval_dataloader_cfg</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-25-353"><a id="__codelineno-25-353" name="__codelineno-25-353"></a>        <span class="s2">"dataset"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-25-354"><a id="__codelineno-25-354" name="__codelineno-25-354"></a>            <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"NamedArrayDataset"</span><span class="p">,</span>
</span><span id="__span-25-355"><a id="__codelineno-25-355" name="__codelineno-25-355"></a>            <span class="s2">"input"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-25-356"><a id="__codelineno-25-356" name="__codelineno-25-356"></a>                <span class="s2">"density_low"</span><span class="p">:</span> <span class="n">dataset_valid</span><span class="p">[</span><span class="s2">"density_low"</span><span class="p">],</span>
</span><span id="__span-25-357"><a id="__codelineno-25-357" name="__codelineno-25-357"></a>            <span class="p">},</span>
</span><span id="__span-25-358"><a id="__codelineno-25-358" name="__codelineno-25-358"></a>            <span class="s2">"label"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"density_high"</span><span class="p">:</span> <span class="n">dataset_valid</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">]},</span>
</span><span id="__span-25-359"><a id="__codelineno-25-359" name="__codelineno-25-359"></a>        <span class="p">},</span>
</span><span id="__span-25-360"><a id="__codelineno-25-360" name="__codelineno-25-360"></a>        <span class="s2">"sampler"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-25-361"><a id="__codelineno-25-361" name="__codelineno-25-361"></a>            <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"BatchSampler"</span><span class="p">,</span>
</span><span id="__span-25-362"><a id="__codelineno-25-362" name="__codelineno-25-362"></a>            <span class="s2">"drop_last"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-25-363"><a id="__codelineno-25-363" name="__codelineno-25-363"></a>            <span class="s2">"shuffle"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-25-364"><a id="__codelineno-25-364" name="__codelineno-25-364"></a>        <span class="p">},</span>
</span><span id="__span-25-365"><a id="__codelineno-25-365" name="__codelineno-25-365"></a>        <span class="s2">"batch_size"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-25-366"><a id="__codelineno-25-366" name="__codelineno-25-366"></a>    <span class="p">}</span>
</span><span id="__span-25-367"><a id="__codelineno-25-367" name="__codelineno-25-367"></a>    <span class="n">sup_validator</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">SupervisedValidator</span><span class="p">(</span>
</span><span id="__span-25-368"><a id="__codelineno-25-368" name="__codelineno-25-368"></a>        <span class="n">eval_dataloader_cfg</span><span class="p">,</span>
</span><span id="__span-25-369"><a id="__codelineno-25-369" name="__codelineno-25-369"></a>        <span class="n">ppsci</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">(</span><span class="s2">"mean"</span><span class="p">),</span>
</span><span id="__span-25-370"><a id="__codelineno-25-370" name="__codelineno-25-370"></a>        <span class="p">{</span><span class="s2">"density_high"</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">out</span><span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="s2">"output_gen"</span><span class="p">]},</span>
</span><span id="__span-25-371"><a id="__codelineno-25-371" name="__codelineno-25-371"></a>        <span class="n">metric</span><span class="o">=</span><span class="p">{</span><span class="s2">"metric"</span><span class="p">:</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">L2Rel</span><span class="p">()},</span>
</span><span id="__span-25-372"><a id="__codelineno-25-372" name="__codelineno-25-372"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">"sup_validator_gen"</span><span class="p">,</span>
</span><span id="__span-25-373"><a id="__codelineno-25-373" name="__codelineno-25-373"></a>    <span class="p">)</span>
</span><span id="__span-25-374"><a id="__codelineno-25-374" name="__codelineno-25-374"></a>
</span><span id="__span-25-375"><a id="__codelineno-25-375" name="__codelineno-25-375"></a>    <span class="c1"># customized evalution</span>
</span><span id="__span-25-376"><a id="__codelineno-25-376" name="__codelineno-25-376"></a>    <span class="k">def</span> <span class="nf">scale</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span><span id="__span-25-377"><a id="__codelineno-25-377" name="__codelineno-25-377"></a>        <span class="n">smax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="__span-25-378"><a id="__codelineno-25-378" name="__codelineno-25-378"></a>        <span class="n">smin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="__span-25-379"><a id="__codelineno-25-379" name="__codelineno-25-379"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">smin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">smax</span> <span class="o">-</span> <span class="n">smin</span><span class="p">)</span>
</span><span id="__span-25-380"><a id="__codelineno-25-380" name="__codelineno-25-380"></a>
</span><span id="__span-25-381"><a id="__codelineno-25-381" name="__codelineno-25-381"></a>    <span class="n">eval_mse_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-25-382"><a id="__codelineno-25-382" name="__codelineno-25-382"></a>    <span class="n">eval_psnr_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-25-383"><a id="__codelineno-25-383" name="__codelineno-25-383"></a>    <span class="n">eval_ssim_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-25-384"><a id="__codelineno-25-384" name="__codelineno-25-384"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sup_validator</span><span class="o">.</span><span class="n">data_loader</span><span class="p">):</span>
</span><span id="__span-25-385"><a id="__codelineno-25-385" name="__codelineno-25-385"></a>        <span class="n">output_dict</span> <span class="o">=</span> <span class="n">model_list</span><span class="p">({</span><span class="s2">"density_low"</span><span class="p">:</span> <span class="nb">input</span><span class="p">[</span><span class="s2">"density_low"</span><span class="p">]})</span>
</span><span id="__span-25-386"><a id="__codelineno-25-386" name="__codelineno-25-386"></a>        <span class="n">output_arr</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">output_dict</span><span class="p">[</span><span class="s2">"output_gen"</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))</span>
</span><span id="__span-25-387"><a id="__codelineno-25-387" name="__codelineno-25-387"></a>        <span class="n">target_arr</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))</span>
</span><span id="__span-25-388"><a id="__codelineno-25-388" name="__codelineno-25-388"></a>
</span><span id="__span-25-389"><a id="__codelineno-25-389" name="__codelineno-25-389"></a>        <span class="n">eval_mse</span><span class="p">,</span> <span class="n">eval_psnr</span><span class="p">,</span> <span class="n">eval_ssim</span> <span class="o">=</span> <span class="n">func_module</span><span class="o">.</span><span class="n">evaluate_img</span><span class="p">(</span>
</span><span id="__span-25-390"><a id="__codelineno-25-390" name="__codelineno-25-390"></a>            <span class="n">target_arr</span><span class="p">,</span> <span class="n">output_arr</span>
</span><span id="__span-25-391"><a id="__codelineno-25-391" name="__codelineno-25-391"></a>        <span class="p">)</span>
</span><span id="__span-25-392"><a id="__codelineno-25-392" name="__codelineno-25-392"></a>        <span class="n">eval_mse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eval_mse</span><span class="p">)</span>
</span><span id="__span-25-393"><a id="__codelineno-25-393" name="__codelineno-25-393"></a>        <span class="n">eval_psnr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eval_psnr</span><span class="p">)</span>
</span><span id="__span-25-394"><a id="__codelineno-25-394" name="__codelineno-25-394"></a>        <span class="n">eval_ssim_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eval_ssim</span><span class="p">)</span>
</span><span id="__span-25-395"><a id="__codelineno-25-395" name="__codelineno-25-395"></a>
</span><span id="__span-25-396"><a id="__codelineno-25-396" name="__codelineno-25-396"></a>        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">EVAL</span><span class="o">.</span><span class="n">save_outs</span><span class="p">:</span>
</span><span id="__span-25-397"><a id="__codelineno-25-397" name="__codelineno-25-397"></a>            <span class="n">Img</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span>
</span><span id="__span-25-398"><a id="__codelineno-25-398" name="__codelineno-25-398"></a>                <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"eval_outs"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"out_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.png"</span><span class="p">),</span>
</span><span id="__span-25-399"><a id="__codelineno-25-399" name="__codelineno-25-399"></a>                <span class="n">output_arr</span><span class="p">,</span>
</span><span id="__span-25-400"><a id="__codelineno-25-400" name="__codelineno-25-400"></a>                <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="__span-25-401"><a id="__codelineno-25-401" name="__codelineno-25-401"></a>                <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="__span-25-402"><a id="__codelineno-25-402" name="__codelineno-25-402"></a>                <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span>
</span><span id="__span-25-403"><a id="__codelineno-25-403" name="__codelineno-25-403"></a>            <span class="p">)</span>
</span><span id="__span-25-404"><a id="__codelineno-25-404" name="__codelineno-25-404"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">message</span><span class="p">(</span>
</span><span id="__span-25-405"><a id="__codelineno-25-405" name="__codelineno-25-405"></a>        <span class="sa">f</span><span class="s2">"MSE: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">eval_mse_list</span><span class="p">)</span><span class="si">}</span><span class="s2">, PSNR: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">eval_psnr_list</span><span class="p">)</span><span class="si">}</span><span class="s2">, SSIM: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">eval_ssim_list</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-25-406"><a id="__codelineno-25-406" name="__codelineno-25-406"></a>    <span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>另外，其中：</p>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-396">396</a></span>
<span class="normal"><a href="#__codelineno-26-397">397</a></span>
<span class="normal"><a href="#__codelineno-26-398">398</a></span>
<span class="normal"><a href="#__codelineno-26-399">399</a></span>
<span class="normal"><a href="#__codelineno-26-400">400</a></span>
<span class="normal"><a href="#__codelineno-26-401">401</a></span>
<span class="normal"><a href="#__codelineno-26-402">402</a></span>
<span class="normal"><a href="#__codelineno-26-403">403</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-26-396"><a id="__codelineno-26-396" name="__codelineno-26-396"></a><span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">EVAL</span><span class="o">.</span><span class="n">save_outs</span><span class="p">:</span>
</span><span id="__span-26-397"><a id="__codelineno-26-397" name="__codelineno-26-397"></a>    <span class="n">Img</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span>
</span><span id="__span-26-398"><a id="__codelineno-26-398" name="__codelineno-26-398"></a>        <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"eval_outs"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"out_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.png"</span><span class="p">),</span>
</span><span id="__span-26-399"><a id="__codelineno-26-399" name="__codelineno-26-399"></a>        <span class="n">output_arr</span><span class="p">,</span>
</span><span id="__span-26-400"><a id="__codelineno-26-400" name="__codelineno-26-400"></a>        <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="__span-26-401"><a id="__codelineno-26-401" name="__codelineno-26-401"></a>        <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="__span-26-402"><a id="__codelineno-26-402" name="__codelineno-26-402"></a>        <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span>
</span><span id="__span-26-403"><a id="__codelineno-26-403" name="__codelineno-26-403"></a>    <span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>提供了保存模型输出结果的选择，以便更直观的看出超分后的结果，是否开启由配置文件 <code>EVAL</code> 中的 <code>save_outs</code> 指定：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-91">91</a></span>
<span class="normal"><a href="#__codelineno-27-92">92</a></span>
<span class="normal"><a href="#__codelineno-27-93">93</a></span>
<span class="normal"><a href="#__codelineno-27-94">94</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-27-91"><a id="__codelineno-27-91" name="__codelineno-27-91"></a><span class="w">  </span><span class="nt">checkpoint_path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
</span><span id="__span-27-92"><a id="__codelineno-27-92" name="__codelineno-27-92"></a>
</span><span id="__span-27-93"><a id="__codelineno-27-93" name="__codelineno-27-93"></a><span class="c1"># evaluation settings</span>
</span><span id="__span-27-94"><a id="__codelineno-27-94" name="__codelineno-27-94"></a><span class="nt">EVAL</span><span class="p">:</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="4">4. 完整代码<a class="headerlink" href="#4" title="Permanent link">¶</a></h2>
<p>完整代码包含 PaddleScience 具体训练流程代码 tempoGAN.py 和所有自定义函数代码 functions.py，另外还向 <code>ppsci.arch</code> 添加了网络结构代码 gan.py，一并显示在下面，如果需要自定义网络结构，可以作为参考。</p>
<div class="language-py highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">tempoGAN.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1">  1</a></span>
<span class="normal"><a href="#__codelineno-28-2">  2</a></span>
<span class="normal"><a href="#__codelineno-28-3">  3</a></span>
<span class="normal"><a href="#__codelineno-28-4">  4</a></span>
<span class="normal"><a href="#__codelineno-28-5">  5</a></span>
<span class="normal"><a href="#__codelineno-28-6">  6</a></span>
<span class="normal"><a href="#__codelineno-28-7">  7</a></span>
<span class="normal"><a href="#__codelineno-28-8">  8</a></span>
<span class="normal"><a href="#__codelineno-28-9">  9</a></span>
<span class="normal"><a href="#__codelineno-28-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-28-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-28-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-28-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-28-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-28-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-28-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-28-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-28-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-28-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-28-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-28-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-28-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-28-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-28-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-28-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-28-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-28-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-28-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-28-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-28-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-28-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-28-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-28-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-28-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-28-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-28-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-28-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-28-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-28-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-28-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-28-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-28-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-28-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-28-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-28-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-28-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-28-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-28-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-28-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-28-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-28-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-28-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-28-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-28-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-28-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-28-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-28-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-28-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-28-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-28-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-28-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-28-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-28-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-28-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-28-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-28-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-28-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-28-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-28-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-28-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-28-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-28-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-28-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-28-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-28-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-28-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-28-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-28-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-28-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-28-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-28-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-28-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-28-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-28-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-28-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-28-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-28-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-28-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-28-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-28-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-28-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-28-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-28-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-28-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-28-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-28-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-28-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-28-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-28-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-28-100">100</a></span>
<span class="normal"><a href="#__codelineno-28-101">101</a></span>
<span class="normal"><a href="#__codelineno-28-102">102</a></span>
<span class="normal"><a href="#__codelineno-28-103">103</a></span>
<span class="normal"><a href="#__codelineno-28-104">104</a></span>
<span class="normal"><a href="#__codelineno-28-105">105</a></span>
<span class="normal"><a href="#__codelineno-28-106">106</a></span>
<span class="normal"><a href="#__codelineno-28-107">107</a></span>
<span class="normal"><a href="#__codelineno-28-108">108</a></span>
<span class="normal"><a href="#__codelineno-28-109">109</a></span>
<span class="normal"><a href="#__codelineno-28-110">110</a></span>
<span class="normal"><a href="#__codelineno-28-111">111</a></span>
<span class="normal"><a href="#__codelineno-28-112">112</a></span>
<span class="normal"><a href="#__codelineno-28-113">113</a></span>
<span class="normal"><a href="#__codelineno-28-114">114</a></span>
<span class="normal"><a href="#__codelineno-28-115">115</a></span>
<span class="normal"><a href="#__codelineno-28-116">116</a></span>
<span class="normal"><a href="#__codelineno-28-117">117</a></span>
<span class="normal"><a href="#__codelineno-28-118">118</a></span>
<span class="normal"><a href="#__codelineno-28-119">119</a></span>
<span class="normal"><a href="#__codelineno-28-120">120</a></span>
<span class="normal"><a href="#__codelineno-28-121">121</a></span>
<span class="normal"><a href="#__codelineno-28-122">122</a></span>
<span class="normal"><a href="#__codelineno-28-123">123</a></span>
<span class="normal"><a href="#__codelineno-28-124">124</a></span>
<span class="normal"><a href="#__codelineno-28-125">125</a></span>
<span class="normal"><a href="#__codelineno-28-126">126</a></span>
<span class="normal"><a href="#__codelineno-28-127">127</a></span>
<span class="normal"><a href="#__codelineno-28-128">128</a></span>
<span class="normal"><a href="#__codelineno-28-129">129</a></span>
<span class="normal"><a href="#__codelineno-28-130">130</a></span>
<span class="normal"><a href="#__codelineno-28-131">131</a></span>
<span class="normal"><a href="#__codelineno-28-132">132</a></span>
<span class="normal"><a href="#__codelineno-28-133">133</a></span>
<span class="normal"><a href="#__codelineno-28-134">134</a></span>
<span class="normal"><a href="#__codelineno-28-135">135</a></span>
<span class="normal"><a href="#__codelineno-28-136">136</a></span>
<span class="normal"><a href="#__codelineno-28-137">137</a></span>
<span class="normal"><a href="#__codelineno-28-138">138</a></span>
<span class="normal"><a href="#__codelineno-28-139">139</a></span>
<span class="normal"><a href="#__codelineno-28-140">140</a></span>
<span class="normal"><a href="#__codelineno-28-141">141</a></span>
<span class="normal"><a href="#__codelineno-28-142">142</a></span>
<span class="normal"><a href="#__codelineno-28-143">143</a></span>
<span class="normal"><a href="#__codelineno-28-144">144</a></span>
<span class="normal"><a href="#__codelineno-28-145">145</a></span>
<span class="normal"><a href="#__codelineno-28-146">146</a></span>
<span class="normal"><a href="#__codelineno-28-147">147</a></span>
<span class="normal"><a href="#__codelineno-28-148">148</a></span>
<span class="normal"><a href="#__codelineno-28-149">149</a></span>
<span class="normal"><a href="#__codelineno-28-150">150</a></span>
<span class="normal"><a href="#__codelineno-28-151">151</a></span>
<span class="normal"><a href="#__codelineno-28-152">152</a></span>
<span class="normal"><a href="#__codelineno-28-153">153</a></span>
<span class="normal"><a href="#__codelineno-28-154">154</a></span>
<span class="normal"><a href="#__codelineno-28-155">155</a></span>
<span class="normal"><a href="#__codelineno-28-156">156</a></span>
<span class="normal"><a href="#__codelineno-28-157">157</a></span>
<span class="normal"><a href="#__codelineno-28-158">158</a></span>
<span class="normal"><a href="#__codelineno-28-159">159</a></span>
<span class="normal"><a href="#__codelineno-28-160">160</a></span>
<span class="normal"><a href="#__codelineno-28-161">161</a></span>
<span class="normal"><a href="#__codelineno-28-162">162</a></span>
<span class="normal"><a href="#__codelineno-28-163">163</a></span>
<span class="normal"><a href="#__codelineno-28-164">164</a></span>
<span class="normal"><a href="#__codelineno-28-165">165</a></span>
<span class="normal"><a href="#__codelineno-28-166">166</a></span>
<span class="normal"><a href="#__codelineno-28-167">167</a></span>
<span class="normal"><a href="#__codelineno-28-168">168</a></span>
<span class="normal"><a href="#__codelineno-28-169">169</a></span>
<span class="normal"><a href="#__codelineno-28-170">170</a></span>
<span class="normal"><a href="#__codelineno-28-171">171</a></span>
<span class="normal"><a href="#__codelineno-28-172">172</a></span>
<span class="normal"><a href="#__codelineno-28-173">173</a></span>
<span class="normal"><a href="#__codelineno-28-174">174</a></span>
<span class="normal"><a href="#__codelineno-28-175">175</a></span>
<span class="normal"><a href="#__codelineno-28-176">176</a></span>
<span class="normal"><a href="#__codelineno-28-177">177</a></span>
<span class="normal"><a href="#__codelineno-28-178">178</a></span>
<span class="normal"><a href="#__codelineno-28-179">179</a></span>
<span class="normal"><a href="#__codelineno-28-180">180</a></span>
<span class="normal"><a href="#__codelineno-28-181">181</a></span>
<span class="normal"><a href="#__codelineno-28-182">182</a></span>
<span class="normal"><a href="#__codelineno-28-183">183</a></span>
<span class="normal"><a href="#__codelineno-28-184">184</a></span>
<span class="normal"><a href="#__codelineno-28-185">185</a></span>
<span class="normal"><a href="#__codelineno-28-186">186</a></span>
<span class="normal"><a href="#__codelineno-28-187">187</a></span>
<span class="normal"><a href="#__codelineno-28-188">188</a></span>
<span class="normal"><a href="#__codelineno-28-189">189</a></span>
<span class="normal"><a href="#__codelineno-28-190">190</a></span>
<span class="normal"><a href="#__codelineno-28-191">191</a></span>
<span class="normal"><a href="#__codelineno-28-192">192</a></span>
<span class="normal"><a href="#__codelineno-28-193">193</a></span>
<span class="normal"><a href="#__codelineno-28-194">194</a></span>
<span class="normal"><a href="#__codelineno-28-195">195</a></span>
<span class="normal"><a href="#__codelineno-28-196">196</a></span>
<span class="normal"><a href="#__codelineno-28-197">197</a></span>
<span class="normal"><a href="#__codelineno-28-198">198</a></span>
<span class="normal"><a href="#__codelineno-28-199">199</a></span>
<span class="normal"><a href="#__codelineno-28-200">200</a></span>
<span class="normal"><a href="#__codelineno-28-201">201</a></span>
<span class="normal"><a href="#__codelineno-28-202">202</a></span>
<span class="normal"><a href="#__codelineno-28-203">203</a></span>
<span class="normal"><a href="#__codelineno-28-204">204</a></span>
<span class="normal"><a href="#__codelineno-28-205">205</a></span>
<span class="normal"><a href="#__codelineno-28-206">206</a></span>
<span class="normal"><a href="#__codelineno-28-207">207</a></span>
<span class="normal"><a href="#__codelineno-28-208">208</a></span>
<span class="normal"><a href="#__codelineno-28-209">209</a></span>
<span class="normal"><a href="#__codelineno-28-210">210</a></span>
<span class="normal"><a href="#__codelineno-28-211">211</a></span>
<span class="normal"><a href="#__codelineno-28-212">212</a></span>
<span class="normal"><a href="#__codelineno-28-213">213</a></span>
<span class="normal"><a href="#__codelineno-28-214">214</a></span>
<span class="normal"><a href="#__codelineno-28-215">215</a></span>
<span class="normal"><a href="#__codelineno-28-216">216</a></span>
<span class="normal"><a href="#__codelineno-28-217">217</a></span>
<span class="normal"><a href="#__codelineno-28-218">218</a></span>
<span class="normal"><a href="#__codelineno-28-219">219</a></span>
<span class="normal"><a href="#__codelineno-28-220">220</a></span>
<span class="normal"><a href="#__codelineno-28-221">221</a></span>
<span class="normal"><a href="#__codelineno-28-222">222</a></span>
<span class="normal"><a href="#__codelineno-28-223">223</a></span>
<span class="normal"><a href="#__codelineno-28-224">224</a></span>
<span class="normal"><a href="#__codelineno-28-225">225</a></span>
<span class="normal"><a href="#__codelineno-28-226">226</a></span>
<span class="normal"><a href="#__codelineno-28-227">227</a></span>
<span class="normal"><a href="#__codelineno-28-228">228</a></span>
<span class="normal"><a href="#__codelineno-28-229">229</a></span>
<span class="normal"><a href="#__codelineno-28-230">230</a></span>
<span class="normal"><a href="#__codelineno-28-231">231</a></span>
<span class="normal"><a href="#__codelineno-28-232">232</a></span>
<span class="normal"><a href="#__codelineno-28-233">233</a></span>
<span class="normal"><a href="#__codelineno-28-234">234</a></span>
<span class="normal"><a href="#__codelineno-28-235">235</a></span>
<span class="normal"><a href="#__codelineno-28-236">236</a></span>
<span class="normal"><a href="#__codelineno-28-237">237</a></span>
<span class="normal"><a href="#__codelineno-28-238">238</a></span>
<span class="normal"><a href="#__codelineno-28-239">239</a></span>
<span class="normal"><a href="#__codelineno-28-240">240</a></span>
<span class="normal"><a href="#__codelineno-28-241">241</a></span>
<span class="normal"><a href="#__codelineno-28-242">242</a></span>
<span class="normal"><a href="#__codelineno-28-243">243</a></span>
<span class="normal"><a href="#__codelineno-28-244">244</a></span>
<span class="normal"><a href="#__codelineno-28-245">245</a></span>
<span class="normal"><a href="#__codelineno-28-246">246</a></span>
<span class="normal"><a href="#__codelineno-28-247">247</a></span>
<span class="normal"><a href="#__codelineno-28-248">248</a></span>
<span class="normal"><a href="#__codelineno-28-249">249</a></span>
<span class="normal"><a href="#__codelineno-28-250">250</a></span>
<span class="normal"><a href="#__codelineno-28-251">251</a></span>
<span class="normal"><a href="#__codelineno-28-252">252</a></span>
<span class="normal"><a href="#__codelineno-28-253">253</a></span>
<span class="normal"><a href="#__codelineno-28-254">254</a></span>
<span class="normal"><a href="#__codelineno-28-255">255</a></span>
<span class="normal"><a href="#__codelineno-28-256">256</a></span>
<span class="normal"><a href="#__codelineno-28-257">257</a></span>
<span class="normal"><a href="#__codelineno-28-258">258</a></span>
<span class="normal"><a href="#__codelineno-28-259">259</a></span>
<span class="normal"><a href="#__codelineno-28-260">260</a></span>
<span class="normal"><a href="#__codelineno-28-261">261</a></span>
<span class="normal"><a href="#__codelineno-28-262">262</a></span>
<span class="normal"><a href="#__codelineno-28-263">263</a></span>
<span class="normal"><a href="#__codelineno-28-264">264</a></span>
<span class="normal"><a href="#__codelineno-28-265">265</a></span>
<span class="normal"><a href="#__codelineno-28-266">266</a></span>
<span class="normal"><a href="#__codelineno-28-267">267</a></span>
<span class="normal"><a href="#__codelineno-28-268">268</a></span>
<span class="normal"><a href="#__codelineno-28-269">269</a></span>
<span class="normal"><a href="#__codelineno-28-270">270</a></span>
<span class="normal"><a href="#__codelineno-28-271">271</a></span>
<span class="normal"><a href="#__codelineno-28-272">272</a></span>
<span class="normal"><a href="#__codelineno-28-273">273</a></span>
<span class="normal"><a href="#__codelineno-28-274">274</a></span>
<span class="normal"><a href="#__codelineno-28-275">275</a></span>
<span class="normal"><a href="#__codelineno-28-276">276</a></span>
<span class="normal"><a href="#__codelineno-28-277">277</a></span>
<span class="normal"><a href="#__codelineno-28-278">278</a></span>
<span class="normal"><a href="#__codelineno-28-279">279</a></span>
<span class="normal"><a href="#__codelineno-28-280">280</a></span>
<span class="normal"><a href="#__codelineno-28-281">281</a></span>
<span class="normal"><a href="#__codelineno-28-282">282</a></span>
<span class="normal"><a href="#__codelineno-28-283">283</a></span>
<span class="normal"><a href="#__codelineno-28-284">284</a></span>
<span class="normal"><a href="#__codelineno-28-285">285</a></span>
<span class="normal"><a href="#__codelineno-28-286">286</a></span>
<span class="normal"><a href="#__codelineno-28-287">287</a></span>
<span class="normal"><a href="#__codelineno-28-288">288</a></span>
<span class="normal"><a href="#__codelineno-28-289">289</a></span>
<span class="normal"><a href="#__codelineno-28-290">290</a></span>
<span class="normal"><a href="#__codelineno-28-291">291</a></span>
<span class="normal"><a href="#__codelineno-28-292">292</a></span>
<span class="normal"><a href="#__codelineno-28-293">293</a></span>
<span class="normal"><a href="#__codelineno-28-294">294</a></span>
<span class="normal"><a href="#__codelineno-28-295">295</a></span>
<span class="normal"><a href="#__codelineno-28-296">296</a></span>
<span class="normal"><a href="#__codelineno-28-297">297</a></span>
<span class="normal"><a href="#__codelineno-28-298">298</a></span>
<span class="normal"><a href="#__codelineno-28-299">299</a></span>
<span class="normal"><a href="#__codelineno-28-300">300</a></span>
<span class="normal"><a href="#__codelineno-28-301">301</a></span>
<span class="normal"><a href="#__codelineno-28-302">302</a></span>
<span class="normal"><a href="#__codelineno-28-303">303</a></span>
<span class="normal"><a href="#__codelineno-28-304">304</a></span>
<span class="normal"><a href="#__codelineno-28-305">305</a></span>
<span class="normal"><a href="#__codelineno-28-306">306</a></span>
<span class="normal"><a href="#__codelineno-28-307">307</a></span>
<span class="normal"><a href="#__codelineno-28-308">308</a></span>
<span class="normal"><a href="#__codelineno-28-309">309</a></span>
<span class="normal"><a href="#__codelineno-28-310">310</a></span>
<span class="normal"><a href="#__codelineno-28-311">311</a></span>
<span class="normal"><a href="#__codelineno-28-312">312</a></span>
<span class="normal"><a href="#__codelineno-28-313">313</a></span>
<span class="normal"><a href="#__codelineno-28-314">314</a></span>
<span class="normal"><a href="#__codelineno-28-315">315</a></span>
<span class="normal"><a href="#__codelineno-28-316">316</a></span>
<span class="normal"><a href="#__codelineno-28-317">317</a></span>
<span class="normal"><a href="#__codelineno-28-318">318</a></span>
<span class="normal"><a href="#__codelineno-28-319">319</a></span>
<span class="normal"><a href="#__codelineno-28-320">320</a></span>
<span class="normal"><a href="#__codelineno-28-321">321</a></span>
<span class="normal"><a href="#__codelineno-28-322">322</a></span>
<span class="normal"><a href="#__codelineno-28-323">323</a></span>
<span class="normal"><a href="#__codelineno-28-324">324</a></span>
<span class="normal"><a href="#__codelineno-28-325">325</a></span>
<span class="normal"><a href="#__codelineno-28-326">326</a></span>
<span class="normal"><a href="#__codelineno-28-327">327</a></span>
<span class="normal"><a href="#__codelineno-28-328">328</a></span>
<span class="normal"><a href="#__codelineno-28-329">329</a></span>
<span class="normal"><a href="#__codelineno-28-330">330</a></span>
<span class="normal"><a href="#__codelineno-28-331">331</a></span>
<span class="normal"><a href="#__codelineno-28-332">332</a></span>
<span class="normal"><a href="#__codelineno-28-333">333</a></span>
<span class="normal"><a href="#__codelineno-28-334">334</a></span>
<span class="normal"><a href="#__codelineno-28-335">335</a></span>
<span class="normal"><a href="#__codelineno-28-336">336</a></span>
<span class="normal"><a href="#__codelineno-28-337">337</a></span>
<span class="normal"><a href="#__codelineno-28-338">338</a></span>
<span class="normal"><a href="#__codelineno-28-339">339</a></span>
<span class="normal"><a href="#__codelineno-28-340">340</a></span>
<span class="normal"><a href="#__codelineno-28-341">341</a></span>
<span class="normal"><a href="#__codelineno-28-342">342</a></span>
<span class="normal"><a href="#__codelineno-28-343">343</a></span>
<span class="normal"><a href="#__codelineno-28-344">344</a></span>
<span class="normal"><a href="#__codelineno-28-345">345</a></span>
<span class="normal"><a href="#__codelineno-28-346">346</a></span>
<span class="normal"><a href="#__codelineno-28-347">347</a></span>
<span class="normal"><a href="#__codelineno-28-348">348</a></span>
<span class="normal"><a href="#__codelineno-28-349">349</a></span>
<span class="normal"><a href="#__codelineno-28-350">350</a></span>
<span class="normal"><a href="#__codelineno-28-351">351</a></span>
<span class="normal"><a href="#__codelineno-28-352">352</a></span>
<span class="normal"><a href="#__codelineno-28-353">353</a></span>
<span class="normal"><a href="#__codelineno-28-354">354</a></span>
<span class="normal"><a href="#__codelineno-28-355">355</a></span>
<span class="normal"><a href="#__codelineno-28-356">356</a></span>
<span class="normal"><a href="#__codelineno-28-357">357</a></span>
<span class="normal"><a href="#__codelineno-28-358">358</a></span>
<span class="normal"><a href="#__codelineno-28-359">359</a></span>
<span class="normal"><a href="#__codelineno-28-360">360</a></span>
<span class="normal"><a href="#__codelineno-28-361">361</a></span>
<span class="normal"><a href="#__codelineno-28-362">362</a></span>
<span class="normal"><a href="#__codelineno-28-363">363</a></span>
<span class="normal"><a href="#__codelineno-28-364">364</a></span>
<span class="normal"><a href="#__codelineno-28-365">365</a></span>
<span class="normal"><a href="#__codelineno-28-366">366</a></span>
<span class="normal"><a href="#__codelineno-28-367">367</a></span>
<span class="normal"><a href="#__codelineno-28-368">368</a></span>
<span class="normal"><a href="#__codelineno-28-369">369</a></span>
<span class="normal"><a href="#__codelineno-28-370">370</a></span>
<span class="normal"><a href="#__codelineno-28-371">371</a></span>
<span class="normal"><a href="#__codelineno-28-372">372</a></span>
<span class="normal"><a href="#__codelineno-28-373">373</a></span>
<span class="normal"><a href="#__codelineno-28-374">374</a></span>
<span class="normal"><a href="#__codelineno-28-375">375</a></span>
<span class="normal"><a href="#__codelineno-28-376">376</a></span>
<span class="normal"><a href="#__codelineno-28-377">377</a></span>
<span class="normal"><a href="#__codelineno-28-378">378</a></span>
<span class="normal"><a href="#__codelineno-28-379">379</a></span>
<span class="normal"><a href="#__codelineno-28-380">380</a></span>
<span class="normal"><a href="#__codelineno-28-381">381</a></span>
<span class="normal"><a href="#__codelineno-28-382">382</a></span>
<span class="normal"><a href="#__codelineno-28-383">383</a></span>
<span class="normal"><a href="#__codelineno-28-384">384</a></span>
<span class="normal"><a href="#__codelineno-28-385">385</a></span>
<span class="normal"><a href="#__codelineno-28-386">386</a></span>
<span class="normal"><a href="#__codelineno-28-387">387</a></span>
<span class="normal"><a href="#__codelineno-28-388">388</a></span>
<span class="normal"><a href="#__codelineno-28-389">389</a></span>
<span class="normal"><a href="#__codelineno-28-390">390</a></span>
<span class="normal"><a href="#__codelineno-28-391">391</a></span>
<span class="normal"><a href="#__codelineno-28-392">392</a></span>
<span class="normal"><a href="#__codelineno-28-393">393</a></span>
<span class="normal"><a href="#__codelineno-28-394">394</a></span>
<span class="normal"><a href="#__codelineno-28-395">395</a></span>
<span class="normal"><a href="#__codelineno-28-396">396</a></span>
<span class="normal"><a href="#__codelineno-28-397">397</a></span>
<span class="normal"><a href="#__codelineno-28-398">398</a></span>
<span class="normal"><a href="#__codelineno-28-399">399</a></span>
<span class="normal"><a href="#__codelineno-28-400">400</a></span>
<span class="normal"><a href="#__codelineno-28-401">401</a></span>
<span class="normal"><a href="#__codelineno-28-402">402</a></span>
<span class="normal"><a href="#__codelineno-28-403">403</a></span>
<span class="normal"><a href="#__codelineno-28-404">404</a></span>
<span class="normal"><a href="#__codelineno-28-405">405</a></span>
<span class="normal"><a href="#__codelineno-28-406">406</a></span>
<span class="normal"><a href="#__codelineno-28-407">407</a></span>
<span class="normal"><a href="#__codelineno-28-408">408</a></span>
<span class="normal"><a href="#__codelineno-28-409">409</a></span>
<span class="normal"><a href="#__codelineno-28-410">410</a></span>
<span class="normal"><a href="#__codelineno-28-411">411</a></span>
<span class="normal"><a href="#__codelineno-28-412">412</a></span>
<span class="normal"><a href="#__codelineno-28-413">413</a></span>
<span class="normal"><a href="#__codelineno-28-414">414</a></span>
<span class="normal"><a href="#__codelineno-28-415">415</a></span>
<span class="normal"><a href="#__codelineno-28-416">416</a></span>
<span class="normal"><a href="#__codelineno-28-417">417</a></span>
<span class="normal"><a href="#__codelineno-28-418">418</a></span>
<span class="normal"><a href="#__codelineno-28-419">419</a></span>
<span class="normal"><a href="#__codelineno-28-420">420</a></span>
<span class="normal"><a href="#__codelineno-28-421">421</a></span>
<span class="normal"><a href="#__codelineno-28-422">422</a></span>
<span class="normal"><a href="#__codelineno-28-423">423</a></span>
<span class="normal"><a href="#__codelineno-28-424">424</a></span>
<span class="normal"><a href="#__codelineno-28-425">425</a></span>
<span class="normal"><a href="#__codelineno-28-426">426</a></span>
<span class="normal"><a href="#__codelineno-28-427">427</a></span>
<span class="normal"><a href="#__codelineno-28-428">428</a></span>
<span class="normal"><a href="#__codelineno-28-429">429</a></span>
<span class="normal"><a href="#__codelineno-28-430">430</a></span>
<span class="normal"><a href="#__codelineno-28-431">431</a></span>
<span class="normal"><a href="#__codelineno-28-432">432</a></span>
<span class="normal"><a href="#__codelineno-28-433">433</a></span>
<span class="normal"><a href="#__codelineno-28-434">434</a></span>
<span class="normal"><a href="#__codelineno-28-435">435</a></span>
<span class="normal"><a href="#__codelineno-28-436">436</a></span>
<span class="normal"><a href="#__codelineno-28-437">437</a></span>
<span class="normal"><a href="#__codelineno-28-438">438</a></span>
<span class="normal"><a href="#__codelineno-28-439">439</a></span>
<span class="normal"><a href="#__codelineno-28-440">440</a></span>
<span class="normal"><a href="#__codelineno-28-441">441</a></span>
<span class="normal"><a href="#__codelineno-28-442">442</a></span>
<span class="normal"><a href="#__codelineno-28-443">443</a></span>
<span class="normal"><a href="#__codelineno-28-444">444</a></span>
<span class="normal"><a href="#__codelineno-28-445">445</a></span>
<span class="normal"><a href="#__codelineno-28-446">446</a></span>
<span class="normal"><a href="#__codelineno-28-447">447</a></span>
<span class="normal"><a href="#__codelineno-28-448">448</a></span>
<span class="normal"><a href="#__codelineno-28-449">449</a></span>
<span class="normal"><a href="#__codelineno-28-450">450</a></span>
<span class="normal"><a href="#__codelineno-28-451">451</a></span>
<span class="normal"><a href="#__codelineno-28-452">452</a></span>
<span class="normal"><a href="#__codelineno-28-453">453</a></span>
<span class="normal"><a href="#__codelineno-28-454">454</a></span>
<span class="normal"><a href="#__codelineno-28-455">455</a></span>
<span class="normal"><a href="#__codelineno-28-456">456</a></span>
<span class="normal"><a href="#__codelineno-28-457">457</a></span>
<span class="normal"><a href="#__codelineno-28-458">458</a></span>
<span class="normal"><a href="#__codelineno-28-459">459</a></span>
<span class="normal"><a href="#__codelineno-28-460">460</a></span>
<span class="normal"><a href="#__codelineno-28-461">461</a></span>
<span class="normal"><a href="#__codelineno-28-462">462</a></span>
<span class="normal"><a href="#__codelineno-28-463">463</a></span>
<span class="normal"><a href="#__codelineno-28-464">464</a></span>
<span class="normal"><a href="#__codelineno-28-465">465</a></span>
<span class="normal"><a href="#__codelineno-28-466">466</a></span>
<span class="normal"><a href="#__codelineno-28-467">467</a></span>
<span class="normal"><a href="#__codelineno-28-468">468</a></span>
<span class="normal"><a href="#__codelineno-28-469">469</a></span>
<span class="normal"><a href="#__codelineno-28-470">470</a></span>
<span class="normal"><a href="#__codelineno-28-471">471</a></span>
<span class="normal"><a href="#__codelineno-28-472">472</a></span>
<span class="normal"><a href="#__codelineno-28-473">473</a></span>
<span class="normal"><a href="#__codelineno-28-474">474</a></span>
<span class="normal"><a href="#__codelineno-28-475">475</a></span>
<span class="normal"><a href="#__codelineno-28-476">476</a></span>
<span class="normal"><a href="#__codelineno-28-477">477</a></span>
<span class="normal"><a href="#__codelineno-28-478">478</a></span>
<span class="normal"><a href="#__codelineno-28-479">479</a></span>
<span class="normal"><a href="#__codelineno-28-480">480</a></span>
<span class="normal"><a href="#__codelineno-28-481">481</a></span>
<span class="normal"><a href="#__codelineno-28-482">482</a></span>
<span class="normal"><a href="#__codelineno-28-483">483</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="c1"># Copyright (c) 2023 PaddlePaddle Authors. All Rights Reserved.</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2"></a>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3"></a><span class="c1"># Licensed under the Apache License, Version 2.0 (the "License");</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="c1"># you may not use this file except in compliance with the License.</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5"></a><span class="c1"># You may obtain a copy of the License at</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6"></a>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7"></a><span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8"></a>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9"></a><span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10"></a><span class="c1"># distributed under the License is distributed on an "AS IS" BASIS,</span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11"></a><span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12"></a><span class="c1"># See the License for the specific language governing permissions and</span>
</span><span id="__span-28-13"><a id="__codelineno-28-13" name="__codelineno-28-13"></a><span class="c1"># limitations under the License.</span>
</span><span id="__span-28-14"><a id="__codelineno-28-14" name="__codelineno-28-14"></a>
</span><span id="__span-28-15"><a id="__codelineno-28-15" name="__codelineno-28-15"></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="__span-28-16"><a id="__codelineno-28-16" name="__codelineno-28-16"></a><span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span> <span class="k">as</span> <span class="n">osp</span>
</span><span id="__span-28-17"><a id="__codelineno-28-17" name="__codelineno-28-17"></a>
</span><span id="__span-28-18"><a id="__codelineno-28-18" name="__codelineno-28-18"></a><span class="kn">import</span> <span class="nn">functions</span> <span class="k">as</span> <span class="nn">func_module</span>
</span><span id="__span-28-19"><a id="__codelineno-28-19" name="__codelineno-28-19"></a><span class="kn">import</span> <span class="nn">hydra</span>
</span><span id="__span-28-20"><a id="__codelineno-28-20" name="__codelineno-28-20"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="__span-28-21"><a id="__codelineno-28-21" name="__codelineno-28-21"></a><span class="kn">import</span> <span class="nn">paddle</span>
</span><span id="__span-28-22"><a id="__codelineno-28-22" name="__codelineno-28-22"></a><span class="kn">from</span> <span class="nn">omegaconf</span> <span class="kn">import</span> <span class="n">DictConfig</span>
</span><span id="__span-28-23"><a id="__codelineno-28-23" name="__codelineno-28-23"></a>
</span><span id="__span-28-24"><a id="__codelineno-28-24" name="__codelineno-28-24"></a><span class="kn">import</span> <span class="nn">ppsci</span>
</span><span id="__span-28-25"><a id="__codelineno-28-25" name="__codelineno-28-25"></a><span class="kn">from</span> <span class="nn">ppsci.utils</span> <span class="kn">import</span> <span class="n">checker</span>
</span><span id="__span-28-26"><a id="__codelineno-28-26" name="__codelineno-28-26"></a><span class="kn">from</span> <span class="nn">ppsci.utils</span> <span class="kn">import</span> <span class="n">logger</span>
</span><span id="__span-28-27"><a id="__codelineno-28-27" name="__codelineno-28-27"></a><span class="kn">from</span> <span class="nn">ppsci.utils</span> <span class="kn">import</span> <span class="n">save_load</span>
</span><span id="__span-28-28"><a id="__codelineno-28-28" name="__codelineno-28-28"></a>
</span><span id="__span-28-29"><a id="__codelineno-28-29" name="__codelineno-28-29"></a><span class="k">if</span> <span class="ow">not</span> <span class="n">checker</span><span class="o">.</span><span class="n">dynamic_import_to_globals</span><span class="p">(</span><span class="s2">"hdf5storage"</span><span class="p">):</span>
</span><span id="__span-28-30"><a id="__codelineno-28-30" name="__codelineno-28-30"></a>    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
</span><span id="__span-28-31"><a id="__codelineno-28-31" name="__codelineno-28-31"></a>        <span class="s2">"Could not import hdf5storage python package. "</span>
</span><span id="__span-28-32"><a id="__codelineno-28-32" name="__codelineno-28-32"></a>        <span class="s2">"Please install it with `pip install hdf5storage`."</span>
</span><span id="__span-28-33"><a id="__codelineno-28-33" name="__codelineno-28-33"></a>    <span class="p">)</span>
</span><span id="__span-28-34"><a id="__codelineno-28-34" name="__codelineno-28-34"></a><span class="kn">import</span> <span class="nn">hdf5storage</span>
</span><span id="__span-28-35"><a id="__codelineno-28-35" name="__codelineno-28-35"></a>
</span><span id="__span-28-36"><a id="__codelineno-28-36" name="__codelineno-28-36"></a>
</span><span id="__span-28-37"><a id="__codelineno-28-37" name="__codelineno-28-37"></a><span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">DictConfig</span><span class="p">):</span>
</span><span id="__span-28-38"><a id="__codelineno-28-38" name="__codelineno-28-38"></a>    <span class="n">ppsci</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">set_random_seed</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
</span><span id="__span-28-39"><a id="__codelineno-28-39" name="__codelineno-28-39"></a>    <span class="c1"># initialize logger</span>
</span><span id="__span-28-40"><a id="__codelineno-28-40" name="__codelineno-28-40"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">init_logger</span><span class="p">(</span><span class="s2">"ppsci"</span><span class="p">,</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"train.log"</span><span class="p">),</span> <span class="s2">"info"</span><span class="p">)</span>
</span><span id="__span-28-41"><a id="__codelineno-28-41" name="__codelineno-28-41"></a>
</span><span id="__span-28-42"><a id="__codelineno-28-42" name="__codelineno-28-42"></a>    <span class="n">gen_funcs</span> <span class="o">=</span> <span class="n">func_module</span><span class="o">.</span><span class="n">GenFuncs</span><span class="p">(</span>
</span><span id="__span-28-43"><a id="__codelineno-28-43" name="__codelineno-28-43"></a>        <span class="n">cfg</span><span class="o">.</span><span class="n">WEIGHT_GEN</span><span class="p">,</span> <span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">WEIGHT_GEN_LAYER</span> <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">USE_SPATIALDISC</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="__span-28-44"><a id="__codelineno-28-44" name="__codelineno-28-44"></a>    <span class="p">)</span>
</span><span id="__span-28-45"><a id="__codelineno-28-45" name="__codelineno-28-45"></a>    <span class="n">disc_funcs</span> <span class="o">=</span> <span class="n">func_module</span><span class="o">.</span><span class="n">DiscFuncs</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">WEIGHT_DISC</span><span class="p">)</span>
</span><span id="__span-28-46"><a id="__codelineno-28-46" name="__codelineno-28-46"></a>    <span class="n">data_funcs</span> <span class="o">=</span> <span class="n">func_module</span><span class="o">.</span><span class="n">DataFuncs</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">TILE_RATIO</span><span class="p">)</span>
</span><span id="__span-28-47"><a id="__codelineno-28-47" name="__codelineno-28-47"></a>
</span><span id="__span-28-48"><a id="__codelineno-28-48" name="__codelineno-28-48"></a>    <span class="c1"># load dataset</span>
</span><span id="__span-28-49"><a id="__codelineno-28-49" name="__codelineno-28-49"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">message</span><span class="p">(</span>
</span><span id="__span-28-50"><a id="__codelineno-28-50" name="__codelineno-28-50"></a>        <span class="s2">"Attention! Start loading datasets, this will take tens of seconds to several minutes, please wait patiently."</span>
</span><span id="__span-28-51"><a id="__codelineno-28-51" name="__codelineno-28-51"></a>    <span class="p">)</span>
</span><span id="__span-28-52"><a id="__codelineno-28-52" name="__codelineno-28-52"></a>    <span class="n">dataset_train</span> <span class="o">=</span> <span class="n">hdf5storage</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">DATASET_PATH</span><span class="p">)</span>
</span><span id="__span-28-53"><a id="__codelineno-28-53" name="__codelineno-28-53"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">"Finish loading training dataset."</span><span class="p">)</span>
</span><span id="__span-28-54"><a id="__codelineno-28-54" name="__codelineno-28-54"></a>    <span class="n">dataset_valid</span> <span class="o">=</span> <span class="n">hdf5storage</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">DATASET_PATH_VALID</span><span class="p">)</span>
</span><span id="__span-28-55"><a id="__codelineno-28-55" name="__codelineno-28-55"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">"Finish loading validation dataset."</span><span class="p">)</span>
</span><span id="__span-28-56"><a id="__codelineno-28-56" name="__codelineno-28-56"></a>
</span><span id="__span-28-57"><a id="__codelineno-28-57" name="__codelineno-28-57"></a>    <span class="c1"># define Generator model</span>
</span><span id="__span-28-58"><a id="__codelineno-28-58" name="__codelineno-28-58"></a>    <span class="n">model_gen</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">Generator</span><span class="p">(</span><span class="o">**</span><span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">gen_net</span><span class="p">)</span>
</span><span id="__span-28-59"><a id="__codelineno-28-59" name="__codelineno-28-59"></a>    <span class="n">model_gen</span><span class="o">.</span><span class="n">register_input_transform</span><span class="p">(</span><span class="n">gen_funcs</span><span class="o">.</span><span class="n">transform_in</span><span class="p">)</span>
</span><span id="__span-28-60"><a id="__codelineno-28-60" name="__codelineno-28-60"></a>    <span class="n">disc_funcs</span><span class="o">.</span><span class="n">model_gen</span> <span class="o">=</span> <span class="n">model_gen</span>
</span><span id="__span-28-61"><a id="__codelineno-28-61" name="__codelineno-28-61"></a>
</span><span id="__span-28-62"><a id="__codelineno-28-62" name="__codelineno-28-62"></a>    <span class="n">model_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">model_gen</span><span class="p">,)</span>
</span><span id="__span-28-63"><a id="__codelineno-28-63" name="__codelineno-28-63"></a>    <span class="c1"># define Discriminators</span>
</span><span id="__span-28-64"><a id="__codelineno-28-64" name="__codelineno-28-64"></a>    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">USE_SPATIALDISC</span><span class="p">:</span>
</span><span id="__span-28-65"><a id="__codelineno-28-65" name="__codelineno-28-65"></a>        <span class="n">model_disc</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">Discriminator</span><span class="p">(</span><span class="o">**</span><span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">disc_net</span><span class="p">)</span>
</span><span id="__span-28-66"><a id="__codelineno-28-66" name="__codelineno-28-66"></a>        <span class="n">model_disc</span><span class="o">.</span><span class="n">register_input_transform</span><span class="p">(</span><span class="n">disc_funcs</span><span class="o">.</span><span class="n">transform_in</span><span class="p">)</span>
</span><span id="__span-28-67"><a id="__codelineno-28-67" name="__codelineno-28-67"></a>        <span class="n">model_tuple</span> <span class="o">+=</span> <span class="p">(</span><span class="n">model_disc</span><span class="p">,)</span>
</span><span id="__span-28-68"><a id="__codelineno-28-68" name="__codelineno-28-68"></a>
</span><span id="__span-28-69"><a id="__codelineno-28-69" name="__codelineno-28-69"></a>    <span class="c1"># define temporal Discriminators</span>
</span><span id="__span-28-70"><a id="__codelineno-28-70" name="__codelineno-28-70"></a>    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">USE_TEMPODISC</span><span class="p">:</span>
</span><span id="__span-28-71"><a id="__codelineno-28-71" name="__codelineno-28-71"></a>        <span class="n">model_disc_tempo</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">Discriminator</span><span class="p">(</span><span class="o">**</span><span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">tempo_net</span><span class="p">)</span>
</span><span id="__span-28-72"><a id="__codelineno-28-72" name="__codelineno-28-72"></a>        <span class="n">model_disc_tempo</span><span class="o">.</span><span class="n">register_input_transform</span><span class="p">(</span><span class="n">disc_funcs</span><span class="o">.</span><span class="n">transform_in_tempo</span><span class="p">)</span>
</span><span id="__span-28-73"><a id="__codelineno-28-73" name="__codelineno-28-73"></a>        <span class="n">model_tuple</span> <span class="o">+=</span> <span class="p">(</span><span class="n">model_disc_tempo</span><span class="p">,)</span>
</span><span id="__span-28-74"><a id="__codelineno-28-74" name="__codelineno-28-74"></a>
</span><span id="__span-28-75"><a id="__codelineno-28-75" name="__codelineno-28-75"></a>    <span class="c1"># define model_list</span>
</span><span id="__span-28-76"><a id="__codelineno-28-76" name="__codelineno-28-76"></a>    <span class="n">model_list</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">ModelList</span><span class="p">(</span><span class="n">model_tuple</span><span class="p">)</span>
</span><span id="__span-28-77"><a id="__codelineno-28-77" name="__codelineno-28-77"></a>
</span><span id="__span-28-78"><a id="__codelineno-28-78" name="__codelineno-28-78"></a>    <span class="c1"># initialize Adam optimizer</span>
</span><span id="__span-28-79"><a id="__codelineno-28-79" name="__codelineno-28-79"></a>    <span class="n">lr_scheduler_gen</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">Step</span><span class="p">(</span>
</span><span id="__span-28-80"><a id="__codelineno-28-80" name="__codelineno-28-80"></a>        <span class="n">step_size</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">epochs</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">lr_scheduler</span>
</span><span id="__span-28-81"><a id="__codelineno-28-81" name="__codelineno-28-81"></a>    <span class="p">)()</span>
</span><span id="__span-28-82"><a id="__codelineno-28-82" name="__codelineno-28-82"></a>    <span class="n">optimizer_gen</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">lr_scheduler_gen</span><span class="p">)(</span><span class="n">model_gen</span><span class="p">)</span>
</span><span id="__span-28-83"><a id="__codelineno-28-83" name="__codelineno-28-83"></a>    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">USE_SPATIALDISC</span><span class="p">:</span>
</span><span id="__span-28-84"><a id="__codelineno-28-84" name="__codelineno-28-84"></a>        <span class="n">lr_scheduler_disc</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">Step</span><span class="p">(</span>
</span><span id="__span-28-85"><a id="__codelineno-28-85" name="__codelineno-28-85"></a>            <span class="n">step_size</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">epochs</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">lr_scheduler</span>
</span><span id="__span-28-86"><a id="__codelineno-28-86" name="__codelineno-28-86"></a>        <span class="p">)()</span>
</span><span id="__span-28-87"><a id="__codelineno-28-87" name="__codelineno-28-87"></a>        <span class="n">optimizer_disc</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">lr_scheduler_disc</span><span class="p">)(</span><span class="n">model_disc</span><span class="p">)</span>
</span><span id="__span-28-88"><a id="__codelineno-28-88" name="__codelineno-28-88"></a>    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">USE_TEMPODISC</span><span class="p">:</span>
</span><span id="__span-28-89"><a id="__codelineno-28-89" name="__codelineno-28-89"></a>        <span class="n">lr_scheduler_disc_tempo</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">Step</span><span class="p">(</span>
</span><span id="__span-28-90"><a id="__codelineno-28-90" name="__codelineno-28-90"></a>            <span class="n">step_size</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">epochs</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">lr_scheduler</span>
</span><span id="__span-28-91"><a id="__codelineno-28-91" name="__codelineno-28-91"></a>        <span class="p">)()</span>
</span><span id="__span-28-92"><a id="__codelineno-28-92" name="__codelineno-28-92"></a>        <span class="n">optimizer_disc_tempo</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">lr_scheduler_disc_tempo</span><span class="p">)(</span>
</span><span id="__span-28-93"><a id="__codelineno-28-93" name="__codelineno-28-93"></a>            <span class="p">(</span><span class="n">model_disc_tempo</span><span class="p">,)</span>
</span><span id="__span-28-94"><a id="__codelineno-28-94" name="__codelineno-28-94"></a>        <span class="p">)</span>
</span><span id="__span-28-95"><a id="__codelineno-28-95" name="__codelineno-28-95"></a>
</span><span id="__span-28-96"><a id="__codelineno-28-96" name="__codelineno-28-96"></a>    <span class="c1"># Generator</span>
</span><span id="__span-28-97"><a id="__codelineno-28-97" name="__codelineno-28-97"></a>    <span class="c1"># manually build constraint(s)</span>
</span><span id="__span-28-98"><a id="__codelineno-28-98" name="__codelineno-28-98"></a>    <span class="n">sup_constraint_gen</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">SupervisedConstraint</span><span class="p">(</span>
</span><span id="__span-28-99"><a id="__codelineno-28-99" name="__codelineno-28-99"></a>        <span class="p">{</span>
</span><span id="__span-28-100"><a id="__codelineno-28-100" name="__codelineno-28-100"></a>            <span class="s2">"dataset"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-101"><a id="__codelineno-28-101" name="__codelineno-28-101"></a>                <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"NamedArrayDataset"</span><span class="p">,</span>
</span><span id="__span-28-102"><a id="__codelineno-28-102" name="__codelineno-28-102"></a>                <span class="s2">"input"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-103"><a id="__codelineno-28-103" name="__codelineno-28-103"></a>                    <span class="s2">"density_low"</span><span class="p">:</span> <span class="n">dataset_train</span><span class="p">[</span><span class="s2">"density_low"</span><span class="p">],</span>
</span><span id="__span-28-104"><a id="__codelineno-28-104" name="__codelineno-28-104"></a>                    <span class="s2">"density_high"</span><span class="p">:</span> <span class="n">dataset_train</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">],</span>
</span><span id="__span-28-105"><a id="__codelineno-28-105" name="__codelineno-28-105"></a>                <span class="p">},</span>
</span><span id="__span-28-106"><a id="__codelineno-28-106" name="__codelineno-28-106"></a>                <span class="s2">"transforms"</span><span class="p">:</span> <span class="p">(</span>
</span><span id="__span-28-107"><a id="__codelineno-28-107" name="__codelineno-28-107"></a>                    <span class="p">{</span>
</span><span id="__span-28-108"><a id="__codelineno-28-108" name="__codelineno-28-108"></a>                        <span class="s2">"FunctionalTransform"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-109"><a id="__codelineno-28-109" name="__codelineno-28-109"></a>                            <span class="s2">"transform_func"</span><span class="p">:</span> <span class="n">data_funcs</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
</span><span id="__span-28-110"><a id="__codelineno-28-110" name="__codelineno-28-110"></a>                        <span class="p">},</span>
</span><span id="__span-28-111"><a id="__codelineno-28-111" name="__codelineno-28-111"></a>                    <span class="p">},</span>
</span><span id="__span-28-112"><a id="__codelineno-28-112" name="__codelineno-28-112"></a>                <span class="p">),</span>
</span><span id="__span-28-113"><a id="__codelineno-28-113" name="__codelineno-28-113"></a>            <span class="p">},</span>
</span><span id="__span-28-114"><a id="__codelineno-28-114" name="__codelineno-28-114"></a>            <span class="s2">"batch_size"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">batch_size</span><span class="o">.</span><span class="n">sup_constraint</span><span class="p">,</span>
</span><span id="__span-28-115"><a id="__codelineno-28-115" name="__codelineno-28-115"></a>            <span class="s2">"sampler"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-116"><a id="__codelineno-28-116" name="__codelineno-28-116"></a>                <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"BatchSampler"</span><span class="p">,</span>
</span><span id="__span-28-117"><a id="__codelineno-28-117" name="__codelineno-28-117"></a>                <span class="s2">"drop_last"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-28-118"><a id="__codelineno-28-118" name="__codelineno-28-118"></a>                <span class="s2">"shuffle"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-28-119"><a id="__codelineno-28-119" name="__codelineno-28-119"></a>            <span class="p">},</span>
</span><span id="__span-28-120"><a id="__codelineno-28-120" name="__codelineno-28-120"></a>        <span class="p">},</span>
</span><span id="__span-28-121"><a id="__codelineno-28-121" name="__codelineno-28-121"></a>        <span class="n">ppsci</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">FunctionalLoss</span><span class="p">(</span><span class="n">gen_funcs</span><span class="o">.</span><span class="n">loss_func_gen</span><span class="p">),</span>
</span><span id="__span-28-122"><a id="__codelineno-28-122" name="__codelineno-28-122"></a>        <span class="p">{</span>
</span><span id="__span-28-123"><a id="__codelineno-28-123" name="__codelineno-28-123"></a>            <span class="s2">"output_gen"</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">out</span><span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="s2">"output_gen"</span><span class="p">],</span>
</span><span id="__span-28-124"><a id="__codelineno-28-124" name="__codelineno-28-124"></a>            <span class="s2">"density_high"</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">out</span><span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">],</span>
</span><span id="__span-28-125"><a id="__codelineno-28-125" name="__codelineno-28-125"></a>        <span class="p">},</span>
</span><span id="__span-28-126"><a id="__codelineno-28-126" name="__codelineno-28-126"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">"sup_constraint_gen"</span><span class="p">,</span>
</span><span id="__span-28-127"><a id="__codelineno-28-127" name="__codelineno-28-127"></a>    <span class="p">)</span>
</span><span id="__span-28-128"><a id="__codelineno-28-128" name="__codelineno-28-128"></a>    <span class="n">constraint_gen</span> <span class="o">=</span> <span class="p">{</span><span class="n">sup_constraint_gen</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">sup_constraint_gen</span><span class="p">}</span>
</span><span id="__span-28-129"><a id="__codelineno-28-129" name="__codelineno-28-129"></a>    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">USE_TEMPODISC</span><span class="p">:</span>
</span><span id="__span-28-130"><a id="__codelineno-28-130" name="__codelineno-28-130"></a>        <span class="n">sup_constraint_gen_tempo</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">SupervisedConstraint</span><span class="p">(</span>
</span><span id="__span-28-131"><a id="__codelineno-28-131" name="__codelineno-28-131"></a>            <span class="p">{</span>
</span><span id="__span-28-132"><a id="__codelineno-28-132" name="__codelineno-28-132"></a>                <span class="s2">"dataset"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-133"><a id="__codelineno-28-133" name="__codelineno-28-133"></a>                    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"NamedArrayDataset"</span><span class="p">,</span>
</span><span id="__span-28-134"><a id="__codelineno-28-134" name="__codelineno-28-134"></a>                    <span class="s2">"input"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-135"><a id="__codelineno-28-135" name="__codelineno-28-135"></a>                        <span class="s2">"density_low"</span><span class="p">:</span> <span class="n">dataset_train</span><span class="p">[</span><span class="s2">"density_low_tempo"</span><span class="p">],</span>
</span><span id="__span-28-136"><a id="__codelineno-28-136" name="__codelineno-28-136"></a>                        <span class="s2">"density_high"</span><span class="p">:</span> <span class="n">dataset_train</span><span class="p">[</span><span class="s2">"density_high_tempo"</span><span class="p">],</span>
</span><span id="__span-28-137"><a id="__codelineno-28-137" name="__codelineno-28-137"></a>                    <span class="p">},</span>
</span><span id="__span-28-138"><a id="__codelineno-28-138" name="__codelineno-28-138"></a>                    <span class="s2">"transforms"</span><span class="p">:</span> <span class="p">(</span>
</span><span id="__span-28-139"><a id="__codelineno-28-139" name="__codelineno-28-139"></a>                        <span class="p">{</span>
</span><span id="__span-28-140"><a id="__codelineno-28-140" name="__codelineno-28-140"></a>                            <span class="s2">"FunctionalTransform"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-141"><a id="__codelineno-28-141" name="__codelineno-28-141"></a>                                <span class="s2">"transform_func"</span><span class="p">:</span> <span class="n">data_funcs</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
</span><span id="__span-28-142"><a id="__codelineno-28-142" name="__codelineno-28-142"></a>                            <span class="p">},</span>
</span><span id="__span-28-143"><a id="__codelineno-28-143" name="__codelineno-28-143"></a>                        <span class="p">},</span>
</span><span id="__span-28-144"><a id="__codelineno-28-144" name="__codelineno-28-144"></a>                    <span class="p">),</span>
</span><span id="__span-28-145"><a id="__codelineno-28-145" name="__codelineno-28-145"></a>                <span class="p">},</span>
</span><span id="__span-28-146"><a id="__codelineno-28-146" name="__codelineno-28-146"></a>                <span class="s2">"batch_size"</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">batch_size</span><span class="o">.</span><span class="n">sup_constraint</span> <span class="o">//</span> <span class="mi">3</span><span class="p">),</span>
</span><span id="__span-28-147"><a id="__codelineno-28-147" name="__codelineno-28-147"></a>                <span class="s2">"sampler"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-148"><a id="__codelineno-28-148" name="__codelineno-28-148"></a>                    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"BatchSampler"</span><span class="p">,</span>
</span><span id="__span-28-149"><a id="__codelineno-28-149" name="__codelineno-28-149"></a>                    <span class="s2">"drop_last"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-28-150"><a id="__codelineno-28-150" name="__codelineno-28-150"></a>                    <span class="s2">"shuffle"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-28-151"><a id="__codelineno-28-151" name="__codelineno-28-151"></a>                <span class="p">},</span>
</span><span id="__span-28-152"><a id="__codelineno-28-152" name="__codelineno-28-152"></a>            <span class="p">},</span>
</span><span id="__span-28-153"><a id="__codelineno-28-153" name="__codelineno-28-153"></a>            <span class="n">ppsci</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">FunctionalLoss</span><span class="p">(</span><span class="n">gen_funcs</span><span class="o">.</span><span class="n">loss_func_gen_tempo</span><span class="p">),</span>
</span><span id="__span-28-154"><a id="__codelineno-28-154" name="__codelineno-28-154"></a>            <span class="p">{</span>
</span><span id="__span-28-155"><a id="__codelineno-28-155" name="__codelineno-28-155"></a>                <span class="s2">"output_gen"</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">out</span><span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="s2">"output_gen"</span><span class="p">],</span>
</span><span id="__span-28-156"><a id="__codelineno-28-156" name="__codelineno-28-156"></a>                <span class="s2">"density_high"</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">out</span><span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">],</span>
</span><span id="__span-28-157"><a id="__codelineno-28-157" name="__codelineno-28-157"></a>            <span class="p">},</span>
</span><span id="__span-28-158"><a id="__codelineno-28-158" name="__codelineno-28-158"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">"sup_constraint_gen_tempo"</span><span class="p">,</span>
</span><span id="__span-28-159"><a id="__codelineno-28-159" name="__codelineno-28-159"></a>        <span class="p">)</span>
</span><span id="__span-28-160"><a id="__codelineno-28-160" name="__codelineno-28-160"></a>        <span class="n">constraint_gen</span><span class="p">[</span><span class="n">sup_constraint_gen_tempo</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sup_constraint_gen_tempo</span>
</span><span id="__span-28-161"><a id="__codelineno-28-161" name="__codelineno-28-161"></a>
</span><span id="__span-28-162"><a id="__codelineno-28-162" name="__codelineno-28-162"></a>    <span class="c1"># Discriminators</span>
</span><span id="__span-28-163"><a id="__codelineno-28-163" name="__codelineno-28-163"></a>    <span class="c1"># manually build constraint(s)</span>
</span><span id="__span-28-164"><a id="__codelineno-28-164" name="__codelineno-28-164"></a>    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">USE_SPATIALDISC</span><span class="p">:</span>
</span><span id="__span-28-165"><a id="__codelineno-28-165" name="__codelineno-28-165"></a>        <span class="n">sup_constraint_disc</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">SupervisedConstraint</span><span class="p">(</span>
</span><span id="__span-28-166"><a id="__codelineno-28-166" name="__codelineno-28-166"></a>            <span class="p">{</span>
</span><span id="__span-28-167"><a id="__codelineno-28-167" name="__codelineno-28-167"></a>                <span class="s2">"dataset"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-168"><a id="__codelineno-28-168" name="__codelineno-28-168"></a>                    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"NamedArrayDataset"</span><span class="p">,</span>
</span><span id="__span-28-169"><a id="__codelineno-28-169" name="__codelineno-28-169"></a>                    <span class="s2">"input"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-170"><a id="__codelineno-28-170" name="__codelineno-28-170"></a>                        <span class="s2">"density_low"</span><span class="p">:</span> <span class="n">dataset_train</span><span class="p">[</span><span class="s2">"density_low"</span><span class="p">],</span>
</span><span id="__span-28-171"><a id="__codelineno-28-171" name="__codelineno-28-171"></a>                        <span class="s2">"density_high"</span><span class="p">:</span> <span class="n">dataset_train</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">],</span>
</span><span id="__span-28-172"><a id="__codelineno-28-172" name="__codelineno-28-172"></a>                    <span class="p">},</span>
</span><span id="__span-28-173"><a id="__codelineno-28-173" name="__codelineno-28-173"></a>                    <span class="s2">"label"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-174"><a id="__codelineno-28-174" name="__codelineno-28-174"></a>                        <span class="s2">"out_disc_from_target"</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="__span-28-175"><a id="__codelineno-28-175" name="__codelineno-28-175"></a>                            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dataset_train</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="__span-28-176"><a id="__codelineno-28-176" name="__codelineno-28-176"></a>                            <span class="n">dtype</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">get_default_dtype</span><span class="p">(),</span>
</span><span id="__span-28-177"><a id="__codelineno-28-177" name="__codelineno-28-177"></a>                        <span class="p">),</span>
</span><span id="__span-28-178"><a id="__codelineno-28-178" name="__codelineno-28-178"></a>                        <span class="s2">"out_disc_from_gen"</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="__span-28-179"><a id="__codelineno-28-179" name="__codelineno-28-179"></a>                            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dataset_train</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="__span-28-180"><a id="__codelineno-28-180" name="__codelineno-28-180"></a>                            <span class="n">dtype</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">get_default_dtype</span><span class="p">(),</span>
</span><span id="__span-28-181"><a id="__codelineno-28-181" name="__codelineno-28-181"></a>                        <span class="p">),</span>
</span><span id="__span-28-182"><a id="__codelineno-28-182" name="__codelineno-28-182"></a>                    <span class="p">},</span>
</span><span id="__span-28-183"><a id="__codelineno-28-183" name="__codelineno-28-183"></a>                    <span class="s2">"transforms"</span><span class="p">:</span> <span class="p">(</span>
</span><span id="__span-28-184"><a id="__codelineno-28-184" name="__codelineno-28-184"></a>                        <span class="p">{</span>
</span><span id="__span-28-185"><a id="__codelineno-28-185" name="__codelineno-28-185"></a>                            <span class="s2">"FunctionalTransform"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-186"><a id="__codelineno-28-186" name="__codelineno-28-186"></a>                                <span class="s2">"transform_func"</span><span class="p">:</span> <span class="n">data_funcs</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
</span><span id="__span-28-187"><a id="__codelineno-28-187" name="__codelineno-28-187"></a>                            <span class="p">},</span>
</span><span id="__span-28-188"><a id="__codelineno-28-188" name="__codelineno-28-188"></a>                        <span class="p">},</span>
</span><span id="__span-28-189"><a id="__codelineno-28-189" name="__codelineno-28-189"></a>                    <span class="p">),</span>
</span><span id="__span-28-190"><a id="__codelineno-28-190" name="__codelineno-28-190"></a>                <span class="p">},</span>
</span><span id="__span-28-191"><a id="__codelineno-28-191" name="__codelineno-28-191"></a>                <span class="s2">"batch_size"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">batch_size</span><span class="o">.</span><span class="n">sup_constraint</span><span class="p">,</span>
</span><span id="__span-28-192"><a id="__codelineno-28-192" name="__codelineno-28-192"></a>                <span class="s2">"sampler"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-193"><a id="__codelineno-28-193" name="__codelineno-28-193"></a>                    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"BatchSampler"</span><span class="p">,</span>
</span><span id="__span-28-194"><a id="__codelineno-28-194" name="__codelineno-28-194"></a>                    <span class="s2">"drop_last"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-28-195"><a id="__codelineno-28-195" name="__codelineno-28-195"></a>                    <span class="s2">"shuffle"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-28-196"><a id="__codelineno-28-196" name="__codelineno-28-196"></a>                <span class="p">},</span>
</span><span id="__span-28-197"><a id="__codelineno-28-197" name="__codelineno-28-197"></a>            <span class="p">},</span>
</span><span id="__span-28-198"><a id="__codelineno-28-198" name="__codelineno-28-198"></a>            <span class="n">ppsci</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">FunctionalLoss</span><span class="p">(</span><span class="n">disc_funcs</span><span class="o">.</span><span class="n">loss_func</span><span class="p">),</span>
</span><span id="__span-28-199"><a id="__codelineno-28-199" name="__codelineno-28-199"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">"sup_constraint_disc"</span><span class="p">,</span>
</span><span id="__span-28-200"><a id="__codelineno-28-200" name="__codelineno-28-200"></a>        <span class="p">)</span>
</span><span id="__span-28-201"><a id="__codelineno-28-201" name="__codelineno-28-201"></a>        <span class="n">constraint_disc</span> <span class="o">=</span> <span class="p">{</span><span class="n">sup_constraint_disc</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">sup_constraint_disc</span><span class="p">}</span>
</span><span id="__span-28-202"><a id="__codelineno-28-202" name="__codelineno-28-202"></a>
</span><span id="__span-28-203"><a id="__codelineno-28-203" name="__codelineno-28-203"></a>    <span class="c1"># temporal Discriminators</span>
</span><span id="__span-28-204"><a id="__codelineno-28-204" name="__codelineno-28-204"></a>    <span class="c1"># manually build constraint(s)</span>
</span><span id="__span-28-205"><a id="__codelineno-28-205" name="__codelineno-28-205"></a>    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">USE_TEMPODISC</span><span class="p">:</span>
</span><span id="__span-28-206"><a id="__codelineno-28-206" name="__codelineno-28-206"></a>        <span class="n">sup_constraint_disc_tempo</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">SupervisedConstraint</span><span class="p">(</span>
</span><span id="__span-28-207"><a id="__codelineno-28-207" name="__codelineno-28-207"></a>            <span class="p">{</span>
</span><span id="__span-28-208"><a id="__codelineno-28-208" name="__codelineno-28-208"></a>                <span class="s2">"dataset"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-209"><a id="__codelineno-28-209" name="__codelineno-28-209"></a>                    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"NamedArrayDataset"</span><span class="p">,</span>
</span><span id="__span-28-210"><a id="__codelineno-28-210" name="__codelineno-28-210"></a>                    <span class="s2">"input"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-211"><a id="__codelineno-28-211" name="__codelineno-28-211"></a>                        <span class="s2">"density_low"</span><span class="p">:</span> <span class="n">dataset_train</span><span class="p">[</span><span class="s2">"density_low_tempo"</span><span class="p">],</span>
</span><span id="__span-28-212"><a id="__codelineno-28-212" name="__codelineno-28-212"></a>                        <span class="s2">"density_high"</span><span class="p">:</span> <span class="n">dataset_train</span><span class="p">[</span><span class="s2">"density_high_tempo"</span><span class="p">],</span>
</span><span id="__span-28-213"><a id="__codelineno-28-213" name="__codelineno-28-213"></a>                    <span class="p">},</span>
</span><span id="__span-28-214"><a id="__codelineno-28-214" name="__codelineno-28-214"></a>                    <span class="s2">"label"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-215"><a id="__codelineno-28-215" name="__codelineno-28-215"></a>                        <span class="s2">"out_disc_tempo_from_target"</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="__span-28-216"><a id="__codelineno-28-216" name="__codelineno-28-216"></a>                            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dataset_train</span><span class="p">[</span><span class="s2">"density_high_tempo"</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="__span-28-217"><a id="__codelineno-28-217" name="__codelineno-28-217"></a>                            <span class="n">dtype</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">get_default_dtype</span><span class="p">(),</span>
</span><span id="__span-28-218"><a id="__codelineno-28-218" name="__codelineno-28-218"></a>                        <span class="p">),</span>
</span><span id="__span-28-219"><a id="__codelineno-28-219" name="__codelineno-28-219"></a>                        <span class="s2">"out_disc_tempo_from_gen"</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="__span-28-220"><a id="__codelineno-28-220" name="__codelineno-28-220"></a>                            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dataset_train</span><span class="p">[</span><span class="s2">"density_high_tempo"</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="__span-28-221"><a id="__codelineno-28-221" name="__codelineno-28-221"></a>                            <span class="n">dtype</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">get_default_dtype</span><span class="p">(),</span>
</span><span id="__span-28-222"><a id="__codelineno-28-222" name="__codelineno-28-222"></a>                        <span class="p">),</span>
</span><span id="__span-28-223"><a id="__codelineno-28-223" name="__codelineno-28-223"></a>                    <span class="p">},</span>
</span><span id="__span-28-224"><a id="__codelineno-28-224" name="__codelineno-28-224"></a>                    <span class="s2">"transforms"</span><span class="p">:</span> <span class="p">(</span>
</span><span id="__span-28-225"><a id="__codelineno-28-225" name="__codelineno-28-225"></a>                        <span class="p">{</span>
</span><span id="__span-28-226"><a id="__codelineno-28-226" name="__codelineno-28-226"></a>                            <span class="s2">"FunctionalTransform"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-227"><a id="__codelineno-28-227" name="__codelineno-28-227"></a>                                <span class="s2">"transform_func"</span><span class="p">:</span> <span class="n">data_funcs</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
</span><span id="__span-28-228"><a id="__codelineno-28-228" name="__codelineno-28-228"></a>                            <span class="p">},</span>
</span><span id="__span-28-229"><a id="__codelineno-28-229" name="__codelineno-28-229"></a>                        <span class="p">},</span>
</span><span id="__span-28-230"><a id="__codelineno-28-230" name="__codelineno-28-230"></a>                    <span class="p">),</span>
</span><span id="__span-28-231"><a id="__codelineno-28-231" name="__codelineno-28-231"></a>                <span class="p">},</span>
</span><span id="__span-28-232"><a id="__codelineno-28-232" name="__codelineno-28-232"></a>                <span class="s2">"batch_size"</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">batch_size</span><span class="o">.</span><span class="n">sup_constraint</span> <span class="o">//</span> <span class="mi">3</span><span class="p">),</span>
</span><span id="__span-28-233"><a id="__codelineno-28-233" name="__codelineno-28-233"></a>                <span class="s2">"sampler"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-234"><a id="__codelineno-28-234" name="__codelineno-28-234"></a>                    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"BatchSampler"</span><span class="p">,</span>
</span><span id="__span-28-235"><a id="__codelineno-28-235" name="__codelineno-28-235"></a>                    <span class="s2">"drop_last"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-28-236"><a id="__codelineno-28-236" name="__codelineno-28-236"></a>                    <span class="s2">"shuffle"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-28-237"><a id="__codelineno-28-237" name="__codelineno-28-237"></a>                <span class="p">},</span>
</span><span id="__span-28-238"><a id="__codelineno-28-238" name="__codelineno-28-238"></a>            <span class="p">},</span>
</span><span id="__span-28-239"><a id="__codelineno-28-239" name="__codelineno-28-239"></a>            <span class="n">ppsci</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">FunctionalLoss</span><span class="p">(</span><span class="n">disc_funcs</span><span class="o">.</span><span class="n">loss_func_tempo</span><span class="p">),</span>
</span><span id="__span-28-240"><a id="__codelineno-28-240" name="__codelineno-28-240"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">"sup_constraint_disc_tempo"</span><span class="p">,</span>
</span><span id="__span-28-241"><a id="__codelineno-28-241" name="__codelineno-28-241"></a>        <span class="p">)</span>
</span><span id="__span-28-242"><a id="__codelineno-28-242" name="__codelineno-28-242"></a>        <span class="n">constraint_disc_tempo</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-28-243"><a id="__codelineno-28-243" name="__codelineno-28-243"></a>            <span class="n">sup_constraint_disc_tempo</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">sup_constraint_disc_tempo</span>
</span><span id="__span-28-244"><a id="__codelineno-28-244" name="__codelineno-28-244"></a>        <span class="p">}</span>
</span><span id="__span-28-245"><a id="__codelineno-28-245" name="__codelineno-28-245"></a>
</span><span id="__span-28-246"><a id="__codelineno-28-246" name="__codelineno-28-246"></a>    <span class="c1"># initialize solver</span>
</span><span id="__span-28-247"><a id="__codelineno-28-247" name="__codelineno-28-247"></a>    <span class="n">solver_gen</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">Solver</span><span class="p">(</span>
</span><span id="__span-28-248"><a id="__codelineno-28-248" name="__codelineno-28-248"></a>        <span class="n">model_list</span><span class="p">,</span>
</span><span id="__span-28-249"><a id="__codelineno-28-249" name="__codelineno-28-249"></a>        <span class="n">constraint_gen</span><span class="p">,</span>
</span><span id="__span-28-250"><a id="__codelineno-28-250" name="__codelineno-28-250"></a>        <span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span>
</span><span id="__span-28-251"><a id="__codelineno-28-251" name="__codelineno-28-251"></a>        <span class="n">optimizer_gen</span><span class="p">,</span>
</span><span id="__span-28-252"><a id="__codelineno-28-252" name="__codelineno-28-252"></a>        <span class="n">lr_scheduler_gen</span><span class="p">,</span>
</span><span id="__span-28-253"><a id="__codelineno-28-253" name="__codelineno-28-253"></a>        <span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">epochs_gen</span><span class="p">,</span>
</span><span id="__span-28-254"><a id="__codelineno-28-254" name="__codelineno-28-254"></a>        <span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">iters_per_epoch</span><span class="p">,</span>
</span><span id="__span-28-255"><a id="__codelineno-28-255" name="__codelineno-28-255"></a>        <span class="n">eval_during_train</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">eval_during_train</span><span class="p">,</span>
</span><span id="__span-28-256"><a id="__codelineno-28-256" name="__codelineno-28-256"></a>        <span class="n">use_amp</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">USE_AMP</span><span class="p">,</span>
</span><span id="__span-28-257"><a id="__codelineno-28-257" name="__codelineno-28-257"></a>        <span class="n">amp_level</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">amp_level</span><span class="p">,</span>
</span><span id="__span-28-258"><a id="__codelineno-28-258" name="__codelineno-28-258"></a>    <span class="p">)</span>
</span><span id="__span-28-259"><a id="__codelineno-28-259" name="__codelineno-28-259"></a>    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">USE_SPATIALDISC</span><span class="p">:</span>
</span><span id="__span-28-260"><a id="__codelineno-28-260" name="__codelineno-28-260"></a>        <span class="n">solver_disc</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">Solver</span><span class="p">(</span>
</span><span id="__span-28-261"><a id="__codelineno-28-261" name="__codelineno-28-261"></a>            <span class="n">model_list</span><span class="p">,</span>
</span><span id="__span-28-262"><a id="__codelineno-28-262" name="__codelineno-28-262"></a>            <span class="n">constraint_disc</span><span class="p">,</span>
</span><span id="__span-28-263"><a id="__codelineno-28-263" name="__codelineno-28-263"></a>            <span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span>
</span><span id="__span-28-264"><a id="__codelineno-28-264" name="__codelineno-28-264"></a>            <span class="n">optimizer_disc</span><span class="p">,</span>
</span><span id="__span-28-265"><a id="__codelineno-28-265" name="__codelineno-28-265"></a>            <span class="n">lr_scheduler_disc</span><span class="p">,</span>
</span><span id="__span-28-266"><a id="__codelineno-28-266" name="__codelineno-28-266"></a>            <span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">epochs_disc</span><span class="p">,</span>
</span><span id="__span-28-267"><a id="__codelineno-28-267" name="__codelineno-28-267"></a>            <span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">iters_per_epoch</span><span class="p">,</span>
</span><span id="__span-28-268"><a id="__codelineno-28-268" name="__codelineno-28-268"></a>            <span class="n">eval_during_train</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">eval_during_train</span><span class="p">,</span>
</span><span id="__span-28-269"><a id="__codelineno-28-269" name="__codelineno-28-269"></a>            <span class="n">use_amp</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">USE_AMP</span><span class="p">,</span>
</span><span id="__span-28-270"><a id="__codelineno-28-270" name="__codelineno-28-270"></a>            <span class="n">amp_level</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">amp_level</span><span class="p">,</span>
</span><span id="__span-28-271"><a id="__codelineno-28-271" name="__codelineno-28-271"></a>        <span class="p">)</span>
</span><span id="__span-28-272"><a id="__codelineno-28-272" name="__codelineno-28-272"></a>    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">USE_TEMPODISC</span><span class="p">:</span>
</span><span id="__span-28-273"><a id="__codelineno-28-273" name="__codelineno-28-273"></a>        <span class="n">solver_disc_tempo</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">Solver</span><span class="p">(</span>
</span><span id="__span-28-274"><a id="__codelineno-28-274" name="__codelineno-28-274"></a>            <span class="n">model_list</span><span class="p">,</span>
</span><span id="__span-28-275"><a id="__codelineno-28-275" name="__codelineno-28-275"></a>            <span class="n">constraint_disc_tempo</span><span class="p">,</span>
</span><span id="__span-28-276"><a id="__codelineno-28-276" name="__codelineno-28-276"></a>            <span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span>
</span><span id="__span-28-277"><a id="__codelineno-28-277" name="__codelineno-28-277"></a>            <span class="n">optimizer_disc_tempo</span><span class="p">,</span>
</span><span id="__span-28-278"><a id="__codelineno-28-278" name="__codelineno-28-278"></a>            <span class="n">lr_scheduler_disc_tempo</span><span class="p">,</span>
</span><span id="__span-28-279"><a id="__codelineno-28-279" name="__codelineno-28-279"></a>            <span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">epochs_disc_tempo</span><span class="p">,</span>
</span><span id="__span-28-280"><a id="__codelineno-28-280" name="__codelineno-28-280"></a>            <span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">iters_per_epoch</span><span class="p">,</span>
</span><span id="__span-28-281"><a id="__codelineno-28-281" name="__codelineno-28-281"></a>            <span class="n">eval_during_train</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">eval_during_train</span><span class="p">,</span>
</span><span id="__span-28-282"><a id="__codelineno-28-282" name="__codelineno-28-282"></a>            <span class="n">use_amp</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">USE_AMP</span><span class="p">,</span>
</span><span id="__span-28-283"><a id="__codelineno-28-283" name="__codelineno-28-283"></a>            <span class="n">amp_level</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">amp_level</span><span class="p">,</span>
</span><span id="__span-28-284"><a id="__codelineno-28-284" name="__codelineno-28-284"></a>        <span class="p">)</span>
</span><span id="__span-28-285"><a id="__codelineno-28-285" name="__codelineno-28-285"></a>
</span><span id="__span-28-286"><a id="__codelineno-28-286" name="__codelineno-28-286"></a>    <span class="n">PRED_INTERVAL</span> <span class="o">=</span> <span class="mi">200</span>
</span><span id="__span-28-287"><a id="__codelineno-28-287" name="__codelineno-28-287"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="__span-28-288"><a id="__codelineno-28-288" name="__codelineno-28-288"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Epoch: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-28-289"><a id="__codelineno-28-289" name="__codelineno-28-289"></a>        <span class="c1"># plotting during training</span>
</span><span id="__span-28-290"><a id="__codelineno-28-290" name="__codelineno-28-290"></a>        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">%</span> <span class="n">PRED_INTERVAL</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">epochs</span><span class="p">:</span>
</span><span id="__span-28-291"><a id="__codelineno-28-291" name="__codelineno-28-291"></a>            <span class="n">func_module</span><span class="o">.</span><span class="n">predict_and_save_plot</span><span class="p">(</span>
</span><span id="__span-28-292"><a id="__codelineno-28-292" name="__codelineno-28-292"></a>                <span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">solver_gen</span><span class="p">,</span> <span class="n">dataset_valid</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">TILE_RATIO</span>
</span><span id="__span-28-293"><a id="__codelineno-28-293" name="__codelineno-28-293"></a>            <span class="p">)</span>
</span><span id="__span-28-294"><a id="__codelineno-28-294" name="__codelineno-28-294"></a>
</span><span id="__span-28-295"><a id="__codelineno-28-295" name="__codelineno-28-295"></a>        <span class="n">disc_funcs</span><span class="o">.</span><span class="n">model_gen</span> <span class="o">=</span> <span class="n">model_gen</span>
</span><span id="__span-28-296"><a id="__codelineno-28-296" name="__codelineno-28-296"></a>        <span class="c1"># train disc, input: (x,y,G(x))</span>
</span><span id="__span-28-297"><a id="__codelineno-28-297" name="__codelineno-28-297"></a>        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">USE_SPATIALDISC</span><span class="p">:</span>
</span><span id="__span-28-298"><a id="__codelineno-28-298" name="__codelineno-28-298"></a>            <span class="n">solver_disc</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="__span-28-299"><a id="__codelineno-28-299" name="__codelineno-28-299"></a>
</span><span id="__span-28-300"><a id="__codelineno-28-300" name="__codelineno-28-300"></a>        <span class="c1"># train disc tempo, input: (y_3,G(x)_3)</span>
</span><span id="__span-28-301"><a id="__codelineno-28-301" name="__codelineno-28-301"></a>        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">USE_TEMPODISC</span><span class="p">:</span>
</span><span id="__span-28-302"><a id="__codelineno-28-302" name="__codelineno-28-302"></a>            <span class="n">solver_disc_tempo</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="__span-28-303"><a id="__codelineno-28-303" name="__codelineno-28-303"></a>
</span><span id="__span-28-304"><a id="__codelineno-28-304" name="__codelineno-28-304"></a>        <span class="c1"># train gen, input: (x,)</span>
</span><span id="__span-28-305"><a id="__codelineno-28-305" name="__codelineno-28-305"></a>        <span class="n">solver_gen</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="__span-28-306"><a id="__codelineno-28-306" name="__codelineno-28-306"></a>
</span><span id="__span-28-307"><a id="__codelineno-28-307" name="__codelineno-28-307"></a>    <span class="c1">############### evaluation for training ###############</span>
</span><span id="__span-28-308"><a id="__codelineno-28-308" name="__codelineno-28-308"></a>    <span class="n">img_target</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-28-309"><a id="__codelineno-28-309" name="__codelineno-28-309"></a>        <span class="n">func_module</span><span class="o">.</span><span class="n">get_image_array</span><span class="p">(</span>
</span><span id="__span-28-310"><a id="__codelineno-28-310" name="__codelineno-28-310"></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"predict"</span><span class="p">,</span> <span class="s2">"target.png"</span><span class="p">)</span>
</span><span id="__span-28-311"><a id="__codelineno-28-311" name="__codelineno-28-311"></a>        <span class="p">)</span>
</span><span id="__span-28-312"><a id="__codelineno-28-312" name="__codelineno-28-312"></a>        <span class="o">/</span> <span class="mf">255.0</span>
</span><span id="__span-28-313"><a id="__codelineno-28-313" name="__codelineno-28-313"></a>    <span class="p">)</span>
</span><span id="__span-28-314"><a id="__codelineno-28-314" name="__codelineno-28-314"></a>    <span class="n">img_pred</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-28-315"><a id="__codelineno-28-315" name="__codelineno-28-315"></a>        <span class="n">func_module</span><span class="o">.</span><span class="n">get_image_array</span><span class="p">(</span>
</span><span id="__span-28-316"><a id="__codelineno-28-316" name="__codelineno-28-316"></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="__span-28-317"><a id="__codelineno-28-317" name="__codelineno-28-317"></a>                <span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"predict"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"pred_epoch_</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">epochs</span><span class="si">}</span><span class="s2">.png"</span>
</span><span id="__span-28-318"><a id="__codelineno-28-318" name="__codelineno-28-318"></a>            <span class="p">)</span>
</span><span id="__span-28-319"><a id="__codelineno-28-319" name="__codelineno-28-319"></a>        <span class="p">)</span>
</span><span id="__span-28-320"><a id="__codelineno-28-320" name="__codelineno-28-320"></a>        <span class="o">/</span> <span class="mf">255.0</span>
</span><span id="__span-28-321"><a id="__codelineno-28-321" name="__codelineno-28-321"></a>    <span class="p">)</span>
</span><span id="__span-28-322"><a id="__codelineno-28-322" name="__codelineno-28-322"></a>    <span class="n">eval_mse</span><span class="p">,</span> <span class="n">eval_psnr</span><span class="p">,</span> <span class="n">eval_ssim</span> <span class="o">=</span> <span class="n">func_module</span><span class="o">.</span><span class="n">evaluate_img</span><span class="p">(</span><span class="n">img_target</span><span class="p">,</span> <span class="n">img_pred</span><span class="p">)</span>
</span><span id="__span-28-323"><a id="__codelineno-28-323" name="__codelineno-28-323"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="sa">f</span><span class="s2">"MSE: </span><span class="si">{</span><span class="n">eval_mse</span><span class="si">}</span><span class="s2">, PSNR: </span><span class="si">{</span><span class="n">eval_psnr</span><span class="si">}</span><span class="s2">, SSIM: </span><span class="si">{</span><span class="n">eval_ssim</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-28-324"><a id="__codelineno-28-324" name="__codelineno-28-324"></a>
</span><span id="__span-28-325"><a id="__codelineno-28-325" name="__codelineno-28-325"></a>
</span><span id="__span-28-326"><a id="__codelineno-28-326" name="__codelineno-28-326"></a><span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">DictConfig</span><span class="p">):</span>
</span><span id="__span-28-327"><a id="__codelineno-28-327" name="__codelineno-28-327"></a>    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">EVAL</span><span class="o">.</span><span class="n">save_outs</span><span class="p">:</span>
</span><span id="__span-28-328"><a id="__codelineno-28-328" name="__codelineno-28-328"></a>        <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">image</span> <span class="k">as</span> <span class="n">Img</span>
</span><span id="__span-28-329"><a id="__codelineno-28-329" name="__codelineno-28-329"></a>
</span><span id="__span-28-330"><a id="__codelineno-28-330" name="__codelineno-28-330"></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"eval_outs"</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-28-331"><a id="__codelineno-28-331" name="__codelineno-28-331"></a>
</span><span id="__span-28-332"><a id="__codelineno-28-332" name="__codelineno-28-332"></a>    <span class="n">ppsci</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">set_random_seed</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
</span><span id="__span-28-333"><a id="__codelineno-28-333" name="__codelineno-28-333"></a>    <span class="c1"># initialize logger</span>
</span><span id="__span-28-334"><a id="__codelineno-28-334" name="__codelineno-28-334"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">init_logger</span><span class="p">(</span><span class="s2">"ppsci"</span><span class="p">,</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"eval.log"</span><span class="p">),</span> <span class="s2">"info"</span><span class="p">)</span>
</span><span id="__span-28-335"><a id="__codelineno-28-335" name="__codelineno-28-335"></a>
</span><span id="__span-28-336"><a id="__codelineno-28-336" name="__codelineno-28-336"></a>    <span class="n">gen_funcs</span> <span class="o">=</span> <span class="n">func_module</span><span class="o">.</span><span class="n">GenFuncs</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">WEIGHT_GEN</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="__span-28-337"><a id="__codelineno-28-337" name="__codelineno-28-337"></a>
</span><span id="__span-28-338"><a id="__codelineno-28-338" name="__codelineno-28-338"></a>    <span class="c1"># load dataset</span>
</span><span id="__span-28-339"><a id="__codelineno-28-339" name="__codelineno-28-339"></a>    <span class="n">dataset_valid</span> <span class="o">=</span> <span class="n">hdf5storage</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">DATASET_PATH_VALID</span><span class="p">)</span>
</span><span id="__span-28-340"><a id="__codelineno-28-340" name="__codelineno-28-340"></a>
</span><span id="__span-28-341"><a id="__codelineno-28-341" name="__codelineno-28-341"></a>    <span class="c1"># define Generator model</span>
</span><span id="__span-28-342"><a id="__codelineno-28-342" name="__codelineno-28-342"></a>    <span class="n">model_gen</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">Generator</span><span class="p">(</span><span class="o">**</span><span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">gen_net</span><span class="p">)</span>
</span><span id="__span-28-343"><a id="__codelineno-28-343" name="__codelineno-28-343"></a>    <span class="n">model_gen</span><span class="o">.</span><span class="n">register_input_transform</span><span class="p">(</span><span class="n">gen_funcs</span><span class="o">.</span><span class="n">transform_in</span><span class="p">)</span>
</span><span id="__span-28-344"><a id="__codelineno-28-344" name="__codelineno-28-344"></a>
</span><span id="__span-28-345"><a id="__codelineno-28-345" name="__codelineno-28-345"></a>    <span class="c1"># define model_list</span>
</span><span id="__span-28-346"><a id="__codelineno-28-346" name="__codelineno-28-346"></a>    <span class="n">model_list</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">ModelList</span><span class="p">((</span><span class="n">model_gen</span><span class="p">,))</span>
</span><span id="__span-28-347"><a id="__codelineno-28-347" name="__codelineno-28-347"></a>
</span><span id="__span-28-348"><a id="__codelineno-28-348" name="__codelineno-28-348"></a>    <span class="c1"># load pretrained model</span>
</span><span id="__span-28-349"><a id="__codelineno-28-349" name="__codelineno-28-349"></a>    <span class="n">save_load</span><span class="o">.</span><span class="n">load_pretrain</span><span class="p">(</span><span class="n">model_list</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">EVAL</span><span class="o">.</span><span class="n">pretrained_model_path</span><span class="p">)</span>
</span><span id="__span-28-350"><a id="__codelineno-28-350" name="__codelineno-28-350"></a>
</span><span id="__span-28-351"><a id="__codelineno-28-351" name="__codelineno-28-351"></a>    <span class="c1"># set validator</span>
</span><span id="__span-28-352"><a id="__codelineno-28-352" name="__codelineno-28-352"></a>    <span class="n">eval_dataloader_cfg</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-28-353"><a id="__codelineno-28-353" name="__codelineno-28-353"></a>        <span class="s2">"dataset"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-354"><a id="__codelineno-28-354" name="__codelineno-28-354"></a>            <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"NamedArrayDataset"</span><span class="p">,</span>
</span><span id="__span-28-355"><a id="__codelineno-28-355" name="__codelineno-28-355"></a>            <span class="s2">"input"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-356"><a id="__codelineno-28-356" name="__codelineno-28-356"></a>                <span class="s2">"density_low"</span><span class="p">:</span> <span class="n">dataset_valid</span><span class="p">[</span><span class="s2">"density_low"</span><span class="p">],</span>
</span><span id="__span-28-357"><a id="__codelineno-28-357" name="__codelineno-28-357"></a>            <span class="p">},</span>
</span><span id="__span-28-358"><a id="__codelineno-28-358" name="__codelineno-28-358"></a>            <span class="s2">"label"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"density_high"</span><span class="p">:</span> <span class="n">dataset_valid</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">]},</span>
</span><span id="__span-28-359"><a id="__codelineno-28-359" name="__codelineno-28-359"></a>        <span class="p">},</span>
</span><span id="__span-28-360"><a id="__codelineno-28-360" name="__codelineno-28-360"></a>        <span class="s2">"sampler"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-361"><a id="__codelineno-28-361" name="__codelineno-28-361"></a>            <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"BatchSampler"</span><span class="p">,</span>
</span><span id="__span-28-362"><a id="__codelineno-28-362" name="__codelineno-28-362"></a>            <span class="s2">"drop_last"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-28-363"><a id="__codelineno-28-363" name="__codelineno-28-363"></a>            <span class="s2">"shuffle"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-28-364"><a id="__codelineno-28-364" name="__codelineno-28-364"></a>        <span class="p">},</span>
</span><span id="__span-28-365"><a id="__codelineno-28-365" name="__codelineno-28-365"></a>        <span class="s2">"batch_size"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-28-366"><a id="__codelineno-28-366" name="__codelineno-28-366"></a>    <span class="p">}</span>
</span><span id="__span-28-367"><a id="__codelineno-28-367" name="__codelineno-28-367"></a>    <span class="n">sup_validator</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">SupervisedValidator</span><span class="p">(</span>
</span><span id="__span-28-368"><a id="__codelineno-28-368" name="__codelineno-28-368"></a>        <span class="n">eval_dataloader_cfg</span><span class="p">,</span>
</span><span id="__span-28-369"><a id="__codelineno-28-369" name="__codelineno-28-369"></a>        <span class="n">ppsci</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">(</span><span class="s2">"mean"</span><span class="p">),</span>
</span><span id="__span-28-370"><a id="__codelineno-28-370" name="__codelineno-28-370"></a>        <span class="p">{</span><span class="s2">"density_high"</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">out</span><span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="s2">"output_gen"</span><span class="p">]},</span>
</span><span id="__span-28-371"><a id="__codelineno-28-371" name="__codelineno-28-371"></a>        <span class="n">metric</span><span class="o">=</span><span class="p">{</span><span class="s2">"metric"</span><span class="p">:</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">L2Rel</span><span class="p">()},</span>
</span><span id="__span-28-372"><a id="__codelineno-28-372" name="__codelineno-28-372"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">"sup_validator_gen"</span><span class="p">,</span>
</span><span id="__span-28-373"><a id="__codelineno-28-373" name="__codelineno-28-373"></a>    <span class="p">)</span>
</span><span id="__span-28-374"><a id="__codelineno-28-374" name="__codelineno-28-374"></a>
</span><span id="__span-28-375"><a id="__codelineno-28-375" name="__codelineno-28-375"></a>    <span class="c1"># customized evalution</span>
</span><span id="__span-28-376"><a id="__codelineno-28-376" name="__codelineno-28-376"></a>    <span class="k">def</span> <span class="nf">scale</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span><span id="__span-28-377"><a id="__codelineno-28-377" name="__codelineno-28-377"></a>        <span class="n">smax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="__span-28-378"><a id="__codelineno-28-378" name="__codelineno-28-378"></a>        <span class="n">smin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="__span-28-379"><a id="__codelineno-28-379" name="__codelineno-28-379"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">smin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">smax</span> <span class="o">-</span> <span class="n">smin</span><span class="p">)</span>
</span><span id="__span-28-380"><a id="__codelineno-28-380" name="__codelineno-28-380"></a>
</span><span id="__span-28-381"><a id="__codelineno-28-381" name="__codelineno-28-381"></a>    <span class="n">eval_mse_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-28-382"><a id="__codelineno-28-382" name="__codelineno-28-382"></a>    <span class="n">eval_psnr_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-28-383"><a id="__codelineno-28-383" name="__codelineno-28-383"></a>    <span class="n">eval_ssim_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-28-384"><a id="__codelineno-28-384" name="__codelineno-28-384"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sup_validator</span><span class="o">.</span><span class="n">data_loader</span><span class="p">):</span>
</span><span id="__span-28-385"><a id="__codelineno-28-385" name="__codelineno-28-385"></a>        <span class="n">output_dict</span> <span class="o">=</span> <span class="n">model_list</span><span class="p">({</span><span class="s2">"density_low"</span><span class="p">:</span> <span class="nb">input</span><span class="p">[</span><span class="s2">"density_low"</span><span class="p">]})</span>
</span><span id="__span-28-386"><a id="__codelineno-28-386" name="__codelineno-28-386"></a>        <span class="n">output_arr</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">output_dict</span><span class="p">[</span><span class="s2">"output_gen"</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))</span>
</span><span id="__span-28-387"><a id="__codelineno-28-387" name="__codelineno-28-387"></a>        <span class="n">target_arr</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))</span>
</span><span id="__span-28-388"><a id="__codelineno-28-388" name="__codelineno-28-388"></a>
</span><span id="__span-28-389"><a id="__codelineno-28-389" name="__codelineno-28-389"></a>        <span class="n">eval_mse</span><span class="p">,</span> <span class="n">eval_psnr</span><span class="p">,</span> <span class="n">eval_ssim</span> <span class="o">=</span> <span class="n">func_module</span><span class="o">.</span><span class="n">evaluate_img</span><span class="p">(</span>
</span><span id="__span-28-390"><a id="__codelineno-28-390" name="__codelineno-28-390"></a>            <span class="n">target_arr</span><span class="p">,</span> <span class="n">output_arr</span>
</span><span id="__span-28-391"><a id="__codelineno-28-391" name="__codelineno-28-391"></a>        <span class="p">)</span>
</span><span id="__span-28-392"><a id="__codelineno-28-392" name="__codelineno-28-392"></a>        <span class="n">eval_mse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eval_mse</span><span class="p">)</span>
</span><span id="__span-28-393"><a id="__codelineno-28-393" name="__codelineno-28-393"></a>        <span class="n">eval_psnr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eval_psnr</span><span class="p">)</span>
</span><span id="__span-28-394"><a id="__codelineno-28-394" name="__codelineno-28-394"></a>        <span class="n">eval_ssim_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eval_ssim</span><span class="p">)</span>
</span><span id="__span-28-395"><a id="__codelineno-28-395" name="__codelineno-28-395"></a>
</span><span id="__span-28-396"><a id="__codelineno-28-396" name="__codelineno-28-396"></a>        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">EVAL</span><span class="o">.</span><span class="n">save_outs</span><span class="p">:</span>
</span><span id="__span-28-397"><a id="__codelineno-28-397" name="__codelineno-28-397"></a>            <span class="n">Img</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span>
</span><span id="__span-28-398"><a id="__codelineno-28-398" name="__codelineno-28-398"></a>                <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"eval_outs"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"out_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.png"</span><span class="p">),</span>
</span><span id="__span-28-399"><a id="__codelineno-28-399" name="__codelineno-28-399"></a>                <span class="n">output_arr</span><span class="p">,</span>
</span><span id="__span-28-400"><a id="__codelineno-28-400" name="__codelineno-28-400"></a>                <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="__span-28-401"><a id="__codelineno-28-401" name="__codelineno-28-401"></a>                <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="__span-28-402"><a id="__codelineno-28-402" name="__codelineno-28-402"></a>                <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span>
</span><span id="__span-28-403"><a id="__codelineno-28-403" name="__codelineno-28-403"></a>            <span class="p">)</span>
</span><span id="__span-28-404"><a id="__codelineno-28-404" name="__codelineno-28-404"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">message</span><span class="p">(</span>
</span><span id="__span-28-405"><a id="__codelineno-28-405" name="__codelineno-28-405"></a>        <span class="sa">f</span><span class="s2">"MSE: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">eval_mse_list</span><span class="p">)</span><span class="si">}</span><span class="s2">, PSNR: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">eval_psnr_list</span><span class="p">)</span><span class="si">}</span><span class="s2">, SSIM: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">eval_ssim_list</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-28-406"><a id="__codelineno-28-406" name="__codelineno-28-406"></a>    <span class="p">)</span>
</span><span id="__span-28-407"><a id="__codelineno-28-407" name="__codelineno-28-407"></a>
</span><span id="__span-28-408"><a id="__codelineno-28-408" name="__codelineno-28-408"></a>
</span><span id="__span-28-409"><a id="__codelineno-28-409" name="__codelineno-28-409"></a><span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">DictConfig</span><span class="p">):</span>
</span><span id="__span-28-410"><a id="__codelineno-28-410" name="__codelineno-28-410"></a>    <span class="kn">from</span> <span class="nn">paddle.static</span> <span class="kn">import</span> <span class="n">InputSpec</span>
</span><span id="__span-28-411"><a id="__codelineno-28-411" name="__codelineno-28-411"></a>
</span><span id="__span-28-412"><a id="__codelineno-28-412" name="__codelineno-28-412"></a>    <span class="c1"># set models</span>
</span><span id="__span-28-413"><a id="__codelineno-28-413" name="__codelineno-28-413"></a>    <span class="n">gen_funcs</span> <span class="o">=</span> <span class="n">func_module</span><span class="o">.</span><span class="n">GenFuncs</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">WEIGHT_GEN</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="__span-28-414"><a id="__codelineno-28-414" name="__codelineno-28-414"></a>    <span class="n">model_gen</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">Generator</span><span class="p">(</span><span class="o">**</span><span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">gen_net</span><span class="p">)</span>
</span><span id="__span-28-415"><a id="__codelineno-28-415" name="__codelineno-28-415"></a>    <span class="n">model_gen</span><span class="o">.</span><span class="n">register_input_transform</span><span class="p">(</span><span class="n">gen_funcs</span><span class="o">.</span><span class="n">transform_in</span><span class="p">)</span>
</span><span id="__span-28-416"><a id="__codelineno-28-416" name="__codelineno-28-416"></a>
</span><span id="__span-28-417"><a id="__codelineno-28-417" name="__codelineno-28-417"></a>    <span class="c1"># define model_list</span>
</span><span id="__span-28-418"><a id="__codelineno-28-418" name="__codelineno-28-418"></a>    <span class="n">model_list</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">ModelList</span><span class="p">((</span><span class="n">model_gen</span><span class="p">,))</span>
</span><span id="__span-28-419"><a id="__codelineno-28-419" name="__codelineno-28-419"></a>
</span><span id="__span-28-420"><a id="__codelineno-28-420" name="__codelineno-28-420"></a>    <span class="c1"># load pretrained model</span>
</span><span id="__span-28-421"><a id="__codelineno-28-421" name="__codelineno-28-421"></a>    <span class="n">solver</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">Solver</span><span class="p">(</span>
</span><span id="__span-28-422"><a id="__codelineno-28-422" name="__codelineno-28-422"></a>        <span class="n">model</span><span class="o">=</span><span class="n">model_list</span><span class="p">,</span> <span class="n">pretrained_model_path</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">INFER</span><span class="o">.</span><span class="n">pretrained_model_path</span>
</span><span id="__span-28-423"><a id="__codelineno-28-423" name="__codelineno-28-423"></a>    <span class="p">)</span>
</span><span id="__span-28-424"><a id="__codelineno-28-424" name="__codelineno-28-424"></a>
</span><span id="__span-28-425"><a id="__codelineno-28-425" name="__codelineno-28-425"></a>    <span class="c1"># export models</span>
</span><span id="__span-28-426"><a id="__codelineno-28-426" name="__codelineno-28-426"></a>    <span class="n">input_spec</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-28-427"><a id="__codelineno-28-427" name="__codelineno-28-427"></a>        <span class="p">{</span><span class="s2">"density_low"</span><span class="p">:</span> <span class="n">InputSpec</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="s2">"float32"</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">"density_low"</span><span class="p">)},</span>
</span><span id="__span-28-428"><a id="__codelineno-28-428" name="__codelineno-28-428"></a>    <span class="p">]</span>
</span><span id="__span-28-429"><a id="__codelineno-28-429" name="__codelineno-28-429"></a>    <span class="n">solver</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">input_spec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">INFER</span><span class="o">.</span><span class="n">export_path</span><span class="p">,</span> <span class="n">skip_prune_program</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-28-430"><a id="__codelineno-28-430" name="__codelineno-28-430"></a>
</span><span id="__span-28-431"><a id="__codelineno-28-431" name="__codelineno-28-431"></a>
</span><span id="__span-28-432"><a id="__codelineno-28-432" name="__codelineno-28-432"></a><span class="k">def</span> <span class="nf">inference</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">DictConfig</span><span class="p">):</span>
</span><span id="__span-28-433"><a id="__codelineno-28-433" name="__codelineno-28-433"></a>    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">image</span> <span class="k">as</span> <span class="n">Img</span>
</span><span id="__span-28-434"><a id="__codelineno-28-434" name="__codelineno-28-434"></a>
</span><span id="__span-28-435"><a id="__codelineno-28-435" name="__codelineno-28-435"></a>    <span class="kn">from</span> <span class="nn">deploy.python_infer</span> <span class="kn">import</span> <span class="n">pinn_predictor</span>
</span><span id="__span-28-436"><a id="__codelineno-28-436" name="__codelineno-28-436"></a>
</span><span id="__span-28-437"><a id="__codelineno-28-437" name="__codelineno-28-437"></a>    <span class="c1"># set model predictor</span>
</span><span id="__span-28-438"><a id="__codelineno-28-438" name="__codelineno-28-438"></a>    <span class="n">predictor</span> <span class="o">=</span> <span class="n">pinn_predictor</span><span class="o">.</span><span class="n">PINNPredictor</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
</span><span id="__span-28-439"><a id="__codelineno-28-439" name="__codelineno-28-439"></a>
</span><span id="__span-28-440"><a id="__codelineno-28-440" name="__codelineno-28-440"></a>    <span class="c1"># load dataset</span>
</span><span id="__span-28-441"><a id="__codelineno-28-441" name="__codelineno-28-441"></a>    <span class="n">dataset_infer</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-28-442"><a id="__codelineno-28-442" name="__codelineno-28-442"></a>        <span class="s2">"density_low"</span><span class="p">:</span> <span class="n">hdf5storage</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">DATASET_PATH_VALID</span><span class="p">)[</span><span class="s2">"density_low"</span><span class="p">]</span>
</span><span id="__span-28-443"><a id="__codelineno-28-443" name="__codelineno-28-443"></a>    <span class="p">}</span>
</span><span id="__span-28-444"><a id="__codelineno-28-444" name="__codelineno-28-444"></a>
</span><span id="__span-28-445"><a id="__codelineno-28-445" name="__codelineno-28-445"></a>    <span class="n">output_dict</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dataset_infer</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">INFER</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="__span-28-446"><a id="__codelineno-28-446" name="__codelineno-28-446"></a>
</span><span id="__span-28-447"><a id="__codelineno-28-447" name="__codelineno-28-447"></a>    <span class="c1"># mapping data to cfg.INFER.output_keys</span>
</span><span id="__span-28-448"><a id="__codelineno-28-448" name="__codelineno-28-448"></a>    <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">output_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">output_dict</span><span class="p">]</span>
</span><span id="__span-28-449"><a id="__codelineno-28-449" name="__codelineno-28-449"></a>
</span><span id="__span-28-450"><a id="__codelineno-28-450" name="__codelineno-28-450"></a>    <span class="k">def</span> <span class="nf">scale</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span><span id="__span-28-451"><a id="__codelineno-28-451" name="__codelineno-28-451"></a>        <span class="n">smax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="__span-28-452"><a id="__codelineno-28-452" name="__codelineno-28-452"></a>        <span class="n">smin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="__span-28-453"><a id="__codelineno-28-453" name="__codelineno-28-453"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">smin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">smax</span> <span class="o">-</span> <span class="n">smin</span><span class="p">)</span>
</span><span id="__span-28-454"><a id="__codelineno-28-454" name="__codelineno-28-454"></a>
</span><span id="__span-28-455"><a id="__codelineno-28-455" name="__codelineno-28-455"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="__span-28-456"><a id="__codelineno-28-456" name="__codelineno-28-456"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
</span><span id="__span-28-457"><a id="__codelineno-28-457" name="__codelineno-28-457"></a>        <span class="n">Img</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span>
</span><span id="__span-28-458"><a id="__codelineno-28-458" name="__codelineno-28-458"></a>            <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"out_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.png"</span><span class="p">),</span>
</span><span id="__span-28-459"><a id="__codelineno-28-459" name="__codelineno-28-459"></a>            <span class="n">img</span><span class="p">,</span>
</span><span id="__span-28-460"><a id="__codelineno-28-460" name="__codelineno-28-460"></a>            <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="__span-28-461"><a id="__codelineno-28-461" name="__codelineno-28-461"></a>            <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="__span-28-462"><a id="__codelineno-28-462" name="__codelineno-28-462"></a>            <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span>
</span><span id="__span-28-463"><a id="__codelineno-28-463" name="__codelineno-28-463"></a>        <span class="p">)</span>
</span><span id="__span-28-464"><a id="__codelineno-28-464" name="__codelineno-28-464"></a>
</span><span id="__span-28-465"><a id="__codelineno-28-465" name="__codelineno-28-465"></a>
</span><span id="__span-28-466"><a id="__codelineno-28-466" name="__codelineno-28-466"></a><span class="nd">@hydra</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">version_base</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config_path</span><span class="o">=</span><span class="s2">"./conf"</span><span class="p">,</span> <span class="n">config_name</span><span class="o">=</span><span class="s2">"tempogan.yaml"</span><span class="p">)</span>
</span><span id="__span-28-467"><a id="__codelineno-28-467" name="__codelineno-28-467"></a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">DictConfig</span><span class="p">):</span>
</span><span id="__span-28-468"><a id="__codelineno-28-468" name="__codelineno-28-468"></a>    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">"train"</span><span class="p">:</span>
</span><span id="__span-28-469"><a id="__codelineno-28-469" name="__codelineno-28-469"></a>        <span class="n">train</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
</span><span id="__span-28-470"><a id="__codelineno-28-470" name="__codelineno-28-470"></a>    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">"eval"</span><span class="p">:</span>
</span><span id="__span-28-471"><a id="__codelineno-28-471" name="__codelineno-28-471"></a>        <span class="n">evaluate</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
</span><span id="__span-28-472"><a id="__codelineno-28-472" name="__codelineno-28-472"></a>    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">"export"</span><span class="p">:</span>
</span><span id="__span-28-473"><a id="__codelineno-28-473" name="__codelineno-28-473"></a>        <span class="n">export</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
</span><span id="__span-28-474"><a id="__codelineno-28-474" name="__codelineno-28-474"></a>    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">"infer"</span><span class="p">:</span>
</span><span id="__span-28-475"><a id="__codelineno-28-475" name="__codelineno-28-475"></a>        <span class="n">inference</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
</span><span id="__span-28-476"><a id="__codelineno-28-476" name="__codelineno-28-476"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-28-477"><a id="__codelineno-28-477" name="__codelineno-28-477"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="__span-28-478"><a id="__codelineno-28-478" name="__codelineno-28-478"></a>            <span class="sa">f</span><span class="s2">"cfg.mode should in ['train', 'eval', 'export', 'infer'], but got '</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">mode</span><span class="si">}</span><span class="s2">'"</span>
</span><span id="__span-28-479"><a id="__codelineno-28-479" name="__codelineno-28-479"></a>        <span class="p">)</span>
</span><span id="__span-28-480"><a id="__codelineno-28-480" name="__codelineno-28-480"></a>
</span><span id="__span-28-481"><a id="__codelineno-28-481" name="__codelineno-28-481"></a>
</span><span id="__span-28-482"><a id="__codelineno-28-482" name="__codelineno-28-482"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
</span><span id="__span-28-483"><a id="__codelineno-28-483" name="__codelineno-28-483"></a>    <span class="n">main</span><span class="p">()</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-py highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">functions.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1">  1</a></span>
<span class="normal"><a href="#__codelineno-29-2">  2</a></span>
<span class="normal"><a href="#__codelineno-29-3">  3</a></span>
<span class="normal"><a href="#__codelineno-29-4">  4</a></span>
<span class="normal"><a href="#__codelineno-29-5">  5</a></span>
<span class="normal"><a href="#__codelineno-29-6">  6</a></span>
<span class="normal"><a href="#__codelineno-29-7">  7</a></span>
<span class="normal"><a href="#__codelineno-29-8">  8</a></span>
<span class="normal"><a href="#__codelineno-29-9">  9</a></span>
<span class="normal"><a href="#__codelineno-29-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-29-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-29-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-29-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-29-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-29-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-29-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-29-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-29-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-29-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-29-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-29-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-29-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-29-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-29-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-29-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-29-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-29-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-29-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-29-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-29-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-29-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-29-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-29-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-29-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-29-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-29-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-29-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-29-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-29-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-29-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-29-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-29-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-29-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-29-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-29-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-29-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-29-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-29-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-29-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-29-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-29-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-29-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-29-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-29-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-29-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-29-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-29-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-29-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-29-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-29-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-29-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-29-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-29-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-29-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-29-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-29-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-29-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-29-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-29-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-29-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-29-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-29-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-29-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-29-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-29-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-29-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-29-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-29-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-29-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-29-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-29-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-29-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-29-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-29-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-29-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-29-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-29-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-29-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-29-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-29-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-29-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-29-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-29-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-29-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-29-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-29-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-29-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-29-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-29-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-29-100">100</a></span>
<span class="normal"><a href="#__codelineno-29-101">101</a></span>
<span class="normal"><a href="#__codelineno-29-102">102</a></span>
<span class="normal"><a href="#__codelineno-29-103">103</a></span>
<span class="normal"><a href="#__codelineno-29-104">104</a></span>
<span class="normal"><a href="#__codelineno-29-105">105</a></span>
<span class="normal"><a href="#__codelineno-29-106">106</a></span>
<span class="normal"><a href="#__codelineno-29-107">107</a></span>
<span class="normal"><a href="#__codelineno-29-108">108</a></span>
<span class="normal"><a href="#__codelineno-29-109">109</a></span>
<span class="normal"><a href="#__codelineno-29-110">110</a></span>
<span class="normal"><a href="#__codelineno-29-111">111</a></span>
<span class="normal"><a href="#__codelineno-29-112">112</a></span>
<span class="normal"><a href="#__codelineno-29-113">113</a></span>
<span class="normal"><a href="#__codelineno-29-114">114</a></span>
<span class="normal"><a href="#__codelineno-29-115">115</a></span>
<span class="normal"><a href="#__codelineno-29-116">116</a></span>
<span class="normal"><a href="#__codelineno-29-117">117</a></span>
<span class="normal"><a href="#__codelineno-29-118">118</a></span>
<span class="normal"><a href="#__codelineno-29-119">119</a></span>
<span class="normal"><a href="#__codelineno-29-120">120</a></span>
<span class="normal"><a href="#__codelineno-29-121">121</a></span>
<span class="normal"><a href="#__codelineno-29-122">122</a></span>
<span class="normal"><a href="#__codelineno-29-123">123</a></span>
<span class="normal"><a href="#__codelineno-29-124">124</a></span>
<span class="normal"><a href="#__codelineno-29-125">125</a></span>
<span class="normal"><a href="#__codelineno-29-126">126</a></span>
<span class="normal"><a href="#__codelineno-29-127">127</a></span>
<span class="normal"><a href="#__codelineno-29-128">128</a></span>
<span class="normal"><a href="#__codelineno-29-129">129</a></span>
<span class="normal"><a href="#__codelineno-29-130">130</a></span>
<span class="normal"><a href="#__codelineno-29-131">131</a></span>
<span class="normal"><a href="#__codelineno-29-132">132</a></span>
<span class="normal"><a href="#__codelineno-29-133">133</a></span>
<span class="normal"><a href="#__codelineno-29-134">134</a></span>
<span class="normal"><a href="#__codelineno-29-135">135</a></span>
<span class="normal"><a href="#__codelineno-29-136">136</a></span>
<span class="normal"><a href="#__codelineno-29-137">137</a></span>
<span class="normal"><a href="#__codelineno-29-138">138</a></span>
<span class="normal"><a href="#__codelineno-29-139">139</a></span>
<span class="normal"><a href="#__codelineno-29-140">140</a></span>
<span class="normal"><a href="#__codelineno-29-141">141</a></span>
<span class="normal"><a href="#__codelineno-29-142">142</a></span>
<span class="normal"><a href="#__codelineno-29-143">143</a></span>
<span class="normal"><a href="#__codelineno-29-144">144</a></span>
<span class="normal"><a href="#__codelineno-29-145">145</a></span>
<span class="normal"><a href="#__codelineno-29-146">146</a></span>
<span class="normal"><a href="#__codelineno-29-147">147</a></span>
<span class="normal"><a href="#__codelineno-29-148">148</a></span>
<span class="normal"><a href="#__codelineno-29-149">149</a></span>
<span class="normal"><a href="#__codelineno-29-150">150</a></span>
<span class="normal"><a href="#__codelineno-29-151">151</a></span>
<span class="normal"><a href="#__codelineno-29-152">152</a></span>
<span class="normal"><a href="#__codelineno-29-153">153</a></span>
<span class="normal"><a href="#__codelineno-29-154">154</a></span>
<span class="normal"><a href="#__codelineno-29-155">155</a></span>
<span class="normal"><a href="#__codelineno-29-156">156</a></span>
<span class="normal"><a href="#__codelineno-29-157">157</a></span>
<span class="normal"><a href="#__codelineno-29-158">158</a></span>
<span class="normal"><a href="#__codelineno-29-159">159</a></span>
<span class="normal"><a href="#__codelineno-29-160">160</a></span>
<span class="normal"><a href="#__codelineno-29-161">161</a></span>
<span class="normal"><a href="#__codelineno-29-162">162</a></span>
<span class="normal"><a href="#__codelineno-29-163">163</a></span>
<span class="normal"><a href="#__codelineno-29-164">164</a></span>
<span class="normal"><a href="#__codelineno-29-165">165</a></span>
<span class="normal"><a href="#__codelineno-29-166">166</a></span>
<span class="normal"><a href="#__codelineno-29-167">167</a></span>
<span class="normal"><a href="#__codelineno-29-168">168</a></span>
<span class="normal"><a href="#__codelineno-29-169">169</a></span>
<span class="normal"><a href="#__codelineno-29-170">170</a></span>
<span class="normal"><a href="#__codelineno-29-171">171</a></span>
<span class="normal"><a href="#__codelineno-29-172">172</a></span>
<span class="normal"><a href="#__codelineno-29-173">173</a></span>
<span class="normal"><a href="#__codelineno-29-174">174</a></span>
<span class="normal"><a href="#__codelineno-29-175">175</a></span>
<span class="normal"><a href="#__codelineno-29-176">176</a></span>
<span class="normal"><a href="#__codelineno-29-177">177</a></span>
<span class="normal"><a href="#__codelineno-29-178">178</a></span>
<span class="normal"><a href="#__codelineno-29-179">179</a></span>
<span class="normal"><a href="#__codelineno-29-180">180</a></span>
<span class="normal"><a href="#__codelineno-29-181">181</a></span>
<span class="normal"><a href="#__codelineno-29-182">182</a></span>
<span class="normal"><a href="#__codelineno-29-183">183</a></span>
<span class="normal"><a href="#__codelineno-29-184">184</a></span>
<span class="normal"><a href="#__codelineno-29-185">185</a></span>
<span class="normal"><a href="#__codelineno-29-186">186</a></span>
<span class="normal"><a href="#__codelineno-29-187">187</a></span>
<span class="normal"><a href="#__codelineno-29-188">188</a></span>
<span class="normal"><a href="#__codelineno-29-189">189</a></span>
<span class="normal"><a href="#__codelineno-29-190">190</a></span>
<span class="normal"><a href="#__codelineno-29-191">191</a></span>
<span class="normal"><a href="#__codelineno-29-192">192</a></span>
<span class="normal"><a href="#__codelineno-29-193">193</a></span>
<span class="normal"><a href="#__codelineno-29-194">194</a></span>
<span class="normal"><a href="#__codelineno-29-195">195</a></span>
<span class="normal"><a href="#__codelineno-29-196">196</a></span>
<span class="normal"><a href="#__codelineno-29-197">197</a></span>
<span class="normal"><a href="#__codelineno-29-198">198</a></span>
<span class="normal"><a href="#__codelineno-29-199">199</a></span>
<span class="normal"><a href="#__codelineno-29-200">200</a></span>
<span class="normal"><a href="#__codelineno-29-201">201</a></span>
<span class="normal"><a href="#__codelineno-29-202">202</a></span>
<span class="normal"><a href="#__codelineno-29-203">203</a></span>
<span class="normal"><a href="#__codelineno-29-204">204</a></span>
<span class="normal"><a href="#__codelineno-29-205">205</a></span>
<span class="normal"><a href="#__codelineno-29-206">206</a></span>
<span class="normal"><a href="#__codelineno-29-207">207</a></span>
<span class="normal"><a href="#__codelineno-29-208">208</a></span>
<span class="normal"><a href="#__codelineno-29-209">209</a></span>
<span class="normal"><a href="#__codelineno-29-210">210</a></span>
<span class="normal"><a href="#__codelineno-29-211">211</a></span>
<span class="normal"><a href="#__codelineno-29-212">212</a></span>
<span class="normal"><a href="#__codelineno-29-213">213</a></span>
<span class="normal"><a href="#__codelineno-29-214">214</a></span>
<span class="normal"><a href="#__codelineno-29-215">215</a></span>
<span class="normal"><a href="#__codelineno-29-216">216</a></span>
<span class="normal"><a href="#__codelineno-29-217">217</a></span>
<span class="normal"><a href="#__codelineno-29-218">218</a></span>
<span class="normal"><a href="#__codelineno-29-219">219</a></span>
<span class="normal"><a href="#__codelineno-29-220">220</a></span>
<span class="normal"><a href="#__codelineno-29-221">221</a></span>
<span class="normal"><a href="#__codelineno-29-222">222</a></span>
<span class="normal"><a href="#__codelineno-29-223">223</a></span>
<span class="normal"><a href="#__codelineno-29-224">224</a></span>
<span class="normal"><a href="#__codelineno-29-225">225</a></span>
<span class="normal"><a href="#__codelineno-29-226">226</a></span>
<span class="normal"><a href="#__codelineno-29-227">227</a></span>
<span class="normal"><a href="#__codelineno-29-228">228</a></span>
<span class="normal"><a href="#__codelineno-29-229">229</a></span>
<span class="normal"><a href="#__codelineno-29-230">230</a></span>
<span class="normal"><a href="#__codelineno-29-231">231</a></span>
<span class="normal"><a href="#__codelineno-29-232">232</a></span>
<span class="normal"><a href="#__codelineno-29-233">233</a></span>
<span class="normal"><a href="#__codelineno-29-234">234</a></span>
<span class="normal"><a href="#__codelineno-29-235">235</a></span>
<span class="normal"><a href="#__codelineno-29-236">236</a></span>
<span class="normal"><a href="#__codelineno-29-237">237</a></span>
<span class="normal"><a href="#__codelineno-29-238">238</a></span>
<span class="normal"><a href="#__codelineno-29-239">239</a></span>
<span class="normal"><a href="#__codelineno-29-240">240</a></span>
<span class="normal"><a href="#__codelineno-29-241">241</a></span>
<span class="normal"><a href="#__codelineno-29-242">242</a></span>
<span class="normal"><a href="#__codelineno-29-243">243</a></span>
<span class="normal"><a href="#__codelineno-29-244">244</a></span>
<span class="normal"><a href="#__codelineno-29-245">245</a></span>
<span class="normal"><a href="#__codelineno-29-246">246</a></span>
<span class="normal"><a href="#__codelineno-29-247">247</a></span>
<span class="normal"><a href="#__codelineno-29-248">248</a></span>
<span class="normal"><a href="#__codelineno-29-249">249</a></span>
<span class="normal"><a href="#__codelineno-29-250">250</a></span>
<span class="normal"><a href="#__codelineno-29-251">251</a></span>
<span class="normal"><a href="#__codelineno-29-252">252</a></span>
<span class="normal"><a href="#__codelineno-29-253">253</a></span>
<span class="normal"><a href="#__codelineno-29-254">254</a></span>
<span class="normal"><a href="#__codelineno-29-255">255</a></span>
<span class="normal"><a href="#__codelineno-29-256">256</a></span>
<span class="normal"><a href="#__codelineno-29-257">257</a></span>
<span class="normal"><a href="#__codelineno-29-258">258</a></span>
<span class="normal"><a href="#__codelineno-29-259">259</a></span>
<span class="normal"><a href="#__codelineno-29-260">260</a></span>
<span class="normal"><a href="#__codelineno-29-261">261</a></span>
<span class="normal"><a href="#__codelineno-29-262">262</a></span>
<span class="normal"><a href="#__codelineno-29-263">263</a></span>
<span class="normal"><a href="#__codelineno-29-264">264</a></span>
<span class="normal"><a href="#__codelineno-29-265">265</a></span>
<span class="normal"><a href="#__codelineno-29-266">266</a></span>
<span class="normal"><a href="#__codelineno-29-267">267</a></span>
<span class="normal"><a href="#__codelineno-29-268">268</a></span>
<span class="normal"><a href="#__codelineno-29-269">269</a></span>
<span class="normal"><a href="#__codelineno-29-270">270</a></span>
<span class="normal"><a href="#__codelineno-29-271">271</a></span>
<span class="normal"><a href="#__codelineno-29-272">272</a></span>
<span class="normal"><a href="#__codelineno-29-273">273</a></span>
<span class="normal"><a href="#__codelineno-29-274">274</a></span>
<span class="normal"><a href="#__codelineno-29-275">275</a></span>
<span class="normal"><a href="#__codelineno-29-276">276</a></span>
<span class="normal"><a href="#__codelineno-29-277">277</a></span>
<span class="normal"><a href="#__codelineno-29-278">278</a></span>
<span class="normal"><a href="#__codelineno-29-279">279</a></span>
<span class="normal"><a href="#__codelineno-29-280">280</a></span>
<span class="normal"><a href="#__codelineno-29-281">281</a></span>
<span class="normal"><a href="#__codelineno-29-282">282</a></span>
<span class="normal"><a href="#__codelineno-29-283">283</a></span>
<span class="normal"><a href="#__codelineno-29-284">284</a></span>
<span class="normal"><a href="#__codelineno-29-285">285</a></span>
<span class="normal"><a href="#__codelineno-29-286">286</a></span>
<span class="normal"><a href="#__codelineno-29-287">287</a></span>
<span class="normal"><a href="#__codelineno-29-288">288</a></span>
<span class="normal"><a href="#__codelineno-29-289">289</a></span>
<span class="normal"><a href="#__codelineno-29-290">290</a></span>
<span class="normal"><a href="#__codelineno-29-291">291</a></span>
<span class="normal"><a href="#__codelineno-29-292">292</a></span>
<span class="normal"><a href="#__codelineno-29-293">293</a></span>
<span class="normal"><a href="#__codelineno-29-294">294</a></span>
<span class="normal"><a href="#__codelineno-29-295">295</a></span>
<span class="normal"><a href="#__codelineno-29-296">296</a></span>
<span class="normal"><a href="#__codelineno-29-297">297</a></span>
<span class="normal"><a href="#__codelineno-29-298">298</a></span>
<span class="normal"><a href="#__codelineno-29-299">299</a></span>
<span class="normal"><a href="#__codelineno-29-300">300</a></span>
<span class="normal"><a href="#__codelineno-29-301">301</a></span>
<span class="normal"><a href="#__codelineno-29-302">302</a></span>
<span class="normal"><a href="#__codelineno-29-303">303</a></span>
<span class="normal"><a href="#__codelineno-29-304">304</a></span>
<span class="normal"><a href="#__codelineno-29-305">305</a></span>
<span class="normal"><a href="#__codelineno-29-306">306</a></span>
<span class="normal"><a href="#__codelineno-29-307">307</a></span>
<span class="normal"><a href="#__codelineno-29-308">308</a></span>
<span class="normal"><a href="#__codelineno-29-309">309</a></span>
<span class="normal"><a href="#__codelineno-29-310">310</a></span>
<span class="normal"><a href="#__codelineno-29-311">311</a></span>
<span class="normal"><a href="#__codelineno-29-312">312</a></span>
<span class="normal"><a href="#__codelineno-29-313">313</a></span>
<span class="normal"><a href="#__codelineno-29-314">314</a></span>
<span class="normal"><a href="#__codelineno-29-315">315</a></span>
<span class="normal"><a href="#__codelineno-29-316">316</a></span>
<span class="normal"><a href="#__codelineno-29-317">317</a></span>
<span class="normal"><a href="#__codelineno-29-318">318</a></span>
<span class="normal"><a href="#__codelineno-29-319">319</a></span>
<span class="normal"><a href="#__codelineno-29-320">320</a></span>
<span class="normal"><a href="#__codelineno-29-321">321</a></span>
<span class="normal"><a href="#__codelineno-29-322">322</a></span>
<span class="normal"><a href="#__codelineno-29-323">323</a></span>
<span class="normal"><a href="#__codelineno-29-324">324</a></span>
<span class="normal"><a href="#__codelineno-29-325">325</a></span>
<span class="normal"><a href="#__codelineno-29-326">326</a></span>
<span class="normal"><a href="#__codelineno-29-327">327</a></span>
<span class="normal"><a href="#__codelineno-29-328">328</a></span>
<span class="normal"><a href="#__codelineno-29-329">329</a></span>
<span class="normal"><a href="#__codelineno-29-330">330</a></span>
<span class="normal"><a href="#__codelineno-29-331">331</a></span>
<span class="normal"><a href="#__codelineno-29-332">332</a></span>
<span class="normal"><a href="#__codelineno-29-333">333</a></span>
<span class="normal"><a href="#__codelineno-29-334">334</a></span>
<span class="normal"><a href="#__codelineno-29-335">335</a></span>
<span class="normal"><a href="#__codelineno-29-336">336</a></span>
<span class="normal"><a href="#__codelineno-29-337">337</a></span>
<span class="normal"><a href="#__codelineno-29-338">338</a></span>
<span class="normal"><a href="#__codelineno-29-339">339</a></span>
<span class="normal"><a href="#__codelineno-29-340">340</a></span>
<span class="normal"><a href="#__codelineno-29-341">341</a></span>
<span class="normal"><a href="#__codelineno-29-342">342</a></span>
<span class="normal"><a href="#__codelineno-29-343">343</a></span>
<span class="normal"><a href="#__codelineno-29-344">344</a></span>
<span class="normal"><a href="#__codelineno-29-345">345</a></span>
<span class="normal"><a href="#__codelineno-29-346">346</a></span>
<span class="normal"><a href="#__codelineno-29-347">347</a></span>
<span class="normal"><a href="#__codelineno-29-348">348</a></span>
<span class="normal"><a href="#__codelineno-29-349">349</a></span>
<span class="normal"><a href="#__codelineno-29-350">350</a></span>
<span class="normal"><a href="#__codelineno-29-351">351</a></span>
<span class="normal"><a href="#__codelineno-29-352">352</a></span>
<span class="normal"><a href="#__codelineno-29-353">353</a></span>
<span class="normal"><a href="#__codelineno-29-354">354</a></span>
<span class="normal"><a href="#__codelineno-29-355">355</a></span>
<span class="normal"><a href="#__codelineno-29-356">356</a></span>
<span class="normal"><a href="#__codelineno-29-357">357</a></span>
<span class="normal"><a href="#__codelineno-29-358">358</a></span>
<span class="normal"><a href="#__codelineno-29-359">359</a></span>
<span class="normal"><a href="#__codelineno-29-360">360</a></span>
<span class="normal"><a href="#__codelineno-29-361">361</a></span>
<span class="normal"><a href="#__codelineno-29-362">362</a></span>
<span class="normal"><a href="#__codelineno-29-363">363</a></span>
<span class="normal"><a href="#__codelineno-29-364">364</a></span>
<span class="normal"><a href="#__codelineno-29-365">365</a></span>
<span class="normal"><a href="#__codelineno-29-366">366</a></span>
<span class="normal"><a href="#__codelineno-29-367">367</a></span>
<span class="normal"><a href="#__codelineno-29-368">368</a></span>
<span class="normal"><a href="#__codelineno-29-369">369</a></span>
<span class="normal"><a href="#__codelineno-29-370">370</a></span>
<span class="normal"><a href="#__codelineno-29-371">371</a></span>
<span class="normal"><a href="#__codelineno-29-372">372</a></span>
<span class="normal"><a href="#__codelineno-29-373">373</a></span>
<span class="normal"><a href="#__codelineno-29-374">374</a></span>
<span class="normal"><a href="#__codelineno-29-375">375</a></span>
<span class="normal"><a href="#__codelineno-29-376">376</a></span>
<span class="normal"><a href="#__codelineno-29-377">377</a></span>
<span class="normal"><a href="#__codelineno-29-378">378</a></span>
<span class="normal"><a href="#__codelineno-29-379">379</a></span>
<span class="normal"><a href="#__codelineno-29-380">380</a></span>
<span class="normal"><a href="#__codelineno-29-381">381</a></span>
<span class="normal"><a href="#__codelineno-29-382">382</a></span>
<span class="normal"><a href="#__codelineno-29-383">383</a></span>
<span class="normal"><a href="#__codelineno-29-384">384</a></span>
<span class="normal"><a href="#__codelineno-29-385">385</a></span>
<span class="normal"><a href="#__codelineno-29-386">386</a></span>
<span class="normal"><a href="#__codelineno-29-387">387</a></span>
<span class="normal"><a href="#__codelineno-29-388">388</a></span>
<span class="normal"><a href="#__codelineno-29-389">389</a></span>
<span class="normal"><a href="#__codelineno-29-390">390</a></span>
<span class="normal"><a href="#__codelineno-29-391">391</a></span>
<span class="normal"><a href="#__codelineno-29-392">392</a></span>
<span class="normal"><a href="#__codelineno-29-393">393</a></span>
<span class="normal"><a href="#__codelineno-29-394">394</a></span>
<span class="normal"><a href="#__codelineno-29-395">395</a></span>
<span class="normal"><a href="#__codelineno-29-396">396</a></span>
<span class="normal"><a href="#__codelineno-29-397">397</a></span>
<span class="normal"><a href="#__codelineno-29-398">398</a></span>
<span class="normal"><a href="#__codelineno-29-399">399</a></span>
<span class="normal"><a href="#__codelineno-29-400">400</a></span>
<span class="normal"><a href="#__codelineno-29-401">401</a></span>
<span class="normal"><a href="#__codelineno-29-402">402</a></span>
<span class="normal"><a href="#__codelineno-29-403">403</a></span>
<span class="normal"><a href="#__codelineno-29-404">404</a></span>
<span class="normal"><a href="#__codelineno-29-405">405</a></span>
<span class="normal"><a href="#__codelineno-29-406">406</a></span>
<span class="normal"><a href="#__codelineno-29-407">407</a></span>
<span class="normal"><a href="#__codelineno-29-408">408</a></span>
<span class="normal"><a href="#__codelineno-29-409">409</a></span>
<span class="normal"><a href="#__codelineno-29-410">410</a></span>
<span class="normal"><a href="#__codelineno-29-411">411</a></span>
<span class="normal"><a href="#__codelineno-29-412">412</a></span>
<span class="normal"><a href="#__codelineno-29-413">413</a></span>
<span class="normal"><a href="#__codelineno-29-414">414</a></span>
<span class="normal"><a href="#__codelineno-29-415">415</a></span>
<span class="normal"><a href="#__codelineno-29-416">416</a></span>
<span class="normal"><a href="#__codelineno-29-417">417</a></span>
<span class="normal"><a href="#__codelineno-29-418">418</a></span>
<span class="normal"><a href="#__codelineno-29-419">419</a></span>
<span class="normal"><a href="#__codelineno-29-420">420</a></span>
<span class="normal"><a href="#__codelineno-29-421">421</a></span>
<span class="normal"><a href="#__codelineno-29-422">422</a></span>
<span class="normal"><a href="#__codelineno-29-423">423</a></span>
<span class="normal"><a href="#__codelineno-29-424">424</a></span>
<span class="normal"><a href="#__codelineno-29-425">425</a></span>
<span class="normal"><a href="#__codelineno-29-426">426</a></span>
<span class="normal"><a href="#__codelineno-29-427">427</a></span>
<span class="normal"><a href="#__codelineno-29-428">428</a></span>
<span class="normal"><a href="#__codelineno-29-429">429</a></span>
<span class="normal"><a href="#__codelineno-29-430">430</a></span>
<span class="normal"><a href="#__codelineno-29-431">431</a></span>
<span class="normal"><a href="#__codelineno-29-432">432</a></span>
<span class="normal"><a href="#__codelineno-29-433">433</a></span>
<span class="normal"><a href="#__codelineno-29-434">434</a></span>
<span class="normal"><a href="#__codelineno-29-435">435</a></span>
<span class="normal"><a href="#__codelineno-29-436">436</a></span>
<span class="normal"><a href="#__codelineno-29-437">437</a></span>
<span class="normal"><a href="#__codelineno-29-438">438</a></span>
<span class="normal"><a href="#__codelineno-29-439">439</a></span>
<span class="normal"><a href="#__codelineno-29-440">440</a></span>
<span class="normal"><a href="#__codelineno-29-441">441</a></span>
<span class="normal"><a href="#__codelineno-29-442">442</a></span>
<span class="normal"><a href="#__codelineno-29-443">443</a></span>
<span class="normal"><a href="#__codelineno-29-444">444</a></span>
<span class="normal"><a href="#__codelineno-29-445">445</a></span>
<span class="normal"><a href="#__codelineno-29-446">446</a></span>
<span class="normal"><a href="#__codelineno-29-447">447</a></span>
<span class="normal"><a href="#__codelineno-29-448">448</a></span>
<span class="normal"><a href="#__codelineno-29-449">449</a></span>
<span class="normal"><a href="#__codelineno-29-450">450</a></span>
<span class="normal"><a href="#__codelineno-29-451">451</a></span>
<span class="normal"><a href="#__codelineno-29-452">452</a></span>
<span class="normal"><a href="#__codelineno-29-453">453</a></span>
<span class="normal"><a href="#__codelineno-29-454">454</a></span>
<span class="normal"><a href="#__codelineno-29-455">455</a></span>
<span class="normal"><a href="#__codelineno-29-456">456</a></span>
<span class="normal"><a href="#__codelineno-29-457">457</a></span>
<span class="normal"><a href="#__codelineno-29-458">458</a></span>
<span class="normal"><a href="#__codelineno-29-459">459</a></span>
<span class="normal"><a href="#__codelineno-29-460">460</a></span>
<span class="normal"><a href="#__codelineno-29-461">461</a></span>
<span class="normal"><a href="#__codelineno-29-462">462</a></span>
<span class="normal"><a href="#__codelineno-29-463">463</a></span>
<span class="normal"><a href="#__codelineno-29-464">464</a></span>
<span class="normal"><a href="#__codelineno-29-465">465</a></span>
<span class="normal"><a href="#__codelineno-29-466">466</a></span>
<span class="normal"><a href="#__codelineno-29-467">467</a></span>
<span class="normal"><a href="#__codelineno-29-468">468</a></span>
<span class="normal"><a href="#__codelineno-29-469">469</a></span>
<span class="normal"><a href="#__codelineno-29-470">470</a></span>
<span class="normal"><a href="#__codelineno-29-471">471</a></span>
<span class="normal"><a href="#__codelineno-29-472">472</a></span>
<span class="normal"><a href="#__codelineno-29-473">473</a></span>
<span class="normal"><a href="#__codelineno-29-474">474</a></span>
<span class="normal"><a href="#__codelineno-29-475">475</a></span>
<span class="normal"><a href="#__codelineno-29-476">476</a></span>
<span class="normal"><a href="#__codelineno-29-477">477</a></span>
<span class="normal"><a href="#__codelineno-29-478">478</a></span>
<span class="normal"><a href="#__codelineno-29-479">479</a></span>
<span class="normal"><a href="#__codelineno-29-480">480</a></span>
<span class="normal"><a href="#__codelineno-29-481">481</a></span>
<span class="normal"><a href="#__codelineno-29-482">482</a></span>
<span class="normal"><a href="#__codelineno-29-483">483</a></span>
<span class="normal"><a href="#__codelineno-29-484">484</a></span>
<span class="normal"><a href="#__codelineno-29-485">485</a></span>
<span class="normal"><a href="#__codelineno-29-486">486</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="c1"># Copyright (c) 2023 PaddlePaddle Authors. All Rights Reserved.</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2"></a>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3"></a><span class="c1"># Licensed under the Apache License, Version 2.0 (the "License");</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4"></a><span class="c1"># you may not use this file except in compliance with the License.</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5"></a><span class="c1"># You may obtain a copy of the License at</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6"></a>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7"></a><span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8"></a>
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9"></a><span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10"></a><span class="c1"># distributed under the License is distributed on an "AS IS" BASIS,</span>
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11"></a><span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12"></a><span class="c1"># See the License for the specific language governing permissions and</span>
</span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13"></a><span class="c1"># limitations under the License.</span>
</span><span id="__span-29-14"><a id="__codelineno-29-14" name="__codelineno-29-14"></a>
</span><span id="__span-29-15"><a id="__codelineno-29-15" name="__codelineno-29-15"></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="__span-29-16"><a id="__codelineno-29-16" name="__codelineno-29-16"></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
</span><span id="__span-29-17"><a id="__codelineno-29-17" name="__codelineno-29-17"></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
</span><span id="__span-29-18"><a id="__codelineno-29-18" name="__codelineno-29-18"></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
</span><span id="__span-29-19"><a id="__codelineno-29-19" name="__codelineno-29-19"></a>
</span><span id="__span-29-20"><a id="__codelineno-29-20" name="__codelineno-29-20"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="__span-29-21"><a id="__codelineno-29-21" name="__codelineno-29-21"></a><span class="kn">import</span> <span class="nn">paddle</span>
</span><span id="__span-29-22"><a id="__codelineno-29-22" name="__codelineno-29-22"></a><span class="kn">import</span> <span class="nn">paddle.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
</span><span id="__span-29-23"><a id="__codelineno-29-23" name="__codelineno-29-23"></a><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">image</span> <span class="k">as</span> <span class="n">Img</span>
</span><span id="__span-29-24"><a id="__codelineno-29-24" name="__codelineno-29-24"></a><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
</span><span id="__span-29-25"><a id="__codelineno-29-25" name="__codelineno-29-25"></a><span class="kn">from</span> <span class="nn">skimage.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>
</span><span id="__span-29-26"><a id="__codelineno-29-26" name="__codelineno-29-26"></a><span class="kn">from</span> <span class="nn">skimage.metrics</span> <span class="kn">import</span> <span class="n">peak_signal_noise_ratio</span>
</span><span id="__span-29-27"><a id="__codelineno-29-27" name="__codelineno-29-27"></a><span class="kn">from</span> <span class="nn">skimage.metrics</span> <span class="kn">import</span> <span class="n">structural_similarity</span>
</span><span id="__span-29-28"><a id="__codelineno-29-28" name="__codelineno-29-28"></a>
</span><span id="__span-29-29"><a id="__codelineno-29-29" name="__codelineno-29-29"></a><span class="kn">import</span> <span class="nn">ppsci</span>
</span><span id="__span-29-30"><a id="__codelineno-29-30" name="__codelineno-29-30"></a><span class="kn">from</span> <span class="nn">ppsci.utils</span> <span class="kn">import</span> <span class="n">logger</span>
</span><span id="__span-29-31"><a id="__codelineno-29-31" name="__codelineno-29-31"></a>
</span><span id="__span-29-32"><a id="__codelineno-29-32" name="__codelineno-29-32"></a>
</span><span id="__span-29-33"><a id="__codelineno-29-33" name="__codelineno-29-33"></a><span class="c1"># train</span>
</span><span id="__span-29-34"><a id="__codelineno-29-34" name="__codelineno-29-34"></a><span class="k">def</span> <span class="nf">interpolate</span><span class="p">(</span>
</span><span id="__span-29-35"><a id="__codelineno-29-35" name="__codelineno-29-35"></a>    <span class="n">data</span><span class="p">:</span> <span class="n">paddle</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">ratio</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"nearest"</span>
</span><span id="__span-29-36"><a id="__codelineno-29-36" name="__codelineno-29-36"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">paddle</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="__span-29-37"><a id="__codelineno-29-37" name="__codelineno-29-37"></a><span class="w">    </span><span class="sd">"""Interpolate twice.</span>
</span><span id="__span-29-38"><a id="__codelineno-29-38" name="__codelineno-29-38"></a>
</span><span id="__span-29-39"><a id="__codelineno-29-39" name="__codelineno-29-39"></a><span class="sd">    Args:</span>
</span><span id="__span-29-40"><a id="__codelineno-29-40" name="__codelineno-29-40"></a><span class="sd">        data (paddle.Tensor): The data to be interpolated.</span>
</span><span id="__span-29-41"><a id="__codelineno-29-41" name="__codelineno-29-41"></a><span class="sd">        ratio (int): Ratio of one interpolation.</span>
</span><span id="__span-29-42"><a id="__codelineno-29-42" name="__codelineno-29-42"></a><span class="sd">        mode (str, optional): Interpolation method. Defaults to "nearest".</span>
</span><span id="__span-29-43"><a id="__codelineno-29-43" name="__codelineno-29-43"></a>
</span><span id="__span-29-44"><a id="__codelineno-29-44" name="__codelineno-29-44"></a><span class="sd">    Returns:</span>
</span><span id="__span-29-45"><a id="__codelineno-29-45" name="__codelineno-29-45"></a><span class="sd">        paddle.Tensor: Data interpolated.</span>
</span><span id="__span-29-46"><a id="__codelineno-29-46" name="__codelineno-29-46"></a><span class="sd">    """</span>
</span><span id="__span-29-47"><a id="__codelineno-29-47" name="__codelineno-29-47"></a>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="__span-29-48"><a id="__codelineno-29-48" name="__codelineno-29-48"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
</span><span id="__span-29-49"><a id="__codelineno-29-49" name="__codelineno-29-49"></a>            <span class="n">data</span><span class="p">,</span>
</span><span id="__span-29-50"><a id="__codelineno-29-50" name="__codelineno-29-50"></a>            <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">],</span>
</span><span id="__span-29-51"><a id="__codelineno-29-51" name="__codelineno-29-51"></a>            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
</span><span id="__span-29-52"><a id="__codelineno-29-52" name="__codelineno-29-52"></a>        <span class="p">)</span>
</span><span id="__span-29-53"><a id="__codelineno-29-53" name="__codelineno-29-53"></a>    <span class="k">return</span> <span class="n">data</span>
</span><span id="__span-29-54"><a id="__codelineno-29-54" name="__codelineno-29-54"></a>
</span><span id="__span-29-55"><a id="__codelineno-29-55" name="__codelineno-29-55"></a>
</span><span id="__span-29-56"><a id="__codelineno-29-56" name="__codelineno-29-56"></a><span class="k">def</span> <span class="nf">reshape_input</span><span class="p">(</span><span class="n">input_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">paddle</span><span class="o">.</span><span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">paddle</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
</span><span id="__span-29-57"><a id="__codelineno-29-57" name="__codelineno-29-57"></a><span class="w">    </span><span class="sd">"""Reshape input data for temporally Discriminator. Reshape data from N, C, W, H to N * C, 1, H, W.</span>
</span><span id="__span-29-58"><a id="__codelineno-29-58" name="__codelineno-29-58"></a><span class="sd">        Which will merge N dimension and C dimension to 1 dimension but still keep 4 dimensions</span>
</span><span id="__span-29-59"><a id="__codelineno-29-59" name="__codelineno-29-59"></a><span class="sd">        to ensure the data can be used for training.</span>
</span><span id="__span-29-60"><a id="__codelineno-29-60" name="__codelineno-29-60"></a>
</span><span id="__span-29-61"><a id="__codelineno-29-61" name="__codelineno-29-61"></a><span class="sd">    Args:</span>
</span><span id="__span-29-62"><a id="__codelineno-29-62" name="__codelineno-29-62"></a><span class="sd">        input_dict (Dict[str, paddle.Tensor]): input data dict.</span>
</span><span id="__span-29-63"><a id="__codelineno-29-63" name="__codelineno-29-63"></a>
</span><span id="__span-29-64"><a id="__codelineno-29-64" name="__codelineno-29-64"></a><span class="sd">    Returns:</span>
</span><span id="__span-29-65"><a id="__codelineno-29-65" name="__codelineno-29-65"></a><span class="sd">        Dict[str, paddle.Tensor]: reshaped data dict.</span>
</span><span id="__span-29-66"><a id="__codelineno-29-66" name="__codelineno-29-66"></a><span class="sd">    """</span>
</span><span id="__span-29-67"><a id="__codelineno-29-67" name="__codelineno-29-67"></a>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">input_dict</span><span class="p">:</span>
</span><span id="__span-29-68"><a id="__codelineno-29-68" name="__codelineno-29-68"></a>        <span class="nb">input</span> <span class="o">=</span> <span class="n">input_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="__span-29-69"><a id="__codelineno-29-69" name="__codelineno-29-69"></a>        <span class="n">N</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">shape</span>
</span><span id="__span-29-70"><a id="__codelineno-29-70" name="__codelineno-29-70"></a>        <span class="n">input_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="p">[</span><span class="n">N</span> <span class="o">*</span> <span class="n">C</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">])</span>
</span><span id="__span-29-71"><a id="__codelineno-29-71" name="__codelineno-29-71"></a>    <span class="k">return</span> <span class="n">input_dict</span>
</span><span id="__span-29-72"><a id="__codelineno-29-72" name="__codelineno-29-72"></a>
</span><span id="__span-29-73"><a id="__codelineno-29-73" name="__codelineno-29-73"></a>
</span><span id="__span-29-74"><a id="__codelineno-29-74" name="__codelineno-29-74"></a><span class="k">def</span> <span class="nf">dereshape_input</span><span class="p">(</span>
</span><span id="__span-29-75"><a id="__codelineno-29-75" name="__codelineno-29-75"></a>    <span class="n">input_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">paddle</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">C</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="__span-29-76"><a id="__codelineno-29-76" name="__codelineno-29-76"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">paddle</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
</span><span id="__span-29-77"><a id="__codelineno-29-77" name="__codelineno-29-77"></a><span class="w">    </span><span class="sd">"""Dereshape input data for temporally Discriminator. Deeshape data from N * C, 1, H, W to N, C, W, H.</span>
</span><span id="__span-29-78"><a id="__codelineno-29-78" name="__codelineno-29-78"></a>
</span><span id="__span-29-79"><a id="__codelineno-29-79" name="__codelineno-29-79"></a><span class="sd">    Args:</span>
</span><span id="__span-29-80"><a id="__codelineno-29-80" name="__codelineno-29-80"></a><span class="sd">        input_dict (Dict[str, paddle.Tensor]): input data dict.</span>
</span><span id="__span-29-81"><a id="__codelineno-29-81" name="__codelineno-29-81"></a><span class="sd">        C (int): Channel of dereshape.</span>
</span><span id="__span-29-82"><a id="__codelineno-29-82" name="__codelineno-29-82"></a>
</span><span id="__span-29-83"><a id="__codelineno-29-83" name="__codelineno-29-83"></a><span class="sd">    Returns:</span>
</span><span id="__span-29-84"><a id="__codelineno-29-84" name="__codelineno-29-84"></a><span class="sd">        Dict[str, paddle.Tensor]: dereshaped data dict.</span>
</span><span id="__span-29-85"><a id="__codelineno-29-85" name="__codelineno-29-85"></a><span class="sd">    """</span>
</span><span id="__span-29-86"><a id="__codelineno-29-86" name="__codelineno-29-86"></a>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">input_dict</span><span class="p">:</span>
</span><span id="__span-29-87"><a id="__codelineno-29-87" name="__codelineno-29-87"></a>        <span class="nb">input</span> <span class="o">=</span> <span class="n">input_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="__span-29-88"><a id="__codelineno-29-88" name="__codelineno-29-88"></a>        <span class="n">N</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">shape</span>
</span><span id="__span-29-89"><a id="__codelineno-29-89" name="__codelineno-29-89"></a>        <span class="k">if</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="n">C</span><span class="p">:</span>
</span><span id="__span-29-90"><a id="__codelineno-29-90" name="__codelineno-29-90"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="__span-29-91"><a id="__codelineno-29-91" name="__codelineno-29-91"></a>                <span class="sa">f</span><span class="s2">"batch_size is smaller than </span><span class="si">{</span><span class="n">C</span><span class="si">}</span><span class="s2">! Tempo needs at least </span><span class="si">{</span><span class="n">C</span><span class="si">}</span><span class="s2"> frames, input will be copied."</span>
</span><span id="__span-29-92"><a id="__codelineno-29-92" name="__codelineno-29-92"></a>            <span class="p">)</span>
</span><span id="__span-29-93"><a id="__codelineno-29-93" name="__codelineno-29-93"></a>            <span class="n">input_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="nb">input</span><span class="p">[:</span><span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="n">C</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-29-94"><a id="__codelineno-29-94" name="__codelineno-29-94"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-29-95"><a id="__codelineno-29-95" name="__codelineno-29-95"></a>            <span class="n">N_new</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">N</span> <span class="o">//</span> <span class="n">C</span><span class="p">)</span>
</span><span id="__span-29-96"><a id="__codelineno-29-96" name="__codelineno-29-96"></a>            <span class="n">input_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">input</span><span class="p">[:</span> <span class="n">N_new</span> <span class="o">*</span> <span class="n">C</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">])</span>
</span><span id="__span-29-97"><a id="__codelineno-29-97" name="__codelineno-29-97"></a>    <span class="k">return</span> <span class="n">input_dict</span>
</span><span id="__span-29-98"><a id="__codelineno-29-98" name="__codelineno-29-98"></a>
</span><span id="__span-29-99"><a id="__codelineno-29-99" name="__codelineno-29-99"></a>
</span><span id="__span-29-100"><a id="__codelineno-29-100" name="__codelineno-29-100"></a><span class="c1"># predict</span>
</span><span id="__span-29-101"><a id="__codelineno-29-101" name="__codelineno-29-101"></a><span class="k">def</span> <span class="nf">split_data</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tile_ratio</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="__span-29-102"><a id="__codelineno-29-102" name="__codelineno-29-102"></a><span class="w">    </span><span class="sd">"""Split a numpy image to tiles equally.</span>
</span><span id="__span-29-103"><a id="__codelineno-29-103" name="__codelineno-29-103"></a>
</span><span id="__span-29-104"><a id="__codelineno-29-104" name="__codelineno-29-104"></a><span class="sd">    Args:</span>
</span><span id="__span-29-105"><a id="__codelineno-29-105" name="__codelineno-29-105"></a><span class="sd">        data (np.ndarray): The image to be Split.</span>
</span><span id="__span-29-106"><a id="__codelineno-29-106" name="__codelineno-29-106"></a><span class="sd">        tile_ratio (int): How many tiles of one dim.</span>
</span><span id="__span-29-107"><a id="__codelineno-29-107" name="__codelineno-29-107"></a><span class="sd">            Number of result tiles is tile_ratio * tile_ratio for a 2d image.</span>
</span><span id="__span-29-108"><a id="__codelineno-29-108" name="__codelineno-29-108"></a>
</span><span id="__span-29-109"><a id="__codelineno-29-109" name="__codelineno-29-109"></a><span class="sd">    Returns:</span>
</span><span id="__span-29-110"><a id="__codelineno-29-110" name="__codelineno-29-110"></a><span class="sd">        np.ndarray: Tiles in [N,C,H,W] shape.</span>
</span><span id="__span-29-111"><a id="__codelineno-29-111" name="__codelineno-29-111"></a><span class="sd">    """</span>
</span><span id="__span-29-112"><a id="__codelineno-29-112" name="__codelineno-29-112"></a>    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</span><span id="__span-29-113"><a id="__codelineno-29-113" name="__codelineno-29-113"></a>    <span class="n">tile_h</span><span class="p">,</span> <span class="n">tile_w</span> <span class="o">=</span> <span class="n">h</span> <span class="o">//</span> <span class="n">tile_ratio</span><span class="p">,</span> <span class="n">w</span> <span class="o">//</span> <span class="n">tile_ratio</span>
</span><span id="__span-29-114"><a id="__codelineno-29-114" name="__codelineno-29-114"></a>    <span class="n">tiles</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-29-115"><a id="__codelineno-29-115" name="__codelineno-29-115"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tile_ratio</span><span class="p">):</span>
</span><span id="__span-29-116"><a id="__codelineno-29-116" name="__codelineno-29-116"></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tile_ratio</span><span class="p">):</span>
</span><span id="__span-29-117"><a id="__codelineno-29-117" name="__codelineno-29-117"></a>            <span class="n">tiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="__span-29-118"><a id="__codelineno-29-118" name="__codelineno-29-118"></a>                <span class="n">data</span><span class="p">[</span>
</span><span id="__span-29-119"><a id="__codelineno-29-119" name="__codelineno-29-119"></a>                    <span class="p">:</span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-29-120"><a id="__codelineno-29-120" name="__codelineno-29-120"></a>                    <span class="p">:,</span>
</span><span id="__span-29-121"><a id="__codelineno-29-121" name="__codelineno-29-121"></a>                    <span class="n">i</span> <span class="o">*</span> <span class="n">tile_h</span> <span class="p">:</span> <span class="n">i</span> <span class="o">*</span> <span class="n">tile_h</span> <span class="o">+</span> <span class="n">tile_h</span><span class="p">,</span>
</span><span id="__span-29-122"><a id="__codelineno-29-122" name="__codelineno-29-122"></a>                    <span class="n">j</span> <span class="o">*</span> <span class="n">tile_w</span> <span class="p">:</span> <span class="n">j</span> <span class="o">*</span> <span class="n">tile_w</span> <span class="o">+</span> <span class="n">tile_w</span><span class="p">,</span>
</span><span id="__span-29-123"><a id="__codelineno-29-123" name="__codelineno-29-123"></a>                <span class="p">],</span>
</span><span id="__span-29-124"><a id="__codelineno-29-124" name="__codelineno-29-124"></a>            <span class="p">)</span>
</span><span id="__span-29-125"><a id="__codelineno-29-125" name="__codelineno-29-125"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">tiles</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-29-126"><a id="__codelineno-29-126" name="__codelineno-29-126"></a>
</span><span id="__span-29-127"><a id="__codelineno-29-127" name="__codelineno-29-127"></a>
</span><span id="__span-29-128"><a id="__codelineno-29-128" name="__codelineno-29-128"></a><span class="k">def</span> <span class="nf">concat_data</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tile_ratio</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="__span-29-129"><a id="__codelineno-29-129" name="__codelineno-29-129"></a><span class="w">    </span><span class="sd">"""Concat numpy tiles to a image equally.</span>
</span><span id="__span-29-130"><a id="__codelineno-29-130" name="__codelineno-29-130"></a>
</span><span id="__span-29-131"><a id="__codelineno-29-131" name="__codelineno-29-131"></a><span class="sd">    Args:</span>
</span><span id="__span-29-132"><a id="__codelineno-29-132" name="__codelineno-29-132"></a><span class="sd">        data (np.ndarray): The tiles to be upsplited.</span>
</span><span id="__span-29-133"><a id="__codelineno-29-133" name="__codelineno-29-133"></a><span class="sd">        tile_ratio (int): How many tiles of one dim.</span>
</span><span id="__span-29-134"><a id="__codelineno-29-134" name="__codelineno-29-134"></a><span class="sd">            Number of input tiles is tile_ratio * tile_ratio for 2d result.</span>
</span><span id="__span-29-135"><a id="__codelineno-29-135" name="__codelineno-29-135"></a>
</span><span id="__span-29-136"><a id="__codelineno-29-136" name="__codelineno-29-136"></a><span class="sd">    Returns:</span>
</span><span id="__span-29-137"><a id="__codelineno-29-137" name="__codelineno-29-137"></a><span class="sd">        np.ndarray: Image in [H,W] shape.</span>
</span><span id="__span-29-138"><a id="__codelineno-29-138" name="__codelineno-29-138"></a><span class="sd">    """</span>
</span><span id="__span-29-139"><a id="__codelineno-29-139" name="__codelineno-29-139"></a>    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">tile_h</span><span class="p">,</span> <span class="n">tile_w</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</span><span id="__span-29-140"><a id="__codelineno-29-140" name="__codelineno-29-140"></a>    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">tile_h</span> <span class="o">*</span> <span class="n">tile_ratio</span><span class="p">,</span> <span class="n">tile_w</span> <span class="o">*</span> <span class="n">tile_ratio</span>
</span><span id="__span-29-141"><a id="__codelineno-29-141" name="__codelineno-29-141"></a>    <span class="n">data_whole</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">get_default_dtype</span><span class="p">())</span>
</span><span id="__span-29-142"><a id="__codelineno-29-142" name="__codelineno-29-142"></a>    <span class="n">tile_idx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-29-143"><a id="__codelineno-29-143" name="__codelineno-29-143"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tile_ratio</span><span class="p">):</span>
</span><span id="__span-29-144"><a id="__codelineno-29-144" name="__codelineno-29-144"></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tile_ratio</span><span class="p">):</span>
</span><span id="__span-29-145"><a id="__codelineno-29-145" name="__codelineno-29-145"></a>            <span class="n">data_whole</span><span class="p">[</span>
</span><span id="__span-29-146"><a id="__codelineno-29-146" name="__codelineno-29-146"></a>                <span class="n">i</span> <span class="o">*</span> <span class="n">tile_h</span> <span class="p">:</span> <span class="n">i</span> <span class="o">*</span> <span class="n">tile_h</span> <span class="o">+</span> <span class="n">tile_h</span><span class="p">,</span>
</span><span id="__span-29-147"><a id="__codelineno-29-147" name="__codelineno-29-147"></a>                <span class="n">j</span> <span class="o">*</span> <span class="n">tile_w</span> <span class="p">:</span> <span class="n">j</span> <span class="o">*</span> <span class="n">tile_w</span> <span class="o">+</span> <span class="n">tile_w</span><span class="p">,</span>
</span><span id="__span-29-148"><a id="__codelineno-29-148" name="__codelineno-29-148"></a>            <span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">tile_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-29-149"><a id="__codelineno-29-149" name="__codelineno-29-149"></a>            <span class="n">tile_idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-29-150"><a id="__codelineno-29-150" name="__codelineno-29-150"></a>    <span class="k">return</span> <span class="n">data_whole</span>
</span><span id="__span-29-151"><a id="__codelineno-29-151" name="__codelineno-29-151"></a>
</span><span id="__span-29-152"><a id="__codelineno-29-152" name="__codelineno-29-152"></a>
</span><span id="__span-29-153"><a id="__codelineno-29-153" name="__codelineno-29-153"></a><span class="k">def</span> <span class="nf">predict_and_save_plot</span><span class="p">(</span>
</span><span id="__span-29-154"><a id="__codelineno-29-154" name="__codelineno-29-154"></a>    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-29-155"><a id="__codelineno-29-155" name="__codelineno-29-155"></a>    <span class="n">epoch_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="__span-29-156"><a id="__codelineno-29-156" name="__codelineno-29-156"></a>    <span class="n">solver_gen</span><span class="p">:</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">Solver</span><span class="p">,</span>
</span><span id="__span-29-157"><a id="__codelineno-29-157" name="__codelineno-29-157"></a>    <span class="n">dataset_valid</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="__span-29-158"><a id="__codelineno-29-158" name="__codelineno-29-158"></a>    <span class="n">tile_ratio</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-29-159"><a id="__codelineno-29-159" name="__codelineno-29-159"></a><span class="p">):</span>
</span><span id="__span-29-160"><a id="__codelineno-29-160" name="__codelineno-29-160"></a><span class="w">    </span><span class="sd">"""Predicting and plotting.</span>
</span><span id="__span-29-161"><a id="__codelineno-29-161" name="__codelineno-29-161"></a>
</span><span id="__span-29-162"><a id="__codelineno-29-162" name="__codelineno-29-162"></a><span class="sd">    Args:</span>
</span><span id="__span-29-163"><a id="__codelineno-29-163" name="__codelineno-29-163"></a><span class="sd">        output_dir (str): Output dir path.</span>
</span><span id="__span-29-164"><a id="__codelineno-29-164" name="__codelineno-29-164"></a><span class="sd">        epoch_id (int): Which epoch it is.</span>
</span><span id="__span-29-165"><a id="__codelineno-29-165" name="__codelineno-29-165"></a><span class="sd">        solver_gen (ppsci.solver.Solver): Solver for predicting.</span>
</span><span id="__span-29-166"><a id="__codelineno-29-166" name="__codelineno-29-166"></a><span class="sd">        dataset_valid (np.ndarray): Valid dataset.</span>
</span><span id="__span-29-167"><a id="__codelineno-29-167" name="__codelineno-29-167"></a><span class="sd">        tile_ratio (int, optional): How many tiles of one dim. Defaults to 1.</span>
</span><span id="__span-29-168"><a id="__codelineno-29-168" name="__codelineno-29-168"></a><span class="sd">    """</span>
</span><span id="__span-29-169"><a id="__codelineno-29-169" name="__codelineno-29-169"></a>    <span class="n">dir_pred</span> <span class="o">=</span> <span class="s2">"predict/"</span>
</span><span id="__span-29-170"><a id="__codelineno-29-170" name="__codelineno-29-170"></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">dir_pred</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-29-171"><a id="__codelineno-29-171" name="__codelineno-29-171"></a>
</span><span id="__span-29-172"><a id="__codelineno-29-172" name="__codelineno-29-172"></a>    <span class="n">start_idx</span> <span class="o">=</span> <span class="mi">190</span>
</span><span id="__span-29-173"><a id="__codelineno-29-173" name="__codelineno-29-173"></a>    <span class="n">density_low</span> <span class="o">=</span> <span class="n">dataset_valid</span><span class="p">[</span><span class="s2">"density_low"</span><span class="p">][</span><span class="n">start_idx</span> <span class="p">:</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="__span-29-174"><a id="__codelineno-29-174" name="__codelineno-29-174"></a>    <span class="n">density_high</span> <span class="o">=</span> <span class="n">dataset_valid</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">][</span><span class="n">start_idx</span> <span class="p">:</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="__span-29-175"><a id="__codelineno-29-175" name="__codelineno-29-175"></a>
</span><span id="__span-29-176"><a id="__codelineno-29-176" name="__codelineno-29-176"></a>    <span class="c1"># tile</span>
</span><span id="__span-29-177"><a id="__codelineno-29-177" name="__codelineno-29-177"></a>    <span class="n">density_low</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-29-178"><a id="__codelineno-29-178" name="__codelineno-29-178"></a>        <span class="n">split_data</span><span class="p">(</span><span class="n">density_low</span><span class="p">,</span> <span class="n">tile_ratio</span><span class="p">)</span> <span class="k">if</span> <span class="n">tile_ratio</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">density_low</span>
</span><span id="__span-29-179"><a id="__codelineno-29-179" name="__codelineno-29-179"></a>    <span class="p">)</span>
</span><span id="__span-29-180"><a id="__codelineno-29-180" name="__codelineno-29-180"></a>    <span class="n">density_high</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-29-181"><a id="__codelineno-29-181" name="__codelineno-29-181"></a>        <span class="n">split_data</span><span class="p">(</span><span class="n">density_high</span><span class="p">,</span> <span class="n">tile_ratio</span><span class="p">)</span> <span class="k">if</span> <span class="n">tile_ratio</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">density_high</span>
</span><span id="__span-29-182"><a id="__codelineno-29-182" name="__codelineno-29-182"></a>    <span class="p">)</span>
</span><span id="__span-29-183"><a id="__codelineno-29-183" name="__codelineno-29-183"></a>
</span><span id="__span-29-184"><a id="__codelineno-29-184" name="__codelineno-29-184"></a>    <span class="n">pred_dict</span> <span class="o">=</span> <span class="n">solver_gen</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
</span><span id="__span-29-185"><a id="__codelineno-29-185" name="__codelineno-29-185"></a>        <span class="p">{</span>
</span><span id="__span-29-186"><a id="__codelineno-29-186" name="__codelineno-29-186"></a>            <span class="s2">"density_low"</span><span class="p">:</span> <span class="n">density_low</span><span class="p">,</span>
</span><span id="__span-29-187"><a id="__codelineno-29-187" name="__codelineno-29-187"></a>            <span class="s2">"density_high"</span><span class="p">:</span> <span class="n">density_high</span><span class="p">,</span>
</span><span id="__span-29-188"><a id="__codelineno-29-188" name="__codelineno-29-188"></a>        <span class="p">},</span>
</span><span id="__span-29-189"><a id="__codelineno-29-189" name="__codelineno-29-189"></a>        <span class="p">{</span><span class="s2">"density_high"</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">out</span><span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="s2">"output_gen"</span><span class="p">]},</span>
</span><span id="__span-29-190"><a id="__codelineno-29-190" name="__codelineno-29-190"></a>        <span class="n">batch_size</span><span class="o">=</span><span class="n">tile_ratio</span> <span class="o">*</span> <span class="n">tile_ratio</span> <span class="k">if</span> <span class="n">tile_ratio</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="__span-29-191"><a id="__codelineno-29-191" name="__codelineno-29-191"></a>        <span class="n">no_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-29-192"><a id="__codelineno-29-192" name="__codelineno-29-192"></a>    <span class="p">)</span>
</span><span id="__span-29-193"><a id="__codelineno-29-193" name="__codelineno-29-193"></a>    <span class="k">if</span> <span class="n">epoch_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="__span-29-194"><a id="__codelineno-29-194" name="__codelineno-29-194"></a>        <span class="c1"># plot interpolated input image</span>
</span><span id="__span-29-195"><a id="__codelineno-29-195" name="__codelineno-29-195"></a>        <span class="n">input_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">dataset_valid</span><span class="p">[</span><span class="s2">"density_low"</span><span class="p">][</span><span class="n">start_idx</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-29-196"><a id="__codelineno-29-196" name="__codelineno-29-196"></a>        <span class="n">input_img</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">input_img</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">paddle</span><span class="o">.</span><span class="n">get_default_dtype</span><span class="p">())</span>
</span><span id="__span-29-197"><a id="__codelineno-29-197" name="__codelineno-29-197"></a>        <span class="n">input_img</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
</span><span id="__span-29-198"><a id="__codelineno-29-198" name="__codelineno-29-198"></a>            <span class="n">input_img</span><span class="p">,</span>
</span><span id="__span-29-199"><a id="__codelineno-29-199" name="__codelineno-29-199"></a>            <span class="p">[</span><span class="n">input_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">input_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">],</span>
</span><span id="__span-29-200"><a id="__codelineno-29-200" name="__codelineno-29-200"></a>            <span class="n">mode</span><span class="o">=</span><span class="s2">"nearest"</span><span class="p">,</span>
</span><span id="__span-29-201"><a id="__codelineno-29-201" name="__codelineno-29-201"></a>        <span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="__span-29-202"><a id="__codelineno-29-202" name="__codelineno-29-202"></a>        <span class="n">Img</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span>
</span><span id="__span-29-203"><a id="__codelineno-29-203" name="__codelineno-29-203"></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">dir_pred</span><span class="p">,</span> <span class="s2">"input.png"</span><span class="p">),</span>
</span><span id="__span-29-204"><a id="__codelineno-29-204" name="__codelineno-29-204"></a>            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">input_img</span><span class="p">),</span>
</span><span id="__span-29-205"><a id="__codelineno-29-205" name="__codelineno-29-205"></a>            <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="__span-29-206"><a id="__codelineno-29-206" name="__codelineno-29-206"></a>            <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="__span-29-207"><a id="__codelineno-29-207" name="__codelineno-29-207"></a>            <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span>
</span><span id="__span-29-208"><a id="__codelineno-29-208" name="__codelineno-29-208"></a>        <span class="p">)</span>
</span><span id="__span-29-209"><a id="__codelineno-29-209" name="__codelineno-29-209"></a>        <span class="c1"># plot target image</span>
</span><span id="__span-29-210"><a id="__codelineno-29-210" name="__codelineno-29-210"></a>        <span class="n">Img</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span>
</span><span id="__span-29-211"><a id="__codelineno-29-211" name="__codelineno-29-211"></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">dir_pred</span><span class="p">,</span> <span class="s2">"target.png"</span><span class="p">),</span>
</span><span id="__span-29-212"><a id="__codelineno-29-212" name="__codelineno-29-212"></a>            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dataset_valid</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">][</span><span class="n">start_idx</span><span class="p">]),</span>
</span><span id="__span-29-213"><a id="__codelineno-29-213" name="__codelineno-29-213"></a>            <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="__span-29-214"><a id="__codelineno-29-214" name="__codelineno-29-214"></a>            <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="__span-29-215"><a id="__codelineno-29-215" name="__codelineno-29-215"></a>            <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span>
</span><span id="__span-29-216"><a id="__codelineno-29-216" name="__codelineno-29-216"></a>        <span class="p">)</span>
</span><span id="__span-29-217"><a id="__codelineno-29-217" name="__codelineno-29-217"></a>    <span class="c1"># plot pred image</span>
</span><span id="__span-29-218"><a id="__codelineno-29-218" name="__codelineno-29-218"></a>    <span class="n">pred_img</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-29-219"><a id="__codelineno-29-219" name="__codelineno-29-219"></a>        <span class="n">concat_data</span><span class="p">(</span><span class="n">pred_dict</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">tile_ratio</span><span class="p">)</span>
</span><span id="__span-29-220"><a id="__codelineno-29-220" name="__codelineno-29-220"></a>        <span class="k">if</span> <span class="n">tile_ratio</span> <span class="o">!=</span> <span class="mi">1</span>
</span><span id="__span-29-221"><a id="__codelineno-29-221" name="__codelineno-29-221"></a>        <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">pred_dict</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</span><span id="__span-29-222"><a id="__codelineno-29-222" name="__codelineno-29-222"></a>    <span class="p">)</span>
</span><span id="__span-29-223"><a id="__codelineno-29-223" name="__codelineno-29-223"></a>    <span class="n">Img</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span>
</span><span id="__span-29-224"><a id="__codelineno-29-224" name="__codelineno-29-224"></a>        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">dir_pred</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"pred_epoch_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">epoch_id</span><span class="p">)</span><span class="si">}</span><span class="s2">.png"</span><span class="p">),</span>
</span><span id="__span-29-225"><a id="__codelineno-29-225" name="__codelineno-29-225"></a>        <span class="n">pred_img</span><span class="p">,</span>
</span><span id="__span-29-226"><a id="__codelineno-29-226" name="__codelineno-29-226"></a>        <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="__span-29-227"><a id="__codelineno-29-227" name="__codelineno-29-227"></a>        <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="__span-29-228"><a id="__codelineno-29-228" name="__codelineno-29-228"></a>        <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span>
</span><span id="__span-29-229"><a id="__codelineno-29-229" name="__codelineno-29-229"></a>    <span class="p">)</span>
</span><span id="__span-29-230"><a id="__codelineno-29-230" name="__codelineno-29-230"></a>
</span><span id="__span-29-231"><a id="__codelineno-29-231" name="__codelineno-29-231"></a>
</span><span id="__span-29-232"><a id="__codelineno-29-232" name="__codelineno-29-232"></a><span class="c1"># evaluation</span>
</span><span id="__span-29-233"><a id="__codelineno-29-233" name="__codelineno-29-233"></a><span class="k">def</span> <span class="nf">evaluate_img</span><span class="p">(</span>
</span><span id="__span-29-234"><a id="__codelineno-29-234" name="__codelineno-29-234"></a>    <span class="n">img_target</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">img_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
</span><span id="__span-29-235"><a id="__codelineno-29-235" name="__codelineno-29-235"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="__span-29-236"><a id="__codelineno-29-236" name="__codelineno-29-236"></a><span class="w">    </span><span class="sd">"""Evaluate two images.</span>
</span><span id="__span-29-237"><a id="__codelineno-29-237" name="__codelineno-29-237"></a>
</span><span id="__span-29-238"><a id="__codelineno-29-238" name="__codelineno-29-238"></a><span class="sd">    Args:</span>
</span><span id="__span-29-239"><a id="__codelineno-29-239" name="__codelineno-29-239"></a><span class="sd">        img_target (np.ndarray): Target image.</span>
</span><span id="__span-29-240"><a id="__codelineno-29-240" name="__codelineno-29-240"></a><span class="sd">        img_pred (np.ndarray): Image generated by prediction.</span>
</span><span id="__span-29-241"><a id="__codelineno-29-241" name="__codelineno-29-241"></a>
</span><span id="__span-29-242"><a id="__codelineno-29-242" name="__codelineno-29-242"></a><span class="sd">    Returns:</span>
</span><span id="__span-29-243"><a id="__codelineno-29-243" name="__codelineno-29-243"></a><span class="sd">        Tuple[float, float, float]: MSE, PSNR, SSIM.</span>
</span><span id="__span-29-244"><a id="__codelineno-29-244" name="__codelineno-29-244"></a><span class="sd">    """</span>
</span><span id="__span-29-245"><a id="__codelineno-29-245" name="__codelineno-29-245"></a>    <span class="n">eval_mse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">img_target</span><span class="p">,</span> <span class="n">img_pred</span><span class="p">)</span>
</span><span id="__span-29-246"><a id="__codelineno-29-246" name="__codelineno-29-246"></a>    <span class="n">eval_psnr</span> <span class="o">=</span> <span class="n">peak_signal_noise_ratio</span><span class="p">(</span><span class="n">img_target</span><span class="p">,</span> <span class="n">img_pred</span><span class="p">)</span>
</span><span id="__span-29-247"><a id="__codelineno-29-247" name="__codelineno-29-247"></a>    <span class="n">eval_ssim</span> <span class="o">=</span> <span class="n">structural_similarity</span><span class="p">(</span><span class="n">img_target</span><span class="p">,</span> <span class="n">img_pred</span><span class="p">,</span> <span class="n">data_range</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="__span-29-248"><a id="__codelineno-29-248" name="__codelineno-29-248"></a>    <span class="k">return</span> <span class="n">eval_mse</span><span class="p">,</span> <span class="n">eval_psnr</span><span class="p">,</span> <span class="n">eval_ssim</span>
</span><span id="__span-29-249"><a id="__codelineno-29-249" name="__codelineno-29-249"></a>
</span><span id="__span-29-250"><a id="__codelineno-29-250" name="__codelineno-29-250"></a>
</span><span id="__span-29-251"><a id="__codelineno-29-251" name="__codelineno-29-251"></a><span class="k">def</span> <span class="nf">get_image_array</span><span class="p">(</span><span class="n">img_path</span><span class="p">):</span>
</span><span id="__span-29-252"><a id="__codelineno-29-252" name="__codelineno-29-252"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">"L"</span><span class="p">))</span>
</span><span id="__span-29-253"><a id="__codelineno-29-253" name="__codelineno-29-253"></a>
</span><span id="__span-29-254"><a id="__codelineno-29-254" name="__codelineno-29-254"></a>
</span><span id="__span-29-255"><a id="__codelineno-29-255" name="__codelineno-29-255"></a><span class="k">class</span> <span class="nc">GenFuncs</span><span class="p">:</span>
</span><span id="__span-29-256"><a id="__codelineno-29-256" name="__codelineno-29-256"></a><span class="w">    </span><span class="sd">"""All functions used for Generator, including functions of transform and loss.</span>
</span><span id="__span-29-257"><a id="__codelineno-29-257" name="__codelineno-29-257"></a>
</span><span id="__span-29-258"><a id="__codelineno-29-258" name="__codelineno-29-258"></a><span class="sd">    Args:</span>
</span><span id="__span-29-259"><a id="__codelineno-29-259" name="__codelineno-29-259"></a><span class="sd">        weight_gen (List[float]): Weights of L1 loss.</span>
</span><span id="__span-29-260"><a id="__codelineno-29-260" name="__codelineno-29-260"></a><span class="sd">        weight_gen_layer (List[float], optional): Weights of layers loss. Defaults to None.</span>
</span><span id="__span-29-261"><a id="__codelineno-29-261" name="__codelineno-29-261"></a><span class="sd">    """</span>
</span><span id="__span-29-262"><a id="__codelineno-29-262" name="__codelineno-29-262"></a>
</span><span id="__span-29-263"><a id="__codelineno-29-263" name="__codelineno-29-263"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="__span-29-264"><a id="__codelineno-29-264" name="__codelineno-29-264"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">weight_gen</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">weight_gen_layer</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-29-265"><a id="__codelineno-29-265" name="__codelineno-29-265"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-29-266"><a id="__codelineno-29-266" name="__codelineno-29-266"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weight_gen</span> <span class="o">=</span> <span class="n">weight_gen</span>
</span><span id="__span-29-267"><a id="__codelineno-29-267" name="__codelineno-29-267"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weight_gen_layer</span> <span class="o">=</span> <span class="n">weight_gen_layer</span>
</span><span id="__span-29-268"><a id="__codelineno-29-268" name="__codelineno-29-268"></a>
</span><span id="__span-29-269"><a id="__codelineno-29-269" name="__codelineno-29-269"></a>    <span class="k">def</span> <span class="nf">transform_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_in</span><span class="p">):</span>
</span><span id="__span-29-270"><a id="__codelineno-29-270" name="__codelineno-29-270"></a>        <span class="n">ratio</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="__span-29-271"><a id="__codelineno-29-271" name="__codelineno-29-271"></a>        <span class="n">input_dict</span> <span class="o">=</span> <span class="n">reshape_input</span><span class="p">(</span><span class="n">_in</span><span class="p">)</span>
</span><span id="__span-29-272"><a id="__codelineno-29-272" name="__codelineno-29-272"></a>        <span class="n">density_low</span> <span class="o">=</span> <span class="n">input_dict</span><span class="p">[</span><span class="s2">"density_low"</span><span class="p">]</span>
</span><span id="__span-29-273"><a id="__codelineno-29-273" name="__codelineno-29-273"></a>        <span class="n">density_low_inp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="p">(</span><span class="n">density_low</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="s2">"nearest"</span><span class="p">)</span>
</span><span id="__span-29-274"><a id="__codelineno-29-274" name="__codelineno-29-274"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">"input_gen"</span><span class="p">:</span> <span class="n">density_low_inp</span><span class="p">}</span>
</span><span id="__span-29-275"><a id="__codelineno-29-275" name="__codelineno-29-275"></a>
</span><span id="__span-29-276"><a id="__codelineno-29-276" name="__codelineno-29-276"></a>    <span class="k">def</span> <span class="nf">loss_func_gen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">paddle</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="__span-29-277"><a id="__codelineno-29-277" name="__codelineno-29-277"></a><span class="w">        </span><span class="sd">"""Calculate loss of generator when use spatial discriminator.</span>
</span><span id="__span-29-278"><a id="__codelineno-29-278" name="__codelineno-29-278"></a><span class="sd">            The loss consists of l1 loss, l2 loss and layer loss when use spatial discriminator.</span>
</span><span id="__span-29-279"><a id="__codelineno-29-279" name="__codelineno-29-279"></a><span class="sd">            Notice that all item of loss is optional because weight of them might be 0.</span>
</span><span id="__span-29-280"><a id="__codelineno-29-280" name="__codelineno-29-280"></a>
</span><span id="__span-29-281"><a id="__codelineno-29-281" name="__codelineno-29-281"></a><span class="sd">        Args:</span>
</span><span id="__span-29-282"><a id="__codelineno-29-282" name="__codelineno-29-282"></a><span class="sd">            output_dict (Dict): output dict of model.</span>
</span><span id="__span-29-283"><a id="__codelineno-29-283" name="__codelineno-29-283"></a>
</span><span id="__span-29-284"><a id="__codelineno-29-284" name="__codelineno-29-284"></a><span class="sd">        Returns:</span>
</span><span id="__span-29-285"><a id="__codelineno-29-285" name="__codelineno-29-285"></a><span class="sd">            paddle.Tensor: Loss of generator.</span>
</span><span id="__span-29-286"><a id="__codelineno-29-286" name="__codelineno-29-286"></a><span class="sd">        """</span>
</span><span id="__span-29-287"><a id="__codelineno-29-287" name="__codelineno-29-287"></a>        <span class="c1"># l1 loss</span>
</span><span id="__span-29-288"><a id="__codelineno-29-288" name="__codelineno-29-288"></a>        <span class="n">loss_l1</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">l1_loss</span><span class="p">(</span>
</span><span id="__span-29-289"><a id="__codelineno-29-289" name="__codelineno-29-289"></a>            <span class="n">output_dict</span><span class="p">[</span><span class="s2">"output_gen"</span><span class="p">],</span> <span class="n">output_dict</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">],</span> <span class="s2">"mean"</span>
</span><span id="__span-29-290"><a id="__codelineno-29-290" name="__codelineno-29-290"></a>        <span class="p">)</span>
</span><span id="__span-29-291"><a id="__codelineno-29-291" name="__codelineno-29-291"></a>        <span class="n">losses</span> <span class="o">=</span> <span class="n">loss_l1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_gen</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-29-292"><a id="__codelineno-29-292" name="__codelineno-29-292"></a>
</span><span id="__span-29-293"><a id="__codelineno-29-293" name="__codelineno-29-293"></a>        <span class="c1"># l2 loss</span>
</span><span id="__span-29-294"><a id="__codelineno-29-294" name="__codelineno-29-294"></a>        <span class="n">loss_l2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span>
</span><span id="__span-29-295"><a id="__codelineno-29-295" name="__codelineno-29-295"></a>            <span class="n">output_dict</span><span class="p">[</span><span class="s2">"output_gen"</span><span class="p">],</span> <span class="n">output_dict</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">],</span> <span class="s2">"mean"</span>
</span><span id="__span-29-296"><a id="__codelineno-29-296" name="__codelineno-29-296"></a>        <span class="p">)</span>
</span><span id="__span-29-297"><a id="__codelineno-29-297" name="__codelineno-29-297"></a>        <span class="n">losses</span> <span class="o">+=</span> <span class="n">loss_l2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_gen</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-29-298"><a id="__codelineno-29-298" name="__codelineno-29-298"></a>
</span><span id="__span-29-299"><a id="__codelineno-29-299" name="__codelineno-29-299"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_gen_layer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-29-300"><a id="__codelineno-29-300" name="__codelineno-29-300"></a>            <span class="c1"># disc(generator_out) loss</span>
</span><span id="__span-29-301"><a id="__codelineno-29-301" name="__codelineno-29-301"></a>            <span class="n">out_disc_from_gen</span> <span class="o">=</span> <span class="n">output_dict</span><span class="p">[</span><span class="s2">"out_disc_from_gen"</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-29-302"><a id="__codelineno-29-302" name="__codelineno-29-302"></a>            <span class="n">label_ones</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">out_disc_from_gen</span><span class="p">)</span>
</span><span id="__span-29-303"><a id="__codelineno-29-303" name="__codelineno-29-303"></a>            <span class="n">loss_gen</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">binary_cross_entropy_with_logits</span><span class="p">(</span>
</span><span id="__span-29-304"><a id="__codelineno-29-304" name="__codelineno-29-304"></a>                <span class="n">out_disc_from_gen</span><span class="p">,</span> <span class="n">label_ones</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">"mean"</span>
</span><span id="__span-29-305"><a id="__codelineno-29-305" name="__codelineno-29-305"></a>            <span class="p">)</span>
</span><span id="__span-29-306"><a id="__codelineno-29-306" name="__codelineno-29-306"></a>            <span class="n">losses</span> <span class="o">+=</span> <span class="n">loss_gen</span>
</span><span id="__span-29-307"><a id="__codelineno-29-307" name="__codelineno-29-307"></a>
</span><span id="__span-29-308"><a id="__codelineno-29-308" name="__codelineno-29-308"></a>            <span class="c1"># layer loss</span>
</span><span id="__span-29-309"><a id="__codelineno-29-309" name="__codelineno-29-309"></a>            <span class="n">key_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">output_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="__span-29-310"><a id="__codelineno-29-310" name="__codelineno-29-310"></a>            <span class="c1"># ["out0_layer0","out0_layer1","out0_layer2","out0_layer3","out_disc_from_target",</span>
</span><span id="__span-29-311"><a id="__codelineno-29-311" name="__codelineno-29-311"></a>            <span class="c1"># "out1_layer0","out1_layer1","out1_layer2","out1_layer3","out_disc_from_gen"]</span>
</span><span id="__span-29-312"><a id="__codelineno-29-312" name="__codelineno-29-312"></a>            <span class="n">loss_layer</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-29-313"><a id="__codelineno-29-313" name="__codelineno-29-313"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_gen_layer</span><span class="p">)):</span>
</span><span id="__span-29-314"><a id="__codelineno-29-314" name="__codelineno-29-314"></a>                <span class="c1"># i = 0,1,2,3</span>
</span><span id="__span-29-315"><a id="__codelineno-29-315" name="__codelineno-29-315"></a>                <span class="n">loss_layer</span> <span class="o">+=</span> <span class="p">(</span>
</span><span id="__span-29-316"><a id="__codelineno-29-316" name="__codelineno-29-316"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">weight_gen_layer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="__span-29-317"><a id="__codelineno-29-317" name="__codelineno-29-317"></a>                    <span class="o">*</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span>
</span><span id="__span-29-318"><a id="__codelineno-29-318" name="__codelineno-29-318"></a>                        <span class="n">output_dict</span><span class="p">[</span><span class="n">key_list</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
</span><span id="__span-29-319"><a id="__codelineno-29-319" name="__codelineno-29-319"></a>                        <span class="n">output_dict</span><span class="p">[</span><span class="n">key_list</span><span class="p">[</span><span class="mi">5</span> <span class="o">+</span> <span class="n">i</span><span class="p">]],</span>
</span><span id="__span-29-320"><a id="__codelineno-29-320" name="__codelineno-29-320"></a>                        <span class="n">reduction</span><span class="o">=</span><span class="s2">"sum"</span><span class="p">,</span>
</span><span id="__span-29-321"><a id="__codelineno-29-321" name="__codelineno-29-321"></a>                    <span class="p">)</span>
</span><span id="__span-29-322"><a id="__codelineno-29-322" name="__codelineno-29-322"></a>                    <span class="o">/</span> <span class="mi">2</span>
</span><span id="__span-29-323"><a id="__codelineno-29-323" name="__codelineno-29-323"></a>                <span class="p">)</span>
</span><span id="__span-29-324"><a id="__codelineno-29-324" name="__codelineno-29-324"></a>            <span class="n">losses</span> <span class="o">+=</span> <span class="n">loss_layer</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_gen_layer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-29-325"><a id="__codelineno-29-325" name="__codelineno-29-325"></a>
</span><span id="__span-29-326"><a id="__codelineno-29-326" name="__codelineno-29-326"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">"output_gen"</span><span class="p">:</span> <span class="n">losses</span><span class="p">}</span>
</span><span id="__span-29-327"><a id="__codelineno-29-327" name="__codelineno-29-327"></a>
</span><span id="__span-29-328"><a id="__codelineno-29-328" name="__codelineno-29-328"></a>    <span class="k">def</span> <span class="nf">loss_func_gen_tempo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">paddle</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="__span-29-329"><a id="__codelineno-29-329" name="__codelineno-29-329"></a><span class="w">        </span><span class="sd">"""Calculate loss of generator when use temporal discriminator.</span>
</span><span id="__span-29-330"><a id="__codelineno-29-330" name="__codelineno-29-330"></a><span class="sd">            The loss is cross entropy loss when use temporal discriminator.</span>
</span><span id="__span-29-331"><a id="__codelineno-29-331" name="__codelineno-29-331"></a>
</span><span id="__span-29-332"><a id="__codelineno-29-332" name="__codelineno-29-332"></a><span class="sd">        Args:</span>
</span><span id="__span-29-333"><a id="__codelineno-29-333" name="__codelineno-29-333"></a><span class="sd">            output_dict (Dict): output dict of model.</span>
</span><span id="__span-29-334"><a id="__codelineno-29-334" name="__codelineno-29-334"></a>
</span><span id="__span-29-335"><a id="__codelineno-29-335" name="__codelineno-29-335"></a><span class="sd">        Returns:</span>
</span><span id="__span-29-336"><a id="__codelineno-29-336" name="__codelineno-29-336"></a><span class="sd">            paddle.Tensor: Loss of generator.</span>
</span><span id="__span-29-337"><a id="__codelineno-29-337" name="__codelineno-29-337"></a><span class="sd">        """</span>
</span><span id="__span-29-338"><a id="__codelineno-29-338" name="__codelineno-29-338"></a>        <span class="n">out_disc_tempo_from_gen</span> <span class="o">=</span> <span class="n">output_dict</span><span class="p">[</span><span class="s2">"out_disc_tempo_from_gen"</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-29-339"><a id="__codelineno-29-339" name="__codelineno-29-339"></a>        <span class="n">label_t_ones</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">out_disc_tempo_from_gen</span><span class="p">)</span>
</span><span id="__span-29-340"><a id="__codelineno-29-340" name="__codelineno-29-340"></a>
</span><span id="__span-29-341"><a id="__codelineno-29-341" name="__codelineno-29-341"></a>        <span class="n">loss_gen_t</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">binary_cross_entropy_with_logits</span><span class="p">(</span>
</span><span id="__span-29-342"><a id="__codelineno-29-342" name="__codelineno-29-342"></a>            <span class="n">out_disc_tempo_from_gen</span><span class="p">,</span> <span class="n">label_t_ones</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">"mean"</span>
</span><span id="__span-29-343"><a id="__codelineno-29-343" name="__codelineno-29-343"></a>        <span class="p">)</span>
</span><span id="__span-29-344"><a id="__codelineno-29-344" name="__codelineno-29-344"></a>        <span class="n">losses</span> <span class="o">=</span> <span class="n">loss_gen_t</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_gen</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="__span-29-345"><a id="__codelineno-29-345" name="__codelineno-29-345"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">"out_disc_tempo_from_gen"</span><span class="p">:</span> <span class="n">losses</span><span class="p">}</span>
</span><span id="__span-29-346"><a id="__codelineno-29-346" name="__codelineno-29-346"></a>
</span><span id="__span-29-347"><a id="__codelineno-29-347" name="__codelineno-29-347"></a>
</span><span id="__span-29-348"><a id="__codelineno-29-348" name="__codelineno-29-348"></a><span class="k">class</span> <span class="nc">DiscFuncs</span><span class="p">:</span>
</span><span id="__span-29-349"><a id="__codelineno-29-349" name="__codelineno-29-349"></a><span class="w">    </span><span class="sd">"""All functions used for Discriminator and temporally Discriminator, including functions of transform and loss.</span>
</span><span id="__span-29-350"><a id="__codelineno-29-350" name="__codelineno-29-350"></a>
</span><span id="__span-29-351"><a id="__codelineno-29-351" name="__codelineno-29-351"></a><span class="sd">    Args:</span>
</span><span id="__span-29-352"><a id="__codelineno-29-352" name="__codelineno-29-352"></a><span class="sd">        weight_disc (float): Weight of loss generated by the discriminator to judge the true target.</span>
</span><span id="__span-29-353"><a id="__codelineno-29-353" name="__codelineno-29-353"></a><span class="sd">    """</span>
</span><span id="__span-29-354"><a id="__codelineno-29-354" name="__codelineno-29-354"></a>
</span><span id="__span-29-355"><a id="__codelineno-29-355" name="__codelineno-29-355"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weight_disc</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-29-356"><a id="__codelineno-29-356" name="__codelineno-29-356"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weight_disc</span> <span class="o">=</span> <span class="n">weight_disc</span>
</span><span id="__span-29-357"><a id="__codelineno-29-357" name="__codelineno-29-357"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_gen</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-29-358"><a id="__codelineno-29-358" name="__codelineno-29-358"></a>
</span><span id="__span-29-359"><a id="__codelineno-29-359" name="__codelineno-29-359"></a>    <span class="k">def</span> <span class="nf">transform_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_in</span><span class="p">):</span>
</span><span id="__span-29-360"><a id="__codelineno-29-360" name="__codelineno-29-360"></a>        <span class="n">ratio</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="__span-29-361"><a id="__codelineno-29-361" name="__codelineno-29-361"></a>        <span class="n">input_dict</span> <span class="o">=</span> <span class="n">reshape_input</span><span class="p">(</span><span class="n">_in</span><span class="p">)</span>
</span><span id="__span-29-362"><a id="__codelineno-29-362" name="__codelineno-29-362"></a>        <span class="n">density_low</span> <span class="o">=</span> <span class="n">input_dict</span><span class="p">[</span><span class="s2">"density_low"</span><span class="p">]</span>
</span><span id="__span-29-363"><a id="__codelineno-29-363" name="__codelineno-29-363"></a>        <span class="n">density_high_from_target</span> <span class="o">=</span> <span class="n">input_dict</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">]</span>
</span><span id="__span-29-364"><a id="__codelineno-29-364" name="__codelineno-29-364"></a>
</span><span id="__span-29-365"><a id="__codelineno-29-365" name="__codelineno-29-365"></a>        <span class="n">density_low_inp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="p">(</span><span class="n">density_low</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="s2">"nearest"</span><span class="p">)</span>
</span><span id="__span-29-366"><a id="__codelineno-29-366" name="__codelineno-29-366"></a>
</span><span id="__span-29-367"><a id="__codelineno-29-367" name="__codelineno-29-367"></a>        <span class="n">density_high_from_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_gen</span><span class="p">(</span><span class="n">input_dict</span><span class="p">)[</span><span class="s2">"output_gen"</span><span class="p">]</span>
</span><span id="__span-29-368"><a id="__codelineno-29-368" name="__codelineno-29-368"></a>        <span class="n">density_high_from_gen</span><span class="o">.</span><span class="n">stop_gradient</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-29-369"><a id="__codelineno-29-369" name="__codelineno-29-369"></a>
</span><span id="__span-29-370"><a id="__codelineno-29-370" name="__codelineno-29-370"></a>        <span class="n">density_input_from_target</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
</span><span id="__span-29-371"><a id="__codelineno-29-371" name="__codelineno-29-371"></a>            <span class="p">[</span><span class="n">density_low_inp</span><span class="p">,</span> <span class="n">density_high_from_target</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
</span><span id="__span-29-372"><a id="__codelineno-29-372" name="__codelineno-29-372"></a>        <span class="p">)</span>
</span><span id="__span-29-373"><a id="__codelineno-29-373" name="__codelineno-29-373"></a>        <span class="n">density_input_from_gen</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
</span><span id="__span-29-374"><a id="__codelineno-29-374" name="__codelineno-29-374"></a>            <span class="p">[</span><span class="n">density_low_inp</span><span class="p">,</span> <span class="n">density_high_from_gen</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
</span><span id="__span-29-375"><a id="__codelineno-29-375" name="__codelineno-29-375"></a>        <span class="p">)</span>
</span><span id="__span-29-376"><a id="__codelineno-29-376" name="__codelineno-29-376"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-29-377"><a id="__codelineno-29-377" name="__codelineno-29-377"></a>            <span class="s2">"input_disc_from_target"</span><span class="p">:</span> <span class="n">density_input_from_target</span><span class="p">,</span>
</span><span id="__span-29-378"><a id="__codelineno-29-378" name="__codelineno-29-378"></a>            <span class="s2">"input_disc_from_gen"</span><span class="p">:</span> <span class="n">density_input_from_gen</span><span class="p">,</span>
</span><span id="__span-29-379"><a id="__codelineno-29-379" name="__codelineno-29-379"></a>        <span class="p">}</span>
</span><span id="__span-29-380"><a id="__codelineno-29-380" name="__codelineno-29-380"></a>
</span><span id="__span-29-381"><a id="__codelineno-29-381" name="__codelineno-29-381"></a>    <span class="k">def</span> <span class="nf">transform_in_tempo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_in</span><span class="p">):</span>
</span><span id="__span-29-382"><a id="__codelineno-29-382" name="__codelineno-29-382"></a>        <span class="n">density_high_from_target</span> <span class="o">=</span> <span class="n">_in</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">]</span>
</span><span id="__span-29-383"><a id="__codelineno-29-383" name="__codelineno-29-383"></a>
</span><span id="__span-29-384"><a id="__codelineno-29-384" name="__codelineno-29-384"></a>        <span class="n">input_dict</span> <span class="o">=</span> <span class="n">reshape_input</span><span class="p">(</span><span class="n">_in</span><span class="p">)</span>
</span><span id="__span-29-385"><a id="__codelineno-29-385" name="__codelineno-29-385"></a>        <span class="n">density_high_from_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_gen</span><span class="p">(</span><span class="n">input_dict</span><span class="p">)[</span><span class="s2">"output_gen"</span><span class="p">]</span>
</span><span id="__span-29-386"><a id="__codelineno-29-386" name="__codelineno-29-386"></a>        <span class="n">density_high_from_gen</span><span class="o">.</span><span class="n">stop_gradient</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-29-387"><a id="__codelineno-29-387" name="__codelineno-29-387"></a>
</span><span id="__span-29-388"><a id="__codelineno-29-388" name="__codelineno-29-388"></a>        <span class="n">input_trans</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-29-389"><a id="__codelineno-29-389" name="__codelineno-29-389"></a>            <span class="s2">"input_tempo_disc_from_target"</span><span class="p">:</span> <span class="n">density_high_from_target</span><span class="p">,</span>
</span><span id="__span-29-390"><a id="__codelineno-29-390" name="__codelineno-29-390"></a>            <span class="s2">"input_tempo_disc_from_gen"</span><span class="p">:</span> <span class="n">density_high_from_gen</span><span class="p">,</span>
</span><span id="__span-29-391"><a id="__codelineno-29-391" name="__codelineno-29-391"></a>        <span class="p">}</span>
</span><span id="__span-29-392"><a id="__codelineno-29-392" name="__codelineno-29-392"></a>
</span><span id="__span-29-393"><a id="__codelineno-29-393" name="__codelineno-29-393"></a>        <span class="k">return</span> <span class="n">dereshape_input</span><span class="p">(</span><span class="n">input_trans</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="__span-29-394"><a id="__codelineno-29-394" name="__codelineno-29-394"></a>
</span><span id="__span-29-395"><a id="__codelineno-29-395" name="__codelineno-29-395"></a>    <span class="k">def</span> <span class="nf">loss_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span><span id="__span-29-396"><a id="__codelineno-29-396" name="__codelineno-29-396"></a>        <span class="n">out_disc_from_target</span> <span class="o">=</span> <span class="n">output_dict</span><span class="p">[</span><span class="s2">"out_disc_from_target"</span><span class="p">]</span>
</span><span id="__span-29-397"><a id="__codelineno-29-397" name="__codelineno-29-397"></a>        <span class="n">out_disc_from_gen</span> <span class="o">=</span> <span class="n">output_dict</span><span class="p">[</span><span class="s2">"out_disc_from_gen"</span><span class="p">]</span>
</span><span id="__span-29-398"><a id="__codelineno-29-398" name="__codelineno-29-398"></a>
</span><span id="__span-29-399"><a id="__codelineno-29-399" name="__codelineno-29-399"></a>        <span class="n">label_ones</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">out_disc_from_target</span><span class="p">)</span>
</span><span id="__span-29-400"><a id="__codelineno-29-400" name="__codelineno-29-400"></a>        <span class="n">label_zeros</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">out_disc_from_gen</span><span class="p">)</span>
</span><span id="__span-29-401"><a id="__codelineno-29-401" name="__codelineno-29-401"></a>
</span><span id="__span-29-402"><a id="__codelineno-29-402" name="__codelineno-29-402"></a>        <span class="n">loss_disc_from_target</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">binary_cross_entropy_with_logits</span><span class="p">(</span>
</span><span id="__span-29-403"><a id="__codelineno-29-403" name="__codelineno-29-403"></a>            <span class="n">out_disc_from_target</span><span class="p">,</span> <span class="n">label_ones</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">"mean"</span>
</span><span id="__span-29-404"><a id="__codelineno-29-404" name="__codelineno-29-404"></a>        <span class="p">)</span>
</span><span id="__span-29-405"><a id="__codelineno-29-405" name="__codelineno-29-405"></a>        <span class="n">loss_disc_from_gen</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">binary_cross_entropy_with_logits</span><span class="p">(</span>
</span><span id="__span-29-406"><a id="__codelineno-29-406" name="__codelineno-29-406"></a>            <span class="n">out_disc_from_gen</span><span class="p">,</span> <span class="n">label_zeros</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">"mean"</span>
</span><span id="__span-29-407"><a id="__codelineno-29-407" name="__codelineno-29-407"></a>        <span class="p">)</span>
</span><span id="__span-29-408"><a id="__codelineno-29-408" name="__codelineno-29-408"></a>        <span class="n">losses</span> <span class="o">=</span> <span class="n">loss_disc_from_target</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_disc</span> <span class="o">+</span> <span class="n">loss_disc_from_gen</span>
</span><span id="__span-29-409"><a id="__codelineno-29-409" name="__codelineno-29-409"></a>        <span class="k">return</span> <span class="n">losses</span>
</span><span id="__span-29-410"><a id="__codelineno-29-410" name="__codelineno-29-410"></a>
</span><span id="__span-29-411"><a id="__codelineno-29-411" name="__codelineno-29-411"></a>    <span class="k">def</span> <span class="nf">loss_func_tempo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span><span id="__span-29-412"><a id="__codelineno-29-412" name="__codelineno-29-412"></a>        <span class="n">out_disc_tempo_from_target</span> <span class="o">=</span> <span class="n">output_dict</span><span class="p">[</span><span class="s2">"out_disc_tempo_from_target"</span><span class="p">]</span>
</span><span id="__span-29-413"><a id="__codelineno-29-413" name="__codelineno-29-413"></a>        <span class="n">out_disc_tempo_from_gen</span> <span class="o">=</span> <span class="n">output_dict</span><span class="p">[</span><span class="s2">"out_disc_tempo_from_gen"</span><span class="p">]</span>
</span><span id="__span-29-414"><a id="__codelineno-29-414" name="__codelineno-29-414"></a>
</span><span id="__span-29-415"><a id="__codelineno-29-415" name="__codelineno-29-415"></a>        <span class="n">label_ones</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">out_disc_tempo_from_target</span><span class="p">)</span>
</span><span id="__span-29-416"><a id="__codelineno-29-416" name="__codelineno-29-416"></a>        <span class="n">label_zeros</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">out_disc_tempo_from_gen</span><span class="p">)</span>
</span><span id="__span-29-417"><a id="__codelineno-29-417" name="__codelineno-29-417"></a>
</span><span id="__span-29-418"><a id="__codelineno-29-418" name="__codelineno-29-418"></a>        <span class="n">loss_disc_tempo_from_target</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">binary_cross_entropy_with_logits</span><span class="p">(</span>
</span><span id="__span-29-419"><a id="__codelineno-29-419" name="__codelineno-29-419"></a>            <span class="n">out_disc_tempo_from_target</span><span class="p">,</span> <span class="n">label_ones</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">"mean"</span>
</span><span id="__span-29-420"><a id="__codelineno-29-420" name="__codelineno-29-420"></a>        <span class="p">)</span>
</span><span id="__span-29-421"><a id="__codelineno-29-421" name="__codelineno-29-421"></a>        <span class="n">loss_disc_tempo_from_gen</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">binary_cross_entropy_with_logits</span><span class="p">(</span>
</span><span id="__span-29-422"><a id="__codelineno-29-422" name="__codelineno-29-422"></a>            <span class="n">out_disc_tempo_from_gen</span><span class="p">,</span> <span class="n">label_zeros</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">"mean"</span>
</span><span id="__span-29-423"><a id="__codelineno-29-423" name="__codelineno-29-423"></a>        <span class="p">)</span>
</span><span id="__span-29-424"><a id="__codelineno-29-424" name="__codelineno-29-424"></a>        <span class="n">losses</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-29-425"><a id="__codelineno-29-425" name="__codelineno-29-425"></a>            <span class="n">loss_disc_tempo_from_target</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_disc</span> <span class="o">+</span> <span class="n">loss_disc_tempo_from_gen</span>
</span><span id="__span-29-426"><a id="__codelineno-29-426" name="__codelineno-29-426"></a>        <span class="p">)</span>
</span><span id="__span-29-427"><a id="__codelineno-29-427" name="__codelineno-29-427"></a>        <span class="k">return</span> <span class="n">losses</span>
</span><span id="__span-29-428"><a id="__codelineno-29-428" name="__codelineno-29-428"></a>
</span><span id="__span-29-429"><a id="__codelineno-29-429" name="__codelineno-29-429"></a>
</span><span id="__span-29-430"><a id="__codelineno-29-430" name="__codelineno-29-430"></a><span class="k">class</span> <span class="nc">DataFuncs</span><span class="p">:</span>
</span><span id="__span-29-431"><a id="__codelineno-29-431" name="__codelineno-29-431"></a><span class="w">    </span><span class="sd">"""All functions used for data transform.</span>
</span><span id="__span-29-432"><a id="__codelineno-29-432" name="__codelineno-29-432"></a>
</span><span id="__span-29-433"><a id="__codelineno-29-433" name="__codelineno-29-433"></a><span class="sd">    Args:</span>
</span><span id="__span-29-434"><a id="__codelineno-29-434" name="__codelineno-29-434"></a><span class="sd">        tile_ratio (int, optional): How many tiles of one dim. Defaults to 1.</span>
</span><span id="__span-29-435"><a id="__codelineno-29-435" name="__codelineno-29-435"></a><span class="sd">        density_min (float, optional): Minimize density of one tile. Defaults to 0.02.</span>
</span><span id="__span-29-436"><a id="__codelineno-29-436" name="__codelineno-29-436"></a><span class="sd">        max_turn (int, optional): Maximize turn of taking a tile from one image. Defaults to 20.</span>
</span><span id="__span-29-437"><a id="__codelineno-29-437" name="__codelineno-29-437"></a><span class="sd">    """</span>
</span><span id="__span-29-438"><a id="__codelineno-29-438" name="__codelineno-29-438"></a>
</span><span id="__span-29-439"><a id="__codelineno-29-439" name="__codelineno-29-439"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="__span-29-440"><a id="__codelineno-29-440" name="__codelineno-29-440"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">tile_ratio</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">density_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">max_turn</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span>
</span><span id="__span-29-441"><a id="__codelineno-29-441" name="__codelineno-29-441"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-29-442"><a id="__codelineno-29-442" name="__codelineno-29-442"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile_ratio</span> <span class="o">=</span> <span class="n">tile_ratio</span>
</span><span id="__span-29-443"><a id="__codelineno-29-443" name="__codelineno-29-443"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">density_min</span> <span class="o">=</span> <span class="n">density_min</span>
</span><span id="__span-29-444"><a id="__codelineno-29-444" name="__codelineno-29-444"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_turn</span> <span class="o">=</span> <span class="n">max_turn</span>
</span><span id="__span-29-445"><a id="__codelineno-29-445" name="__codelineno-29-445"></a>
</span><span id="__span-29-446"><a id="__codelineno-29-446" name="__codelineno-29-446"></a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span>
</span><span id="__span-29-447"><a id="__codelineno-29-447" name="__codelineno-29-447"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-29-448"><a id="__codelineno-29-448" name="__codelineno-29-448"></a>        <span class="n">input_item</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
</span><span id="__span-29-449"><a id="__codelineno-29-449" name="__codelineno-29-449"></a>        <span class="n">label_item</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
</span><span id="__span-29-450"><a id="__codelineno-29-450" name="__codelineno-29-450"></a>        <span class="n">weight_item</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
</span><span id="__span-29-451"><a id="__codelineno-29-451" name="__codelineno-29-451"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
</span><span id="__span-29-452"><a id="__codelineno-29-452" name="__codelineno-29-452"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_ratio</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="__span-29-453"><a id="__codelineno-29-453" name="__codelineno-29-453"></a>            <span class="k">return</span> <span class="n">input_item</span><span class="p">,</span> <span class="n">label_item</span><span class="p">,</span> <span class="n">weight_item</span>
</span><span id="__span-29-454"><a id="__codelineno-29-454" name="__codelineno-29-454"></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_turn</span><span class="p">):</span>
</span><span id="__span-29-455"><a id="__codelineno-29-455" name="__codelineno-29-455"></a>            <span class="n">rand_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
</span><span id="__span-29-456"><a id="__codelineno-29-456" name="__codelineno-29-456"></a>            <span class="n">density_low</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cut_data</span><span class="p">(</span><span class="n">input_item</span><span class="p">[</span><span class="s2">"density_low"</span><span class="p">],</span> <span class="n">rand_ratio</span><span class="p">)</span>
</span><span id="__span-29-457"><a id="__codelineno-29-457" name="__codelineno-29-457"></a>            <span class="n">density_high</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cut_data</span><span class="p">(</span><span class="n">input_item</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">],</span> <span class="n">rand_ratio</span><span class="p">)</span>
</span><span id="__span-29-458"><a id="__codelineno-29-458" name="__codelineno-29-458"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid_tile</span><span class="p">(</span><span class="n">density_low</span><span class="p">):</span>
</span><span id="__span-29-459"><a id="__codelineno-29-459" name="__codelineno-29-459"></a>                <span class="k">break</span>
</span><span id="__span-29-460"><a id="__codelineno-29-460" name="__codelineno-29-460"></a>
</span><span id="__span-29-461"><a id="__codelineno-29-461" name="__codelineno-29-461"></a>        <span class="n">input_item</span><span class="p">[</span><span class="s2">"density_low"</span><span class="p">]</span> <span class="o">=</span> <span class="n">density_low</span>
</span><span id="__span-29-462"><a id="__codelineno-29-462" name="__codelineno-29-462"></a>        <span class="n">input_item</span><span class="p">[</span><span class="s2">"density_high"</span><span class="p">]</span> <span class="o">=</span> <span class="n">density_high</span>
</span><span id="__span-29-463"><a id="__codelineno-29-463" name="__codelineno-29-463"></a>        <span class="k">return</span> <span class="n">input_item</span><span class="p">,</span> <span class="n">label_item</span><span class="p">,</span> <span class="n">weight_item</span>
</span><span id="__span-29-464"><a id="__codelineno-29-464" name="__codelineno-29-464"></a>
</span><span id="__span-29-465"><a id="__codelineno-29-465" name="__codelineno-29-465"></a>    <span class="k">def</span> <span class="nf">cut_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">rand_ratio</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">paddle</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="__span-29-466"><a id="__codelineno-29-466" name="__codelineno-29-466"></a>        <span class="c1"># data: C,H,W</span>
</span><span id="__span-29-467"><a id="__codelineno-29-467" name="__codelineno-29-467"></a>        <span class="n">_</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</span><span id="__span-29-468"><a id="__codelineno-29-468" name="__codelineno-29-468"></a>        <span class="k">if</span> <span class="n">H</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_ratio</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">W</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_ratio</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-29-469"><a id="__codelineno-29-469" name="__codelineno-29-469"></a>            <span class="n">exit</span><span class="p">(</span>
</span><span id="__span-29-470"><a id="__codelineno-29-470" name="__codelineno-29-470"></a>                <span class="sa">f</span><span class="s2">"ERROR: input images cannot be divided into </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_ratio</span><span class="si">}</span><span class="s2"> parts evenly!"</span>
</span><span id="__span-29-471"><a id="__codelineno-29-471" name="__codelineno-29-471"></a>            <span class="p">)</span>
</span><span id="__span-29-472"><a id="__codelineno-29-472" name="__codelineno-29-472"></a>        <span class="n">tile_shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">H</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_ratio</span><span class="p">,</span> <span class="n">W</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_ratio</span><span class="p">]</span>
</span><span id="__span-29-473"><a id="__codelineno-29-473" name="__codelineno-29-473"></a>        <span class="n">rand_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">rand_ratio</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tile_shape</span><span class="p">)))</span>
</span><span id="__span-29-474"><a id="__codelineno-29-474" name="__codelineno-29-474"></a>        <span class="n">start</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">rand_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">rand_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
</span><span id="__span-29-475"><a id="__codelineno-29-475" name="__codelineno-29-475"></a>        <span class="n">end</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">rand_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">rand_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
</span><span id="__span-29-476"><a id="__codelineno-29-476" name="__codelineno-29-476"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span>
</span><span id="__span-29-477"><a id="__codelineno-29-477" name="__codelineno-29-477"></a>            <span class="n">paddle</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">starts</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">ends</span><span class="o">=</span><span class="n">end</span>
</span><span id="__span-29-478"><a id="__codelineno-29-478" name="__codelineno-29-478"></a>        <span class="p">)</span>
</span><span id="__span-29-479"><a id="__codelineno-29-479" name="__codelineno-29-479"></a>
</span><span id="__span-29-480"><a id="__codelineno-29-480" name="__codelineno-29-480"></a>        <span class="k">return</span> <span class="n">data</span>
</span><span id="__span-29-481"><a id="__codelineno-29-481" name="__codelineno-29-481"></a>
</span><span id="__span-29-482"><a id="__codelineno-29-482" name="__codelineno-29-482"></a>    <span class="k">def</span> <span class="nf">is_valid_tile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile</span><span class="p">:</span> <span class="n">paddle</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="__span-29-483"><a id="__codelineno-29-483" name="__codelineno-29-483"></a>        <span class="n">img_density</span> <span class="o">=</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="__span-29-484"><a id="__codelineno-29-484" name="__codelineno-29-484"></a>        <span class="k">return</span> <span class="n">img_density</span> <span class="o">&gt;=</span> <span class="p">(</span>
</span><span id="__span-29-485"><a id="__codelineno-29-485" name="__codelineno-29-485"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">density_min</span> <span class="o">*</span> <span class="n">tile</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">tile</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">tile</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="__span-29-486"><a id="__codelineno-29-486" name="__codelineno-29-486"></a>        <span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-py highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">gan.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1">  1</a></span>
<span class="normal"><a href="#__codelineno-30-2">  2</a></span>
<span class="normal"><a href="#__codelineno-30-3">  3</a></span>
<span class="normal"><a href="#__codelineno-30-4">  4</a></span>
<span class="normal"><a href="#__codelineno-30-5">  5</a></span>
<span class="normal"><a href="#__codelineno-30-6">  6</a></span>
<span class="normal"><a href="#__codelineno-30-7">  7</a></span>
<span class="normal"><a href="#__codelineno-30-8">  8</a></span>
<span class="normal"><a href="#__codelineno-30-9">  9</a></span>
<span class="normal"><a href="#__codelineno-30-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-30-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-30-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-30-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-30-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-30-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-30-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-30-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-30-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-30-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-30-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-30-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-30-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-30-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-30-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-30-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-30-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-30-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-30-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-30-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-30-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-30-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-30-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-30-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-30-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-30-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-30-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-30-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-30-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-30-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-30-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-30-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-30-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-30-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-30-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-30-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-30-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-30-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-30-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-30-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-30-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-30-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-30-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-30-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-30-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-30-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-30-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-30-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-30-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-30-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-30-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-30-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-30-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-30-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-30-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-30-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-30-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-30-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-30-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-30-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-30-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-30-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-30-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-30-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-30-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-30-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-30-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-30-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-30-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-30-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-30-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-30-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-30-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-30-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-30-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-30-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-30-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-30-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-30-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-30-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-30-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-30-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-30-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-30-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-30-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-30-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-30-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-30-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-30-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-30-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-30-100">100</a></span>
<span class="normal"><a href="#__codelineno-30-101">101</a></span>
<span class="normal"><a href="#__codelineno-30-102">102</a></span>
<span class="normal"><a href="#__codelineno-30-103">103</a></span>
<span class="normal"><a href="#__codelineno-30-104">104</a></span>
<span class="normal"><a href="#__codelineno-30-105">105</a></span>
<span class="normal"><a href="#__codelineno-30-106">106</a></span>
<span class="normal"><a href="#__codelineno-30-107">107</a></span>
<span class="normal"><a href="#__codelineno-30-108">108</a></span>
<span class="normal"><a href="#__codelineno-30-109">109</a></span>
<span class="normal"><a href="#__codelineno-30-110">110</a></span>
<span class="normal"><a href="#__codelineno-30-111">111</a></span>
<span class="normal"><a href="#__codelineno-30-112">112</a></span>
<span class="normal"><a href="#__codelineno-30-113">113</a></span>
<span class="normal"><a href="#__codelineno-30-114">114</a></span>
<span class="normal"><a href="#__codelineno-30-115">115</a></span>
<span class="normal"><a href="#__codelineno-30-116">116</a></span>
<span class="normal"><a href="#__codelineno-30-117">117</a></span>
<span class="normal"><a href="#__codelineno-30-118">118</a></span>
<span class="normal"><a href="#__codelineno-30-119">119</a></span>
<span class="normal"><a href="#__codelineno-30-120">120</a></span>
<span class="normal"><a href="#__codelineno-30-121">121</a></span>
<span class="normal"><a href="#__codelineno-30-122">122</a></span>
<span class="normal"><a href="#__codelineno-30-123">123</a></span>
<span class="normal"><a href="#__codelineno-30-124">124</a></span>
<span class="normal"><a href="#__codelineno-30-125">125</a></span>
<span class="normal"><a href="#__codelineno-30-126">126</a></span>
<span class="normal"><a href="#__codelineno-30-127">127</a></span>
<span class="normal"><a href="#__codelineno-30-128">128</a></span>
<span class="normal"><a href="#__codelineno-30-129">129</a></span>
<span class="normal"><a href="#__codelineno-30-130">130</a></span>
<span class="normal"><a href="#__codelineno-30-131">131</a></span>
<span class="normal"><a href="#__codelineno-30-132">132</a></span>
<span class="normal"><a href="#__codelineno-30-133">133</a></span>
<span class="normal"><a href="#__codelineno-30-134">134</a></span>
<span class="normal"><a href="#__codelineno-30-135">135</a></span>
<span class="normal"><a href="#__codelineno-30-136">136</a></span>
<span class="normal"><a href="#__codelineno-30-137">137</a></span>
<span class="normal"><a href="#__codelineno-30-138">138</a></span>
<span class="normal"><a href="#__codelineno-30-139">139</a></span>
<span class="normal"><a href="#__codelineno-30-140">140</a></span>
<span class="normal"><a href="#__codelineno-30-141">141</a></span>
<span class="normal"><a href="#__codelineno-30-142">142</a></span>
<span class="normal"><a href="#__codelineno-30-143">143</a></span>
<span class="normal"><a href="#__codelineno-30-144">144</a></span>
<span class="normal"><a href="#__codelineno-30-145">145</a></span>
<span class="normal"><a href="#__codelineno-30-146">146</a></span>
<span class="normal"><a href="#__codelineno-30-147">147</a></span>
<span class="normal"><a href="#__codelineno-30-148">148</a></span>
<span class="normal"><a href="#__codelineno-30-149">149</a></span>
<span class="normal"><a href="#__codelineno-30-150">150</a></span>
<span class="normal"><a href="#__codelineno-30-151">151</a></span>
<span class="normal"><a href="#__codelineno-30-152">152</a></span>
<span class="normal"><a href="#__codelineno-30-153">153</a></span>
<span class="normal"><a href="#__codelineno-30-154">154</a></span>
<span class="normal"><a href="#__codelineno-30-155">155</a></span>
<span class="normal"><a href="#__codelineno-30-156">156</a></span>
<span class="normal"><a href="#__codelineno-30-157">157</a></span>
<span class="normal"><a href="#__codelineno-30-158">158</a></span>
<span class="normal"><a href="#__codelineno-30-159">159</a></span>
<span class="normal"><a href="#__codelineno-30-160">160</a></span>
<span class="normal"><a href="#__codelineno-30-161">161</a></span>
<span class="normal"><a href="#__codelineno-30-162">162</a></span>
<span class="normal"><a href="#__codelineno-30-163">163</a></span>
<span class="normal"><a href="#__codelineno-30-164">164</a></span>
<span class="normal"><a href="#__codelineno-30-165">165</a></span>
<span class="normal"><a href="#__codelineno-30-166">166</a></span>
<span class="normal"><a href="#__codelineno-30-167">167</a></span>
<span class="normal"><a href="#__codelineno-30-168">168</a></span>
<span class="normal"><a href="#__codelineno-30-169">169</a></span>
<span class="normal"><a href="#__codelineno-30-170">170</a></span>
<span class="normal"><a href="#__codelineno-30-171">171</a></span>
<span class="normal"><a href="#__codelineno-30-172">172</a></span>
<span class="normal"><a href="#__codelineno-30-173">173</a></span>
<span class="normal"><a href="#__codelineno-30-174">174</a></span>
<span class="normal"><a href="#__codelineno-30-175">175</a></span>
<span class="normal"><a href="#__codelineno-30-176">176</a></span>
<span class="normal"><a href="#__codelineno-30-177">177</a></span>
<span class="normal"><a href="#__codelineno-30-178">178</a></span>
<span class="normal"><a href="#__codelineno-30-179">179</a></span>
<span class="normal"><a href="#__codelineno-30-180">180</a></span>
<span class="normal"><a href="#__codelineno-30-181">181</a></span>
<span class="normal"><a href="#__codelineno-30-182">182</a></span>
<span class="normal"><a href="#__codelineno-30-183">183</a></span>
<span class="normal"><a href="#__codelineno-30-184">184</a></span>
<span class="normal"><a href="#__codelineno-30-185">185</a></span>
<span class="normal"><a href="#__codelineno-30-186">186</a></span>
<span class="normal"><a href="#__codelineno-30-187">187</a></span>
<span class="normal"><a href="#__codelineno-30-188">188</a></span>
<span class="normal"><a href="#__codelineno-30-189">189</a></span>
<span class="normal"><a href="#__codelineno-30-190">190</a></span>
<span class="normal"><a href="#__codelineno-30-191">191</a></span>
<span class="normal"><a href="#__codelineno-30-192">192</a></span>
<span class="normal"><a href="#__codelineno-30-193">193</a></span>
<span class="normal"><a href="#__codelineno-30-194">194</a></span>
<span class="normal"><a href="#__codelineno-30-195">195</a></span>
<span class="normal"><a href="#__codelineno-30-196">196</a></span>
<span class="normal"><a href="#__codelineno-30-197">197</a></span>
<span class="normal"><a href="#__codelineno-30-198">198</a></span>
<span class="normal"><a href="#__codelineno-30-199">199</a></span>
<span class="normal"><a href="#__codelineno-30-200">200</a></span>
<span class="normal"><a href="#__codelineno-30-201">201</a></span>
<span class="normal"><a href="#__codelineno-30-202">202</a></span>
<span class="normal"><a href="#__codelineno-30-203">203</a></span>
<span class="normal"><a href="#__codelineno-30-204">204</a></span>
<span class="normal"><a href="#__codelineno-30-205">205</a></span>
<span class="normal"><a href="#__codelineno-30-206">206</a></span>
<span class="normal"><a href="#__codelineno-30-207">207</a></span>
<span class="normal"><a href="#__codelineno-30-208">208</a></span>
<span class="normal"><a href="#__codelineno-30-209">209</a></span>
<span class="normal"><a href="#__codelineno-30-210">210</a></span>
<span class="normal"><a href="#__codelineno-30-211">211</a></span>
<span class="normal"><a href="#__codelineno-30-212">212</a></span>
<span class="normal"><a href="#__codelineno-30-213">213</a></span>
<span class="normal"><a href="#__codelineno-30-214">214</a></span>
<span class="normal"><a href="#__codelineno-30-215">215</a></span>
<span class="normal"><a href="#__codelineno-30-216">216</a></span>
<span class="normal"><a href="#__codelineno-30-217">217</a></span>
<span class="normal"><a href="#__codelineno-30-218">218</a></span>
<span class="normal"><a href="#__codelineno-30-219">219</a></span>
<span class="normal"><a href="#__codelineno-30-220">220</a></span>
<span class="normal"><a href="#__codelineno-30-221">221</a></span>
<span class="normal"><a href="#__codelineno-30-222">222</a></span>
<span class="normal"><a href="#__codelineno-30-223">223</a></span>
<span class="normal"><a href="#__codelineno-30-224">224</a></span>
<span class="normal"><a href="#__codelineno-30-225">225</a></span>
<span class="normal"><a href="#__codelineno-30-226">226</a></span>
<span class="normal"><a href="#__codelineno-30-227">227</a></span>
<span class="normal"><a href="#__codelineno-30-228">228</a></span>
<span class="normal"><a href="#__codelineno-30-229">229</a></span>
<span class="normal"><a href="#__codelineno-30-230">230</a></span>
<span class="normal"><a href="#__codelineno-30-231">231</a></span>
<span class="normal"><a href="#__codelineno-30-232">232</a></span>
<span class="normal"><a href="#__codelineno-30-233">233</a></span>
<span class="normal"><a href="#__codelineno-30-234">234</a></span>
<span class="normal"><a href="#__codelineno-30-235">235</a></span>
<span class="normal"><a href="#__codelineno-30-236">236</a></span>
<span class="normal"><a href="#__codelineno-30-237">237</a></span>
<span class="normal"><a href="#__codelineno-30-238">238</a></span>
<span class="normal"><a href="#__codelineno-30-239">239</a></span>
<span class="normal"><a href="#__codelineno-30-240">240</a></span>
<span class="normal"><a href="#__codelineno-30-241">241</a></span>
<span class="normal"><a href="#__codelineno-30-242">242</a></span>
<span class="normal"><a href="#__codelineno-30-243">243</a></span>
<span class="normal"><a href="#__codelineno-30-244">244</a></span>
<span class="normal"><a href="#__codelineno-30-245">245</a></span>
<span class="normal"><a href="#__codelineno-30-246">246</a></span>
<span class="normal"><a href="#__codelineno-30-247">247</a></span>
<span class="normal"><a href="#__codelineno-30-248">248</a></span>
<span class="normal"><a href="#__codelineno-30-249">249</a></span>
<span class="normal"><a href="#__codelineno-30-250">250</a></span>
<span class="normal"><a href="#__codelineno-30-251">251</a></span>
<span class="normal"><a href="#__codelineno-30-252">252</a></span>
<span class="normal"><a href="#__codelineno-30-253">253</a></span>
<span class="normal"><a href="#__codelineno-30-254">254</a></span>
<span class="normal"><a href="#__codelineno-30-255">255</a></span>
<span class="normal"><a href="#__codelineno-30-256">256</a></span>
<span class="normal"><a href="#__codelineno-30-257">257</a></span>
<span class="normal"><a href="#__codelineno-30-258">258</a></span>
<span class="normal"><a href="#__codelineno-30-259">259</a></span>
<span class="normal"><a href="#__codelineno-30-260">260</a></span>
<span class="normal"><a href="#__codelineno-30-261">261</a></span>
<span class="normal"><a href="#__codelineno-30-262">262</a></span>
<span class="normal"><a href="#__codelineno-30-263">263</a></span>
<span class="normal"><a href="#__codelineno-30-264">264</a></span>
<span class="normal"><a href="#__codelineno-30-265">265</a></span>
<span class="normal"><a href="#__codelineno-30-266">266</a></span>
<span class="normal"><a href="#__codelineno-30-267">267</a></span>
<span class="normal"><a href="#__codelineno-30-268">268</a></span>
<span class="normal"><a href="#__codelineno-30-269">269</a></span>
<span class="normal"><a href="#__codelineno-30-270">270</a></span>
<span class="normal"><a href="#__codelineno-30-271">271</a></span>
<span class="normal"><a href="#__codelineno-30-272">272</a></span>
<span class="normal"><a href="#__codelineno-30-273">273</a></span>
<span class="normal"><a href="#__codelineno-30-274">274</a></span>
<span class="normal"><a href="#__codelineno-30-275">275</a></span>
<span class="normal"><a href="#__codelineno-30-276">276</a></span>
<span class="normal"><a href="#__codelineno-30-277">277</a></span>
<span class="normal"><a href="#__codelineno-30-278">278</a></span>
<span class="normal"><a href="#__codelineno-30-279">279</a></span>
<span class="normal"><a href="#__codelineno-30-280">280</a></span>
<span class="normal"><a href="#__codelineno-30-281">281</a></span>
<span class="normal"><a href="#__codelineno-30-282">282</a></span>
<span class="normal"><a href="#__codelineno-30-283">283</a></span>
<span class="normal"><a href="#__codelineno-30-284">284</a></span>
<span class="normal"><a href="#__codelineno-30-285">285</a></span>
<span class="normal"><a href="#__codelineno-30-286">286</a></span>
<span class="normal"><a href="#__codelineno-30-287">287</a></span>
<span class="normal"><a href="#__codelineno-30-288">288</a></span>
<span class="normal"><a href="#__codelineno-30-289">289</a></span>
<span class="normal"><a href="#__codelineno-30-290">290</a></span>
<span class="normal"><a href="#__codelineno-30-291">291</a></span>
<span class="normal"><a href="#__codelineno-30-292">292</a></span>
<span class="normal"><a href="#__codelineno-30-293">293</a></span>
<span class="normal"><a href="#__codelineno-30-294">294</a></span>
<span class="normal"><a href="#__codelineno-30-295">295</a></span>
<span class="normal"><a href="#__codelineno-30-296">296</a></span>
<span class="normal"><a href="#__codelineno-30-297">297</a></span>
<span class="normal"><a href="#__codelineno-30-298">298</a></span>
<span class="normal"><a href="#__codelineno-30-299">299</a></span>
<span class="normal"><a href="#__codelineno-30-300">300</a></span>
<span class="normal"><a href="#__codelineno-30-301">301</a></span>
<span class="normal"><a href="#__codelineno-30-302">302</a></span>
<span class="normal"><a href="#__codelineno-30-303">303</a></span>
<span class="normal"><a href="#__codelineno-30-304">304</a></span>
<span class="normal"><a href="#__codelineno-30-305">305</a></span>
<span class="normal"><a href="#__codelineno-30-306">306</a></span>
<span class="normal"><a href="#__codelineno-30-307">307</a></span>
<span class="normal"><a href="#__codelineno-30-308">308</a></span>
<span class="normal"><a href="#__codelineno-30-309">309</a></span>
<span class="normal"><a href="#__codelineno-30-310">310</a></span>
<span class="normal"><a href="#__codelineno-30-311">311</a></span>
<span class="normal"><a href="#__codelineno-30-312">312</a></span>
<span class="normal"><a href="#__codelineno-30-313">313</a></span>
<span class="normal"><a href="#__codelineno-30-314">314</a></span>
<span class="normal"><a href="#__codelineno-30-315">315</a></span>
<span class="normal"><a href="#__codelineno-30-316">316</a></span>
<span class="normal"><a href="#__codelineno-30-317">317</a></span>
<span class="normal"><a href="#__codelineno-30-318">318</a></span>
<span class="normal"><a href="#__codelineno-30-319">319</a></span>
<span class="normal"><a href="#__codelineno-30-320">320</a></span>
<span class="normal"><a href="#__codelineno-30-321">321</a></span>
<span class="normal"><a href="#__codelineno-30-322">322</a></span>
<span class="normal"><a href="#__codelineno-30-323">323</a></span>
<span class="normal"><a href="#__codelineno-30-324">324</a></span>
<span class="normal"><a href="#__codelineno-30-325">325</a></span>
<span class="normal"><a href="#__codelineno-30-326">326</a></span>
<span class="normal"><a href="#__codelineno-30-327">327</a></span>
<span class="normal"><a href="#__codelineno-30-328">328</a></span>
<span class="normal"><a href="#__codelineno-30-329">329</a></span>
<span class="normal"><a href="#__codelineno-30-330">330</a></span>
<span class="normal"><a href="#__codelineno-30-331">331</a></span>
<span class="normal"><a href="#__codelineno-30-332">332</a></span>
<span class="normal"><a href="#__codelineno-30-333">333</a></span>
<span class="normal"><a href="#__codelineno-30-334">334</a></span>
<span class="normal"><a href="#__codelineno-30-335">335</a></span>
<span class="normal"><a href="#__codelineno-30-336">336</a></span>
<span class="normal"><a href="#__codelineno-30-337">337</a></span>
<span class="normal"><a href="#__codelineno-30-338">338</a></span>
<span class="normal"><a href="#__codelineno-30-339">339</a></span>
<span class="normal"><a href="#__codelineno-30-340">340</a></span>
<span class="normal"><a href="#__codelineno-30-341">341</a></span>
<span class="normal"><a href="#__codelineno-30-342">342</a></span>
<span class="normal"><a href="#__codelineno-30-343">343</a></span>
<span class="normal"><a href="#__codelineno-30-344">344</a></span>
<span class="normal"><a href="#__codelineno-30-345">345</a></span>
<span class="normal"><a href="#__codelineno-30-346">346</a></span>
<span class="normal"><a href="#__codelineno-30-347">347</a></span>
<span class="normal"><a href="#__codelineno-30-348">348</a></span>
<span class="normal"><a href="#__codelineno-30-349">349</a></span>
<span class="normal"><a href="#__codelineno-30-350">350</a></span>
<span class="normal"><a href="#__codelineno-30-351">351</a></span>
<span class="normal"><a href="#__codelineno-30-352">352</a></span>
<span class="normal"><a href="#__codelineno-30-353">353</a></span>
<span class="normal"><a href="#__codelineno-30-354">354</a></span>
<span class="normal"><a href="#__codelineno-30-355">355</a></span>
<span class="normal"><a href="#__codelineno-30-356">356</a></span>
<span class="normal"><a href="#__codelineno-30-357">357</a></span>
<span class="normal"><a href="#__codelineno-30-358">358</a></span>
<span class="normal"><a href="#__codelineno-30-359">359</a></span>
<span class="normal"><a href="#__codelineno-30-360">360</a></span>
<span class="normal"><a href="#__codelineno-30-361">361</a></span>
<span class="normal"><a href="#__codelineno-30-362">362</a></span>
<span class="normal"><a href="#__codelineno-30-363">363</a></span>
<span class="normal"><a href="#__codelineno-30-364">364</a></span>
<span class="normal"><a href="#__codelineno-30-365">365</a></span>
<span class="normal"><a href="#__codelineno-30-366">366</a></span>
<span class="normal"><a href="#__codelineno-30-367">367</a></span>
<span class="normal"><a href="#__codelineno-30-368">368</a></span>
<span class="normal"><a href="#__codelineno-30-369">369</a></span>
<span class="normal"><a href="#__codelineno-30-370">370</a></span>
<span class="normal"><a href="#__codelineno-30-371">371</a></span>
<span class="normal"><a href="#__codelineno-30-372">372</a></span>
<span class="normal"><a href="#__codelineno-30-373">373</a></span>
<span class="normal"><a href="#__codelineno-30-374">374</a></span>
<span class="normal"><a href="#__codelineno-30-375">375</a></span>
<span class="normal"><a href="#__codelineno-30-376">376</a></span>
<span class="normal"><a href="#__codelineno-30-377">377</a></span>
<span class="normal"><a href="#__codelineno-30-378">378</a></span>
<span class="normal"><a href="#__codelineno-30-379">379</a></span>
<span class="normal"><a href="#__codelineno-30-380">380</a></span>
<span class="normal"><a href="#__codelineno-30-381">381</a></span>
<span class="normal"><a href="#__codelineno-30-382">382</a></span>
<span class="normal"><a href="#__codelineno-30-383">383</a></span>
<span class="normal"><a href="#__codelineno-30-384">384</a></span>
<span class="normal"><a href="#__codelineno-30-385">385</a></span>
<span class="normal"><a href="#__codelineno-30-386">386</a></span>
<span class="normal"><a href="#__codelineno-30-387">387</a></span>
<span class="normal"><a href="#__codelineno-30-388">388</a></span>
<span class="normal"><a href="#__codelineno-30-389">389</a></span>
<span class="normal"><a href="#__codelineno-30-390">390</a></span>
<span class="normal"><a href="#__codelineno-30-391">391</a></span>
<span class="normal"><a href="#__codelineno-30-392">392</a></span>
<span class="normal"><a href="#__codelineno-30-393">393</a></span>
<span class="normal"><a href="#__codelineno-30-394">394</a></span>
<span class="normal"><a href="#__codelineno-30-395">395</a></span>
<span class="normal"><a href="#__codelineno-30-396">396</a></span>
<span class="normal"><a href="#__codelineno-30-397">397</a></span>
<span class="normal"><a href="#__codelineno-30-398">398</a></span>
<span class="normal"><a href="#__codelineno-30-399">399</a></span>
<span class="normal"><a href="#__codelineno-30-400">400</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="c1"># Copyright (c) 2023 PaddlePaddle Authors. All Rights Reserved.</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2"></a>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3"></a><span class="c1"># Licensed under the Apache License, Version 2.0 (the "License");</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4"></a><span class="c1"># you may not use this file except in compliance with the License.</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5"></a><span class="c1"># You may obtain a copy of the License at</span>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6"></a>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7"></a><span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8"></a>
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9"></a><span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10"></a><span class="c1"># distributed under the License is distributed on an "AS IS" BASIS,</span>
</span><span id="__span-30-11"><a id="__codelineno-30-11" name="__codelineno-30-11"></a><span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span><span id="__span-30-12"><a id="__codelineno-30-12" name="__codelineno-30-12"></a><span class="c1"># See the License for the specific language governing permissions and</span>
</span><span id="__span-30-13"><a id="__codelineno-30-13" name="__codelineno-30-13"></a><span class="c1"># limitations under the License.</span>
</span><span id="__span-30-14"><a id="__codelineno-30-14" name="__codelineno-30-14"></a>
</span><span id="__span-30-15"><a id="__codelineno-30-15" name="__codelineno-30-15"></a><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
</span><span id="__span-30-16"><a id="__codelineno-30-16" name="__codelineno-30-16"></a>
</span><span id="__span-30-17"><a id="__codelineno-30-17" name="__codelineno-30-17"></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
</span><span id="__span-30-18"><a id="__codelineno-30-18" name="__codelineno-30-18"></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
</span><span id="__span-30-19"><a id="__codelineno-30-19" name="__codelineno-30-19"></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
</span><span id="__span-30-20"><a id="__codelineno-30-20" name="__codelineno-30-20"></a>
</span><span id="__span-30-21"><a id="__codelineno-30-21" name="__codelineno-30-21"></a><span class="kn">import</span> <span class="nn">paddle</span>
</span><span id="__span-30-22"><a id="__codelineno-30-22" name="__codelineno-30-22"></a><span class="kn">import</span> <span class="nn">paddle.nn</span> <span class="k">as</span> <span class="nn">nn</span>
</span><span id="__span-30-23"><a id="__codelineno-30-23" name="__codelineno-30-23"></a>
</span><span id="__span-30-24"><a id="__codelineno-30-24" name="__codelineno-30-24"></a><span class="kn">from</span> <span class="nn">ppsci.arch</span> <span class="kn">import</span> <span class="n">activation</span> <span class="k">as</span> <span class="n">act_mod</span>
</span><span id="__span-30-25"><a id="__codelineno-30-25" name="__codelineno-30-25"></a><span class="kn">from</span> <span class="nn">ppsci.arch</span> <span class="kn">import</span> <span class="n">base</span>
</span><span id="__span-30-26"><a id="__codelineno-30-26" name="__codelineno-30-26"></a>
</span><span id="__span-30-27"><a id="__codelineno-30-27" name="__codelineno-30-27"></a>
</span><span id="__span-30-28"><a id="__codelineno-30-28" name="__codelineno-30-28"></a><span class="k">class</span> <span class="nc">Conv2DBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
</span><span id="__span-30-29"><a id="__codelineno-30-29" name="__codelineno-30-29"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="__span-30-30"><a id="__codelineno-30-30" name="__codelineno-30-30"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-30-31"><a id="__codelineno-30-31" name="__codelineno-30-31"></a>        <span class="n">in_channel</span><span class="p">,</span>
</span><span id="__span-30-32"><a id="__codelineno-30-32" name="__codelineno-30-32"></a>        <span class="n">out_channel</span><span class="p">,</span>
</span><span id="__span-30-33"><a id="__codelineno-30-33" name="__codelineno-30-33"></a>        <span class="n">kernel_size</span><span class="p">,</span>
</span><span id="__span-30-34"><a id="__codelineno-30-34" name="__codelineno-30-34"></a>        <span class="n">stride</span><span class="p">,</span>
</span><span id="__span-30-35"><a id="__codelineno-30-35" name="__codelineno-30-35"></a>        <span class="n">use_bn</span><span class="p">,</span>
</span><span id="__span-30-36"><a id="__codelineno-30-36" name="__codelineno-30-36"></a>        <span class="n">act</span><span class="p">,</span>
</span><span id="__span-30-37"><a id="__codelineno-30-37" name="__codelineno-30-37"></a>        <span class="n">mean</span><span class="p">,</span>
</span><span id="__span-30-38"><a id="__codelineno-30-38" name="__codelineno-30-38"></a>        <span class="n">std</span><span class="p">,</span>
</span><span id="__span-30-39"><a id="__codelineno-30-39" name="__codelineno-30-39"></a>        <span class="n">value</span><span class="p">,</span>
</span><span id="__span-30-40"><a id="__codelineno-30-40" name="__codelineno-30-40"></a>    <span class="p">):</span>
</span><span id="__span-30-41"><a id="__codelineno-30-41" name="__codelineno-30-41"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-30-42"><a id="__codelineno-30-42" name="__codelineno-30-42"></a>        <span class="n">weight_attr</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">ParamAttr</span><span class="p">(</span>
</span><span id="__span-30-43"><a id="__codelineno-30-43" name="__codelineno-30-43"></a>            <span class="n">initializer</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">initializer</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">std</span><span class="p">)</span>
</span><span id="__span-30-44"><a id="__codelineno-30-44" name="__codelineno-30-44"></a>        <span class="p">)</span>
</span><span id="__span-30-45"><a id="__codelineno-30-45" name="__codelineno-30-45"></a>        <span class="n">bias_attr</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">ParamAttr</span><span class="p">(</span><span class="n">initializer</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">initializer</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">))</span>
</span><span id="__span-30-46"><a id="__codelineno-30-46" name="__codelineno-30-46"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv_2d</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span>
</span><span id="__span-30-47"><a id="__codelineno-30-47" name="__codelineno-30-47"></a>            <span class="n">in_channel</span><span class="p">,</span>
</span><span id="__span-30-48"><a id="__codelineno-30-48" name="__codelineno-30-48"></a>            <span class="n">out_channel</span><span class="p">,</span>
</span><span id="__span-30-49"><a id="__codelineno-30-49" name="__codelineno-30-49"></a>            <span class="n">kernel_size</span><span class="p">,</span>
</span><span id="__span-30-50"><a id="__codelineno-30-50" name="__codelineno-30-50"></a>            <span class="n">stride</span><span class="p">,</span>
</span><span id="__span-30-51"><a id="__codelineno-30-51" name="__codelineno-30-51"></a>            <span class="n">padding</span><span class="o">=</span><span class="s2">"SAME"</span><span class="p">,</span>
</span><span id="__span-30-52"><a id="__codelineno-30-52" name="__codelineno-30-52"></a>            <span class="n">weight_attr</span><span class="o">=</span><span class="n">weight_attr</span><span class="p">,</span>
</span><span id="__span-30-53"><a id="__codelineno-30-53" name="__codelineno-30-53"></a>            <span class="n">bias_attr</span><span class="o">=</span><span class="n">bias_attr</span><span class="p">,</span>
</span><span id="__span-30-54"><a id="__codelineno-30-54" name="__codelineno-30-54"></a>        <span class="p">)</span>
</span><span id="__span-30-55"><a id="__codelineno-30-55" name="__codelineno-30-55"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2D</span><span class="p">(</span><span class="n">out_channel</span><span class="p">)</span> <span class="k">if</span> <span class="n">use_bn</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="__span-30-56"><a id="__codelineno-30-56" name="__codelineno-30-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">act</span> <span class="o">=</span> <span class="n">act_mod</span><span class="o">.</span><span class="n">get_activation</span><span class="p">(</span><span class="n">act</span><span class="p">)</span> <span class="k">if</span> <span class="n">act</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="__span-30-57"><a id="__codelineno-30-57" name="__codelineno-30-57"></a>
</span><span id="__span-30-58"><a id="__codelineno-30-58" name="__codelineno-30-58"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-30-59"><a id="__codelineno-30-59" name="__codelineno-30-59"></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="__span-30-60"><a id="__codelineno-30-60" name="__codelineno-30-60"></a>        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_2d</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="__span-30-61"><a id="__codelineno-30-61" name="__codelineno-30-61"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn</span><span class="p">:</span>
</span><span id="__span-30-62"><a id="__codelineno-30-62" name="__codelineno-30-62"></a>            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="__span-30-63"><a id="__codelineno-30-63" name="__codelineno-30-63"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">act</span><span class="p">:</span>
</span><span id="__span-30-64"><a id="__codelineno-30-64" name="__codelineno-30-64"></a>            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="__span-30-65"><a id="__codelineno-30-65" name="__codelineno-30-65"></a>        <span class="k">return</span> <span class="n">y</span>
</span><span id="__span-30-66"><a id="__codelineno-30-66" name="__codelineno-30-66"></a>
</span><span id="__span-30-67"><a id="__codelineno-30-67" name="__codelineno-30-67"></a>
</span><span id="__span-30-68"><a id="__codelineno-30-68" name="__codelineno-30-68"></a><span class="k">class</span> <span class="nc">VariantResBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
</span><span id="__span-30-69"><a id="__codelineno-30-69" name="__codelineno-30-69"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="__span-30-70"><a id="__codelineno-30-70" name="__codelineno-30-70"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-30-71"><a id="__codelineno-30-71" name="__codelineno-30-71"></a>        <span class="n">in_channel</span><span class="p">,</span>
</span><span id="__span-30-72"><a id="__codelineno-30-72" name="__codelineno-30-72"></a>        <span class="n">out_channels</span><span class="p">,</span>
</span><span id="__span-30-73"><a id="__codelineno-30-73" name="__codelineno-30-73"></a>        <span class="n">kernel_sizes</span><span class="p">,</span>
</span><span id="__span-30-74"><a id="__codelineno-30-74" name="__codelineno-30-74"></a>        <span class="n">strides</span><span class="p">,</span>
</span><span id="__span-30-75"><a id="__codelineno-30-75" name="__codelineno-30-75"></a>        <span class="n">use_bns</span><span class="p">,</span>
</span><span id="__span-30-76"><a id="__codelineno-30-76" name="__codelineno-30-76"></a>        <span class="n">acts</span><span class="p">,</span>
</span><span id="__span-30-77"><a id="__codelineno-30-77" name="__codelineno-30-77"></a>        <span class="n">mean</span><span class="p">,</span>
</span><span id="__span-30-78"><a id="__codelineno-30-78" name="__codelineno-30-78"></a>        <span class="n">std</span><span class="p">,</span>
</span><span id="__span-30-79"><a id="__codelineno-30-79" name="__codelineno-30-79"></a>        <span class="n">value</span><span class="p">,</span>
</span><span id="__span-30-80"><a id="__codelineno-30-80" name="__codelineno-30-80"></a>    <span class="p">):</span>
</span><span id="__span-30-81"><a id="__codelineno-30-81" name="__codelineno-30-81"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-30-82"><a id="__codelineno-30-82" name="__codelineno-30-82"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv_2d_0</span> <span class="o">=</span> <span class="n">Conv2DBlock</span><span class="p">(</span>
</span><span id="__span-30-83"><a id="__codelineno-30-83" name="__codelineno-30-83"></a>            <span class="n">in_channel</span><span class="o">=</span><span class="n">in_channel</span><span class="p">,</span>
</span><span id="__span-30-84"><a id="__codelineno-30-84" name="__codelineno-30-84"></a>            <span class="n">out_channel</span><span class="o">=</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="__span-30-85"><a id="__codelineno-30-85" name="__codelineno-30-85"></a>            <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="__span-30-86"><a id="__codelineno-30-86" name="__codelineno-30-86"></a>            <span class="n">stride</span><span class="o">=</span><span class="n">strides</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="__span-30-87"><a id="__codelineno-30-87" name="__codelineno-30-87"></a>            <span class="n">use_bn</span><span class="o">=</span><span class="n">use_bns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="__span-30-88"><a id="__codelineno-30-88" name="__codelineno-30-88"></a>            <span class="n">act</span><span class="o">=</span><span class="n">acts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="__span-30-89"><a id="__codelineno-30-89" name="__codelineno-30-89"></a>            <span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span>
</span><span id="__span-30-90"><a id="__codelineno-30-90" name="__codelineno-30-90"></a>            <span class="n">std</span><span class="o">=</span><span class="n">std</span><span class="p">,</span>
</span><span id="__span-30-91"><a id="__codelineno-30-91" name="__codelineno-30-91"></a>            <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
</span><span id="__span-30-92"><a id="__codelineno-30-92" name="__codelineno-30-92"></a>        <span class="p">)</span>
</span><span id="__span-30-93"><a id="__codelineno-30-93" name="__codelineno-30-93"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv_2d_1</span> <span class="o">=</span> <span class="n">Conv2DBlock</span><span class="p">(</span>
</span><span id="__span-30-94"><a id="__codelineno-30-94" name="__codelineno-30-94"></a>            <span class="n">in_channel</span><span class="o">=</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="__span-30-95"><a id="__codelineno-30-95" name="__codelineno-30-95"></a>            <span class="n">out_channel</span><span class="o">=</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="__span-30-96"><a id="__codelineno-30-96" name="__codelineno-30-96"></a>            <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="__span-30-97"><a id="__codelineno-30-97" name="__codelineno-30-97"></a>            <span class="n">stride</span><span class="o">=</span><span class="n">strides</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="__span-30-98"><a id="__codelineno-30-98" name="__codelineno-30-98"></a>            <span class="n">use_bn</span><span class="o">=</span><span class="n">use_bns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="__span-30-99"><a id="__codelineno-30-99" name="__codelineno-30-99"></a>            <span class="n">act</span><span class="o">=</span><span class="n">acts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="__span-30-100"><a id="__codelineno-30-100" name="__codelineno-30-100"></a>            <span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span>
</span><span id="__span-30-101"><a id="__codelineno-30-101" name="__codelineno-30-101"></a>            <span class="n">std</span><span class="o">=</span><span class="n">std</span><span class="p">,</span>
</span><span id="__span-30-102"><a id="__codelineno-30-102" name="__codelineno-30-102"></a>            <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
</span><span id="__span-30-103"><a id="__codelineno-30-103" name="__codelineno-30-103"></a>        <span class="p">)</span>
</span><span id="__span-30-104"><a id="__codelineno-30-104" name="__codelineno-30-104"></a>
</span><span id="__span-30-105"><a id="__codelineno-30-105" name="__codelineno-30-105"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv_2d_2</span> <span class="o">=</span> <span class="n">Conv2DBlock</span><span class="p">(</span>
</span><span id="__span-30-106"><a id="__codelineno-30-106" name="__codelineno-30-106"></a>            <span class="n">in_channel</span><span class="o">=</span><span class="n">in_channel</span><span class="p">,</span>
</span><span id="__span-30-107"><a id="__codelineno-30-107" name="__codelineno-30-107"></a>            <span class="n">out_channel</span><span class="o">=</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span id="__span-30-108"><a id="__codelineno-30-108" name="__codelineno-30-108"></a>            <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_sizes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span id="__span-30-109"><a id="__codelineno-30-109" name="__codelineno-30-109"></a>            <span class="n">stride</span><span class="o">=</span><span class="n">strides</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span id="__span-30-110"><a id="__codelineno-30-110" name="__codelineno-30-110"></a>            <span class="n">use_bn</span><span class="o">=</span><span class="n">use_bns</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span id="__span-30-111"><a id="__codelineno-30-111" name="__codelineno-30-111"></a>            <span class="n">act</span><span class="o">=</span><span class="n">acts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span id="__span-30-112"><a id="__codelineno-30-112" name="__codelineno-30-112"></a>            <span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span>
</span><span id="__span-30-113"><a id="__codelineno-30-113" name="__codelineno-30-113"></a>            <span class="n">std</span><span class="o">=</span><span class="n">std</span><span class="p">,</span>
</span><span id="__span-30-114"><a id="__codelineno-30-114" name="__codelineno-30-114"></a>            <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
</span><span id="__span-30-115"><a id="__codelineno-30-115" name="__codelineno-30-115"></a>        <span class="p">)</span>
</span><span id="__span-30-116"><a id="__codelineno-30-116" name="__codelineno-30-116"></a>
</span><span id="__span-30-117"><a id="__codelineno-30-117" name="__codelineno-30-117"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">act</span> <span class="o">=</span> <span class="n">act_mod</span><span class="o">.</span><span class="n">get_activation</span><span class="p">(</span><span class="s2">"relu"</span><span class="p">)</span>
</span><span id="__span-30-118"><a id="__codelineno-30-118" name="__codelineno-30-118"></a>
</span><span id="__span-30-119"><a id="__codelineno-30-119" name="__codelineno-30-119"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-30-120"><a id="__codelineno-30-120" name="__codelineno-30-120"></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="__span-30-121"><a id="__codelineno-30-121" name="__codelineno-30-121"></a>        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_2d_0</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="__span-30-122"><a id="__codelineno-30-122" name="__codelineno-30-122"></a>        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_2d_1</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="__span-30-123"><a id="__codelineno-30-123" name="__codelineno-30-123"></a>        <span class="n">short</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_2d_2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-30-124"><a id="__codelineno-30-124" name="__codelineno-30-124"></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">short</span><span class="p">)</span>
</span><span id="__span-30-125"><a id="__codelineno-30-125" name="__codelineno-30-125"></a>        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="__span-30-126"><a id="__codelineno-30-126" name="__codelineno-30-126"></a>        <span class="k">return</span> <span class="n">y</span>
</span><span id="__span-30-127"><a id="__codelineno-30-127" name="__codelineno-30-127"></a>
</span><span id="__span-30-128"><a id="__codelineno-30-128" name="__codelineno-30-128"></a>
</span><span id="__span-30-129"><a id="__codelineno-30-129" name="__codelineno-30-129"></a><span class="k">class</span> <span class="nc">FCBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
</span><span id="__span-30-130"><a id="__codelineno-30-130" name="__codelineno-30-130"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_channel</span><span class="p">,</span> <span class="n">act</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="__span-30-131"><a id="__codelineno-30-131" name="__codelineno-30-131"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-30-132"><a id="__codelineno-30-132" name="__codelineno-30-132"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()</span>
</span><span id="__span-30-133"><a id="__codelineno-30-133" name="__codelineno-30-133"></a>        <span class="n">weight_attr</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">ParamAttr</span><span class="p">(</span>
</span><span id="__span-30-134"><a id="__codelineno-30-134" name="__codelineno-30-134"></a>            <span class="n">initializer</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">initializer</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">std</span><span class="p">)</span>
</span><span id="__span-30-135"><a id="__codelineno-30-135" name="__codelineno-30-135"></a>        <span class="p">)</span>
</span><span id="__span-30-136"><a id="__codelineno-30-136" name="__codelineno-30-136"></a>        <span class="n">bias_attr</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">ParamAttr</span><span class="p">(</span><span class="n">initializer</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">initializer</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">))</span>
</span><span id="__span-30-137"><a id="__codelineno-30-137" name="__codelineno-30-137"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span>
</span><span id="__span-30-138"><a id="__codelineno-30-138" name="__codelineno-30-138"></a>            <span class="n">in_channel</span><span class="p">,</span>
</span><span id="__span-30-139"><a id="__codelineno-30-139" name="__codelineno-30-139"></a>            <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-30-140"><a id="__codelineno-30-140" name="__codelineno-30-140"></a>            <span class="n">weight_attr</span><span class="o">=</span><span class="n">weight_attr</span><span class="p">,</span>
</span><span id="__span-30-141"><a id="__codelineno-30-141" name="__codelineno-30-141"></a>            <span class="n">bias_attr</span><span class="o">=</span><span class="n">bias_attr</span><span class="p">,</span>
</span><span id="__span-30-142"><a id="__codelineno-30-142" name="__codelineno-30-142"></a>        <span class="p">)</span>
</span><span id="__span-30-143"><a id="__codelineno-30-143" name="__codelineno-30-143"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">act</span> <span class="o">=</span> <span class="n">act_mod</span><span class="o">.</span><span class="n">get_activation</span><span class="p">(</span><span class="n">act</span><span class="p">)</span> <span class="k">if</span> <span class="n">act</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="__span-30-144"><a id="__codelineno-30-144" name="__codelineno-30-144"></a>
</span><span id="__span-30-145"><a id="__codelineno-30-145" name="__codelineno-30-145"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-30-146"><a id="__codelineno-30-146" name="__codelineno-30-146"></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="__span-30-147"><a id="__codelineno-30-147" name="__codelineno-30-147"></a>        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="__span-30-148"><a id="__codelineno-30-148" name="__codelineno-30-148"></a>        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="__span-30-149"><a id="__codelineno-30-149" name="__codelineno-30-149"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">act</span><span class="p">:</span>
</span><span id="__span-30-150"><a id="__codelineno-30-150" name="__codelineno-30-150"></a>            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="__span-30-151"><a id="__codelineno-30-151" name="__codelineno-30-151"></a>        <span class="k">return</span> <span class="n">y</span>
</span><span id="__span-30-152"><a id="__codelineno-30-152" name="__codelineno-30-152"></a>
</span><span id="__span-30-153"><a id="__codelineno-30-153" name="__codelineno-30-153"></a>
</span><span id="__span-30-154"><a id="__codelineno-30-154" name="__codelineno-30-154"></a><span class="k">class</span> <span class="nc">Generator</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">Arch</span><span class="p">):</span>
</span><span id="__span-30-155"><a id="__codelineno-30-155" name="__codelineno-30-155"></a><span class="w">    </span><span class="sd">"""Generator Net of GAN. Attention, the net using a kind of variant of ResBlock which is</span>
</span><span id="__span-30-156"><a id="__codelineno-30-156" name="__codelineno-30-156"></a><span class="sd">        unique to "tempoGAN" example but not an open source network.</span>
</span><span id="__span-30-157"><a id="__codelineno-30-157" name="__codelineno-30-157"></a>
</span><span id="__span-30-158"><a id="__codelineno-30-158" name="__codelineno-30-158"></a><span class="sd">    Args:</span>
</span><span id="__span-30-159"><a id="__codelineno-30-159" name="__codelineno-30-159"></a><span class="sd">        input_keys (Tuple[str, ...]): Name of input keys, such as ("input1", "input2").</span>
</span><span id="__span-30-160"><a id="__codelineno-30-160" name="__codelineno-30-160"></a><span class="sd">        output_keys (Tuple[str, ...]): Name of output keys, such as ("output1", "output2").</span>
</span><span id="__span-30-161"><a id="__codelineno-30-161" name="__codelineno-30-161"></a><span class="sd">        in_channel (int): Number of input channels of the first conv layer.</span>
</span><span id="__span-30-162"><a id="__codelineno-30-162" name="__codelineno-30-162"></a><span class="sd">        out_channels_tuple (Tuple[Tuple[int, ...], ...]): Number of output channels of all conv layers,</span>
</span><span id="__span-30-163"><a id="__codelineno-30-163" name="__codelineno-30-163"></a><span class="sd">            such as [[out_res0_conv0, out_res0_conv1], [out_res1_conv0, out_res1_conv1]]</span>
</span><span id="__span-30-164"><a id="__codelineno-30-164" name="__codelineno-30-164"></a><span class="sd">        kernel_sizes_tuple (Tuple[Tuple[int, ...], ...]): Number of kernel_size of all conv layers,</span>
</span><span id="__span-30-165"><a id="__codelineno-30-165" name="__codelineno-30-165"></a><span class="sd">            such as [[kernel_size_res0_conv0, kernel_size_res0_conv1], [kernel_size_res1_conv0, kernel_size_res1_conv1]]</span>
</span><span id="__span-30-166"><a id="__codelineno-30-166" name="__codelineno-30-166"></a><span class="sd">        strides_tuple (Tuple[Tuple[int, ...], ...]): Number of stride of all conv layers,</span>
</span><span id="__span-30-167"><a id="__codelineno-30-167" name="__codelineno-30-167"></a><span class="sd">            such as [[stride_res0_conv0, stride_res0_conv1], [stride_res1_conv0, stride_res1_conv1]]</span>
</span><span id="__span-30-168"><a id="__codelineno-30-168" name="__codelineno-30-168"></a><span class="sd">        use_bns_tuple (Tuple[Tuple[bool, ...], ...]): Whether to use the batch_norm layer after each conv layer.</span>
</span><span id="__span-30-169"><a id="__codelineno-30-169" name="__codelineno-30-169"></a><span class="sd">        acts_tuple (Tuple[Tuple[str, ...], ...]): Whether to use the activation layer after each conv layer. If so, witch activation to use,</span>
</span><span id="__span-30-170"><a id="__codelineno-30-170" name="__codelineno-30-170"></a><span class="sd">            such as [[act_res0_conv0, act_res0_conv1], [act_res1_conv0, act_res1_conv1]]</span>
</span><span id="__span-30-171"><a id="__codelineno-30-171" name="__codelineno-30-171"></a>
</span><span id="__span-30-172"><a id="__codelineno-30-172" name="__codelineno-30-172"></a><span class="sd">    Examples:</span>
</span><span id="__span-30-173"><a id="__codelineno-30-173" name="__codelineno-30-173"></a><span class="sd">        &gt;&gt;&gt; import ppsci</span>
</span><span id="__span-30-174"><a id="__codelineno-30-174" name="__codelineno-30-174"></a><span class="sd">        &gt;&gt;&gt; in_channel = 1</span>
</span><span id="__span-30-175"><a id="__codelineno-30-175" name="__codelineno-30-175"></a><span class="sd">        &gt;&gt;&gt; rb_channel0 = (2, 8, 8)</span>
</span><span id="__span-30-176"><a id="__codelineno-30-176" name="__codelineno-30-176"></a><span class="sd">        &gt;&gt;&gt; rb_channel1 = (128, 128, 128)</span>
</span><span id="__span-30-177"><a id="__codelineno-30-177" name="__codelineno-30-177"></a><span class="sd">        &gt;&gt;&gt; rb_channel2 = (32, 8, 8)</span>
</span><span id="__span-30-178"><a id="__codelineno-30-178" name="__codelineno-30-178"></a><span class="sd">        &gt;&gt;&gt; rb_channel3 = (2, 1, 1)</span>
</span><span id="__span-30-179"><a id="__codelineno-30-179" name="__codelineno-30-179"></a><span class="sd">        &gt;&gt;&gt; out_channels_tuple = (rb_channel0, rb_channel1, rb_channel2, rb_channel3)</span>
</span><span id="__span-30-180"><a id="__codelineno-30-180" name="__codelineno-30-180"></a><span class="sd">        &gt;&gt;&gt; kernel_sizes_tuple = (((5, 5), ) * 2 + ((1, 1), ), ) * 4</span>
</span><span id="__span-30-181"><a id="__codelineno-30-181" name="__codelineno-30-181"></a><span class="sd">        &gt;&gt;&gt; strides_tuple = ((1, 1, 1), ) * 4</span>
</span><span id="__span-30-182"><a id="__codelineno-30-182" name="__codelineno-30-182"></a><span class="sd">        &gt;&gt;&gt; use_bns_tuple = ((True, True, True), ) * 3 + ((False, False, False), )</span>
</span><span id="__span-30-183"><a id="__codelineno-30-183" name="__codelineno-30-183"></a><span class="sd">        &gt;&gt;&gt; acts_tuple = (("relu", None, None), ) * 4</span>
</span><span id="__span-30-184"><a id="__codelineno-30-184" name="__codelineno-30-184"></a><span class="sd">        &gt;&gt;&gt; model = ppsci.arch.Generator(("in",), ("out",), in_channel, out_channels_tuple, kernel_sizes_tuple, strides_tuple, use_bns_tuple, acts_tuple)</span>
</span><span id="__span-30-185"><a id="__codelineno-30-185" name="__codelineno-30-185"></a><span class="sd">        &gt;&gt;&gt; batch_size = 4</span>
</span><span id="__span-30-186"><a id="__codelineno-30-186" name="__codelineno-30-186"></a><span class="sd">        &gt;&gt;&gt; height = 64</span>
</span><span id="__span-30-187"><a id="__codelineno-30-187" name="__codelineno-30-187"></a><span class="sd">        &gt;&gt;&gt; width = 64</span>
</span><span id="__span-30-188"><a id="__codelineno-30-188" name="__codelineno-30-188"></a><span class="sd">        &gt;&gt;&gt; input_data = paddle.randn([batch_size, in_channel, height, width])</span>
</span><span id="__span-30-189"><a id="__codelineno-30-189" name="__codelineno-30-189"></a><span class="sd">        &gt;&gt;&gt; input_dict = {'in': input_data}</span>
</span><span id="__span-30-190"><a id="__codelineno-30-190" name="__codelineno-30-190"></a><span class="sd">        &gt;&gt;&gt; output_data = model(input_dict)</span>
</span><span id="__span-30-191"><a id="__codelineno-30-191" name="__codelineno-30-191"></a><span class="sd">        &gt;&gt;&gt; print(output_data['out'].shape)</span>
</span><span id="__span-30-192"><a id="__codelineno-30-192" name="__codelineno-30-192"></a><span class="sd">        [4, 1, 64, 64]</span>
</span><span id="__span-30-193"><a id="__codelineno-30-193" name="__codelineno-30-193"></a><span class="sd">    """</span>
</span><span id="__span-30-194"><a id="__codelineno-30-194" name="__codelineno-30-194"></a>
</span><span id="__span-30-195"><a id="__codelineno-30-195" name="__codelineno-30-195"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="__span-30-196"><a id="__codelineno-30-196" name="__codelineno-30-196"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-30-197"><a id="__codelineno-30-197" name="__codelineno-30-197"></a>        <span class="n">input_keys</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
</span><span id="__span-30-198"><a id="__codelineno-30-198" name="__codelineno-30-198"></a>        <span class="n">output_keys</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
</span><span id="__span-30-199"><a id="__codelineno-30-199" name="__codelineno-30-199"></a>        <span class="n">in_channel</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="__span-30-200"><a id="__codelineno-30-200" name="__codelineno-30-200"></a>        <span class="n">out_channels_tuple</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="o">...</span><span class="p">],</span>
</span><span id="__span-30-201"><a id="__codelineno-30-201" name="__codelineno-30-201"></a>        <span class="n">kernel_sizes_tuple</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="o">...</span><span class="p">],</span>
</span><span id="__span-30-202"><a id="__codelineno-30-202" name="__codelineno-30-202"></a>        <span class="n">strides_tuple</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="o">...</span><span class="p">],</span>
</span><span id="__span-30-203"><a id="__codelineno-30-203" name="__codelineno-30-203"></a>        <span class="n">use_bns_tuple</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="o">...</span><span class="p">],</span>
</span><span id="__span-30-204"><a id="__codelineno-30-204" name="__codelineno-30-204"></a>        <span class="n">acts_tuple</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="o">...</span><span class="p">],</span>
</span><span id="__span-30-205"><a id="__codelineno-30-205" name="__codelineno-30-205"></a>    <span class="p">):</span>
</span><span id="__span-30-206"><a id="__codelineno-30-206" name="__codelineno-30-206"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-30-207"><a id="__codelineno-30-207" name="__codelineno-30-207"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_keys</span> <span class="o">=</span> <span class="n">input_keys</span>
</span><span id="__span-30-208"><a id="__codelineno-30-208" name="__codelineno-30-208"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_keys</span> <span class="o">=</span> <span class="n">output_keys</span>
</span><span id="__span-30-209"><a id="__codelineno-30-209" name="__codelineno-30-209"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">in_channel</span> <span class="o">=</span> <span class="n">in_channel</span>
</span><span id="__span-30-210"><a id="__codelineno-30-210" name="__codelineno-30-210"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">out_channels_tuple</span> <span class="o">=</span> <span class="n">out_channels_tuple</span>
</span><span id="__span-30-211"><a id="__codelineno-30-211" name="__codelineno-30-211"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_sizes_tuple</span> <span class="o">=</span> <span class="n">kernel_sizes_tuple</span>
</span><span id="__span-30-212"><a id="__codelineno-30-212" name="__codelineno-30-212"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">strides_tuple</span> <span class="o">=</span> <span class="n">strides_tuple</span>
</span><span id="__span-30-213"><a id="__codelineno-30-213" name="__codelineno-30-213"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_bns_tuple</span> <span class="o">=</span> <span class="n">use_bns_tuple</span>
</span><span id="__span-30-214"><a id="__codelineno-30-214" name="__codelineno-30-214"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acts_tuple</span> <span class="o">=</span> <span class="n">acts_tuple</span>
</span><span id="__span-30-215"><a id="__codelineno-30-215" name="__codelineno-30-215"></a>
</span><span id="__span-30-216"><a id="__codelineno-30-216" name="__codelineno-30-216"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_blocks</span><span class="p">()</span>
</span><span id="__span-30-217"><a id="__codelineno-30-217" name="__codelineno-30-217"></a>
</span><span id="__span-30-218"><a id="__codelineno-30-218" name="__codelineno-30-218"></a>    <span class="k">def</span> <span class="nf">init_blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-30-219"><a id="__codelineno-30-219" name="__codelineno-30-219"></a>        <span class="n">blocks_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-30-220"><a id="__codelineno-30-220" name="__codelineno-30-220"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_channels_tuple</span><span class="p">)):</span>
</span><span id="__span-30-221"><a id="__codelineno-30-221" name="__codelineno-30-221"></a>            <span class="n">in_channel</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-30-222"><a id="__codelineno-30-222" name="__codelineno-30-222"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">in_channel</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_channels_tuple</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-30-223"><a id="__codelineno-30-223" name="__codelineno-30-223"></a>            <span class="p">)</span>
</span><span id="__span-30-224"><a id="__codelineno-30-224" name="__codelineno-30-224"></a>            <span class="n">blocks_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="__span-30-225"><a id="__codelineno-30-225" name="__codelineno-30-225"></a>                <span class="n">VariantResBlock</span><span class="p">(</span>
</span><span id="__span-30-226"><a id="__codelineno-30-226" name="__codelineno-30-226"></a>                    <span class="n">in_channel</span><span class="o">=</span><span class="n">in_channel</span><span class="p">,</span>
</span><span id="__span-30-227"><a id="__codelineno-30-227" name="__codelineno-30-227"></a>                    <span class="n">out_channels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_channels_tuple</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="__span-30-228"><a id="__codelineno-30-228" name="__codelineno-30-228"></a>                    <span class="n">kernel_sizes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_sizes_tuple</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="__span-30-229"><a id="__codelineno-30-229" name="__codelineno-30-229"></a>                    <span class="n">strides</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">strides_tuple</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="__span-30-230"><a id="__codelineno-30-230" name="__codelineno-30-230"></a>                    <span class="n">use_bns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bns_tuple</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="__span-30-231"><a id="__codelineno-30-231" name="__codelineno-30-231"></a>                    <span class="n">acts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">acts_tuple</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="__span-30-232"><a id="__codelineno-30-232" name="__codelineno-30-232"></a>                    <span class="n">mean</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="__span-30-233"><a id="__codelineno-30-233" name="__codelineno-30-233"></a>                    <span class="n">std</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span>
</span><span id="__span-30-234"><a id="__codelineno-30-234" name="__codelineno-30-234"></a>                    <span class="n">value</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="__span-30-235"><a id="__codelineno-30-235" name="__codelineno-30-235"></a>                <span class="p">)</span>
</span><span id="__span-30-236"><a id="__codelineno-30-236" name="__codelineno-30-236"></a>            <span class="p">)</span>
</span><span id="__span-30-237"><a id="__codelineno-30-237" name="__codelineno-30-237"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerList</span><span class="p">(</span><span class="n">blocks_list</span><span class="p">)</span>
</span><span id="__span-30-238"><a id="__codelineno-30-238" name="__codelineno-30-238"></a>
</span><span id="__span-30-239"><a id="__codelineno-30-239" name="__codelineno-30-239"></a>    <span class="k">def</span> <span class="nf">forward_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-30-240"><a id="__codelineno-30-240" name="__codelineno-30-240"></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="__span-30-241"><a id="__codelineno-30-241" name="__codelineno-30-241"></a>        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">:</span>
</span><span id="__span-30-242"><a id="__codelineno-30-242" name="__codelineno-30-242"></a>            <span class="n">y</span> <span class="o">=</span> <span class="n">block</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="__span-30-243"><a id="__codelineno-30-243" name="__codelineno-30-243"></a>        <span class="k">return</span> <span class="n">y</span>
</span><span id="__span-30-244"><a id="__codelineno-30-244" name="__codelineno-30-244"></a>
</span><span id="__span-30-245"><a id="__codelineno-30-245" name="__codelineno-30-245"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-30-246"><a id="__codelineno-30-246" name="__codelineno-30-246"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-30-247"><a id="__codelineno-30-247" name="__codelineno-30-247"></a>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-30-248"><a id="__codelineno-30-248" name="__codelineno-30-248"></a>
</span><span id="__span-30-249"><a id="__codelineno-30-249" name="__codelineno-30-249"></a>        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concat_to_tensor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_keys</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-30-250"><a id="__codelineno-30-250" name="__codelineno-30-250"></a>        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_tensor</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="__span-30-251"><a id="__codelineno-30-251" name="__codelineno-30-251"></a>        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_to_dict</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_keys</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-30-252"><a id="__codelineno-30-252" name="__codelineno-30-252"></a>
</span><span id="__span-30-253"><a id="__codelineno-30-253" name="__codelineno-30-253"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-30-254"><a id="__codelineno-30-254" name="__codelineno-30-254"></a>            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_transform</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="__span-30-255"><a id="__codelineno-30-255" name="__codelineno-30-255"></a>        <span class="k">return</span> <span class="n">y</span>
</span><span id="__span-30-256"><a id="__codelineno-30-256" name="__codelineno-30-256"></a>
</span><span id="__span-30-257"><a id="__codelineno-30-257" name="__codelineno-30-257"></a>
</span><span id="__span-30-258"><a id="__codelineno-30-258" name="__codelineno-30-258"></a><span class="k">class</span> <span class="nc">Discriminator</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">Arch</span><span class="p">):</span>
</span><span id="__span-30-259"><a id="__codelineno-30-259" name="__codelineno-30-259"></a><span class="w">    </span><span class="sd">"""Discriminator Net of GAN.</span>
</span><span id="__span-30-260"><a id="__codelineno-30-260" name="__codelineno-30-260"></a>
</span><span id="__span-30-261"><a id="__codelineno-30-261" name="__codelineno-30-261"></a><span class="sd">    Args:</span>
</span><span id="__span-30-262"><a id="__codelineno-30-262" name="__codelineno-30-262"></a><span class="sd">        input_keys (Tuple[str, ...]): Name of input keys, such as ("input1", "input2").</span>
</span><span id="__span-30-263"><a id="__codelineno-30-263" name="__codelineno-30-263"></a><span class="sd">        output_keys (Tuple[str, ...]): Name of output keys, such as ("output1", "output2").</span>
</span><span id="__span-30-264"><a id="__codelineno-30-264" name="__codelineno-30-264"></a><span class="sd">        in_channel (int):  Number of input channels of the first conv layer.</span>
</span><span id="__span-30-265"><a id="__codelineno-30-265" name="__codelineno-30-265"></a><span class="sd">        out_channels (Tuple[int, ...]): Number of output channels of all conv layers,</span>
</span><span id="__span-30-266"><a id="__codelineno-30-266" name="__codelineno-30-266"></a><span class="sd">            such as (out_conv0, out_conv1, out_conv2).</span>
</span><span id="__span-30-267"><a id="__codelineno-30-267" name="__codelineno-30-267"></a><span class="sd">        fc_channel (int):  Number of input features of linear layer. Number of output features of the layer</span>
</span><span id="__span-30-268"><a id="__codelineno-30-268" name="__codelineno-30-268"></a><span class="sd">            is set to 1 in this Net to construct a fully_connected layer.</span>
</span><span id="__span-30-269"><a id="__codelineno-30-269" name="__codelineno-30-269"></a><span class="sd">        kernel_sizes (Tuple[int, ...]): Number of kernel_size of all conv layers,</span>
</span><span id="__span-30-270"><a id="__codelineno-30-270" name="__codelineno-30-270"></a><span class="sd">            such as (kernel_size_conv0, kernel_size_conv1, kernel_size_conv2).</span>
</span><span id="__span-30-271"><a id="__codelineno-30-271" name="__codelineno-30-271"></a><span class="sd">        strides (Tuple[int, ...]): Number of stride of all conv layers,</span>
</span><span id="__span-30-272"><a id="__codelineno-30-272" name="__codelineno-30-272"></a><span class="sd">            such as (stride_conv0, stride_conv1, stride_conv2).</span>
</span><span id="__span-30-273"><a id="__codelineno-30-273" name="__codelineno-30-273"></a><span class="sd">        use_bns (Tuple[bool, ...]): Whether to use the batch_norm layer after each conv layer.</span>
</span><span id="__span-30-274"><a id="__codelineno-30-274" name="__codelineno-30-274"></a><span class="sd">        acts (Tuple[str, ...]): Whether to use the activation layer after each conv layer. If so, witch activation to use,</span>
</span><span id="__span-30-275"><a id="__codelineno-30-275" name="__codelineno-30-275"></a><span class="sd">            such as (act_conv0, act_conv1, act_conv2).</span>
</span><span id="__span-30-276"><a id="__codelineno-30-276" name="__codelineno-30-276"></a>
</span><span id="__span-30-277"><a id="__codelineno-30-277" name="__codelineno-30-277"></a><span class="sd">    Examples:</span>
</span><span id="__span-30-278"><a id="__codelineno-30-278" name="__codelineno-30-278"></a><span class="sd">        &gt;&gt;&gt; import ppsci</span>
</span><span id="__span-30-279"><a id="__codelineno-30-279" name="__codelineno-30-279"></a><span class="sd">        &gt;&gt;&gt; in_channel = 2</span>
</span><span id="__span-30-280"><a id="__codelineno-30-280" name="__codelineno-30-280"></a><span class="sd">        &gt;&gt;&gt; in_channel_tempo = 3</span>
</span><span id="__span-30-281"><a id="__codelineno-30-281" name="__codelineno-30-281"></a><span class="sd">        &gt;&gt;&gt; out_channels = (32, 64, 128, 256)</span>
</span><span id="__span-30-282"><a id="__codelineno-30-282" name="__codelineno-30-282"></a><span class="sd">        &gt;&gt;&gt; fc_channel = 65536</span>
</span><span id="__span-30-283"><a id="__codelineno-30-283" name="__codelineno-30-283"></a><span class="sd">        &gt;&gt;&gt; kernel_sizes = ((4, 4), (4, 4), (4, 4), (4, 4))</span>
</span><span id="__span-30-284"><a id="__codelineno-30-284" name="__codelineno-30-284"></a><span class="sd">        &gt;&gt;&gt; strides = (2, 2, 2, 1)</span>
</span><span id="__span-30-285"><a id="__codelineno-30-285" name="__codelineno-30-285"></a><span class="sd">        &gt;&gt;&gt; use_bns = (False, True, True, True)</span>
</span><span id="__span-30-286"><a id="__codelineno-30-286" name="__codelineno-30-286"></a><span class="sd">        &gt;&gt;&gt; acts = ("leaky_relu", "leaky_relu", "leaky_relu", "leaky_relu", None)</span>
</span><span id="__span-30-287"><a id="__codelineno-30-287" name="__codelineno-30-287"></a><span class="sd">        &gt;&gt;&gt; output_keys_disc = ("out_1", "out_2", "out_3", "out_4", "out_5", "out_6", "out_7", "out_8", "out_9", "out_10")</span>
</span><span id="__span-30-288"><a id="__codelineno-30-288" name="__codelineno-30-288"></a><span class="sd">        &gt;&gt;&gt; model = ppsci.arch.Discriminator(("in_1","in_2"), output_keys_disc, in_channel, out_channels, fc_channel, kernel_sizes, strides, use_bns, acts)</span>
</span><span id="__span-30-289"><a id="__codelineno-30-289" name="__codelineno-30-289"></a><span class="sd">        &gt;&gt;&gt; input_data = [paddle.to_tensor(paddle.randn([1, in_channel, 128, 128])),paddle.to_tensor(paddle.randn([1, in_channel, 128, 128]))]</span>
</span><span id="__span-30-290"><a id="__codelineno-30-290" name="__codelineno-30-290"></a><span class="sd">        &gt;&gt;&gt; input_dict = {"in_1": input_data[0],"in_2": input_data[1]}</span>
</span><span id="__span-30-291"><a id="__codelineno-30-291" name="__codelineno-30-291"></a><span class="sd">        &gt;&gt;&gt; out_dict = model(input_dict)</span>
</span><span id="__span-30-292"><a id="__codelineno-30-292" name="__codelineno-30-292"></a><span class="sd">        &gt;&gt;&gt; for k, v in out_dict.items():</span>
</span><span id="__span-30-293"><a id="__codelineno-30-293" name="__codelineno-30-293"></a><span class="sd">        ...     print(k, v.shape)</span>
</span><span id="__span-30-294"><a id="__codelineno-30-294" name="__codelineno-30-294"></a><span class="sd">        out_1 [1, 32, 64, 64]</span>
</span><span id="__span-30-295"><a id="__codelineno-30-295" name="__codelineno-30-295"></a><span class="sd">        out_2 [1, 64, 32, 32]</span>
</span><span id="__span-30-296"><a id="__codelineno-30-296" name="__codelineno-30-296"></a><span class="sd">        out_3 [1, 128, 16, 16]</span>
</span><span id="__span-30-297"><a id="__codelineno-30-297" name="__codelineno-30-297"></a><span class="sd">        out_4 [1, 256, 16, 16]</span>
</span><span id="__span-30-298"><a id="__codelineno-30-298" name="__codelineno-30-298"></a><span class="sd">        out_5 [1, 1]</span>
</span><span id="__span-30-299"><a id="__codelineno-30-299" name="__codelineno-30-299"></a><span class="sd">        out_6 [1, 32, 64, 64]</span>
</span><span id="__span-30-300"><a id="__codelineno-30-300" name="__codelineno-30-300"></a><span class="sd">        out_7 [1, 64, 32, 32]</span>
</span><span id="__span-30-301"><a id="__codelineno-30-301" name="__codelineno-30-301"></a><span class="sd">        out_8 [1, 128, 16, 16]</span>
</span><span id="__span-30-302"><a id="__codelineno-30-302" name="__codelineno-30-302"></a><span class="sd">        out_9 [1, 256, 16, 16]</span>
</span><span id="__span-30-303"><a id="__codelineno-30-303" name="__codelineno-30-303"></a><span class="sd">        out_10 [1, 1]</span>
</span><span id="__span-30-304"><a id="__codelineno-30-304" name="__codelineno-30-304"></a><span class="sd">    """</span>
</span><span id="__span-30-305"><a id="__codelineno-30-305" name="__codelineno-30-305"></a>
</span><span id="__span-30-306"><a id="__codelineno-30-306" name="__codelineno-30-306"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="__span-30-307"><a id="__codelineno-30-307" name="__codelineno-30-307"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-30-308"><a id="__codelineno-30-308" name="__codelineno-30-308"></a>        <span class="n">input_keys</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
</span><span id="__span-30-309"><a id="__codelineno-30-309" name="__codelineno-30-309"></a>        <span class="n">output_keys</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
</span><span id="__span-30-310"><a id="__codelineno-30-310" name="__codelineno-30-310"></a>        <span class="n">in_channel</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="__span-30-311"><a id="__codelineno-30-311" name="__codelineno-30-311"></a>        <span class="n">out_channels</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
</span><span id="__span-30-312"><a id="__codelineno-30-312" name="__codelineno-30-312"></a>        <span class="n">fc_channel</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="__span-30-313"><a id="__codelineno-30-313" name="__codelineno-30-313"></a>        <span class="n">kernel_sizes</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
</span><span id="__span-30-314"><a id="__codelineno-30-314" name="__codelineno-30-314"></a>        <span class="n">strides</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
</span><span id="__span-30-315"><a id="__codelineno-30-315" name="__codelineno-30-315"></a>        <span class="n">use_bns</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
</span><span id="__span-30-316"><a id="__codelineno-30-316" name="__codelineno-30-316"></a>        <span class="n">acts</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
</span><span id="__span-30-317"><a id="__codelineno-30-317" name="__codelineno-30-317"></a>    <span class="p">):</span>
</span><span id="__span-30-318"><a id="__codelineno-30-318" name="__codelineno-30-318"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-30-319"><a id="__codelineno-30-319" name="__codelineno-30-319"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_keys</span> <span class="o">=</span> <span class="n">input_keys</span>
</span><span id="__span-30-320"><a id="__codelineno-30-320" name="__codelineno-30-320"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_keys</span> <span class="o">=</span> <span class="n">output_keys</span>
</span><span id="__span-30-321"><a id="__codelineno-30-321" name="__codelineno-30-321"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">in_channel</span> <span class="o">=</span> <span class="n">in_channel</span>
</span><span id="__span-30-322"><a id="__codelineno-30-322" name="__codelineno-30-322"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">out_channels</span> <span class="o">=</span> <span class="n">out_channels</span>
</span><span id="__span-30-323"><a id="__codelineno-30-323" name="__codelineno-30-323"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc_channel</span> <span class="o">=</span> <span class="n">fc_channel</span>
</span><span id="__span-30-324"><a id="__codelineno-30-324" name="__codelineno-30-324"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_sizes</span> <span class="o">=</span> <span class="n">kernel_sizes</span>
</span><span id="__span-30-325"><a id="__codelineno-30-325" name="__codelineno-30-325"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">strides</span> <span class="o">=</span> <span class="n">strides</span>
</span><span id="__span-30-326"><a id="__codelineno-30-326" name="__codelineno-30-326"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_bns</span> <span class="o">=</span> <span class="n">use_bns</span>
</span><span id="__span-30-327"><a id="__codelineno-30-327" name="__codelineno-30-327"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acts</span> <span class="o">=</span> <span class="n">acts</span>
</span><span id="__span-30-328"><a id="__codelineno-30-328" name="__codelineno-30-328"></a>
</span><span id="__span-30-329"><a id="__codelineno-30-329" name="__codelineno-30-329"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_layers</span><span class="p">()</span>
</span><span id="__span-30-330"><a id="__codelineno-30-330" name="__codelineno-30-330"></a>
</span><span id="__span-30-331"><a id="__codelineno-30-331" name="__codelineno-30-331"></a>    <span class="k">def</span> <span class="nf">init_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-30-332"><a id="__codelineno-30-332" name="__codelineno-30-332"></a>        <span class="n">layers_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-30-333"><a id="__codelineno-30-333" name="__codelineno-30-333"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_channels</span><span class="p">)):</span>
</span><span id="__span-30-334"><a id="__codelineno-30-334" name="__codelineno-30-334"></a>            <span class="n">in_channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_channel</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_channels</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="__span-30-335"><a id="__codelineno-30-335" name="__codelineno-30-335"></a>            <span class="n">layers_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="__span-30-336"><a id="__codelineno-30-336" name="__codelineno-30-336"></a>                <span class="n">Conv2DBlock</span><span class="p">(</span>
</span><span id="__span-30-337"><a id="__codelineno-30-337" name="__codelineno-30-337"></a>                    <span class="n">in_channel</span><span class="o">=</span><span class="n">in_channel</span><span class="p">,</span>
</span><span id="__span-30-338"><a id="__codelineno-30-338" name="__codelineno-30-338"></a>                    <span class="n">out_channel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_channels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="__span-30-339"><a id="__codelineno-30-339" name="__codelineno-30-339"></a>                    <span class="n">kernel_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="__span-30-340"><a id="__codelineno-30-340" name="__codelineno-30-340"></a>                    <span class="n">stride</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="__span-30-341"><a id="__codelineno-30-341" name="__codelineno-30-341"></a>                    <span class="n">use_bn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bns</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="__span-30-342"><a id="__codelineno-30-342" name="__codelineno-30-342"></a>                    <span class="n">act</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">acts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="__span-30-343"><a id="__codelineno-30-343" name="__codelineno-30-343"></a>                    <span class="n">mean</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="__span-30-344"><a id="__codelineno-30-344" name="__codelineno-30-344"></a>                    <span class="n">std</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span>
</span><span id="__span-30-345"><a id="__codelineno-30-345" name="__codelineno-30-345"></a>                    <span class="n">value</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="__span-30-346"><a id="__codelineno-30-346" name="__codelineno-30-346"></a>                <span class="p">)</span>
</span><span id="__span-30-347"><a id="__codelineno-30-347" name="__codelineno-30-347"></a>            <span class="p">)</span>
</span><span id="__span-30-348"><a id="__codelineno-30-348" name="__codelineno-30-348"></a>
</span><span id="__span-30-349"><a id="__codelineno-30-349" name="__codelineno-30-349"></a>        <span class="n">layers_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="__span-30-350"><a id="__codelineno-30-350" name="__codelineno-30-350"></a>            <span class="n">FCBlock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc_channel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">acts</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">mean</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="__span-30-351"><a id="__codelineno-30-351" name="__codelineno-30-351"></a>        <span class="p">)</span>
</span><span id="__span-30-352"><a id="__codelineno-30-352" name="__codelineno-30-352"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerList</span><span class="p">(</span><span class="n">layers_list</span><span class="p">)</span>
</span><span id="__span-30-353"><a id="__codelineno-30-353" name="__codelineno-30-353"></a>
</span><span id="__span-30-354"><a id="__codelineno-30-354" name="__codelineno-30-354"></a>    <span class="k">def</span> <span class="nf">forward_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-30-355"><a id="__codelineno-30-355" name="__codelineno-30-355"></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="__span-30-356"><a id="__codelineno-30-356" name="__codelineno-30-356"></a>        <span class="n">y_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-30-357"><a id="__codelineno-30-357" name="__codelineno-30-357"></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="__span-30-358"><a id="__codelineno-30-358" name="__codelineno-30-358"></a>            <span class="n">y</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="__span-30-359"><a id="__codelineno-30-359" name="__codelineno-30-359"></a>            <span class="n">y_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="__span-30-360"><a id="__codelineno-30-360" name="__codelineno-30-360"></a>        <span class="k">return</span> <span class="n">y_list</span>  <span class="c1"># y_conv1, y_conv2, y_conv3, y_conv4, y_fc(y_out)</span>
</span><span id="__span-30-361"><a id="__codelineno-30-361" name="__codelineno-30-361"></a>
</span><span id="__span-30-362"><a id="__codelineno-30-362" name="__codelineno-30-362"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-30-363"><a id="__codelineno-30-363" name="__codelineno-30-363"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-30-364"><a id="__codelineno-30-364" name="__codelineno-30-364"></a>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-30-365"><a id="__codelineno-30-365" name="__codelineno-30-365"></a>
</span><span id="__span-30-366"><a id="__codelineno-30-366" name="__codelineno-30-366"></a>        <span class="n">y_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-30-367"><a id="__codelineno-30-367" name="__codelineno-30-367"></a>        <span class="c1"># y1_conv1, y1_conv2, y1_conv3, y1_conv4, y1_fc, y2_conv1, y2_conv2, y2_conv3, y2_conv4, y2_fc</span>
</span><span id="__span-30-368"><a id="__codelineno-30-368" name="__codelineno-30-368"></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
</span><span id="__span-30-369"><a id="__codelineno-30-369" name="__codelineno-30-369"></a>            <span class="n">y_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forward_tensor</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
</span><span id="__span-30-370"><a id="__codelineno-30-370" name="__codelineno-30-370"></a>
</span><span id="__span-30-371"><a id="__codelineno-30-371" name="__codelineno-30-371"></a>        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_to_dict</span><span class="p">(</span><span class="n">y_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_keys</span><span class="p">)</span>
</span><span id="__span-30-372"><a id="__codelineno-30-372" name="__codelineno-30-372"></a>
</span><span id="__span-30-373"><a id="__codelineno-30-373" name="__codelineno-30-373"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-30-374"><a id="__codelineno-30-374" name="__codelineno-30-374"></a>            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_transform</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="__span-30-375"><a id="__codelineno-30-375" name="__codelineno-30-375"></a>
</span><span id="__span-30-376"><a id="__codelineno-30-376" name="__codelineno-30-376"></a>        <span class="k">return</span> <span class="n">y</span>
</span><span id="__span-30-377"><a id="__codelineno-30-377" name="__codelineno-30-377"></a>
</span><span id="__span-30-378"><a id="__codelineno-30-378" name="__codelineno-30-378"></a>    <span class="nd">@staticmethod</span>
</span><span id="__span-30-379"><a id="__codelineno-30-379" name="__codelineno-30-379"></a>    <span class="k">def</span> <span class="nf">split_to_dict</span><span class="p">(</span>
</span><span id="__span-30-380"><a id="__codelineno-30-380" name="__codelineno-30-380"></a>        <span class="n">data_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">paddle</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">keys</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="__span-30-381"><a id="__codelineno-30-381" name="__codelineno-30-381"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">paddle</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
</span><span id="__span-30-382"><a id="__codelineno-30-382" name="__codelineno-30-382"></a><span class="w">        </span><span class="sd">"""Overwrite of split_to_dict() method belongs to Class base.Arch.</span>
</span><span id="__span-30-383"><a id="__codelineno-30-383" name="__codelineno-30-383"></a>
</span><span id="__span-30-384"><a id="__codelineno-30-384" name="__codelineno-30-384"></a><span class="sd">        Reason for overwriting is there is no concat_to_tensor() method called in "tempoGAN" example.</span>
</span><span id="__span-30-385"><a id="__codelineno-30-385" name="__codelineno-30-385"></a><span class="sd">        That is because input in "tempoGAN" example is not in a regular format, but a format like:</span>
</span><span id="__span-30-386"><a id="__codelineno-30-386" name="__codelineno-30-386"></a><span class="sd">        {</span>
</span><span id="__span-30-387"><a id="__codelineno-30-387" name="__codelineno-30-387"></a><span class="sd">            "input1": paddle.concat([in1, in2], axis=1),</span>
</span><span id="__span-30-388"><a id="__codelineno-30-388" name="__codelineno-30-388"></a><span class="sd">            "input2": paddle.concat([in1, in3], axis=1),</span>
</span><span id="__span-30-389"><a id="__codelineno-30-389" name="__codelineno-30-389"></a><span class="sd">        }</span>
</span><span id="__span-30-390"><a id="__codelineno-30-390" name="__codelineno-30-390"></a>
</span><span id="__span-30-391"><a id="__codelineno-30-391" name="__codelineno-30-391"></a><span class="sd">        Args:</span>
</span><span id="__span-30-392"><a id="__codelineno-30-392" name="__codelineno-30-392"></a><span class="sd">            data_list (List[paddle.Tensor]): The data to be split. It should be a list of tensor(s), but not a paddle.Tensor.</span>
</span><span id="__span-30-393"><a id="__codelineno-30-393" name="__codelineno-30-393"></a><span class="sd">            keys (Tuple[str, ...]): Keys of outputs.</span>
</span><span id="__span-30-394"><a id="__codelineno-30-394" name="__codelineno-30-394"></a>
</span><span id="__span-30-395"><a id="__codelineno-30-395" name="__codelineno-30-395"></a><span class="sd">        Returns:</span>
</span><span id="__span-30-396"><a id="__codelineno-30-396" name="__codelineno-30-396"></a><span class="sd">            Dict[str, paddle.Tensor]: Dict with split data.</span>
</span><span id="__span-30-397"><a id="__codelineno-30-397" name="__codelineno-30-397"></a><span class="sd">        """</span>
</span><span id="__span-30-398"><a id="__codelineno-30-398" name="__codelineno-30-398"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="__span-30-399"><a id="__codelineno-30-399" name="__codelineno-30-399"></a>            <span class="k">return</span> <span class="p">{</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">data_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
</span><span id="__span-30-400"><a id="__codelineno-30-400" name="__codelineno-30-400"></a>        <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">data_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keys</span><span class="p">)}</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="5">5. 结果展示<a class="headerlink" href="#5" title="Permanent link">¶</a></h2>
<p>使用混合精度训练后，在测试集上评估与目标之间的 MSE、PSNR、SSIM，评估指标的值为：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">MSE</th>
<th style="text-align: center;">PSNR</th>
<th style="text-align: center;">SSIM</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">4.21e-5</td>
<td style="text-align: center;">47.19</td>
<td style="text-align: center;">0.9974</td>
</tr>
</tbody>
</table>
<p>一个流体超分样例的输入、模型预测结果、<a href="#31">数据集介绍</a>中开源代码包 mantaflow 直接生成的结果如下，模型预测结果与生成的目标结果基本一致。</p>
<figure>
<p><a class="glightbox" href="https://paddle-org.bj.bcebos.com/paddlescience/docs/tempoGAN/input.gif" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="input" loading="lazy" src="https://paddle-org.bj.bcebos.com/paddlescience/docs/tempoGAN/input.gif"></a>
  </p>
<figcaption>输入的低密度流体</figcaption>
</figure>
<figure>
<p><a class="glightbox" href="https://paddle-org.bj.bcebos.com/paddlescience/docs/tempoGAN/pred_amp02.gif" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="pred-amp02" loading="lazy" src="https://paddle-org.bj.bcebos.com/paddlescience/docs/tempoGAN/pred_amp02.gif"></a>
  </p>
<figcaption>混合精度训练后推理得到的高密度流体</figcaption>
</figure>
<figure>
<p><a class="glightbox" href="https://paddle-org.bj.bcebos.com/paddlescience/docs/tempoGAN/target.gif" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="target" loading="lazy" src="https://paddle-org.bj.bcebos.com/paddlescience/docs/tempoGAN/target.gif"></a>
  </p>
<figcaption> 目标高密度流体</figcaption>
</figure>
<h2 id="6">6. 参考文献<a class="headerlink" href="#6" title="Permanent link">¶</a></h2>
<ul>
<li>
<p><a href="https://dl.acm.org/doi/10.1145/3197517.3201304">tempoGAN: A Temporally Coherent, Volumetric GAN for Super-resolution Fluid Flow</a></p>
</li>
<li>
<p><a href="https://github.com/thunil/tempoGAN">参考代码</a></p>
</li>
</ul></div>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="最后更新">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">May 27, 2024</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="创建日期">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">July 12, 2023</span>
  </span>

    
    
    
  </aside>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2022 - 2023 PaddlePaddle
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.tracking", "navigation.sections", "navigation.top", "search.suggest", "navigation.instant", "content.code.copy", "content.code.select", "content.code.annotate", "search.highlight", "content.tabs.link", "content.action.edit", "content.action.view"], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": {"alias": true, "provider": "mike"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.c8d2eff1.min.js"></script>
      
        <script src="../../../javascripts/bd_statistics.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="../../../javascripts/contributors.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>